<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wuqihan&#39;s blog</title>
  
  <subtitle>hard work pays off</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.wuqihan.cn/"/>
  <updated>2020-01-28T13:08:12.806Z</updated>
  <id>http://www.wuqihan.cn/</id>
  
  <author>
    <name>å´å¯æ™—</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Thank You,Kobe Bryant.</title>
    <link href="http://www.wuqihan.cn/2020/01/27/Kobe/"/>
    <id>http://www.wuqihan.cn/2020/01/27/Kobe/</id>
    <published>2020-01-27T05:47:13.000Z</published>
    <updated>2020-01-28T13:08:12.806Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚æœæ—¶å…‰å¯ä»¥å€’æµï¼Œæˆ‘ä¸€å®šä¸€å®šä¼šæƒ³å°½ä¸€åˆ‡åŠæ³•å‘Šè¯‰ä½ ä¸è¦ä¹˜åé‚£æ¶è¯¥æ­»çš„ç›´å‡æœºï¼</p><p>æˆ‘çœŸçš„æ²¡æœ‰æƒ³åˆ°ä½ ä¼šä»¥è¿™æ ·çš„æ–¹å¼ç¦»å¼€ï¼</p><a id="more"></a><p>ä¸€ä¸ªäººæ˜¯æœ‰å¤šä¹ˆå¼ºçš„æ„å¿—åŠ›ã€å¤šä¹ˆå¼ºçš„å¥½èƒœå¿ƒæ‰èƒ½åœ¨è·Ÿè…±æ–­è£‚çš„æƒ…å†µä¸‹ï¼Œè¿˜èƒ½ç‹¬è‡ªå›åœºå¹¶å®Œæˆä¸¤é¢—ç½šçƒã€‚</p><p>æ˜¯çš„ï¼Œåªæœ‰ä½ èƒ½åšåˆ°ã€‚ä½ æ°¸è¿œæ˜¯æˆ‘æœ€å–œæ¬¢çš„è¿åŠ¨å‘˜ï¼Œä½ æ°¸è¿œæ˜¯æˆ‘çš„å¶åƒã€‚</p><p>ä½ çš„ä¼Ÿå¤§æ ¹æœ¬ä¸éœ€è¦ç”¨ä»»ä½•æ•°æ®æ¥ä¿®é¥°ã€‚</p><p>æˆ‘å–œæ¬¢ä½ å¹¶ä¸æ˜¯å› ä¸ºä½ çš„ç¯®çƒæŠ€å·§ã€ä½ æœ‰æ€»å† å†›ï¼Œä½ æ˜¯å¾—åˆ†ç‹ã€ä½ æ˜¯MVPã€ä¹Ÿä¸å› ä¸ºä½ æœ‰è¿‡81åˆ†ï¼Œæ›´ä¸æ˜¯å› ä¸ºæˆ‘æœ‰å¤šå–œæ¬¢ç¯®çƒã€‚</p><p>è€Œæ˜¯å› ä¸ºä½ çš„æ€§æ ¼ï¼Œä½ ç‹¬ä¸€æ— äºŒçš„åæ‰§ã€ä½ çš„å‹¤å¥‹åšéŸ§ã€ä½ çš„å€”å¼ºã€ä½ è¿½æ±‚å®Œç¾ï¼Œä½ æ„¿æ„ä¸ºäº†æˆåŠŸä»˜å‡ºæ‰€æœ‰ã€‚</p><p>ä½ å°±æ˜¯æˆ‘æœ€æƒ³å»æˆä¸ºçš„é‚£ä¸ªäººã€‚</p><p>æˆ‘åœ¨ç”Ÿæ´»å·¥ä½œçš„å„ä¸ªæ–¹é¢éƒ½è¢«ä½ å½±å“ç€ã€‚ä½ å‘Šè¯‰æˆ‘å‡Œæ™¨å››ç‚¹çš„æ´›æ‰çŸ¶ï¼Œä½ å‘Šè¯‰æˆ‘æ›¼å·´ç²¾ç¥ã€‚ä½ ä¸€ç›´éƒ½åœ¨æ¿€åŠ±ç€æˆ‘ï¼Œè®©æˆ‘åƒä½ ä¸€æ ·åŠªåŠ›ã€åƒä½ ä¸€æ ·åæ‰§ã€‚</p><p>åœ¨ä½ çš„8å·å’Œ24å·çƒè¡£é€€å½¹ä»ªå¼ä¸Šï¼Œä½ è¯´è¿‡ï¼š</p><blockquote><p>é‚£äº›ä½ æ—©èµ·çš„æ—¶å…‰ï¼Œé‚£äº›ä½ åŠªåŠ›å·¥ä½œçš„æ—¶å…‰ï¼Œé‚£äº›æ„Ÿè§‰å¤ªç–²æƒ«çš„æ—¶å…‰ï¼Œä½†ä»è¿˜æ˜¯ç»§ç»­é‚£æ ·åšçš„æ—¶å…‰ï¼Œé‚£æ‰æ˜¯æ¢¦æƒ³çš„åŠ›é‡ã€‚é‡è¦çš„ä¸æ˜¯ç›®æ ‡ï¼Œæ˜¯è¿‡ç¨‹ã€‚</p></blockquote><p>è°¢è°¢æ‚¨çš„ä¸€è·¯é™ªä¼´ï¼</p><p>æˆ‘è™½ç„¶ä¸æ˜¯ä¸€ä¸ªä¼˜ç§€çš„äººã€‚ä½†æ˜¯è‡³å°‘å› ä¸ºæ‚¨ï¼Œæˆ‘å¹¶ä¸æ˜¯é‚£ä¹ˆçš„å·®åŠ²ã€‚</p><p><strong>You raise me up and I will always love you ! Mamba 4ever!</strong></p><p><img src="https://i.loli.net/2020/01/27/Qps7taWI5w8TNES.jpg" alt></p><p><img src="https://i.loli.net/2020/01/28/5A87NRSIXset6zr.jpg" alt></p><p><strong><font color="purple">ä¸€è·¯èµ°å¥½</font></strong></p><p><strong><font color="purple">æ„¿å¤©å ‚æœ‰æ‚¨çš„ğŸ€ </font></strong></p><p>ğŸ•¯ï¸ğŸ•¯ï¸ğŸ•¯ï¸ğŸ•¯ï¸ğŸ•¯ï¸ğŸ•¯ï¸</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¦‚æœæ—¶å…‰å¯ä»¥å€’æµï¼Œæˆ‘ä¸€å®šä¸€å®šä¼šæƒ³å°½ä¸€åˆ‡åŠæ³•å‘Šè¯‰ä½ ä¸è¦ä¹˜åé‚£æ¶è¯¥æ­»çš„ç›´å‡æœºï¼&lt;/p&gt;
&lt;p&gt;æˆ‘çœŸçš„æ²¡æœ‰æƒ³åˆ°ä½ ä¼šä»¥è¿™æ ·çš„æ–¹å¼ç¦»å¼€ï¼&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Swiftå®ç°äºŒå‰æœç´¢æ ‘</title>
    <link href="http://www.wuqihan.cn/2019/11/20/Swift%E5%AE%9E%E7%8E%B0%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/"/>
    <id>http://www.wuqihan.cn/2019/11/20/Swiftå®ç°äºŒå‰æœç´¢æ ‘/</id>
    <published>2019-11-20T11:30:33.000Z</published>
    <updated>2019-11-26T13:25:06.651Z</updated>
    
    <content type="html"><![CDATA[<p>åŸºäºSwiftå®ç°äº†äºŒå‰æœç´¢æ ‘ï¼Œä»¥åŠæ”¯æŒåœ¨console(æ§åˆ¶å°)ä¸­ä»¥å¦‚ä¸‹å½¢å¼è¾“å‡ºäºŒå‰æ ‘ï¼š</p><a id="more"></a><p><img src="https://i.loli.net/2019/11/26/8kaWgBH3Tm9A1R2.png" alt="binaryTreePrint.png"></p><p>æ‹¬å·()ä¸­çš„å€¼ï¼Œä»£è¡¨è¯¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œä¾¿äºæµ‹è¯•ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹degugDescritionä¸­çš„å€¼ï¼Œè‡ªå®šä¹‰èŠ‚ç‚¹çš„å±•ç¤ºå†…å®¹ã€‚<br>ä»£ç åœ°å€ï¼š<a href="https://github.com/wqhiOS/BinaryTree" target="_blank" rel="noopener">https://github.com/wqhiOS/BinaryTree</a> </p><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p><code>äºŒå‰æ ‘</code>ã€Binary Treeã€‘ å’Œ <code>äºŒå‰æœç´¢æ ‘</code>(æˆ–å«æŸ¥æ‰¾)ã€Binary Search Treeã€‘çš„ç›¸å…³æ¦‚å¿µ çœ‹ç»´åŸºç™¾ç§‘å°±å¤Ÿäº†ã€‚é‡Œé¢æœ‰è¯¦ç»†ä»‹ç»äºŒå‰æ ‘å’ŒäºŒå‰æœç´¢æ ‘ï¼Œä»¥åŠä¼˜ç¼ºç‚¹ï¼š</p><p><a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%8F%89%E6%A0%91" target="_blank" rel="noopener">äºŒå‰æ ‘</a></p><p><a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%85%83%E6%90%9C%E5%B0%8B%E6%A8%B9" target="_blank" rel="noopener">äºŒå‰æœç´¢æ ‘</a></p><h2 id="äºŒå‰æ ‘çš„éå†"><a href="#äºŒå‰æ ‘çš„éå†" class="headerlink" title="äºŒå‰æ ‘çš„éå†"></a>äºŒå‰æ ‘çš„éå†</h2><h3 id="å‰-ä¸­-ååºéå†ï¼ˆæ·±åº¦ä¼˜å…ˆéå†ï¼‰"><a href="#å‰-ä¸­-ååºéå†ï¼ˆæ·±åº¦ä¼˜å…ˆéå†ï¼‰" class="headerlink" title="å‰/ä¸­/ååºéå†ï¼ˆæ·±åº¦ä¼˜å…ˆéå†ï¼‰"></a>å‰/ä¸­/ååºéå†ï¼ˆæ·±åº¦ä¼˜å…ˆéå†ï¼‰</h3><h4 id="é€’å½’å®ç°"><a href="#é€’å½’å®ç°" class="headerlink" title="é€’å½’å®ç°"></a>é€’å½’å®ç°</h4><p>éå†äºŒå‰æ ‘ï¼šLã€Dã€Råˆ†åˆ«è¡¨ç¤ºéå†å·¦å­æ ‘ã€è®¿é—®æ ¹ç»“ç‚¹å’Œéå†å³å­æ ‘ï¼Œåˆ™å…ˆ(æ ¹)åºéå†äºŒå‰æ ‘çš„é¡ºåºæ˜¯DLRï¼Œä¸­(æ ¹)åºéå†äºŒå‰æ ‘çš„é¡ºåºæ˜¯LDRï¼Œå(æ ¹)åºéå†äºŒå‰æ ‘çš„é¡ºåºæ˜¯LRD</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preorderTraversal</span><span class="hljs-params">(<span class="hljs-number">_</span> block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">    preorderTraversal(root, block: block)</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preorderTraversal</span><span class="hljs-params">(<span class="hljs-number">_</span> node: Node&lt;Element&gt;?,block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> _node = node <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    block(_node.element)</span><br><span class="line">    preorderTraversal(_node.<span class="hljs-keyword">left</span>, block: block)</span><br><span class="line">    preorderTraversal(_node.<span class="hljs-keyword">right</span>, block: block)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">inorderTraversal</span><span class="hljs-params">(<span class="hljs-number">_</span> block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>)  &#123;</span><br><span class="line">  inorderTraversal(root, block: block) </span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">inorderTraversal</span><span class="hljs-params">(<span class="hljs-number">_</span> node: Node&lt;Element&gt;?, block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> _node = node <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    inorderTraversal(_node.<span class="hljs-keyword">left</span>, block: block)</span><br><span class="line">    block(_node.element)</span><br><span class="line">    inorderTraversal(_node.<span class="hljs-keyword">right</span>,block: block)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">postorderTraversal</span><span class="hljs-params">(<span class="hljs-number">_</span> block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">    postorderTraversal(root, block: block)</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">postorderTraversal</span><span class="hljs-params">(<span class="hljs-number">_</span> node: Node&lt;Element&gt;?, block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> _node = node <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    postorderTraversal(_node.<span class="hljs-keyword">left</span>, block: block)</span><br><span class="line">    postorderTraversal(_node.<span class="hljs-keyword">right</span>,block: block)</span><br><span class="line">    block(_node.element)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°æ€è·¯ï¼š</p><p>ä½¿ç”¨é€’å½’å®ç°ã€‚å¦‚ä½•çœ‹ä¸€ä¸ªç®—æ³•æ˜¯å¦èƒ½ç”¨é€’å½’å®ç°ï¼Œæˆ‘è§‰å¾—ä¸»è¦å°±æ˜¯æ˜¯å¦èƒ½å†™å‡ºä¸€ä¸ªé€šç”¨çš„é€’å½’å…¬å¼ã€‚æ¯”å¦‚æœ€ç®€å•çš„ä¾‹å­ï¼šä½ åœ¨ç”µå½±é™¢é‡Œé»‘å’•éš†å’šåªæœ‰å‰åæœ‰äººï¼Œä½ ä¸çŸ¥é“ä½ åçš„ç¬¬å‡ æ’ï¼Œä½ åªéœ€è¦é—®ä¸€ä¸‹ä½ å‰æ’çš„äººä»–æ˜¯ç¬¬næ’ï¼Œç„¶åä½ å°±æ˜¯n+1æ’ã€‚å¦‚æœä½ å‰é¢çš„äººä¹Ÿä¸çŸ¥é“ï¼Œé‚£å‰é¢çš„äººå°±é—®ä¸‹ä»–å‰é¢çš„äººã€‚ã€‚è¿™æ ·ä¾æ¬¡ç±»æ¨ï¼Œæ€»ç»“å‡ºä¸€ä¸ªå…¬å¼ï¼šæ’æ•°=å‰ä¸€æ’+1ã€‚</p><h4 id="è¿­ä»£å®ç°"><a href="#è¿­ä»£å®ç°" class="headerlink" title="è¿­ä»£å®ç°"></a>è¿­ä»£å®ç°</h4><p>ä»¥ä¸Šæ˜¯å®ç”¨<code>é€’å½’</code>å®ç°<code>å‰ä¸­ååºéå†</code>ï¼Œä¸‹é¢æ˜¯å®ç”¨è¿­ä»£å®ç°</p><p>è¿­ä»£å®ç°å…¶å®å°±æ˜¯æ¨¡æ‹Ÿé€’å½’çš„è¿‡ç¨‹ï¼Œæˆ‘æ„Ÿè§‰æŒºéº»çƒ¦çš„ï¼Œå¤ªç»•äº†ã€‚æ€è·¯éƒ½æ˜¯ä»leetcodeæŠ„è¿‡æ¥çš„ã€‚å‰åºéå†æ¯”è¾ƒç®€å•ï¼Œèƒ½è‡ªå·±æƒ³å‡ºæ¥ï¼Œä¸­åºç¨å¾®éš¾ä¸€ç‚¹ï¼Œååºå†æ›´éš¾ä¸€ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/// å‰åºéå† è¿­ä»£å®ç°</span></span><br><span class="line"><span class="hljs-comment">/// - Parameter block: block description</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preorderTraversal2</span><span class="hljs-params">(<span class="hljs-number">_</span> block:<span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> _root = root <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">var</span> stack = [<span class="hljs-type">Node</span>&lt;<span class="hljs-type">Element</span>&gt;]()</span><br><span class="line">    stack.append(_root)</span><br><span class="line">    <span class="hljs-keyword">while</span> !stack.isEmpty &#123;</span><br><span class="line">        <span class="hljs-keyword">let</span> node = stack.removeLast()</span><br><span class="line">        block(node.element)</span><br><span class="line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">right</span> = node.<span class="hljs-keyword">right</span> &#123;</span><br><span class="line">            stack.append(<span class="hljs-keyword">right</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">left</span> = node.<span class="hljs-keyword">left</span> &#123;</span><br><span class="line">            stack.append(<span class="hljs-keyword">left</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/// ä¸­åºéå† è¿­ä»£å®ç°</span></span><br><span class="line"><span class="hljs-comment">/// - Parameter block: block description</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">inorderTraversal2</span><span class="hljs-params">(<span class="hljs-number">_</span> block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">var</span> stack = [<span class="hljs-type">Node</span>&lt;<span class="hljs-type">Element</span>&gt;]()</span><br><span class="line">    <span class="hljs-keyword">var</span> node = root</span><br><span class="line">    <span class="hljs-keyword">while</span> node != <span class="hljs-literal">nil</span> || !stack.isEmpty &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> node != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">            stack.append(node!)</span><br><span class="line">            node = node?.<span class="hljs-keyword">left</span></span><br><span class="line">        &#125;<span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            node = stack.removeLast()</span><br><span class="line">            block(node!.element)</span><br><span class="line">            node = node?.<span class="hljs-keyword">right</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">/// ååºéå† è¿­ä»£å®ç°</span></span><br><span class="line"><span class="hljs-comment">/// - Parameter block: block description</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">postorderTraversal2</span><span class="hljs-params">(<span class="hljs-number">_</span> block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> _root = root <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">var</span> stack = [<span class="hljs-type">Node</span>&lt;<span class="hljs-type">Element</span>&gt;]()</span><br><span class="line">    stack.append(_root)</span><br><span class="line">    <span class="hljs-keyword">var</span> lastNode: <span class="hljs-type">Node</span>&lt;<span class="hljs-type">Element</span>&gt;?</span><br><span class="line">    <span class="hljs-keyword">while</span> !stack.isEmpty &#123;</span><br><span class="line">        <span class="hljs-keyword">let</span> node = stack.last</span><br><span class="line">        <span class="hljs-keyword">if</span> (node!.<span class="hljs-keyword">left</span> == <span class="hljs-literal">nil</span> &amp;&amp; node?.<span class="hljs-keyword">right</span> == <span class="hljs-literal">nil</span>) || node!.<span class="hljs-keyword">left</span> == lastNode || node!.<span class="hljs-keyword">right</span> == lastNode &#123;</span><br><span class="line">            lastNode = node</span><br><span class="line">            block(stack.removeLast().element)</span><br><span class="line">        &#125;<span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">right</span> = node?.<span class="hljs-keyword">right</span> &#123;</span><br><span class="line">                stack.append(<span class="hljs-keyword">right</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">left</span> = node?.<span class="hljs-keyword">left</span> &#123;</span><br><span class="line">                stack.append(<span class="hljs-keyword">left</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å±‚åºéå†ï¼ˆå¹¿-å®½åº¦ä¼˜å…ˆéå†ï¼‰"><a href="#å±‚åºéå†ï¼ˆå¹¿-å®½åº¦ä¼˜å…ˆéå†ï¼‰" class="headerlink" title="å±‚åºéå†ï¼ˆå¹¿/å®½åº¦ä¼˜å…ˆéå†ï¼‰"></a>å±‚åºéå†ï¼ˆå¹¿/å®½åº¦ä¼˜å…ˆéå†ï¼‰</h3><p>ä»ç¬¬ä¸€å±‚å¼€å§‹ä¸€å±‚å±‚éå†ï¼Œæœ€å¥½ç†è§£ã€‚</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">levelTraversal</span><span class="hljs-params">(<span class="hljs-number">_</span> block: <span class="hljs-params">(Element)</span></span></span>-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">  <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> root = root <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">var</span> queue = [<span class="hljs-type">Node</span>&lt;<span class="hljs-type">Element</span>&gt;]()</span><br><span class="line">  queue.append(root)</span><br><span class="line">  <span class="hljs-keyword">while</span> !queue.isEmpty &#123;</span><br><span class="line">      <span class="hljs-keyword">let</span> node = queue.removeFirst()</span><br><span class="line">      block(node.element)</span><br><span class="line">      <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">left</span> = node.<span class="hljs-keyword">left</span> &#123;</span><br><span class="line">          queue.append(<span class="hljs-keyword">left</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">right</span> = node.<span class="hljs-keyword">right</span> &#123;</span><br><span class="line">          queue.append(<span class="hljs-keyword">right</span>)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°æ€è·¯ï¼šä½¿ç”¨é˜Ÿåˆ—</p><p>å…ˆå°†æ ¹èŠ‚ç‚¹rootå…¥é˜Ÿï¼Œ ã€ä»é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ªå…ƒç´ èŠ‚ç‚¹å‡ºé˜Ÿå¹¶è®¿é—®ï¼Œç„¶åå°†è¿™ä¸ªèŠ‚ç‚¹çš„å·¦å³å­æ ‘ä¾æ¬¡å…¥é˜Ÿã€‘ï¼Œé‡å¤æ‰§è¡Œã€ã€‘ä¸­çš„æ“ä½œï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºã€‚</p><h2 id="äºŒå‰æ ‘çš„å‰é©±å’Œåç»§èŠ‚ç‚¹"><a href="#äºŒå‰æ ‘çš„å‰é©±å’Œåç»§èŠ‚ç‚¹" class="headerlink" title="äºŒå‰æ ‘çš„å‰é©±å’Œåç»§èŠ‚ç‚¹"></a>äºŒå‰æ ‘çš„å‰é©±å’Œåç»§èŠ‚ç‚¹</h2><p>åœ¨äºŒå‰æ ‘ä¸­ï¼Œæ±‚æŸä¸ªèŠ‚ç‚¹çš„<code>å‰é©±èŠ‚ç‚¹</code>ï¼Œå°±æ˜¯<code>ä¸­åºéå†</code>æ—¶è¯¥èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚åŒç†ï¼ŒÂ·å°±æ˜¯<code>ä¸­åºéå†</code>æ—¶ï¼Œè¯¥èŠ‚ç‚¹çš„åä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>åœ¨äºŒå‰æœç´¢æ ‘ä¸­ï¼ŒæŸèŠ‚ç‚¹çš„<code>å‰é©±èŠ‚ç‚¹</code>å°±æ˜¯æ¯”è¯¥èŠ‚ç‚¹å°çš„èŠ‚ç‚¹ä¸­æœ€å¤§çš„é‚£ä¸€ä¸ªã€‚æŸèŠ‚ç‚¹çš„<code>åç»§èŠ‚ç‚¹</code>å°±æ˜¯æ¯”è¯¥èŠ‚ç‚¹å¤§çš„æ‰€æœ‰èŠ‚ç‚¹ä¸­æœ€å°çš„é‚£ä¸€ä¸ªã€‚</p><blockquote><p>éå† å’Œ å‰é©±åç»§å¹¶ä¸æ˜¯äºŒå‰æœç´¢æ ‘æ‰æœ‰çš„ï¼Œè¿™äº›éƒ½æ˜¯åŸºäºäºŒå‰æ ‘ã€‚ä½†æ˜¯æŸ¥æ‰¾ã€æ·»åŠ å’Œåˆ é™¤æ˜¯äºŒå‰æ ‘æ²¡æœ‰çš„ï¼ˆå› ä¸ºäºŒå‰æ ‘ä¸­çš„èŠ‚ç‚¹ä¸èƒ½ä¿è¯å¯ä»¥æ¯”è¾ƒå¤§å°ï¼Œåªæœ‰äºŒå‰æœç´¢æ ‘ä¸­çš„èŠ‚ç‚¹ä¸€å®šèƒ½å¤Ÿæ¯”è¾ƒå¤§å°ï¼‰ã€‚</p></blockquote><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/// å‰é©±èŠ‚ç‚¹</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">predecessor</span><span class="hljs-params">(node: Node&lt;Element&gt;)</span></span> -&gt; <span class="hljs-type">Node</span>&lt;<span class="hljs-type">Element</span>&gt;?&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> node.<span class="hljs-keyword">left</span> != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">var</span> predecessor = node.<span class="hljs-keyword">left</span></span><br><span class="line">        <span class="hljs-keyword">while</span> predecessor?.<span class="hljs-keyword">right</span> != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">            predecessor = predecessor?.<span class="hljs-keyword">right</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> predecessor</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">var</span> targetNode = node</span><br><span class="line">    <span class="hljs-keyword">while</span> targetNode.parent != <span class="hljs-literal">nil</span> &amp;&amp; targetNode.parent!.<span class="hljs-keyword">left</span> != <span class="hljs-literal">nil</span> &amp;&amp; targetNode.parent!.<span class="hljs-keyword">left</span>! == targetNode &#123;</span><br><span class="line">        targetNode = targetNode.parent!</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> targetNode.parent</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/// åç»§èŠ‚ç‚¹</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">successor</span><span class="hljs-params">(node: Node&lt;Element&gt;)</span></span> -&gt; <span class="hljs-type">Node</span>&lt;<span class="hljs-type">Element</span>&gt;? &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> node.<span class="hljs-keyword">right</span> != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">var</span> successor = node.<span class="hljs-keyword">right</span></span><br><span class="line">            <span class="hljs-keyword">while</span> successor?.<span class="hljs-keyword">left</span> != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">                successor = successor?.<span class="hljs-keyword">left</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> successor</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">var</span> targetNode = node</span><br><span class="line">    <span class="hljs-keyword">while</span> targetNode.parent != <span class="hljs-literal">nil</span> &amp;&amp; targetNode.parent!.<span class="hljs-keyword">right</span> != <span class="hljs-literal">nil</span> &amp;&amp; targetNode.parent!.<span class="hljs-keyword">right</span>! == targetNode &#123;</span><br><span class="line">        targetNode = targetNode.parent!</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> targetNode.parent</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰é©±èŠ‚ç‚¹å®ç°æ€è·¯ï¼š</p><ul><li>å¦‚æœæœ‰å·¦å­æ ‘ï¼Œå¾ˆç®€å•ï¼Œå‰é©±èŠ‚ç‚¹å°±æ˜¯node.left.right.rightâ€¦</li><li>å¦‚æœæ²¡æœ‰å·¦å­æ ‘ï¼Œå‰é©±èŠ‚ç‚¹ä¸º node.parent.parentâ€¦ç›´åˆ°node.parentâ€¦æ˜¯åœ¨å³èŠ‚ç‚¹</li></ul><p><strong>å¦‚æœæ²¡æœ‰å·¦å­æ ‘ä¼šæ„Ÿè§‰æœ‰ç‚¹ç»•ï¼Œå…¶å®åè¿‡æ¥æƒ³ä¼šæ¯”è¾ƒç®€ç­”ã€‚å¦‚æœæ²¡æœ‰å·¦å­æ ‘çš„è¯ã€‚å°±ç›¸å½“äºæ˜¯ å·²çŸ¥æŸä¸€èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œæ±‚è¯¥èŠ‚ç‚¹ã€‚å°±ç›¸å½“äºæ˜¯æŠŠæ±‚æœ‰å³å­æ ‘çš„èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹åè¿‡æ¥ã€‚</strong></p><p>åç»§èŠ‚ç‚¹å®ç°æ€è·¯å’Œå‰é©±èŠ‚ç‚¹æ­£å¥½ç›¸å</p><h2 id="äºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾ã€æ·»åŠ å’Œåˆ é™¤"><a href="#äºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾ã€æ·»åŠ å’Œåˆ é™¤" class="headerlink" title="äºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾ã€æ·»åŠ å’Œåˆ é™¤"></a>äºŒå‰æœç´¢æ ‘çš„æŸ¥æ‰¾ã€æ·»åŠ å’Œåˆ é™¤</h2><p>å¯¹äºæ™®é€š<code>äºŒå‰æ ‘</code>æ¥è¯´ï¼Œæ˜¯ä¸èƒ½<code>æ·»åŠ </code>å’Œ<code>åˆ é™¤</code>çš„ã€‚å› ä¸ºæ™®é€š<code>äºŒå‰æ ‘</code>çš„<code>èŠ‚ç‚¹</code>ä¹‹é—´å¹¶ä¸ä¸€å®šèƒ½æ¯”è¾ƒå¤§å°ï¼Œä¸èƒ½æ¯”è¾ƒå¤§å°çš„è¯ï¼Œä½ ä¹Ÿä¸çŸ¥é“æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹åº”è¯¥æ·»åŠ åœ¨å“ªé‡Œã€‚æ‰€ä»¥å¼•å‡ºäº†<code>äºŒå‰æœç´¢æ ‘</code>ï¼Œ<code>äºŒå‰æœç´¢</code>ä¸­çš„èŠ‚ç‚¹çš„å€¼æ˜¯å¯ä»¥æ¯”è¾ƒå¤§å°çš„ã€‚</p><h3 id="æŸ¥æ‰¾èŠ‚ç‚¹"><a href="#æŸ¥æ‰¾èŠ‚ç‚¹" class="headerlink" title="æŸ¥æ‰¾èŠ‚ç‚¹"></a>æŸ¥æ‰¾èŠ‚ç‚¹</h3><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">node</span><span class="hljs-params">(withElement element: Element)</span></span> -&gt; <span class="hljs-type">Node</span>&lt;<span class="hljs-type">Element</span>&gt;?&#123;</span><br><span class="line">    <span class="hljs-keyword">var</span> node = root</span><br><span class="line">    <span class="hljs-keyword">while</span> node != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">let</span> result = compare(element, node!.element)</span><br><span class="line">        <span class="hljs-keyword">switch</span> result &#123;</span><br><span class="line">        <span class="hljs-keyword">case</span> .orderedAscending:</span><br><span class="line">            node = node!.<span class="hljs-keyword">left</span></span><br><span class="line">        <span class="hljs-keyword">case</span> .orderedDescending:</span><br><span class="line">            node = node!.<span class="hljs-keyword">right</span></span><br><span class="line">        <span class="hljs-keyword">case</span> .orderedSame:</span><br><span class="line">            <span class="hljs-keyword">return</span> node</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°æ€è·¯ï¼š</strong></p><p>æŸ¥æ‰¾å¾ˆç®€å•ï¼Œå°±æ˜¯ä»<code>æ ¹èŠ‚ç‚¹</code>å¼€å§‹å¾€ä¸‹æ¯”è¾ƒå¤§å°ã€‚</p><h3 id="æ·»åŠ èŠ‚ç‚¹"><a href="#æ·»åŠ èŠ‚ç‚¹" class="headerlink" title="æ·»åŠ èŠ‚ç‚¹"></a>æ·»åŠ èŠ‚ç‚¹</h3><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">_</span> element: Element)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">        root = <span class="hljs-type">Node</span>(element: element, parent: <span class="hljs-literal">nil</span>)</span><br><span class="line">        size += <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">var</span> parentNode = root</span><br><span class="line">    <span class="hljs-keyword">var</span> targetNode = root</span><br><span class="line">    <span class="hljs-keyword">var</span> compareResult: <span class="hljs-type">ComparisonResult</span> = .orderedSame</span><br><span class="line">    <span class="hljs-keyword">while</span> parentNode != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">        targetNode = parentNode</span><br><span class="line">        compareResult = compare(element,parentNode!.element)</span><br><span class="line">        <span class="hljs-keyword">switch</span> compareResult &#123;</span><br><span class="line">        <span class="hljs-keyword">case</span> .orderedAscending:</span><br><span class="line">            parentNode = parentNode!.<span class="hljs-keyword">left</span></span><br><span class="line">            <span class="hljs-keyword">break</span></span><br><span class="line">        <span class="hljs-keyword">case</span> .orderedDescending:</span><br><span class="line">            parentNode = parentNode!.<span class="hljs-keyword">right</span></span><br><span class="line">            <span class="hljs-keyword">break</span></span><br><span class="line">        <span class="hljs-keyword">case</span> .orderedSame:</span><br><span class="line">            parentNode = <span class="hljs-literal">nil</span></span><br><span class="line">            <span class="hljs-keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">switch</span> compareResult &#123;</span><br><span class="line">    <span class="hljs-keyword">case</span> .orderedAscending:</span><br><span class="line">        <span class="hljs-keyword">let</span> node = <span class="hljs-type">Node</span>(element: element, parent: targetNode)</span><br><span class="line">        targetNode?.<span class="hljs-keyword">left</span> = node</span><br><span class="line">        size += <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-keyword">case</span> .orderedDescending:</span><br><span class="line">        <span class="hljs-keyword">let</span> node = <span class="hljs-type">Node</span>(element: element, parent: targetNode)</span><br><span class="line">        targetNode?.<span class="hljs-keyword">right</span> = <span class="hljs-type">Node</span>(element: element, parent: targetNode)</span><br><span class="line">        size += <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-keyword">case</span> .orderedSame:</span><br><span class="line">        targetNode?.element = element</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¸€å®šè¦æ˜ç™½ï¼š<strong>äºŒå‰æœç´¢æ ‘æ·»åŠ èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¸å¯èƒ½æ’å…¥åˆ°äºŒå‰æ ‘ä¸­é—´çš„ï¼Œè¯¥èŠ‚ç‚¹æ·»åŠ ä¹‹åå¿…ç„¶ä¼šæ˜¯å¶å­èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯åº¦ä¸º0çš„èŠ‚ç‚¹ã€‚</strong></p><p><strong>å®ç°æ€è·¯ï¼š</strong></p><p>æ·»åŠ è¦æ¯”åˆ é™¤ç®€å•å¾ˆå¤šï¼Œæ€è·¯å’ŒæŸ¥æ‰¾å…¶å®å·®ä¸å¤šã€‚å‡è®¾è¦æ·»åŠ çš„èŠ‚ç‚¹ä¸ºNï¼Œåªéœ€è¦ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œä¸€è·¯å¾€ä¸‹æ¯”å¤§å°ï¼Œæ‰¾åˆ°Nçš„çˆ¶èŠ‚ç‚¹På³å¯ï¼Œå¦‚æœNæ¯”På°ï¼Œè®¾ç½®Nä¸ºPçš„å·¦å­èŠ‚ç‚¹ã€‚å¦‚æœNæ¯”På¤§è®¾ç½®Nä¸ºPçš„å³å­èŠ‚ç‚¹å³å¯ã€‚<strong>æ€»ç»“ä¸€å¥è¯ï¼šæ‰¾åˆ°åˆé€‚çš„çˆ¶èŠ‚ç‚¹ç„¶åæ·»åŠ å³å¯</strong></p><h3 id="åˆ é™¤èŠ‚ç‚¹"><a href="#åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="åˆ é™¤èŠ‚ç‚¹"></a>åˆ é™¤èŠ‚ç‚¹</h3><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">remove</span><span class="hljs-params">(<span class="hljs-number">_</span> element: Element)</span></span> &#123;</span><br><span class="line">    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">var</span> node = node(withElement: element) <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// å¦‚æœåˆ é™¤èŠ‚ç‚¹åº¦ä¸º2ï¼Œé‚£ä¹ˆæœ€åè¿˜æ˜¯ç›¸å½“äºåˆ é™¤åº¦ä¸º1æˆ–è€…0çš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line">    <span class="hljs-comment">// æ‰€ä»¥å…ˆåˆ¤æ–­è¿™ä¸ª</span></span><br><span class="line">    <span class="hljs-keyword">if</span> node.hasTowChildren &#123;</span><br><span class="line">        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> predecessor = <span class="hljs-keyword">self</span>.predecessor(node: node) <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        node.element = predecessor.element</span><br><span class="line">        node = predecessor</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">//èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜ nodeåº¦è¦ä¹ˆæ˜¯0 è¦ä¹ˆæ˜¯1</span></span><br><span class="line">    <span class="hljs-keyword">let</span> replacement = node.<span class="hljs-keyword">left</span> ?? node.<span class="hljs-keyword">right</span></span><br><span class="line">    <span class="hljs-keyword">if</span> replacement != <span class="hljs-literal">nil</span> &#123;<span class="hljs-comment">//nodeåº¦ä¸º1</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> parent = node.parent &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> parent.<span class="hljs-keyword">left</span> == node &#123;</span><br><span class="line">                parent.<span class="hljs-keyword">left</span> = replacement</span><br><span class="line">            &#125;<span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                parent.<span class="hljs-keyword">right</span> = replacement</span><br><span class="line">            &#125;</span><br><span class="line">            replacement?.parent = parent</span><br><span class="line">        &#125;<span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            root = replacement</span><br><span class="line">            replacement?.parent = <span class="hljs-literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;<span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//åº¦ä¸º0</span></span><br><span class="line">        <span class="hljs-keyword">if</span> node == node.parent?.<span class="hljs-keyword">left</span> &#123;</span><br><span class="line">            node.parent?.<span class="hljs-keyword">left</span> = <span class="hljs-literal">nil</span></span><br><span class="line">        &#125;<span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            node.parent?.<span class="hljs-keyword">right</span> = <span class="hljs-literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> node == root &#123;</span><br><span class="line">            root = <span class="hljs-literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size -= <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°æ€è·¯ï¼š</strong></p><p>åˆ é™¤èŠ‚ç‚¹ä¸€å…±å°±ä¸‰ç§æƒ…å†µï¼šåˆ é™¤çš„èŠ‚ç‚¹åº¦ä¸º0ã€1ã€2è¿™ä¸‰ç§æƒ…å†µ</p><ol><li><p><strong>åˆ é™¤çš„èŠ‚ç‚¹åº¦ä¸º0</strong> ï¼Œå³å¶å­èŠ‚ç‚¹ã€‚</p><p>ç›´æ¥åˆ é™¤å³å¯ã€‚</p></li><li><p><strong>åˆ é™¤çš„èŠ‚ç‚¹åº¦ä¸º1</strong>ï¼Œä»£è¡¨å…¶æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ã€‚</p><p>ç›´æ¥åˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œç„¶åæŠŠè¯¥èŠ‚ç‚¹çš„å”¯ä¸€ä¸€ä¸ªå¶å­èŠ‚ç‚¹æ”¾åœ¨åˆ é™¤çš„è¿™ä¸ªèŠ‚ç‚¹çš„ä½ç½®ä¸Šå³å¯ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ç”¨è¦åˆ é™¤çš„å­èŠ‚ç‚¹è¦†ç›–è‡ªå·±å³å¯ã€‚</p></li><li><p><strong>åˆ é™¤çš„èŠ‚ç‚¹åº¦ä¸º2</strong>ã€‚</p><p>é¦–å…ˆéœ€è¦æ‰¾åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚(è¿™é‡Œæåˆ°è¦æ‰¾åˆ°åç»§èŠ‚ç‚¹ï¼Œå¹¶ä¸æ˜¯å”¯ä¸€åŠæ³•ï¼Œ æ‰¾å‰åºèŠ‚ç‚¹ä¹Ÿå¯ä»¥ã€‚çœ‹ä½ æƒ³è¦å“ªä¸ªèŠ‚ç‚¹ã€‚åªè¦ç¡®ä¿æ˜¯å‰åºæˆ–è€…åç»§éƒ½å¯ä»¥ã€‚ä¸ºä»€ä¹ˆï¼Ÿè‡ªå·±æƒ³ä¸€ä¸‹å°±æ˜ç™½äº†)</p><p>ç”¨åç»§èŠ‚ç‚¹çš„å†…å®¹å¤åˆ¶åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹ä¸Šã€‚ä¹‹ååˆ é™¤è¿™ä¸ªåç»§èŠ‚ç‚¹å³å¯ã€‚</p><p><strong>æ‰€ä»¥è¿™é‡Œçš„åˆ é™¤ï¼Œå°±è½¬å˜ä¸ºäº†åˆ é™¤åç»§èŠ‚ç‚¹ã€‚åç»§èŠ‚ç‚¹çš„åº¦è¦ä¹ˆæ˜¯0è¦ä¹ˆæ˜¯1.æ‰€ä»¥å°±è½¬å˜æˆäº† åˆ é™¤çš„èŠ‚ç‚¹åº¦ä¸º0 æˆ–è€…åº¦ä¸º1ã€‚æ ¹æ®æƒ…å†µ èµ°ä¸Šé¢çš„1æˆ–2æ­¥éª¤å³å¯ã€‚</strong></p></li></ol><blockquote><p>æœ€åå®é™…åˆ é™¤çš„èŠ‚ç‚¹ åº¦æ•°ä¸å¯èƒ½ä¸º2ï¼Œåªèƒ½æ˜¯0æˆ–1</p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åˆ°è¿™é‡Œï¼Œä¸€æ£µäºŒå‰æœç´¢æ ‘çš„æ‰€éœ€è¦çš„åŸºæœ¬æ“ä½œéƒ½å·²ç»å®ç°ã€‚ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>äºŒå‰æ ‘<ul><li>éå†<ul><li>å‰ä¸­ååºéå†ï¼ˆé€’å½’/è¿­ä»£ï¼‰</li><li>å±‚åºéå†ï¼ˆè¿­ä»£ï¼‰</li></ul></li><li>å‰é©±ã€åç»§èŠ‚ç‚¹</li></ul></li><li>äºŒå‰æœç´¢æ ‘ (extends: äºŒå‰æ ‘)<ul><li>æŸ¥æ‰¾</li><li>æ·»åŠ </li><li>åˆ é™¤</li></ul></li></ul><p>è¯¦ç»†ä»£ç å‚è€ƒï¼š<a href="https://github.com/wqhiOS/BinaryTree" target="_blank" rel="noopener">https://github.com/wqhiOS/BinaryTree</a> </p><blockquote><font color="orange">è¿™ç¯‡æ–‡ç« åªæ˜¯è‡ªå·±å¯¹äºŒå‰æœç´¢æ ‘çš„æ€»ç»“ï¼Œä»¥ä¾¿æ—¥åå¤ä¹ å·©å›ºã€‚å¹¶ä¸å®Œå…¨å…·å¤‡å­¦ä¹ ä»·å€¼ã€‚å¦‚æœè¦ä»é›¶å­¦ä¹ äºŒå‰æ ‘ç›¸å…³å†…å®¹å»ºè®®è¿˜æ˜¯æ‹¿ç®—æ³•ä¹¦ç³»ç»Ÿçœ‹ä¸€çœ‹ã€‚</font></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åŸºäºSwiftå®ç°äº†äºŒå‰æœç´¢æ ‘ï¼Œä»¥åŠæ”¯æŒåœ¨console(æ§åˆ¶å°)ä¸­ä»¥å¦‚ä¸‹å½¢å¼è¾“å‡ºäºŒå‰æ ‘ï¼š&lt;/p&gt;
    
    </summary>
    
      <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://www.wuqihan.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="äºŒå‰æ ‘" scheme="http://www.wuqihan.cn/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/"/>
    
      <category term="äºŒå‰æœç´¢æ ‘" scheme="http://www.wuqihan.cn/tags/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨CentOS7ä¸Šæ­å»ºShadowsocks</title>
    <link href="http://www.wuqihan.cn/2019/08/14/%E5%9C%A8CentOS7%E4%B8%8A%E6%90%AD%E5%BB%BAShadowsocks/"/>
    <id>http://www.wuqihan.cn/2019/08/14/åœ¨CentOS7ä¸Šæ­å»ºShadowsocks/</id>
    <published>2019-08-14T12:52:16.000Z</published>
    <updated>2019-08-14T13:10:46.312Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æï¼šè´­ä¹°ä¸€å°å›½å¤–ä¸»æœºï¼Œæˆ‘æ˜¯åœ¨æ¬ç“¦å·¥ä¸Šä¹°çš„</p><h3 id="é¦–å…ˆä½¿ç”¨SSHç™»å½•"><a href="#é¦–å…ˆä½¿ç”¨SSHç™»å½•" class="headerlink" title="é¦–å…ˆä½¿ç”¨SSHç™»å½•"></a>é¦–å…ˆä½¿ç”¨SSHç™»å½•</h3><p>åœ¨CENTOS7ä¸Šæ­å»ºShadowsocksåœ¨CENTOS7ä¸Šæ­å»ºShadowsocks</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p ç«¯å£å· username@ip</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ æˆ‘çš„ç«¯å£å·æ˜¯23456ï¼Œ usernameæ˜¯root ï¼Œipåœ°å€æ˜¯123.232.123.123</p><p>â€œssh -p 23456 root@123.232.123.123â€</p><a id="more"></a><p>ç™»å½•æˆåŠŸå¦‚ä¸‹ï¼š</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/ss_8.png" alt="image-20190802161122759"></p><h3 id="å®‰è£…pip"><a href="#å®‰è£…pip" class="headerlink" title="å®‰è£…pip"></a>å®‰è£…pip</h3><p>ç™»å½•ä¹‹å</p><p>è¾“å…¥ <code>https://bootstrap.pypa.io/get-pip.py -o get-pip.py</code> åŠ å›è½¦</p><p>è¾“å…¥<code>python get-pip.py</code>åŠ å›è½¦</p><p>æ•ˆæœå¦‚ä¸‹</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/ss_7.png" alt="image-20190802161907805"></p><h3 id="å®‰è£…Shadowsocks"><a href="#å®‰è£…Shadowsocks" class="headerlink" title="å®‰è£…Shadowsocks"></a>å®‰è£…Shadowsocks</h3><p>è¾“å…¥<code>pip install shadowsocks</code>åå›è½¦ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/ss_6.png" alt="image-20190802162014711"></p><h3 id="é…ç½®Shadowsocks"><a href="#é…ç½®Shadowsocks" class="headerlink" title="é…ç½®Shadowsocks"></a>é…ç½®Shadowsocks</h3><p>è¾“å…¥ç¼–è¾‘æ–‡ä»¶å‘½ä»¤<code>vi /etc/shadowsocks.json</code>å¹¶å›è½¦</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/ss_5.png" alt="image-20190802162108989"></p><p>è¾“å…¥ä¸‹é¢å†…å®¹</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;0.0.0.0&quot;,</span><br><span class="line">    &quot;server_port&quot;:9057,</span><br><span class="line">    &quot;local_port&quot;:10080,</span><br><span class="line">    &quot;password&quot;:&quot;1234567890&quot;,</span><br><span class="line">    &quot;timeout&quot;:600,</span><br><span class="line">    &quot;method&quot;:&quot;aes-256-cfb&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/ss_4.png" alt="image-20190802162527185"></p><p>9057 æ˜¯ç«¯å£ 1234567890 æ˜¯å¯†ç </p><h3 id="å°†ShadowsocksåŠ å…¥ç³»ç»ŸæœåŠ¡"><a href="#å°†ShadowsocksåŠ å…¥ç³»ç»ŸæœåŠ¡" class="headerlink" title="å°†ShadowsocksåŠ å…¥ç³»ç»ŸæœåŠ¡"></a>å°†ShadowsocksåŠ å…¥ç³»ç»ŸæœåŠ¡</h3><p>è¾“å…¥ç¼–è¾‘æ–‡ä»¶å‘½ä»¤<code>vi /etc/systemd/system/shadowsocks.service</code>å¹¶å›è½¦</p><p>ç²˜è´´ä¸‹é¢å†…å®¹ï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Shadowsocks</span><br><span class="line">[Service]</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStart=/usr/bin/ssserver -c /etc/shadowsocks.json</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/ss_2.png" alt="image-20190802162745539"></p><h3 id="å¯åŠ¨ShadowsocksæœåŠ¡ï¼Œå¹¶è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨"><a href="#å¯åŠ¨ShadowsocksæœåŠ¡ï¼Œå¹¶è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨" class="headerlink" title="å¯åŠ¨ShadowsocksæœåŠ¡ï¼Œå¹¶è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨"></a>å¯åŠ¨ShadowsocksæœåŠ¡ï¼Œå¹¶è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># è®¾ç½®å¼€æœºè‡ªå¯å‘½ä»¤</span><br><span class="line">systemctl enable shadowsocks</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨å‘½ä»¤</span><br><span class="line">systemctl start shadowsocks</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹çŠ¶æ€å‘½ä»¤</span><br><span class="line">systemctl status shadowsocks</span><br></pre></td></tr></table></figure><p>ä¾æ¬¡æ‰§è¡Œä¸Šé¢ä¸‰æ¡å‘½ä»¤å¦‚ä¸‹ï¼š</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/ss_1.png" alt="image-20190802163000085"></p><p>active æ˜¾ç¤ºrunning å°±æˆåŠŸäº†</p><p>Mac shadowsocks è½¯ä»¶ä¸‹è½½åœ°å€ï¼š <a href="https://github.com/shadowsocks/ShadowsocksX-NG" target="_blank" rel="noopener">https://github.com/shadowsocks/ShadowsocksX-NG</a></p><p>iOS shadowsocks è¦å»å›½å¤–appStore ä¸‹è½½ </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰æï¼šè´­ä¹°ä¸€å°å›½å¤–ä¸»æœºï¼Œæˆ‘æ˜¯åœ¨æ¬ç“¦å·¥ä¸Šä¹°çš„&lt;/p&gt;
&lt;h3 id=&quot;é¦–å…ˆä½¿ç”¨SSHç™»å½•&quot;&gt;&lt;a href=&quot;#é¦–å…ˆä½¿ç”¨SSHç™»å½•&quot; class=&quot;headerlink&quot; title=&quot;é¦–å…ˆä½¿ç”¨SSHç™»å½•&quot;&gt;&lt;/a&gt;é¦–å…ˆä½¿ç”¨SSHç™»å½•&lt;/h3&gt;&lt;p&gt;åœ¨CENTOS7ä¸Šæ­å»ºShadowsocksåœ¨CENTOS7ä¸Šæ­å»ºShadowsocks&lt;/p&gt;
&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh -p ç«¯å£å· username@ip&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä¾‹å¦‚ æˆ‘çš„ç«¯å£å·æ˜¯23456ï¼Œ usernameæ˜¯root ï¼Œipåœ°å€æ˜¯123.232.123.123&lt;/p&gt;
&lt;p&gt;â€œssh -p 23456 root@123.232.123.123â€&lt;/p&gt;
    
    </summary>
    
      <category term="å·¥å…·" scheme="http://www.wuqihan.cn/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="Shadowsocks" scheme="http://www.wuqihan.cn/tags/Shadowsocks/"/>
    
  </entry>
  
  <entry>
    <title>iOSå›¾å±‚æ€§èƒ½ä¼˜åŒ–</title>
    <link href="http://www.wuqihan.cn/2019/03/09/iOS%E5%9B%BE%E5%B1%82%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <id>http://www.wuqihan.cn/2019/03/09/iOSå›¾å±‚æ€§èƒ½ä¼˜åŒ–/</id>
    <published>2019-03-09T11:46:43.000Z</published>
    <updated>2019-11-09T13:21:14.858Z</updated>
    
    <content type="html"><![CDATA[<p>æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªå¾ˆå¹¿çš„è¯é¢˜ï¼Œæ€§èƒ½ä¼˜åŒ–åŒ…æ‹¬æ–¹æ–¹é¢é¢ï¼Œæ¯”å¦‚ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€å¤§æ–‡ä»¶çš„è¯»å–å’Œå†™å…¥ã€ç½‘ç»œç¼“å­˜ã€æµé‡çš„ä½¿ç”¨ã€åŠ¨ç”»æµç•…åº¦ã€ç¨‹åºçš„å¯åŠ¨æ—¶é—´ã€åº”ç”¨ç¨‹åºåŒ…çš„å¤§å°ç­‰ç­‰ã€‚</p><p>è¿™é‡Œåªä»‹ç»å…³äºå›¾å±‚æ–¹é¢çš„æ€§èƒ½ä¼˜åŒ–ã€‚</p><h2 id="äº†è§£Core-Animation"><a href="#äº†è§£Core-Animation" class="headerlink" title="äº†è§£Core Animation"></a>äº†è§£Core Animation</h2><p>è¯´èµ·å›¾å±‚ï¼Œä½ å¿…é¡»èƒ½æƒ³åˆ°çš„æ˜¯<code>Core Animation</code>ã€‚åœ¨iOSä¸Šï¼Œå‡ ä¹æ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯é€šè¿‡<code>Core Animation</code>ç»˜åˆ¶å‡ºæ¥çš„ã€‚Core Animation çš„æ ¸å¿ƒæ˜¯ OpenGL ES çš„ä¸€ä¸ªæŠ½è±¡ç‰©ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå®ƒè®©ä½ ç›´æ¥ä½¿ç”¨ OpenGL ES çš„åŠŸèƒ½ï¼Œå´ä¸éœ€è¦å¤„ç† OpenGL ES åšçš„å¤æ‚çš„äº‹æƒ…ã€‚</p><a id="more"></a><p>ä¸è¦è¢«<code>Core Animation</code>çš„åå­—æ‰€è¯¯è§£ï¼Œå¯¹äº<code>Core Animation</code>ï¼Œå®ƒå®é™…æ˜¯ä»<strong>Layer Kit</strong>æ¼”å˜è€Œæ¥çš„ã€‚æ‰€ä»¥åšåŠ¨ç”»ï¼Œä»…ä»…åªæ˜¯<code>Core Animation</code>çš„å†°å±±ä¸€è§’ã€‚</p><p><code>Core Animation</code>æ˜¯ä¸€ä¸ªå¤åˆå¼•æ“ï¼Œå®ƒçš„èŒè´£å°±æ˜¯å°½å¯èƒ½å¿«åœ°ç»„åˆå±å¹•ä¸Šä¸åŒçš„å¯è§†å†…å®¹ï¼Œè¿™ä¸ªå†…å®¹æ˜¯è¢«åˆ†è§£æˆç‹¬ç«‹çš„å›¾å±‚ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªå«åšå›¾å±‚æ ‘çš„ä½“ç³»ä¹‹ä¸­ã€‚<strong>äºæ˜¯è¿™ä¸ªæ ‘å½¢æˆäº†UIKitä»¥åŠåœ¨iOSåº”ç”¨ç¨‹åºå½“ä¸­ä½ æ‰€èƒ½åœ¨å±å¹•ä¸Šçœ‹è§çš„ä¸€åˆ‡çš„åŸºç¡€</strong>ã€‚</p><p>é¦–å…ˆçœ‹ä¸€ä¸‹<code>Core Animation</code>åœ¨cocoaä¸­çš„ä½ç½®çš„å…³ç³»:</p><p><img src="https://i.loli.net/2019/11/08/McRstapoSu2YA8K.png" alt="image-20191028112837723.png"></p><p>Core Animation é€šè¿‡ Core Graphics çš„ä¸€ç«¯å’Œ OpenGL ES çš„å¦ä¸€ç«¯ï¼Œç²¾å¿ƒç­–åˆ’åŸºäº CPU çš„ä½å›¾ç»˜åˆ¶ã€‚å› ä¸º Core Animation å¤„åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­çš„é‡è¦ä½ç½®ä¸Šï¼Œæ‰€ä»¥ä½ å¦‚ä½•ä½¿ç”¨ Core Animation å°†ä¼šå¯¹æ€§èƒ½äº§ç”Ÿæå¤§çš„å½±å“ã€‚</p><h3 id="CoreAnimationæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ"><a href="#CoreAnimationæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ" class="headerlink" title="CoreAnimationæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ"></a>CoreAnimationæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ</h3><ol><li>å¸ƒå±€</li><li>æ˜¾ç¤º</li><li>å‡†å¤‡</li><li>æäº¤</li><li>å¯¹æ‰€æœ‰çš„å›¾å±‚å±æ€§è®¡ç®—ä¸­é—´å€¼ï¼Œè®¾ç½®Open-GLå‡ ä½•å½¢çŠ¶ï¼ˆçº¹ç†è¯çš„ä¸‰è§’å½¢ï¼‰æ¥æ‰§è¡Œæ¸²æŸ“</li><li>åœ¨å±å¹•ä¸Šæ¸²æŸ“å¯è§ä¸‰è§’å½¢</li></ol><p>1-5æ˜¯ç”±CPUæ¥è´Ÿè´£çš„ï¼Œåªæœ‰ç¬¬6æ­¥æ˜¯ç”±GPUè´Ÿè´£ã€‚</p><p>é€šè¿‡ä¸‹é¢çš„ä¸¤å¼ å›¾ï¼Œå¯ä»¥æ›´å¥½ç†è§£ï¼š</p><p><img src="http://images.bestswifter.com/UIKitPerformance/pipeline.png" alt="æ˜¾ç¤ºæµç¨‹" style="zoom: 33%;"></p><p><img src="http://images.bestswifter.com/UIKitPerformance/commit.png" alt="è§£ç ä¸è½¬æ¢" style="zoom: 50%;"></p><h2 id="CPU-VS-GPU"><a href="#CPU-VS-GPU" class="headerlink" title="CPU VS GPU"></a>CPU VS GPU</h2><p>å…³äºå›¾å±‚ç»˜åˆ¶å’ŒåŠ¨ç”»æœ‰ä¸¤ç§å¤„ç†æ–¹å¼ï¼š<code>CPU</code>ï¼ˆä¸­å¤®å¤„ç†å™¨ï¼‰å’Œ<code>GPU</code>ï¼ˆå›¾å½¢å¤„ç†å™¨ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥è¯´<code>CPU</code>æ‰€åšçš„å·¥ä½œéƒ½æ˜¯åœ¨è½¯ä»¶å±‚é¢ï¼Œè€Œ<code>GPU</code>åšçš„å·¥ä½œæ˜¯ç¡¬ä»¶å±‚é¢ã€‚æˆ‘ä»¬å¯ä»¥ç”¨<code>CPU</code>åšä»»ä½•äº‹æƒ…ï¼Œä½†æ˜¯å¯¹äºå›¾åƒå¤„ç†(<code>CPU</code>ä¹Ÿå¯ä»¥åšï¼Œä½†æ˜¯æ•ˆç‡ä½)ï¼Œé€šå¸¸ç”¨ç¡¬ä»¶ä¼šæ›´å¿«ï¼Œå› ä¸º<code>GPU</code>ä½¿ç”¨å›¾åƒå¯¹é«˜åº¦å¹¶è¡Œæµ®ç‚¹è¿ç®—åšäº†ä¼˜åŒ–ã€‚</p><p><code>GPU</code> æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå›¾å½¢é«˜å¹¶å‘è®¡ç®—è€Œé‡èº«å®šåšçš„å¤„ç†å•å…ƒã€‚å®ƒå¹¶å‘çš„æœ¬æ€§è®©å®ƒèƒ½é«˜æ•ˆçš„å°†ä¸åŒçº¹ç†åˆæˆèµ·æ¥ã€‚å®ƒè¿æ¥åˆ° <code>CPU</code>ã€‚ä»ç¡¬ä»¶ä¸Šè®²ä¸¤è€…ä¹‹é—´å­˜åœ¨æŸç§ç±»å‹çš„æ€»çº¿ï¼Œå¹¶ä¸”æœ‰åƒ <code>OpenGL</code>ï¼Œ<code>Core Animation</code> å’Œ <code>Core Graphics</code> è¿™æ ·çš„æ¡†æ¶æ¥åœ¨ <code>GPU</code> å’Œ <code>CPU</code> ä¹‹é—´ç²¾å¿ƒå®‰æ’æ•°æ®çš„ä¼ è¾“ã€‚ä¸ºäº†å°†åƒç´ æ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œä¸€äº›å¤„ç†å°†åœ¨ <code>CPU</code> ä¸Šè¿›è¡Œã€‚ç„¶åæ•°æ®å°†ä¼šä¼ é€åˆ° <code>GPU</code>ï¼Œè¿™ä¹Ÿéœ€è¦åšä¸€äº›ç›¸åº”çš„æ“ä½œï¼Œæœ€ç»ˆåƒç´ æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚</p><p><strong>é’ˆå¯¹å›¾å±‚çš„æ€§èƒ½ä¼˜åŒ–ï¼Œè¯´ç™½äº†å°±æ˜¯å…³äºå¦‚ä½•æ™ºèƒ½åˆ©ç”¨GPUå’ŒCPUï¼Œä½¿ä»–ä»¬å‡è¡¡çš„è¢«ä½¿ç”¨ï¼Œä¸è¶…å‡ºè´Ÿè·ã€‚</strong></p><p>å¯ä»¥å¤§ä½“ç²—ç•¥çš„è¯´ï¼Œå›¾å±‚ç»˜åˆ¶åˆ°å±å¹•ä¹‹å‰æˆ–è€…åšåŠ¨ç”»ä¹‹å‰çš„å¤§å¤šæ•°å·¥ä½œéƒ½æ˜¯ç”±<code>CPU</code>å¤„ç†çš„ï¼Œè€Œ<code>GPU</code>æ˜¯ç”¨æ¥é‡‡é›†å›¾ç‰‡å’Œå½¢çŠ¶(ä¸‰è§’å½¢)ï¼Œè¿è¡Œå˜æ¢ï¼Œåº”ç”¨çº¹ç†å’Œæ··åˆç„¶åæŠŠå®ƒä»¬è¾“é€æ‰å±å¹•ä¸Šã€‚</p><h3 id="GPUçš„ç›¸å…³æ“ä½œ"><a href="#GPUçš„ç›¸å…³æ“ä½œ" class="headerlink" title="GPUçš„ç›¸å…³æ“ä½œ"></a>GPUçš„ç›¸å…³æ“ä½œ</h3><p>åŸºäºGPUçš„å“ªäº›å¸¸è§æ“ä½œä¼šé™ä½å›¾å±‚ç»˜åˆ¶ï¼š</p><ul><li>å¤ªå¤šçš„å‡ ä½•ç»“æ„</li><li>é‡ç»˜ï¼ˆåˆæˆcompositingï¼‰ï¼šä¸»è¦ç”±é‡å åŠé€æ˜å›¾å±‚å¼•èµ·</li><li>ç¦»å±æ¸²æŸ“ ï¼ˆOff-Screen Renderingï¼‰ï¼šç¦»å±æ¸²æŸ“æŒ‡çš„æ˜¯GPUåœ¨å½“å‰å±å¹•ç¼“å†²åŒºä»¥å¤–å¼€è¾Ÿä¸€ä¸ªæ–°çš„ç¼“å†²åŒºè¿›è¡Œæ¸²æŸ“ã€‚åŒ…æ‹¬è®¾ç½®å›¾å±‚çš„åœ†è§’ã€å›¾å±‚é®ç½©(mask)ã€é˜´å½±ã€å…‰æ …åŒ–(shouldRasterize )ç­‰éƒ½ä¼šé€ æˆç¦»å±æ¸²æŸ“ã€‚å¦å¤–è¡¥å……åœ¨å±æ¸²æŸ“çš„æ¦‚å¿µï¼šæŒ‡çš„æ˜¯GPUçš„æ¸²æŸ“æ“ä½œåœ¨å½“å‰ç”¨äºæ˜¾ç¤ºçš„å±å¹•ç¼“å†²åŒºè¿›è¡Œã€‚</li><li>è¿‡å¤§çš„å›¾ç‰‡ï¼šå¦‚æœè§†å›¾ç»˜åˆ¶è¶…å‡ºGPUæ”¯æŒçš„å°ºå¯¸çš„çº¹ç†ï¼Œå°±å¿…é¡»è¦ç”¨CPUåœ¨å›¾å±‚æ¯æ¬¡æ˜¾ç¤ºä¹‹å‰å¯¹å›¾ç‰‡é¢„å¤„ç†ï¼ŒåŒæ ·ä¹Ÿä¼šé™ä½æ€§èƒ½ã€‚ç›®å‰çš„è‹¹æœè®¾å¤‡æœ€å¤§æ”¯æŒ4096x4096å°ºå¯¸çš„çº¹ç†ã€‚å¦‚æœå›¾ç‰‡çš„å¤§å°è¶…è¿‡4096x4096æ˜¯æ— æ³•æ˜¾ç¤ºçš„ã€‚å¿…é¡»è¦ç”¨CPUå¯¹å›¾ç‰‡è¿›è¡Œé¢„å¤„ç†ã€‚</li><li>ç­‰ç­‰</li></ul><h3 id="CPUçš„ç›¸å…³æ“ä½œ"><a href="#CPUçš„ç›¸å…³æ“ä½œ" class="headerlink" title="CPUçš„ç›¸å…³æ“ä½œ"></a>CPUçš„ç›¸å…³æ“ä½œ</h3><p>ä¸Šæ–‡å·²ç»æåˆ°ï¼Œå¤§å¤šæ•°å·¥ä½œåœ¨Core Animationçš„CPUéƒ½å‘ç”Ÿåœ¨åŠ¨ç”»å¼€å§‹ä¹‹å‰ã€‚è¿™æ„å‘³ç€å®ƒä¸ä¼šå½±å“åˆ°å¸§ç‡ï¼Œä½†æ˜¯ä»–ä¼šå»¶è¿ŸåŠ¨ç”»å¼€å§‹çš„æ—¶é—´ï¼Œè®©ä½ çš„ç•Œé¢çœ‹èµ·æ¥ä¼šæ¯”è¾ƒè¿Ÿé’ã€‚</p><p>åŸºäºCPUçš„å“ªäº›å¸¸è§æ“ä½œä¼šå»¶è¿Ÿå›¾å±‚ç»˜åˆ¶çš„å¼€å§‹æ—¶é—´ï¼š</p><ul><li>å¸ƒå±€è®¡ç®—ï¼šå› ä¸ºéœ€è¦å¤§é‡çš„è®¡ç®—ï¼Œè‡ªåŠ¨å¸ƒå±€æœºåˆ¶åœ¨ä½ç‰ˆæœ¬çš„iOSç³»ç»Ÿä¸‹å°¤ä¸ºæ˜æ˜¾ã€‚</li><li>è§†å›¾æ‡’åŠ è½½ï¼šè§†å›¾æ‡’åŠ è½½å¯¹å†…å­˜çš„ä½¿ç”¨æ˜¯å¾ˆå‹å¥½çš„ï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰ä¸å¥½çš„æ–¹é¢ï¼Œæ¯”å¦‚ä½ åœ¨è§†å›¾æ§åˆ¶å™¨çš„ViewDidLoadä¸­å†™å…¥äº†å¤§é‡è€—æ—¶çš„æ“ä½œï¼Œé‚£ç­‰è¯¥è§†å›¾æ§åˆ¶å™¨çš„viewè¢«ä½¿ç”¨æ—¶ï¼Œå°±ä¼šæ¶ˆè€—ä¸€å®šçš„æ—¶é—´ã€‚</li><li>Core Graphicsç»˜åˆ¶ï¼šå¦‚æœå¯¹è§†å›¾å®ç°äº†<code>-drawRect:</code>æ–¹æ³•æˆ–<code>CALayerDelegate</code>çš„<code>-drawLayer:inContext:</code>æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨ç»˜åˆ¶ä»»ä½•ä¸œè¥¿ä¹‹å‰éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªå·¨å¤§çš„æ€§èƒ½å¼€é”€ã€‚ä¸ºäº†æ”¯æŒå¯¹å›¾å±‚å†…å®¹çš„ä»»æ„ç»˜åˆ¶ï¼Œ<code>Core Animation</code>å¿…é¡»åˆ›å»ºä¸€ä¸ªå†…å­˜ä¸­ç­‰å¤§å°çš„å¯„å®¿å›¾ç‰‡ã€‚ç„¶åä¸€æ—¦ç»˜åˆ¶ç»“æŸä¹‹åï¼Œå¿…é¡»æŠŠå›¾ç‰‡æ•°æ®é€šè¿‡IPCä¼ åˆ°æ¸²æŸ“æœåŠ¡å™¨ã€‚æ‰€ä»¥è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šåœ°æ–¹éƒ½ä¼šæåˆ°ï¼Œå°½é‡é¿å…é‡å†™<code>-drawRect:</code>æ–¹æ³•çš„åŸå› ã€‚</li><li>è§£å‹å›¾ç‰‡ï¼šä¸ºäº†èŠ‚çœå†…å­˜ï¼ŒiOSé€šå¸¸ç›´åˆ°çœŸæ­£ç»˜åˆ¶çš„æ—¶å€™æ‰ä¼šå»è§£ç å›¾ç‰‡ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡åŠ è½½å›¾ç‰‡æ—¶éƒ½è¦è§£å‹ï¼Œé‚£å¯¹äºè¿‡å¤§çš„å›¾ç‰‡ï¼Œéƒ½ä¼šå ç”¨ä¸€å®šçš„æ—¶é—´ã€‚</li><li>ç­‰ç­‰</li></ul><h2 id="å±å¹•å›¾åƒæ˜¾ç¤ºåŸç†"><a href="#å±å¹•å›¾åƒæ˜¾ç¤ºåŸç†" class="headerlink" title="å±å¹•å›¾åƒæ˜¾ç¤ºåŸç†"></a>å±å¹•å›¾åƒæ˜¾ç¤ºåŸç†</h2><p>è¿™ç¯‡æ–‡ç« ï¼š <a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/" target="_blank" rel="noopener">iOSä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</a> éå¸¸è¯¦ç»†å¾—ä»‹ç»äº†å±å¹•å›¾åƒæ˜¾ç¤ºåŸç†ï¼Œå…·ä½“å†…å®¹å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘è¿™é‡Œç”¨ä¸€å¼ å›¾æ€»ç»“ä¸€ä¸‹ã€‚</p><p><img src="https://i.loli.net/2019/11/08/1qIsENRlAJeVgP6.png" alt="å±å¹•å›¾åƒæ˜¾ç¤ºåŸç†.png" style="zoom: 67%;"></p><h2 id="Instrumentså·¥å…·ä½¿ç”¨"><a href="#Instrumentså·¥å…·ä½¿ç”¨" class="headerlink" title="Instrumentså·¥å…·ä½¿ç”¨"></a>Instrumentså·¥å…·ä½¿ç”¨</h2><blockquote><p> ç”±äºè‹¹æœAç³»åˆ—èŠ¯ç‰‡å¤ªè¿‡äºå¼ºå¤§ï¼Œæ‰€ä»¥å»ºè®®åœ¨æµ‹è¯•æ€§èƒ½çš„æ—¶å€™å»ºè®®è‡³å°‘ä½¿ç”¨iPhone6ä»¥å‰çš„æ‰‹æœºã€‚æˆ‘ä½¿ç”¨çš„æ˜¯iPhone5s</p><p> æ³¨æ„ï¼šæœ¬æ–‡ä¸­æåˆ°çš„ä¸€äº›éœ€è¦æ€§èƒ½ä¼˜åŒ–çš„åœ°æ–¹ï¼Œä¸æ˜¯è¯´è¿™æ ·åšæ˜¯é”™è¯¯çš„ï¼Œä»…ä»…æ˜¯å› ä¸ºå¦‚æœå¤§é‡çš„åšäº†æŸä¸€ä¸ªæ“ä½œï¼Œè¿™ä¸ªæ“ä½œä¼šå ç”¨CPUæˆ–è€…GPUï¼Œè¿™äº›æ“ä½œå †ç§¯åœ¨ä¸€èµ·ï¼Œå¯èƒ½åœ¨è€æœºå‹çš„æ‰‹æœºä¸Šï¼Œé€ æˆGPUæˆ–è€…CPUå•æ–¹é¢çš„è´Ÿè·ï¼Œå¯¼è‡´å¡é¡¿ç­‰é—®é¢˜ã€‚</p></blockquote><h3 id="CoreAnimation"><a href="#CoreAnimation" class="headerlink" title="CoreAnimation"></a>CoreAnimation</h3><p><img src="https://i.loli.net/2019/11/09/jrOS1RuPX9a27My.png" alt="CoreAnimation.png" style="zoom: 67%;"></p><p>ä½¿ç”¨CoreAnimationè°ƒè¯•ï¼Œç›®çš„æ˜¯<strong>ä¸ºäº†æ‰¾åˆ°ç¨‹åºå½“å‰å¡é¡¿çš„åŸå› æ˜¯CPUè¶…è´Ÿè·è¿˜æ˜¯GPUè¶…è´Ÿè·é€ æˆçš„</strong>ã€‚</p><p>è¿™é‡Œæˆ‘æä¾›äº†ä¸€ä¸ª<a href="https://github.com/wqhiOS/TableViewPerformanceOptimizationDemo" target="_blank" rel="noopener">demo</a>ç”¨æ¥æµ‹è¯•ã€‚æœ‰ä¸¤ä¸ªåˆ—è¡¨é¡µé¢ï¼Œä¸€ä¸ªæ˜¯æœªä¼˜åŒ–çš„ä¸€ä¸ªæ˜¯å·²ä¼˜åŒ–çš„ï¼Œå…ˆä½¿ç”¨Instruments Core Animationå¯¹æœªä¼˜åŒ–çš„åˆ—è¡¨è¿›è¡Œè°ƒè¯•ï¼Œçœ‹çœ‹é—®é¢˜ç©¶ç«Ÿå‡ºåœ¨CPUè¿˜æ˜¯GPUã€‚è¿›å…¥æœªä¼˜åŒ–çš„é¡µé¢å¦‚ä¸‹å›¾ï¼Œæ¥å›æ»‘åŠ¨åˆ—è¡¨ï¼Œè‚‰çœ¼å¯è§çš„å¡é¡¿ã€‚</p><p><img src="https://i.loli.net/2019/11/09/gt2OA13TQyLGMwC.jpg" alt="tableView.jpg" style="zoom:50%;"></p><p>é‚£å¡é¡¿åŸå› åˆ°åº•å‡ºåœ¨å“ªé‡Œï¼Œæ˜¯CPUè´Ÿè·è¿˜æ˜¯GPUå‘¢ï¼Ÿ</p><p><img src="https://i.loli.net/2019/11/09/qHRZDhWKiCxdQnT.png" alt="core_animation_1-2.png"></p><p>å›¾ä¸­çº¢è‰²æ¡†å…¨å‡ºçš„æ—¶é—´ï¼Œè¿™æ—¶å€™æˆ‘åœ¨æœªä¼˜åŒ–çš„åˆ—è¡¨é¡µé¢å§‹ç»ˆä¸åœæ»‘åŠ¨åˆ—è¡¨ã€‚ä»å›¾ä¸­ç›‘æ§çš„æ•°æ®å¯ä»¥çœ‹å‡ºï¼ŒFPSä»æœªè¶…è¿‡15ï¼Œæå…¶å¡é¡¿ï¼ŒGPUä½¿ç”¨ç‡å‡ ä¹è¾¾åˆ° ç™¾åˆ†ä¹‹ç™¾ã€‚CPUè¡¨ç°æ­£å¸¸ã€‚</p><p>æ‰€ä»¥å¯ä»¥å¾—å‡ºç»“è®ºã€‚æˆ‘ä»¬éœ€è¦å¯¹GPUæ‰€åšçš„æ“ä½œè¿›è¡Œä¼˜åŒ–ï¼Œå°½é‡æŠŠGPUæ‰€åšçš„ä¸€éƒ¨åˆ†å·¥ä½œåˆ†ç»™CPUã€‚å…·ä½“æ€ä¹ˆåšï¼Œä¸Šé¢å·²ç»ä»‹ç»è¿‡äº†ã€‚è¯¦ç»†å¯ä»¥æŸ¥çœ‹æˆ‘çš„è¿™ä¸ª<a href="https://github.com/wqhiOS/TableViewPerformanceOptimizationDemo" target="_blank" rel="noopener">demo</a>ã€‚</p><p>æˆ‘ä»¬åœ¨è¿›å…¥å¦ä¸€ä¸ªå±•ç¤ºåŒæ ·åˆ—è¡¨ï¼Œä¸”å·²ç»æ€§èƒ½ä¼˜åŒ–çš„é¡µé¢ã€‚æ¥å›æ»‘åŠ¨åˆ—è¡¨ï¼Œä½ ä¼šå‘ç°éå¸¸æµç•…ã€‚é‚£æˆ‘ä»¬åœ¨ä½¿ç”¨CoreAnimationå·¥å…·æµ‹è¯•ä¸€ä¸‹ï¼Œç»“æœå¦‚ä¸‹å›¾(éå¸¸ç¨³å®šï¼Œæœ€ä½59FPSï¼ŒGPUä½¿ç”¨ç‡ç»´æŒåœ¨30%å·¦å³ï¼ŒCPUè¡¨ç°æ­£å¸¸)ï¼š</p><p><img src="https://i.loli.net/2019/11/09/DSAiCo4HBz2kaq3.png" alt="core_animation_2.png"></p><h3 id="View-Debugging-Rendering"><a href="#View-Debugging-Rendering" class="headerlink" title="View Debugging Rendering"></a>View Debugging Rendering</h3><p>å°†é¡¹ç›®å¯åŠ¨è¿è¡Œåœ¨çœŸæœºä¸Šã€‚æ–°ç‰ˆXcodeå…¥å£åœ¨ï¼š<code>[Debug] -&gt; [View Debugging] -&gt; [Rendering] &gt;</code></p><h4 id="Color-Blended-Layers"><a href="#Color-Blended-Layers" class="headerlink" title="Color Blended Layers"></a>Color Blended Layers</h4><p>å› ä¸ºä¸Šæ–‡æåˆ°äº†ï¼Œå›¾å±‚æ··åˆæ˜¯GPUçš„å·¥ä½œï¼Œæ‰€ä»¥è¯¥ä¼˜åŒ–æ˜¯é’ˆå¯¹GPUè¶…è´Ÿè·çš„æƒ…å†µã€‚å¦‚æœä½ ç”¨Instruments-CoreAnimationè°ƒè¯•ï¼Œå‘ç°GPUä½¿ç”¨ç‡å¾ˆä½ï¼Œå‡ ä¹å°±å¯ä»¥æ”¾å¼ƒè¿™é¡¹æ£€æµ‹ã€‚</p><p>è¯¥é€‰é¡¹ç”¨äºæ£€æµ‹å“ªé‡Œå‘ç”Ÿäº†å›¾å±‚æ··åˆï¼Œå¹¶ç”¨çº¢è‰²æ ‡è®°å‡ºæ¥ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å°½å¯èƒ½å‡å°‘çœ‹åˆ°çš„çº¢è‰²åŒºåŸŸã€‚</p><p>å¦‚æœå‘ç°äº†æœ‰å¤§é‡çš„çº¢è‰²ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p><ul><li>å…³äºCALayerçš„opaque(ä¸é€æ˜)å±æ€§ï¼šè¯¥å±æ€§å¯ä»¥å‘Šè¯‰GPUæ˜¯å¦å»åšåˆæˆï¼ŒYESä»£è¡¨æ˜¯ä¸é€æ˜ï¼ŒGPUä¸ä¼šå»åšåˆæˆï¼Œä½†æ˜¯å¯¹äºæ™®é€šçš„å¼€å‘è€…æ¥è¯´ï¼Œè¿™ä¸ªå±æ€§ç”¨å¤„ä¸å¤§ï¼Œå› ä¸ºåŸºäºUIViewçš„CALayerï¼Œå®ƒé»˜è®¤çš„opaqueå±æ€§å°±æ˜¯YESï¼Œè¡¨ç¤ºä¸é€æ˜ã€‚ï¼ˆè™½ç„¶å¾ˆå¤šæ–‡ç« æœ‰æåˆ°è¿™ä¸ªå±æ€§ï¼Œä½†æ˜¯å…¶å®æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼‰</li><li>é’ˆå¯¹é¡¹ç›®ä¸­ç”¨åˆ°çš„å›¾ç‰‡ç´ æï¼Œä¸ä»…å®ƒæœ¬èº«è¦æ˜¯ä¸é€æ˜çš„ï¼Œå¹¶ä¸”å›¾ç‰‡ä¹Ÿä¸è¦åŒ…å«alphaé€šè¾¾(å› ä¸ºæœ‰ä¸€äº›å›¾ç‰‡ï¼Œä½ çœ‹ç€å®ƒæ˜¯ä¸é€æ˜çš„ï¼Œä½†æ˜¯å®ƒåŒ…å«æœ‰alphaé€šè¾¾ï¼Œä»ç„¶åå‘ç”Ÿå›¾å±‚æ··åˆï¼Œå½±å“åº”èƒ½ï¼‰</li><li>å…³äºUILabelä¸­å«æœ‰ä¸­æ–‡å­—ä½“æ—¶ï¼Œå³ä½¿UILabelè®¾ç½®äº†ä¸é€æ˜çš„èƒŒæ™¯é¢œè‰²ï¼Œå¯æ˜¯è¿˜æ˜¯ä¼šè¢«æ ‡è®°ä¸ºçº¢è‰²ï¼ˆå› ä¸ºè‹¹æœå¯¹æ˜¾ç¤ºä¸­æ–‡åšäº†ä¸çŸ¥é“æ˜¯å¥½çš„è¿˜æ˜¯åçš„ä¼˜åŒ–ï¼Œæ˜¾ç¤ºä¸­æ–‡æ˜¯ï¼ŒUILabelä¼šå¤šå‡ºä¸€ä¸ªlayerï¼‰ï¼Œé’ˆå¯¹è¿™ä¸ªçš„è§£å†³åŠæ³•æ˜¯ï¼š<strong>label.layer.masksToBounds = true;</strong> (æˆ‘è§‰çš„è¿™ä¸ªå½±å“å¾®ä¹å…¶å¾®ï¼Œå¯ä»¥å¿½ç•¥æ²¡æœ‰å¿…è¦å¤„ç†)</li></ul><h4 id="Color-Offscreen-Rendered-Yellow"><a href="#Color-Offscreen-Rendered-Yellow" class="headerlink" title="Color Offscreen-Rendered Yellow"></a>Color Offscreen-Rendered Yellow</h4><p>å“ªäº›å¸¸è§æ“ä½œä¼šé€ æˆç¦»å±æ¸²æŸ“</p><ul><li><p>é˜´å½± </p><ul><li><p>å¦‚ä½•ä¼˜åŒ–ï¼Ÿ</p><ul><li>ä½¿ç”¨shadowPath ã€‚å› ä¸ºå¦‚æœæ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šï¼ŒCore Animationä¼šå»è‡ªåŠ¨è®¡ç®—ï¼Œè¿™å°±ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Œæ‰€ä»¥å¯ä»¥æ‰‹åŠ¨æŒ‡å®šé˜´å½±è·¯å¾„</li><li>å¦‚æœæƒ³ç»™æ–‡å­—æ·»åŠ é˜´å½±ï¼Œæœ€å¥½ä½¿ç”¨å¯Œæ–‡æœ¬ï¼ŒNSShadow</li></ul></li></ul></li></ul><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">layer.shadowPath = <span class="hljs-type">UIBezierPath</span>(rect: cell._imageView2.bounds).cgPath</span><br></pre></td></tr></table></figure><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> shadow = <span class="hljs-type">NSShadow</span>()</span><br><span class="line">shadow.shadowOffset = <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">0</span>, height: <span class="hljs-number">2</span>)</span><br><span class="line">shadow.shadowBlurRadius = <span class="hljs-number">5</span></span><br><span class="line">shadow.shadowColor = <span class="hljs-type">UIColor</span>(white: <span class="hljs-number">0</span>, alpha: <span class="hljs-number">0.5</span>)</span><br><span class="line"><span class="hljs-keyword">let</span> attText = <span class="hljs-type">NSAttributedString</span>(string: text, attributes: [<span class="hljs-type">NSAttributedString</span>.<span class="hljs-type">Key</span>.shadow: shadow])</span><br></pre></td></tr></table></figure><ul><li><p>åœ†è§’</p><ul><li>è®¾ç½®<code>cornerRadius</code>æœ¬èº«å¹¶ä¸ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“ï¼Œä½†å¾ˆå¤šæ—¶å€™å®ƒè¿˜éœ€è¦é…åˆ<code>layer.masksToBounds = true</code>ä½¿ç”¨ã€‚æ ¹æ®ä¹‹å‰çš„æ€»ç»“ï¼Œè®¾ç½®<code>masksToBounds</code>ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“</li><li><p>å¦‚ä½•ä¼˜åŒ–ï¼š</p><ul><li>å…‰æ …åŒ– ï¼Œç­‰äºåŠ äº†ç¼“å­˜(å¼€å¯å…‰æ …åŒ–ç­‰äºå¼€å¯ç¦»å±æ¸²æŸ“ï¼ŒåŒåˆƒå‰‘ã€å¯ä»¥è§£å†³ï¼Œä½†æ˜¯å¹¶ä¸å®Œç¾)</li><li><p>åˆ›å»ºä¸€ä¸ªåœ†å½¢CAShapeLayerï¼Œç„¶åè®¾ç½®ä¸ºmask(å®Œå…¨ä¸æ¨èã€è‡ªå·±å°è¯•åè§‰å¾—æ²¡æœ‰æ•ˆæœï¼Œmaskä¹Ÿæ˜¯ç¦»å±æ¸²æŸ“)</p></li><li><p>ä½¿ç”¨UIGraphicsæŠŠå½“å‰imageç”»æˆåœ†å½¢ç”Ÿæˆæ–°çš„UIImageï¼Œé‡æ–°èµ‹å€¼ç»™UIImageViewï¼ˆåŸç†ï¼šGPUåšçš„äº‹æƒ…ï¼Œè½¬ç»™äº†CPUæ¥åšã€‚ï¼‰</p></li></ul></li></ul></li></ul><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">UIImageView</span> </span>&#123;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">cornerRadiusOptimized</span><span class="hljs-params">(radius: CGFloat)</span></span> &#123;</span><br><span class="line">        <span class="hljs-keyword">self</span>.image = <span class="hljs-keyword">self</span>.image?.drawRectWithRoundedCorner(radius: radius, <span class="hljs-keyword">self</span>.bounds.size)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">UIImage</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">fileprivate</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">drawRectWithRoundedCorner</span><span class="hljs-params">(radius: CGFloat, <span class="hljs-number">_</span> sizetoFit: CGSize)</span></span> -&gt; <span class="hljs-type">UIImage</span>? &#123;</span><br><span class="line">        <span class="hljs-keyword">let</span> rect = <span class="hljs-type">CGRect</span>(origin: <span class="hljs-type">CGPoint</span>(x: <span class="hljs-number">0</span>, y: <span class="hljs-number">0</span>), size: sizetoFit)</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-type">UIGraphicsBeginImageContextWithOptions</span>(rect.size, <span class="hljs-literal">false</span>, <span class="hljs-type">UIScreen</span>.main.scale)</span><br><span class="line">        <span class="hljs-keyword">let</span> context = <span class="hljs-type">UIGraphicsGetCurrentContext</span>()</span><br><span class="line">        context?.addPath(<span class="hljs-type">UIBezierPath</span>(roundedRect: rect, byRoundingCorners: <span class="hljs-type">UIRectCorner</span>.allCorners, cornerRadii: <span class="hljs-type">CGSize</span>(width: radius, height: radius)).cgPath)</span><br><span class="line">        context?.clip()</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-keyword">self</span>.draw(<span class="hljs-keyword">in</span>: rect)</span><br><span class="line">        context?.drawPath(using: .fillStroke)</span><br><span class="line">        <span class="hljs-keyword">let</span> output = <span class="hljs-type">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">        <span class="hljs-type">UIGraphicsEndImageContext</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-keyword">return</span> output</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Color-Hits-Green-and-Misses-Red"><a href="#Color-Hits-Green-and-Misses-Red" class="headerlink" title="Color Hits Green and Misses Red"></a>Color Hits Green and Misses Red</h4><p>è¯¥é€‰é¡¹ç”¨äºæ£€æµ‹å›¾åƒç¼“å­˜æ˜¯å¦å‘½ä¸­ï¼Œè¡¨ç¤ºå¦‚æœå‘½ä¸­ç¼“å­˜åˆ™æ˜¾ç¤ºä¸ºç»¿è‰²ï¼Œå¦åˆ™æ˜¾ç¤ºä¸ºçº¢è‰²ï¼Œæ˜¾ç„¶ç»¿è‰²è¶Šå¤šè¶Šå¥½ï¼Œçº¢è‰²è¶Šå°‘è¶Šå¥½ã€‚</p><p>è¿™é‡Œè¦æåˆ°ä¸€ä¸ªæ¦‚å¿µï¼š<code>å…‰æ …åŒ–</code></p><p><code>å…‰æ …åŒ–</code>æ˜¯å°†ä¸€ä¸ªlayeré¢„å…ˆæ¸²æŸ“æˆä½å›¾(bitmap)ï¼Œç„¶ååŠ å…¥ç¼“å­˜ä¸­ã€‚å¦‚æœå¯¹äºé˜´å½±æ•ˆæœè¿™æ ·æ¯”è¾ƒæ¶ˆè€—èµ„æºçš„é™æ€å†…å®¹è¿›è¡Œç¼“å­˜ï¼Œå¯ä»¥å¾—åˆ°ä¸€å®šå¹…åº¦çš„æ€§èƒ½æå‡</p><p>CALayerçš„å±æ€§shouldRasterizeè¡¨ç¤ºæ˜¯å¦è®¾ç½®å…‰æ …åŒ– yesä»£è¡¨æ˜¯</p><p>è™½ç„¶ã€ŠiOSæ ¸å¿ƒåŠ¨ç”»é«˜çº§æŠ€å·§ã€‹æ€§èƒ½è°ƒä¼˜ä¸€èŠ‚ä¸­æœ‰å…‰æ …åŒ–åšäº†æ€§èƒ½ä¼˜åŒ–ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™æ ·çš„å¤„ç†è¿˜æ˜¯æŒ‡æ ‡ä¸æ²»æœ¬ã€‚å› ä¸ºç°åœ¨çš„é—®é¢˜æ˜¯GPUä½¿ç”¨ç‡è¿‡é«˜ï¼Œæ›´å¥½çš„åŠæ³•æ˜¯æŠŠè¯¥éƒ¨åˆ†å·¥ä½œè½¬ç§»ä¸ªCPUæ‰§è¡Œã€‚ä½†æ˜¯å…‰æ …åŒ–å…¶å®ä»…ä»…æ˜¯åŠ äº†ä¸€ä¸ªç¼“å­˜ï¼Œç¼“å­˜æœŸé™ä¹Ÿä»…ä»…åªæœ‰100msï¼Œå³0.1sä¹‹åç¼“å­˜å°±æ²¡æœ‰äº†ï¼Œæ‰€ä»¥ä»…ä»…æ˜¯å¯¹äºå¿«é€Ÿæ»‘åŠ¨åˆ—è¡¨æ—¶ä¼šæœ‰ä¸€ç‚¹ä½œç”¨ã€‚</p><p><strong>å…‰æ …åŒ–åŒæ ·ä¼šé€ æˆç¦»å±æ¸²æŸ“</strong>ã€‚å½“æŠŠå…‰æ …åŒ–æ‰“å¼€çš„æ—¶å€™ï¼Œä¹Ÿå°±ä»£è¡¨ä½ æ‰‹åŠ¨å¼€å¯äº†ç¦»å±æ¸²æŸ“ã€‚</p><h4 id="Color-Misaligned-Images"><a href="#Color-Misaligned-Images" class="headerlink" title="Color Misaligned Images"></a>Color Misaligned Images</h4><p>è¯¥é€‰é¡¹ä½œç”¨ä¸å¤§ï¼Œå…¶å®å°±æ˜¯æ‰¾å‡ºå“ªäº›å›¾ç‰‡è¿›è¡Œäº†ç¼©æ”¾ï¼Œå› ä¸ºç¼©æ”¾ä¹Ÿæ˜¯éœ€è¦æ—¶é—´çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œå°½é‡ä¿è¯å›¾ç‰‡ç´ æçš„çš„å¤§å°ä¸è§†å›¾çš„frameä¿æŒä¸€è‡´ã€‚ï¼ˆè¿™æ¡åŸºæœ¬å¯ä»¥å¿½ç•¥ï¼Œé™¤éä½ è§†å›¾å¤§å°æ˜¯40x40ï¼Œç»“æœä½ ç”¨äº†ä¸€å¼ 400x400ï¼Œè¿™ç§æƒ…å†µè‚¯å®šæ˜¯è¦é¿å…ã€‚åŸºæœ¬ä¸ä¼šæœ‰äººè¿™æ ·æå§ã€‚ã€‚ï¼‰</p><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a href="https://github.com/qunten/iOS-Core-Animation-Advanced-Techniques" target="_blank" rel="noopener">ã€ŠiOS Core Animation Advanced Techniquesã€‹</a></p><p><a href="https://github.com/100mango/zen/blob/master/WWDCå¿ƒå¾—ï¼šAdvanced%20Graphics%20and%20Animations%20for%20iOS%20Apps/Advanced%20Graphics%20and%20Animations%20for%20iOS%20Apps.md" target="_blank" rel="noopener">WWDCå¿ƒå¾—ï¼šAdvanced Graphics and Animations for iOS Apps</a></p><p><a href="https://objccn.io/issue-3-1/" target="_blank" rel="noopener">ç»˜åˆ¶åƒç´ åˆ°å±å¹•ä¸Š</a></p><p><a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/" target="_blank" rel="noopener">iOSä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</a></p><p><a href="https://bestswifter.com/uikitxing-neng-diao-you-shi-zhan-jiang-jie/" target="_blank" rel="noopener">UIKitæ€§èƒ½è°ƒä¼˜å®æˆ˜è®²è§£</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªå¾ˆå¹¿çš„è¯é¢˜ï¼Œæ€§èƒ½ä¼˜åŒ–åŒ…æ‹¬æ–¹æ–¹é¢é¢ï¼Œæ¯”å¦‚ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€å¤§æ–‡ä»¶çš„è¯»å–å’Œå†™å…¥ã€ç½‘ç»œç¼“å­˜ã€æµé‡çš„ä½¿ç”¨ã€åŠ¨ç”»æµç•…åº¦ã€ç¨‹åºçš„å¯åŠ¨æ—¶é—´ã€åº”ç”¨ç¨‹åºåŒ…çš„å¤§å°ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œåªä»‹ç»å…³äºå›¾å±‚æ–¹é¢çš„æ€§èƒ½ä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;h2 id=&quot;äº†è§£Core-Animation&quot;&gt;&lt;a href=&quot;#äº†è§£Core-Animation&quot; class=&quot;headerlink&quot; title=&quot;äº†è§£Core Animation&quot;&gt;&lt;/a&gt;äº†è§£Core Animation&lt;/h2&gt;&lt;p&gt;è¯´èµ·å›¾å±‚ï¼Œä½ å¿…é¡»èƒ½æƒ³åˆ°çš„æ˜¯&lt;code&gt;Core Animation&lt;/code&gt;ã€‚åœ¨iOSä¸Šï¼Œå‡ ä¹æ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯é€šè¿‡&lt;code&gt;Core Animation&lt;/code&gt;ç»˜åˆ¶å‡ºæ¥çš„ã€‚Core Animation çš„æ ¸å¿ƒæ˜¯ OpenGL ES çš„ä¸€ä¸ªæŠ½è±¡ç‰©ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå®ƒè®©ä½ ç›´æ¥ä½¿ç”¨ OpenGL ES çš„åŠŸèƒ½ï¼Œå´ä¸éœ€è¦å¤„ç† OpenGL ES åšçš„å¤æ‚çš„äº‹æƒ…ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
      <category term="æ€§èƒ½ä¼˜åŒ–" scheme="http://www.wuqihan.cn/categories/iOS/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
    
      <category term="æ€§èƒ½ä¼˜åŒ–" scheme="http://www.wuqihan.cn/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£RunLoop</title>
    <link href="http://www.wuqihan.cn/2019/01/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3RunLoop/"/>
    <id>http://www.wuqihan.cn/2019/01/28/æ·±å…¥ç†è§£RunLoop/</id>
    <published>2019-01-28T10:00:17.000Z</published>
    <updated>2020-01-28T10:06:00.555Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¦‚ä½•ç†è§£RunLoop"><a href="#å¦‚ä½•ç†è§£RunLoop" class="headerlink" title="å¦‚ä½•ç†è§£RunLoop"></a>å¦‚ä½•ç†è§£RunLoop</h2><blockquote><p>Run loops are part of the fundamental infrastructure associated with threads. A <em>run loop</em> is an event processing loop that you use to schedule work and coordinate the receipt of incoming events. The purpose of a run loop is to keep your thread busy when there is work to do and put your thread to sleep when there is none. </p><p>Run loop management is not entirely automatic. You must still design your threadâ€™s code to start the run loop at appropriate times and respond to incoming events. Both Cocoa and Core Foundation provide <em>run loop objects</em> to help you configure and manage your threadâ€™s run loop. Your application does not need to create these objects explicitly; each thread, including the applicationâ€™s main thread, has an associated run loop object. Only secondary threads need to run their run loop explicitly, however. The app frameworks automatically set up and run the run loop on the main thread as part of the application startup process.</p><p>- ä»¥ä¸Šæ‘˜è‡ªè‹¹æœå®˜æ–¹æ–‡æ¡£ã€‚</p></blockquote><a id="more"></a> <p>å…·ä½“çš„å…³äºRunLoopçš„æ·±å…¥äº†è§£å¯ä»¥æŸ¥çœ‹è¿™ä¸¤ç¯‡å¾ˆå¥½çš„èµ„æ–™ï¼Œä¸€ç¯‡æ˜¯YYKitä½œè€…å†™çš„ï¼Œå¦ä¸€ç¯‡æ˜¯è‹¹æœå®˜æ–¹æ–‡æ¡£ï¼š</p><p><a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">æ·±å…¥ç†è§£RunLoop</a></p><p><a href="https://www.cnblogs.com/kenshincui/p/6823841.html" target="_blank" rel="noopener">https://www.cnblogs.com/kenshincui/p/6823841.html</a> è¿™ç¯‡æ–‡ç« ä¹Ÿå¾ˆå¥½</p><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW1" target="_blank" rel="noopener">Apple Threading Programming Guide - Run Loops</a></p><p>YYKitä½œè€…çš„è¿™ç¯‡æ–‡ç« ä¸­å‚è€ƒçš„CFæºç è™½ç„¶å·²ç»æœ‰ç‚¹è¿‡æ—¶äº†ï¼Œä½†æ˜¯æ ¸å¿ƒæ€æƒ³åŸºæœ¬æ˜¯å·®ä¸å¤šçš„ï¼Œå…·ä½“çš„å¯ä»¥è‡ªå·±å»ä¸‹è½½æœ€æ–°å®˜æ–¹æºç ä½œä¸ºå‚è€ƒã€‚</p><p>å¦‚æœæƒ³è¦æ·±å…¥ç†è§£RunLoopï¼Œä¸€å®šè¦é˜…è¯»æºç ï¼š</p><p><a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">Core Foundationæºç </a></p><p><a href="https://github.com/apple/swift-corelibs-foundation/" target="_blank" rel="noopener">Swiftç‰ˆCore Foundationæºç </a></p><h2 id="RunLoopæºç è§£è¯»"><a href="#RunLoopæºç è§£è¯»" class="headerlink" title="RunLoopæºç è§£è¯»"></a>RunLoopæºç è§£è¯»</h2><p><a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">æ·±å…¥ç†è§£RunLoop</a> è¿™ç¯‡æ–‡ç« å¯¹RunLoopæºç è§£è¯»éƒ¨åˆ†ï¼Œæºä»£ç æœ‰ç‚¹è¿‡æ—¶äº†ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œä½¿ç”¨æœ€æ–°çš„CoreFoundationæºç é‡æ–°æ•´ç†ä¸€ä¸‹ã€‚</p><p>CFRunLoopRefå¯¹å¤–å…¬å¼€çš„çš„è¿è¡Œæ–¹æ³•æœ‰ä¸¤ä¸ª <code>CFRunLoopRunInMode(:::)</code> å’Œ <code>CFRunLoopRun()ï¼š</code></p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CFRunLoopRun</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<span class="hljs-comment">/* DOES CALLOUT */</span></span><br><span class="line">    <span class="hljs-keyword">int32_t</span> result;</span><br><span class="line">    <span class="hljs-keyword">do</span> &#123;</span><br><span class="line">        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, <span class="hljs-number">1.0e10</span>, <span class="hljs-literal">false</span>);</span><br><span class="line">        CHECK_FOR_FORK();</span><br><span class="line">    &#125; <span class="hljs-keyword">while</span> (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function">SInt32 <span class="hljs-title">CFRunLoopRunInMode</span><span class="hljs-params">(CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled)</span> </span>&#123;     <span class="hljs-comment">/* DOES CALLOUT */</span></span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    <span class="hljs-keyword">return</span> CFRunLoopRunSpecific(CFRunLoopGetCurrent(), modeName, seconds, returnAfterSourceHandled);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æºç å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«äº†å§ã€‚ä¸¤ä¸ªæ–¹æ³•çš„æœ¬è´¨éƒ½æ˜¯æœ€åè°ƒç”¨<code>CFRunLoopRunSpecific()</code>ï¼Œä½†æ˜¯<code>CFRunLoopRunInMode(:::)</code> é‡Œé¢ç»™å®ƒåŒ…äº†ä¸€å±‚<strong>do-whileå¾ªç¯</strong>ã€‚</p><p><code>CFRunLoopRunSpecific()</code>æºç (çœ‹æˆ‘çš„æ³¨é‡Šå³å¯)ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function">SInt32 <span class="hljs-title">CFRunLoopRunSpecific</span><span class="hljs-params">(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled)</span> </span>&#123;     <span class="hljs-comment">/* DOES CALLOUT */</span></span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">if</span> (__CFRunLoopIsDeallocating(rl)) <span class="hljs-keyword">return</span> kCFRunLoopRunFinished;</span><br><span class="line">    </span><br><span class="line">    __CFRunLoopLock(rl);</span><br><span class="line">    </span><br><span class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, <span class="hljs-literal">false</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == currentMode || __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) &#123;</span><br><span class="line">        Boolean did = <span class="hljs-literal">false</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (currentMode) __CFRunLoopModeUnlock(currentMode);__CFRunLoopUnlock(rl);</span><br><span class="line">        <span class="hljs-keyword">return</span> did ? kCFRunLoopRunHandledSource : kCFRunLoopRunFinished;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">volatile</span> _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);</span><br><span class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;</span><br><span class="line">    rl-&gt;_currentMode = currentMode;</span><br><span class="line">    <span class="hljs-keyword">int32_t</span> result = kCFRunLoopRunFinished;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//é€šçŸ¥Observers kCFRunLoopEntry</span></span><br><span class="line"><span class="hljs-keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//__CFRunLoopRun(:::::)æ˜¯RunLoopçš„æ ¸å¿ƒä»£ç ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//é€šçŸ¥Observers kCFRunLoopExit</span></span><br><span class="line"><span class="hljs-keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</span><br><span class="line"></span><br><span class="line">        __CFRunLoopModeUnlock(currentMode);</span><br><span class="line">        __CFRunLoopPopPerRunData(rl, previousPerRun);</span><br><span class="line">rl-&gt;_currentMode = previousMode;</span><br><span class="line">    __CFRunLoopUnlock(rl);</span><br><span class="line">    <span class="hljs-keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºRunLoopçš„è¿è¡Œé€»è¾‘ï¼Œæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯<code>static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) __attribute__((noinline));</code>è¯¥æ–¹æ³•äº†ã€‚é€šè¿‡è¯¥æ–¹æ³•å¯ä»¥åŸºæœ¬å®Œæ•´çš„çœ‹åˆ°RunLoopçš„è¿è¡Œé€»è¾‘(ä¸€ä¸ªloopçš„å®Œæ•´æµç¨‹)ã€‚</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int32_t</span> __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int32_t</span> retVal = <span class="hljs-number">0</span>;</span><br><span class="line">  <span class="hljs-comment">// å¼€å¯ä¸€ä¸ª do while æ¥ä¿æ´»çº¿ç¨‹ï¼ŒæŒç»­å¤„ç†äº‹ä»¶</span></span><br><span class="line">    <span class="hljs-keyword">do</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// é€šçŸ¥Observers -&gt; kCFRunLoopBeforeTimers æ¥ä¸‹æ¥å°†è¦å¤„ç†Timerå›è°ƒ</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line">        <span class="hljs-comment">// é€šçŸ¥Observers -&gt; kCFRunLoopBeforeSources æ¥ä¸‹æ¥å°†è¦å¤„ç†Source0å›è°ƒ</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line">        <span class="hljs-comment">// å¤„ç†block</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// æ˜¯å¦æœ‰Source0</span></span><br><span class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</span><br><span class="line">        <span class="hljs-comment">// å¦‚æœæœ‰Source0å°±å¤„ç†Source0 Blockså›è°ƒ</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (sourceHandledThisLoop) &#123;</span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// å¦‚æœæœ‰Sorce1å°±è·³åˆ°handle_msgå»å¤„ç†</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg_buffer), &amp;livePort, <span class="hljs-number">0</span>, &amp;voucherState, <span class="hljs-literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="hljs-keyword">goto</span> handle_msg;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="hljs-comment">// å¦‚æœæ²¡æœ‰Source1 é€šçŸ¥Observers kCFRunLoopBeforeWaiting RunLoopçš„çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ çŠ¶æ€</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) &#123;</span><br><span class="line">           __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="hljs-comment">// ä¼‘çœ ï¼Œ</span></span><br><span class="line">        __CFRunLoopSetSleeping(rl);</span><br><span class="line">        __CFPortSetInsert(dispatchPort, waitSet);</span><br><span class="line">        <span class="hljs-comment">// ç­‰å¾…è¢«å”¤é†’</span></span><br><span class="line">        <span class="hljs-keyword">do</span> &#123;</span><br><span class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg_buffer), &amp;livePort, poll ? <span class="hljs-number">0</span> : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">            </span><br><span class="line">            <span class="hljs-keyword">if</span> (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (rlm-&gt;_timerFired) &#123;</span><br><span class="line">                    <span class="hljs-comment">// Leave livePort as the queue port, and service timers below</span></span><br><span class="line">                    rlm-&gt;_timerFired = <span class="hljs-literal">false</span>;</span><br><span class="line">                    <span class="hljs-keyword">break</span>;</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                    <span class="hljs-keyword">if</span> (msg &amp;&amp; msg != (<span class="hljs-keyword">mach_msg_header_t</span> *)msg_buffer) <span class="hljs-built_in">free</span>(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                <span class="hljs-comment">// Go ahead and leave the inner loop.</span></span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// é€šçŸ¥Observers kCFRunLoopAfterWaiting</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line"></span><br><span class="line">handle_msg:;</span><br><span class="line">        <span class="hljs-comment">// å¦‚æœ Timer æ—¶é—´åˆ°ï¼Œå°±è§¦å‘ Timer å›è°ƒ</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (is_timer) &#123;</span><br><span class="line">            __CFRunLoopDoTimers(rl, rlm, mach_absolute_time())</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">// å¦‚æœ dispatch å°±æ‰§è¡Œ block</span></span><br><span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_dispatch) &#123;</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">// Source1 äº‹ä»¶çš„è¯ï¼Œå°±å¤„ç†è¿™ä¸ªäº‹ä»¶</span></span><br><span class="line">        <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</span><br><span class="line">            (<span class="hljs-keyword">void</span>)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, <span class="hljs-number">0</span>, MACH_PORT_NULL, <span class="hljs-number">0</span>, MACH_PORT_NULL);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment">// æ‰§è¡ŒBlocks</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// æ ¹æ®æƒ…å†µ è®¾ç½®å¯¹åº”çš„retval retValä¹Ÿå†³å®šæ˜¯runloopæ˜¯é€€å‡ºè¿˜æ˜¯ç»§ç»­ä¸‹ä¸€ä¸ªroop</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">          <span class="hljs-comment">//äº‹ä»¶å·²å¤„ç†</span></span><br><span class="line">            retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">          <span class="hljs-comment">//è¶…æ—¶</span></span><br><span class="line">            retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">          <span class="hljs-comment">//è¢«åœæ­¢</span></span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rlm-&gt;_stopped) &#123;</span><br><span class="line">          <span class="hljs-comment">//è¢«åœæ­¢</span></span><br><span class="line">            rlm-&gt;_stopped = <span class="hljs-literal">false</span>;</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">          <span class="hljs-comment">//modeç©ºï¼Œç»“æŸ</span></span><br><span class="line">            retVal = kCFRunLoopRunFinished;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span> == retVal)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="RunLoopåœ¨å¼€å‘ä¸­çš„åº”ç”¨"><a href="#RunLoopåœ¨å¼€å‘ä¸­çš„åº”ç”¨" class="headerlink" title="RunLoopåœ¨å¼€å‘ä¸­çš„åº”ç”¨"></a>RunLoopåœ¨å¼€å‘ä¸­çš„åº”ç”¨</h2><h3 id="å¸¸é©»çº¿ç¨‹"><a href="#å¸¸é©»çº¿ç¨‹" class="headerlink" title="å¸¸é©»çº¿ç¨‹"></a>å¸¸é©»çº¿ç¨‹</h3><p>è‹¹æœå®˜æ–¹æ–‡æ¡£é‡Œæœ‰æåˆ°åªæœ‰ä¸»çº¿ç¨‹åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºRunLoopï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦æˆ‘ä»¬æ˜¾ç¤ºçš„å»åˆ›å»ºRunLoopã€‚</p><p>æ‰€ä»¥å¦‚æœæƒ³è®¾è®¡ä¸€ä¸ªå¸¸é©»çº¿ç¨‹ï¼Œå°±å¿…é¡»æ˜¾ç¤ºçš„å»åˆ›å»ºä¸€ä¸ªRunLoopï¼Œä¿æŒçº¿ç¨‹èƒ½å¤Ÿæ—¶åˆ»æ¥æ”¶äº‹ä»¶ã€‚RunLoopå¦‚æœæ²¡æœ‰Sourceå’ŒTimerï¼Œä¼šç«‹é©¬ç»“æŸã€‚æ‰€ä»¥åˆ›å»ºå®ŒRunLoopåï¼Œéœ€è¦ç»™å®ƒæ·»åŠ ä¸€ä¸ªSourceï¼Œä¿è¯å…¶ä¸ç»“æŸã€‚æœ€åè¿è¡ŒRunLoopå³å¯ã€‚</p><p><strong>æ³¨æ„ï¼šåœ¨æ˜¾ç¤ºåˆ›å»ºRunLoopåï¼Œå¦‚æœæ‰“ç®—ç»“æŸè¯¥çº¿ç¨‹ï¼Œéœ€è¦æ‰‹åŠ¨å…³é—­RunLoopï¼Œå¦åˆ™çº¿ç¨‹å°†æ— æ³•é‡Šæ”¾ã€‚</strong></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InnerThread</span>: <span class="hljs-title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">deinit</span> &#123;</span><br><span class="line">        <span class="hljs-built_in">print</span>(<span class="hljs-string">"InnerThread Dealloc"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PermanentThread</span>: <span class="hljs-title">NSObject</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">let</span> thread: <span class="hljs-type">InnerThread</span></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() &#123;</span><br><span class="line">        thread = <span class="hljs-type">InnerThread</span>.<span class="hljs-keyword">init</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">var</span> context = <span class="hljs-type">CFRunLoopSourceContext</span>()</span><br><span class="line">            <span class="hljs-comment">//Swiftä¸­ create åä¸éœ€è¦è°ƒç”¨CFRelease</span></span><br><span class="line">            <span class="hljs-keyword">let</span> source = <span class="hljs-type">CFRunLoopSourceCreate</span>(kCFAllocatorDefault, <span class="hljs-number">0</span>, &amp;context)!</span><br><span class="line">            <span class="hljs-type">CFRunLoopAddSource</span>(<span class="hljs-type">CFRunLoopGetCurrent</span>(), source, <span class="hljs-type">CFRunLoopMode</span>.defaultMode)</span><br><span class="line">            <span class="hljs-comment">//è®¾ç½®ä¸ºtrueçš„è¯ï¼Œå¤„ç†ä¸€æ¬¡äº‹ä»¶å°±ä¼šè¿”å›</span></span><br><span class="line">            <span class="hljs-type">CFRunLoopRunInMode</span>(<span class="hljs-type">CFRunLoopMode</span>.defaultMode, <span class="hljs-number">1.0e10</span>, <span class="hljs-literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        thread.start()</span><br><span class="line">        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">deinit</span> &#123;</span><br><span class="line">        exit()</span><br><span class="line">        <span class="hljs-built_in">print</span>(<span class="hljs-string">"PermanentThread Dealloc"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">executeTask</span><span class="hljs-params">(block: <span class="hljs-params">(<span class="hljs-params">()</span></span></span></span>-&gt;<span class="hljs-type">Void</span>)?) &#123;</span><br><span class="line">        perform(#selector(doExecuteTask(block:)), on: thread, with: block, waitUntilDone: <span class="hljs-literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">exit</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> thread.isExecuting &#123;</span><br><span class="line">            perform(#selector(doExit), on: thread, with: <span class="hljs-literal">nil</span>, waitUntilDone: <span class="hljs-literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">PermanentThread</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// è¿™é‡Œçš„å‚æ•°ä¸èƒ½å†™ ()-&gt;Void, å¿…é¡»å†™Anyã€‚ä¸ç„¶ä¼ è¿‡æ¥çš„å‚æ•°ä¼šè¢«æ”¹å˜ã€‚è°ƒç”¨blockå°±ä¼šå´©æºƒã€‚</span></span><br><span class="line">    <span class="hljs-meta">@objc</span> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doExecuteTask</span><span class="hljs-params">(block: Any)</span></span> &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> _block = block <span class="hljs-keyword">as</span>? (()-&gt;<span class="hljs-type">Void</span>) &#123;</span><br><span class="line">            _block()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-meta">@objc</span> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doExit</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">        thread.cancel()</span><br><span class="line">        <span class="hljs-type">CFRunLoopStop</span>(<span class="hljs-type">CFRunLoopGetCurrent</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¡é¡¿ç›‘æ§"><a href="#å¡é¡¿ç›‘æ§" class="headerlink" title="å¡é¡¿ç›‘æ§"></a>å¡é¡¿ç›‘æ§</h3><p>æˆ‘ä¹‹å‰æ€»ç»“äº†ä¸€ç¯‡æ–‡ç« ï¼šã€ŠiOSå›¾å½¢æ€§èƒ½ä¼˜åŒ–ã€‹ï¼Œæ–‡ç« é‡Œæåˆ°é€šè¿‡InstrumentsæŸ¥çœ‹fpsæ¥åˆ¤æ–­å¡é¡¿ã€‚ä½†æ˜¯ç€ä¹Ÿå¹¶ä¸æ˜¯å®Œå…¨å‡†ç¡®ï¼Œä¸¾ä¸ªå¯èƒ½å¾ˆæç«¯çš„ä¾‹å­ï¼Œæ¯”å¦‚ä¸€ä¸ªåŠ¨ç”»æ˜¯60fpsï¼Œä½†æ˜¯å®ƒæœ‰å¯èƒ½èŠ±äº†60åˆ†ä¹‹1ç§’æ¥ç»˜åˆ¶äº†59å¸§ï¼Œç¬¬60å¸§èŠ±äº†60åˆ†ä¹‹59ç§’æ¥ç»˜åˆ¶ã€‚æ‰€ä»¥è¿™é‡Œç»™å‡ºä¸€ä¸ªç›¸å¯¹æ¥è¯´æ›´åŠ ç²¾ç¡®çš„æ–¹æ³•ï¼š</p><p>é€šè¿‡RunLoopçš„çŠ¶æ€å¯ä»¥æ¥åˆ¤æ–­æ˜¯å¦å‡ºç°å¡é¡¿ã€‚</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//RunLoopçš„å‡ ä¸ªçŠ¶æ€</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">CF_OPTIONS</span><span class="hljs-params">(CFOptionFlags, CFRunLoopActivity)</span> </span>&#123;</span><br><span class="line">    kCFRunLoopEntry , <span class="hljs-comment">// å³å°†è¿›å…¥loop</span></span><br><span class="line">    kCFRunLoopBeforeTimers , <span class="hljs-comment">// å³å°†è§¦å‘ Timer å›è°ƒ</span></span><br><span class="line">    kCFRunLoopBeforeSources , <span class="hljs-comment">// å³å°†è§¦å‘ Source0 å›è°ƒ</span></span><br><span class="line">    kCFRunLoopBeforeWaiting , <span class="hljs-comment">// å³å°†ä¼‘çœ ï¼Œç­‰å¾… mach_port æ¶ˆæ¯</span></span><br><span class="line">    kCFRunLoopAfterWaiting ), <span class="hljs-comment">// å³å°†è¢«å”¤é†’ï¼Œæ¥æ”¶ mach_port æ¶ˆæ¯</span></span><br><span class="line">    kCFRunLoopExit , <span class="hljs-comment">// é€€å‡º loop</span></span><br><span class="line">    kCFRunLoopAllActivities  <span class="hljs-comment">// loop æ‰€æœ‰çŠ¶æ€æ”¹å˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºå¡é¡¿åä¼šå¯¹RunLoopé€ æˆçš„å½±å“å°±æ˜¯ä¼‘çœ è¢«å»¶è¿Ÿï¼Œä»¥åŠå”¤é†’è¢«å»¶è¿Ÿã€‚</p><p>ä»£ç å®ä¾‹ä¸ºï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">dispatchSemaphore = dispatch_semaphore_create(0);</span><br><span class="line">CFRunLoopObserverContext context = &#123;0,(__bridge void *)self,NULL,NULL&#125;;</span><br><span class="line">runLoopObserver = CFRunLoopObserverCreate(kCFAllocatorDefault, kCFRunLoopAllActivities, YES, 0, &amp;runloopObserverCallBack, &amp;context);</span><br><span class="line">CFRunLoopAddObserver(CFRunLoopGetMain(), runLoopObserver, kCFRunLoopCommonModes);</span><br><span class="line"></span><br><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">    while (YES) &#123;</span><br><span class="line">        //dispatch_semaphore_waitæ–¹æ³•å¦‚æœè¶…æ—¶åˆ™ä¼šè¿”å›ä¸€ä¸ªä¸ç­‰äº0çš„æ•´æ•°ï¼Œæ”¶åˆ°dispatch_semaphore_signalçš„æ—¶å€™ä¼šè¿”å›0</span><br><span class="line">        long semaphoreWait = dispatch_semaphore_wait(self-&gt;dispatchSemaphore, dispatch_time(DISPATCH_TIME_NOW, 3*NSEC_PER_SEC));</span><br><span class="line">        if (semaphoreWait != 0)&#123;</span><br><span class="line">            if (!self-&gt;runLoopObserver)&#123;</span><br><span class="line">                self-&gt;timeoutCount = 0;</span><br><span class="line">                self-&gt;dispatchSemaphore = 0;</span><br><span class="line">                self-&gt;runloopActivity = 0;</span><br><span class="line">                return ;</span><br><span class="line">            &#125;</span><br><span class="line">            //BeforeSourceå’ŒAfterWaitingè¿™ä¸¤ä¸ªçŠ¶æ€åŒºé—´èƒ½å¤Ÿç›‘æµ‹åˆ°æ˜¯å¦å¡é¡¿</span><br><span class="line">            if (self-&gt;runloopActivity == kCFRunLoopBeforeSources || self-&gt;runloopActivity == kCFRunLoopAfterWaiting)&#123;</span><br><span class="line">                NSLog(@&quot;monitor trigger&quot;);</span><br><span class="line">                dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">                    //ä¸ŠæŠ¥å †æ ˆ</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        self-&gt;timeoutCount = 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å¦‚ä½•ç†è§£RunLoop&quot;&gt;&lt;a href=&quot;#å¦‚ä½•ç†è§£RunLoop&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•ç†è§£RunLoop&quot;&gt;&lt;/a&gt;å¦‚ä½•ç†è§£RunLoop&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Run loops are part of the fundamental infrastructure associated with threads. A &lt;em&gt;run loop&lt;/em&gt; is an event processing loop that you use to schedule work and coordinate the receipt of incoming events. The purpose of a run loop is to keep your thread busy when there is work to do and put your thread to sleep when there is none. &lt;/p&gt;
&lt;p&gt;Run loop management is not entirely automatic. You must still design your threadâ€™s code to start the run loop at appropriate times and respond to incoming events. Both Cocoa and Core Foundation provide &lt;em&gt;run loop objects&lt;/em&gt; to help you configure and manage your threadâ€™s run loop. Your application does not need to create these objects explicitly; each thread, including the applicationâ€™s main thread, has an associated run loop object. Only secondary threads need to run their run loop explicitly, however. The app frameworks automatically set up and run the run loop on the main thread as part of the application startup process.&lt;/p&gt;
&lt;p&gt;- ä»¥ä¸Šæ‘˜è‡ªè‹¹æœå®˜æ–¹æ–‡æ¡£ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://www.wuqihan.cn/categories/iOS/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
    
      <category term="RunLoop" scheme="http://www.wuqihan.cn/tags/RunLoop/"/>
    
  </entry>
  
  <entry>
    <title>Tagged Pointer</title>
    <link href="http://www.wuqihan.cn/2018/11/06/Tagged-Pointer/"/>
    <id>http://www.wuqihan.cn/2018/11/06/Tagged-Pointer/</id>
    <published>2018-11-06T11:18:48.000Z</published>
    <updated>2020-01-28T10:18:51.134Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€é“é¢è¯•é¢˜"><a href="#ä¸€é“é¢è¯•é¢˜" class="headerlink" title="ä¸€é“é¢è¯•é¢˜"></a>ä¸€é“é¢è¯•é¢˜</h2><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSString</span> *target;</span><br><span class="line"><span class="hljs-comment">//.... </span></span><br><span class="line"><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"parallel"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span> ; i++) &#123;</span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="hljs-keyword">self</span>.target = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@"ksddkjalkjd%d"</span>,i];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><p>ç»“æœä¼šå´©æºƒã€‚åŸå› setTargetæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šå‡ºç°å·²ç»é‡Šæ”¾çš„å†…å­˜å†æ¬¡é‡Šæ”¾ï¼Œé€ æˆå´©æºƒã€‚è§£å†³åŠæ³•å¾ˆå¤šï¼Œåœ¨è¿™é‡Œä¸è¿‡å¤šè®¨è®ºã€‚</p><p>å¦‚æœæŠŠä»£ç æ”¹æˆä¸‹é¢è¿™æ ·å°±ä¸ä¼šå‘ç”Ÿå´©æºƒäº†ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSString</span> *target;</span><br><span class="line"><span class="hljs-comment">//.... </span></span><br><span class="line"><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"parallel"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span> ; i++) &#123;</span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="hljs-keyword">self</span>.target = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@"%d"</span>,i];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè‹¹æœä»64ä½ç¨‹åºå¼€å§‹ï¼Œå¼•å…¥äº†<code>Tagged Pointer</code>æ¦‚å¿µï¼Œå¯¼è‡´self.tagetçš„å€¼ç›´æ¥ä¿å­˜åœ¨äº†æŒ‡é’ˆå€¼ä¸­ã€‚</p><h2 id="å†…å­˜å¯¹é½"><a href="#å†…å­˜å¯¹é½" class="headerlink" title="å†…å­˜å¯¹é½"></a>å†…å­˜å¯¹é½</h2><p>åœ¨è‹¹æœ64ä½å¤„ç†å™¨ä¸Šï¼Œå †å†…å­˜å¯¹é½é‡‡ç”¨çš„æ˜¯16å­—èŠ‚å¯¹é½ã€‚æ‰€ä»¥ä»»ä½•æŒ‡å‘å †å†…å­˜çš„æŒ‡é’ˆéƒ½æ˜¯å¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x---------------0/8</span><br></pre></td></tr></table></figure><p>æœ€åä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—<em>å§‹ç»ˆæ˜¯</em> <code>0æˆ–è€…8</code>ã€‚</p><blockquote><p>æˆ‘ç”¨çœŸæœºæµ‹è¯•æœ€ä½ä½éƒ½æ˜¯8 ç”¨æ¨¡æ‹Ÿå™¨æµ‹è¯•æœ€ä½ä½éƒ½æ˜¯0 ï¼ˆå…·ä½“åŸå› ä¸æ¸…æ¥šã€‚æ€»ä¹‹æŒ‡å‘å †å†…å­˜çš„æŒ‡é’ˆæœ€ä½ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¦ä¹ˆå…¨æ˜¯8è¦ä¹ˆå…¨æ˜¯0ï¼‰</p></blockquote><p>ä½¿ç”¨16å­—èŠ‚å†…å­˜å¯¹é½ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œå¦‚æœå †ä¸Šéœ€è¦å­˜å‚¨çš„æ•°æ®å®é™…å¤§å°åªæœ‰1å­—èŠ‚ï¼Œå¯å®ƒè¿˜æ˜¯ä¼šå¤šå ç”¨15ä¸ªå­—èŠ‚æ¥è¾¾åˆ°å†…å­˜å¯¹é½ï¼Œè¿™æ˜¯ä¸æ˜¯å¾ˆæµªè´¹ï¼Ÿ</p><p>é‚£ä¹ˆæ¯”å¦‚NSNumberï¼Œå¦‚æœæ•°å€¼ä»…ä»…ä¸º1ï¼Œ<code>NSNumber num = @1</code>ã€‚é‚£å¦‚æœä¸ä½¿ç”¨Tagged Pointerè¿˜æ˜¯éœ€è¦å ç”¨16ä¸ªå­—èŠ‚æ¥ä¿å­˜1ï¼Œä»¥åŠä¸€ä¸ª8å­—èŠ‚çš„æŒ‡é’ˆæŒ‡å‘16å­—èŠ‚çš„å †å†…å­˜ã€‚</p><h2 id="Tagged-Pointer"><a href="#Tagged-Pointer" class="headerlink" title="Tagged Pointer"></a>Tagged Pointer</h2><p>ä»64ä½ç¨‹åºå¼€å§‹ï¼ˆiPhone5sæ˜¯é…å¤‡äº†é¦–ä¸ªé‡‡ç”¨ 64 ä½æ¶æ„çš„ A7 åŒæ ¸å¤„ç†å™¨ï¼‰ï¼Œè‹¹æœå¼•å…¥äº†<code>Tagged Pointer</code>çš„æ¦‚å¿µï¼Œä¸ºäº†èŠ‚çœå†…å­˜å’Œæå‡æ•ˆç‡ã€‚</p><p>ä¸»è¦ç”¨äº<strong>NSString</strong>ã€<strong>NSNumber</strong>ã€<strong>NSDate</strong>ã€<strong>NSIndexPath</strong>ç­‰å­˜å‚¨å°è§„æ¨¡æ•°æ®çš„å¯¹è±¡ã€‚è¿™äº›ä½¿ç”¨äº†<code>Tagged Pointer</code>ä¼˜åŒ–çš„å¯¹è±¡ï¼Œä»–ä»¬çš„æŒ‡é’ˆä¸å†æ˜¯æŒ‡å‘å †å†…å­˜çš„åœ°å€ï¼Œè€Œæ˜¯ç›´æ¥å°†å€¼ä¿å­˜åœ¨äº†æŒ‡é’ˆä¸­ï¼ˆ<strong>è‹¹æœä¸ºäº†æ•°æ®å®‰å…¨ï¼Œå¯¹Tagged PointeræŒ‡é’ˆçš„å€¼åšäº†æ•°æ®æ··æ·†</strong>ï¼‰ã€‚</p><p>ä½¿ç”¨<code>Tagged Pointer</code>ä»…ä»…æ˜¯é’ˆå¯¹å­˜å‚¨çš„å€¼æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œå¦‚æœå­˜å‚¨çš„å€¼è¿‡å¤§ï¼Œ8ä¸ªå­—èŠ‚çš„æŒ‡é’ˆæ— æ³•ä¿å­˜ï¼Œè¿˜æ˜¯ä¼šåœ¨å †ä¸­åˆ†é…å†…å­˜ã€‚</p><p>åœ¨objcæºç ä¸­ï¼Œç”¨<code>_objc_isTaggedPointer</code>å‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦ä¸º<code>Tagged Pointer</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> </span><br><span class="line">_objc_isTaggedPointer(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> ((<span class="hljs-keyword">uintptr_t</span>)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„çœ‹ <code>_OBJC_TAG_MASK</code>çš„å€¼</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> (TARGET_OS_OSX || TARGET_OS_IOSMAC) &amp;&amp; __x86_64__</span></span><br><span class="line">    <span class="hljs-comment">// 64-bit Mac - tag bit is LSB</span></span><br><span class="line"><span class="hljs-meta">#   <span class="hljs-meta-keyword">define</span> OBJC_MSB_TAGGED_POINTERS 0</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span></span><br><span class="line">    <span class="hljs-comment">// Everything else - tag bit is MSB</span></span><br><span class="line"><span class="hljs-meta">#   <span class="hljs-meta-keyword">define</span> OBJC_MSB_TAGGED_POINTERS 1</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> OBJC_MSB_TAGGED_POINTERS</span></span><br><span class="line"><span class="hljs-meta">#   <span class="hljs-meta-keyword">define</span> _OBJC_TAG_MASK (1UL&lt;&lt;63)</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span></span><br><span class="line"><span class="hljs-meta">#   <span class="hljs-meta-keyword">define</span> _OBJC_TAG_MASK 1UL</span></span><br><span class="line"><span class="hljs-comment">//åœ¨macå¹³å° _OBJC_TAG_MASK = 1UL</span></span><br><span class="line"><span class="hljs-comment">//å…¶ä»–å¹³å° _OBJC_TAG_MASK = 1UL&lt;&lt;63 (1å·¦ç§»63ä½)</span></span><br></pre></td></tr></table></figure><p>åœ¨<strong>iOS</strong>å¹³å°ä¸Šï¼Œç³»ç»Ÿé€šè¿‡æŒ‡é’ˆçš„æœ€é«˜æœ‰æ•ˆä½æ˜¯å¦ä¸º1(ä¹Ÿå°±æ˜¯ç¬¬64ä½)ï¼Œæ¥åˆ¤æ–­æ˜¯å¦ä¸º<code>Tagged Pointer</code>ï¼Œåœ¨<strong>macOS</strong>å¹³å°ä¸Šåˆ™æ˜¯æ ¹æ®æœ€ä½æœ‰æ•ˆä½ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSString *a = @&quot;a&quot;;</span><br><span class="line">NSObject *object = [[NSObject alloc] init];</span><br><span class="line">NSLog(@&quot;%@ %p\n%p&quot;,[a class],a,object);</span><br></pre></td></tr></table></figure><p>consoleè¾“å‡ºä¸ºï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__NSCFConstantString <span class="hljs-number">0x10dc68020</span></span><br><span class="line"><span class="hljs-number">0x600002c38940</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå‘ç°è¿™é‡Œçš„aä¸æ˜¯TaggedPointerï¼Œaå®é™…æ˜¯æŒ‡å‘äº†å¸¸é‡åŒºã€‚ä¸ºä»€ä¹ˆè¿™æ ·è¯´å‘¢ï¼Ÿå› ä¸ºæˆ‘è¿™é‡Œå¤šæ·»åŠ äº†ä¸€ä¸ªobjectå˜é‡ï¼ŒobjectæŒ‡é’ˆè‚¯å®šæ˜¯æŒ‡å‘å †ä¸­ï¼Œä½†æ˜¯aæŒ‡é’ˆçš„å€¼å´æ¯”objectæŒ‡é’ˆå€¼å°äº†å¾ˆå¤šå¾ˆå¤šã€‚æ‰€ä»¥ï¼Œaä¸æ˜¯åœ¨å †ä¸­ï¼Œä¸”æ ˆçš„åœ°å€åˆæ˜¯å¤§äºå †åœ°å€ï¼Œæ‰€ä»¥æ’é™¤å †å’Œæ ˆï¼Œé‚£å°±æ˜¯è¯´è¿™é‡Œçš„å­—ç¬¦ä¸²â€aâ€æ˜¯ä¿å­˜åœ¨æ•°æ®æ®µå¸¸é‡åŒºçš„ã€‚å› ä¸ºiOSå†…å­˜åˆ†å¸ƒç»“æ„ï¼Œåœ°å€ä»å°åˆ°å¤§ä¾æ¬¡æ˜¯ï¼šä»£ç æ®µã€æ•°æ®æ®µã€å †ã€æ ˆã€‚</p><p>é‚£ä¸ºä»€ä¹ˆè¿™é‡Œçš„aä¸æ˜¯<code>Tagged Pointer</code>å‘¢ã€‚å› ä¸ºå¸¸é‡å­—ç¬¦ä¸²æœ¬æ¥å°±æ˜¯åœ¨å¸¸é‡åŒºå•Šã€‚ã€‚ã€‚<code>Tagged Pointer</code>ä¼˜åŒ–çš„æ˜¯æŒ‡å‘å †å†…å­˜çš„æŒ‡é’ˆã€‚æ‰€ä»¥ä¿®æ”¹ä¸‹ä»£ç ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">NSString</span> *a = [[<span class="hljs-string">@"a"</span> mutableCopy] <span class="hljs-keyword">copy</span>];</span><br><span class="line"><span class="hljs-built_in">NSObject</span> *object = [[<span class="hljs-built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@ %p"</span>,[a <span class="hljs-keyword">class</span>],a);</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ <code>NSString *a = [@&quot;a&quot; copy];</code>?</p><p>å› ä¸ºè‹¹æœåœ¨è¿™é‡Œåšäº†ä¼˜åŒ–ï¼Œå¯¹ä¸€ä¸ªå¸¸é‡åŒºå­—ç¬¦ä¸²copyï¼Œæ²¡æœ‰æ„ä¹‰å•Šï¼Œæ‰€ä»¥ç›´æ¥è¿”å›äº†@â€aâ€;</p><p>ä¸ºä»€ä¹ˆè¦mutableCopyåå†åŠ copyï¼Ÿ</p><p>å› ä¸ºmutableCopyåï¼Œå˜æˆäº†å¯å˜å¯¹è±¡ï¼Œå¯å˜å¯¹è±¡ä¸å¯èƒ½ä¸ºTagged Pointerï¼Œæ‰€ä»¥éœ€è¦åœ¨copyä¸€ä¸‹å˜ä¸ºä¸å¯å˜å¯¹è±¡ã€‚</p><p>(æˆ‘è¿™é‡Œè¿™æ ·åšï¼Œæ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œä»…ä»…æ˜¯ä¸ºäº†è¿™æ¬¡æµ‹è¯•ï¼Œå¼€å‘ä¸­ä¸ä¼šè¿™æ ·å†™ä»£ç )ã€‚</p></blockquote><p>consoleè¾“å‡ºä¸ºï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSTaggedPointerString <span class="hljs-number">0xae2f7c76826f6e01</span></span><br><span class="line"><span class="hljs-number">0x60000104c170</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å¤§ï¼Œaçš„ç±»å‹å˜ä¸ºäº†<code>NSTaggedPointerString</code>ï¼ŒaæŒ‡é’ˆçš„å€¼ä¸º<code>0xae2f7c76826f6e01</code>ã€‚</p><p>æœ€é«˜ä½æ˜¯0xa è½¬æ¢ä¸º2è¿›åˆ¶ä¸º 1010ï¼ŒäºŒè¿›åˆ¶æœ€é«˜ä½ä¸º1ï¼Œæ‰€ä»¥æ˜¯<code>Tagged Pointer</code>ã€‚</p><h2 id="ä¸€ä¸ªé—®é¢˜"><a href="#ä¸€ä¸ªé—®é¢˜" class="headerlink" title="ä¸€ä¸ªé—®é¢˜"></a>ä¸€ä¸ªé—®é¢˜</h2><p>å¦‚æœå¯¹Tagged Pointeræœ‰äº†äº†è§£ï¼Œä¸‹é¢è¿™ä¸ªé—®é¢˜å°±å¾ˆå¥½è§£å†³äº†</p><p>å‡è®¾æœ‰ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSObject</span> (<span class="hljs-title">AssociatedObject</span>) </span></span><br><span class="line"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">CGFloat</span> someProperty; </span><br><span class="line"><span class="hljs-keyword">@end</span> </span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NSObject</span> (<span class="hljs-title">AssociatedObject</span>) </span></span><br><span class="line"><span class="hljs-keyword">@dynamic</span> someProperty; </span><br><span class="line">- (<span class="hljs-keyword">void</span>)setSomeProperty:(<span class="hljs-built_in">CGFloat</span>)someProperty&#123; </span><br><span class="line"><span class="hljs-keyword">return</span> objc_setAssociatedObject(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">@selector</span>(someProperty), @(someProperty), OBJC_ASSOCIATION_ASSIGN); </span><br><span class="line">&#125; </span><br><span class="line">- (<span class="hljs-built_in">CGFloat</span>)someProperty&#123; </span><br><span class="line"><span class="hljs-keyword">return</span> [objc_getAssociatedObject(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">@selector</span>(someProperty)) floatValue]; </span><br><span class="line">&#125; </span><br><span class="line"><span class="hljs-keyword">@end</span></span><br></pre></td></tr></table></figure><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//ä»£ç 1</span></span><br><span class="line"><span class="hljs-keyword">self</span>.view.someProperty = <span class="hljs-number">100</span>;</span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>, @(<span class="hljs-keyword">self</span>.view.someProperty));</span><br></pre></td></tr></table></figure><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//ä»£ç 2</span></span><br><span class="line"><span class="hljs-keyword">self</span>.view.someProperty = <span class="hljs-number">999999999999999.1</span>;</span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>, @(<span class="hljs-keyword">self</span>.view.someProperty));</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«æ‰§è¡Œä¸Šé¢ä¸¤æ®µä»£ç 1 å’Œ 2ã€‚ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜å˜›ï¼Ÿ</p><p>ä»£ç 1ä¸ä¼šå´©æºƒï¼Œä»£ç 2ä¼šå´©æºƒã€‚å› ä¸º@(100)æ²¡æœ‰mallocåˆ†é…å†…å­˜ï¼Œä½†æ˜¯æ•°å€¼è¿‡å¤§ä¼šåˆ†é…å†…å­˜ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨retainã€‚ä½†æ˜¯ä¸Šé¢ä»£ç ä½¿ç”¨çš„assignã€‚æ‰€ä»¥è°ƒç”¨getæ–¹æ³•æ—¶ï¼Œä¼šè®¿é—®åˆ°åå†…å­˜ã€‚</p><p>ä¸Šé¢è¿™ä¸ªé—®é¢˜å¼•ç”¨è‡ª<a href="http://sketchk.xyz/2018/07/29/A-problem-caused-by-Tagged-Pointer/" target="_blank" rel="noopener">ç”±Tagged Pointerè”æƒ³åˆ°çš„ä¸€ä¸ªé—®é¢˜</a>ã€‚å…·ä½“æ›´è¯¦ç»†çš„è§£é‡Šå‚è€ƒè¿™ç¯‡æ–‡ç« å°±è¡Œï¼ˆæˆ‘è¿™é‡Œå°±æ˜¯æŠŠè¿™ä¸ªé—®é¢˜è®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿è‡ªå·±ä»¥åå›é¡¾ï¼Œå› ä¸ºç»å¸¸é‡åˆ°æ”¶è—çš„æ–‡ç« ï¼Œè¿‡ä¸€æ®µæ—¶é—´å†å»è®¿é—®æ–‡ç« å°±ä¸è§äº†ã€‚å¯èƒ½æ˜¯ä½œè€…æœåŠ¡å™¨æŒ‚äº†æˆ–è€…æ–‡ç« è¢«åˆ é™¤äº†==ï¼‰ã€‚</p><blockquote><p>å‚è€ƒèµ„æ–™ï¼š</p><p><a href="https://swift.gg/2018/10/08/tagged-pointer-strings/" target="_blank" rel="noopener">Tagged Pointerå­—ç¬¦ä¸²</a></p><p><a href="https://blog.devtang.com/2014/05/30/understand-tagged-pointer/" target="_blank" rel="noopener">æ·±å…¥ç†è§£Tagged Pointer</a></p><p><a href="https://www.mikeash.com/pyblog/friday-qa-2012-07-27-lets-build-tagged-pointers.html" target="_blank" rel="noopener">Letâ€™s Build Tagged Pointers</a></p><p><a href="[https://qiubaiying.github.io/2017/12/26/%E4%BB%8E%E4%B8%80%E9%81%93%E7%BD%91%E6%98%93%E9%9D%A2%E8%AF%95%E9%A2%98%E6%B5%85%E8%B0%88-Tagged-Pointer/](https://qiubaiying.github.io/2017/12/26/ä»ä¸€é“ç½‘æ˜“é¢è¯•é¢˜æµ…è°ˆ-Tagged-Pointer/">ä»ä¸€é“ç½‘æ˜“é¢è¯•é¢˜æµ…è°ˆTagged Pointer</a>)</p><p><a href="https://www.jianshu.com/p/3176e30c040b" target="_blank" rel="noopener">èŠèŠä¼ªæŒ‡é’ˆTagged Pointer</a></p><p><a href="http://sketchk.xyz/2018/07/29/A-problem-caused-by-Tagged-Pointer/" target="_blank" rel="noopener">ç”±Tagged Pointerè”æƒ³åˆ°çš„ä¸€ä¸ªé—®é¢˜</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä¸€é“é¢è¯•é¢˜&quot;&gt;&lt;a href=&quot;#ä¸€é“é¢è¯•é¢˜&quot; class=&quot;headerlink&quot; title=&quot;ä¸€é“é¢è¯•é¢˜&quot;&gt;&lt;/a&gt;ä¸€é“é¢è¯•é¢˜&lt;/h2&gt;&lt;figure class=&quot;highlight objc hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;@property&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;nonatomic&lt;/span&gt;, &lt;span class=&quot;hljs-keyword&quot;&gt;strong&lt;/span&gt;) &lt;span class=&quot;hljs-built_in&quot;&gt;NSString&lt;/span&gt; *target;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;//.... &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;hljs-built_in&quot;&gt;dispatch_queue_t&lt;/span&gt; queue = dispatch_queue_create(&lt;span class=&quot;hljs-string&quot;&gt;&quot;parallel&quot;&lt;/span&gt;, DISPATCH_QUEUE_CONCURRENT);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;hljs-number&quot;&gt;1000000&lt;/span&gt; ; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;hljs-built_in&quot;&gt;dispatch_async&lt;/span&gt;(queue, ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;hljs-keyword&quot;&gt;self&lt;/span&gt;.target = [&lt;span class=&quot;hljs-built_in&quot;&gt;NSString&lt;/span&gt; stringWithFormat:&lt;span class=&quot;hljs-string&quot;&gt;@&quot;ksddkjalkjd%d&quot;&lt;/span&gt;,i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
    
      <category term="Tagged Pointer" scheme="http://www.wuqihan.cn/tags/Tagged-Pointer/"/>
    
      <category term="å†…å­˜ç®¡ç†" scheme="http://www.wuqihan.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>è¯¦è§£Objective-Cå¯¹è±¡</title>
    <link href="http://www.wuqihan.cn/2018/08/03/%E8%AF%A6%E8%A7%A3Objective-C%E5%AF%B9%E8%B1%A1/"/>
    <id>http://www.wuqihan.cn/2018/08/03/è¯¦è§£Objective-Cå¯¹è±¡/</id>
    <published>2018-08-02T16:46:45.000Z</published>
    <updated>2020-01-28T10:18:06.114Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸¤å¹´å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼š<a href="http://www.wuqihan.cn/2016/05/08/Objective-C%E5%AF%B9%E8%B1%A1%E8%AF%A6%E8%A7%A3/">Objective-Cç±»å¯¹è±¡</a>ã€‚å½“åˆå¯¹OCçš„ç†è§£è¿˜ä»…ä»…æ˜¯åˆšå…¥é—¨ï¼Œä¹Ÿæ²¡æœ‰é‡åˆ°é—®é¢˜çœ‹æºç çš„ä¹ æƒ¯ï¼Œæ‰€ä»¥ä¸¤å¹´åï¼Œé‡æ–°å¯¹Objective-Cå¯¹è±¡åšä¸€ä¸ªæ€»ç»“ã€‚</p><a id="more"></a><h2 id="objc-classä¸objc-object"><a href="#objc-classä¸objc-object" class="headerlink" title="objc_classä¸objc_object"></a>objc_classä¸objc_object</h2><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">NSObject</span>&gt; </span>&#123;</span><br><span class="line">    Class isa;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Classç±»ï¼š</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">objc_class</span> *<span class="hljs-title">Class</span>;</span></span><br></pre></td></tr></table></figure><p>id:</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">objc_object</span> *<span class="hljs-title">id</span>;</span></span><br></pre></td></tr></table></figure><p>objc_class:</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="hljs-comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="hljs-keyword">cache_t</span> cache;             <span class="hljs-comment">// formerly cache pointer and vtable</span></span><br><span class="line">    <span class="hljs-keyword">class_data_bits_t</span> bits;    <span class="hljs-comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//....... çœç•¥</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>objc_object:</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">truct objc_object &#123;</span><br><span class="line"><span class="hljs-keyword">private</span>:</span><br><span class="line">    <span class="hljs-keyword">isa_t</span> isa;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// ISA() assumes this is NOT a tagged pointer object</span></span><br><span class="line">    <span class="hljs-function">Class <span class="hljs-title">ISA</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// getIsa() allows this to be a tagged pointer object</span></span><br><span class="line">    <span class="hljs-function">Class <span class="hljs-title">getIsa</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//....... çœç•¥</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šä»£ç å¯ä»¥å¾—å‡ºç»“è®ºï¼š</p><p>Objective-Cçš„é¢å‘å¯¹è±¡éƒ½æ˜¯åŸºäºC\C++çš„æ•°æ®ç»“æ„å®ç°çš„ã€‚</p><p>NSObjectå¯¹è±¡æœ¬è´¨ä¸Šæ˜¯Cç»“æ„ä½“ï¼Œå…¶åªæœ‰ä¸€ä¸ªå˜é‡<code>isa</code>ï¼Œ<code>isa</code>ç±»å‹æ˜¯<code>Class</code>(è¿™æ ·è¯´å¹¶ä¸ç®—ä¸¥è°¨ï¼Œå…¶å®ç°åœ¨isaæ˜¯ä¸€ä¸ªè”åˆä½“ç±»å‹ï¼Œä¸‹æ–‡ä¼šè®²åˆ°)ï¼Œ<code>Class</code>æ˜¯æŒ‡å‘ç»“æ„ä½“<code>objc_class</code>çš„æŒ‡é’ˆã€‚</p><p><code>objc_class</code>åˆç»§æ‰¿è‡ª<code>objc_object</code>ã€‚æ‰€ä»¥ç±»ä¹Ÿæ˜¯ç»“æ„ä½“å¯¹è±¡ï¼Œæˆ‘ä»¬å¹³æ—¶ç§°ä¹‹ä¸ºç±»å¯¹è±¡ã€‚</p><h2 id="è‡ªå®šä¹‰ç±»"><a href="#è‡ªå®šä¹‰ç±»" class="headerlink" title="è‡ªå®šä¹‰ç±»"></a>è‡ªå®šä¹‰ç±»</h2><p>è‡ªå®šä¹‰ä¸€ä¸ªPersonç±»ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Person</span> : <span class="hljs-title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-built_in">NSString</span> *_name;</span><br><span class="line">    <span class="hljs-built_in">NSInteger</span> _age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">@end</span></span><br></pre></td></tr></table></figure><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o person</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤å°†ä¸Šè¿°æ–‡ä»¶ç¼–è¯‘ä¸ºc++ï¼Œå¯ä»¥çœ‹åˆ°Personç±»çš„å®è´¨ä¸ºï¼š</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NSObject_IMPL</span> &#123;</span></span><br><span class="line">Class isa;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Person_IMPL</span> &#123;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NSObject_IMPL</span> <span class="hljs-title">NSObject_IVARS</span>;</span></span><br><span class="line">NSString *_name;</span><br><span class="line">NSInteger _age;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ•´ç†ä¸ºï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">struct</span> Person_IMPL &#123;</span><br><span class="line">Class isa;</span><br><span class="line"><span class="hljs-built_in">NSString</span> *_name;</span><br><span class="line"><span class="hljs-built_in">NSInteger</span> _age;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå› ä¸ºNSObjectä¸­ï¼Œisaæ˜¯ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œæ‰€ä»¥isaçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚</p><h2 id="ä¸€ä¸ªNSObjectå ç”¨å¤šå°‘å†…å­˜"><a href="#ä¸€ä¸ªNSObjectå ç”¨å¤šå°‘å†…å­˜" class="headerlink" title="ä¸€ä¸ªNSObjectå ç”¨å¤šå°‘å†…å­˜"></a>ä¸€ä¸ªNSObjectå ç”¨å¤šå°‘å†…å­˜</h2><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">NSObject</span> *object = [[<span class="hljs-built_in">NSObject</span> alloc] init]</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªobjectä½¿ç”¨äº†8ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå› ä¸ºé‡Œé¢æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡é’ˆæ˜¯8ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä½¿ç”¨äº†8ä¸ªå­—èŠ‚ã€‚é€šè¿‡<code>class_getInstanceSize</code> è·å–æ˜¯8ã€‚</p><p>ï¼ˆä¸ºä»€ä¹ˆæŒ‡é’ˆæ˜¯8ä¸ªå­—èŠ‚ã€‚CPU64ä½ï¼Œåœ°å€æ€»çº¿å°±æ˜¯64ä½ï¼Œ64ä½= 8bï¼‰</p><p>ä½†æ˜¯åœ¨64ä½ç³»ç»Ÿä¸‹ã€‚ä¸€ä¸ªobjectç³»ç»Ÿä¼šåˆ†é…16ä¸ªå­—èŠ‚ï¼Œå› ä¸ºiOSå †ç©ºé—´å†…å­˜åˆ†é…éƒ½æ˜¯16å­—èŠ‚çš„å€æ•°ã€‚å¯ä»¥é€šè¿‡ <code>malloc_size</code> å‡½æ•°æŸ¥è¯¢ä¸º16ã€‚</p><ul><li><code>class_getInstanceSize</code>å¯¹è±¡è‡³å°‘éœ€è¦å å¤šå°‘å†…å­˜(æ¶‰åŠå†…å­˜å¯¹é½ï¼Œä¸€èˆ¬æ˜¯ç»“æ„ä½“çš„å¤§å°å¿…é¡»æ˜¯æœ€å¤§æˆå‘˜å¤§å°çš„å€æ•°ã€‚å†…å­˜å¯¹é½è§„åˆ™å¾ˆå¤šï¼Œæš‚æ—¶ä¸éœ€è¦ç‰¹åˆ«è¯¦ç»†çš„ç†è§£ã€‚çŸ¥é“æœ‰å†…å­˜å¯¹é½å°±è¡Œäº†ã€‚)</li><li><code>malloc_size</code> ç³»ç»ŸçœŸå®åˆ†é…äº†å¤šå°‘å†…å­˜ï¼Œ(iOSå †ç©ºé—´å†…å­˜åˆ†é…éƒ½æ˜¯16å­—èŠ‚çš„å€æ•°)</li></ul><p>å¦‚ä¸‹çš„Personç±»åˆ†åˆ«ä½¿ç”¨<code>class_getInstanceSize</code>å’Œ<code>malloc_size</code>è®¡ç®—å‡ºå¤§å°ï¼Œåˆ†åˆ«æ˜¯å‡ å‘¢ï¼Ÿ</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Person</span>: <span class="hljs-title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-built_in">NSString</span> *_name;</span><br><span class="line">    <span class="hljs-built_in">NSInteger</span> _age;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-keyword">@end</span></span><br></pre></td></tr></table></figure><p>ç­”æ¡ˆæ˜¯24å’Œ32ã€‚å› ä¸ºPersonç±»ï¼Œå†…éƒ¨æœ‰_nameå±æ€§å’Œ _ageä¸¤ä¸ªå±æ€§ï¼Œåˆ†åˆ«éƒ½æ˜¯8ä¸ªå­—èŠ‚ï¼Œå†åŠ ä¸Šé€šè¿‡ç»§æ‰¿è·å¾—çš„isaæŒ‡é’ˆï¼Œæ‰€ä»¥æ˜¯24ä¸ªå­—èŠ‚ã€‚åˆå› ä¸ºç³»ç»Ÿåˆ†é…éƒ½æ˜¯16å­—èŠ‚çš„å€æ•°ï¼Œæ‰€ä»¥ç³»ç»ŸçœŸå®ä¼šåˆ†é…32å­—èŠ‚ã€‚</p><h2 id="å¯¹è±¡ã€ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡"><a href="#å¯¹è±¡ã€ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡" class="headerlink" title="å¯¹è±¡ã€ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡"></a>å¯¹è±¡ã€ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡</h2><p><img src="https://i.loli.net/2019/12/02/35CyexBGoZTtjVw.png" alt="objc_class.png" style="zoom:50%;"></p><p>è¿™ä¸ªå›¾å¾ˆç»å…¸äº†ã€‚è¦å¼ºè°ƒçš„ç‚¹æ˜¯å³ä¸Šè§’çš„<code>Root Class(meta)</code>ã€‚å®ƒçš„isaæŒ‡å‘è‡ªå·±ï¼ŒsuperclassæŒ‡å‘<code>Root Class(class)</code>ã€‚è¿™é‡Œçš„<code>Root Class</code>,å…¶å®å°±å¯ä»¥çœ‹åšæ˜¯<code>NSObject</code>ï¼Œå› ä¸ºOCä¸­<code>NSObject</code>å°±æ˜¯<code>åŸºç±»</code>ã€‚ä»¥åŠä»»ä½•<code>meta-class</code>çš„<code>isa</code>æŒ‡é’ˆéƒ½æŒ‡å‘<code>Root Class(meta)</code>ã€‚</p><p>é€šè¿‡è¿™å¹…å›¾ï¼Œå¯ä»¥æ¸…æ¥šçš„äº†è§£åˆ°ï¼š<code>instance</code>ã€<code>class</code>ã€<code>meta-class</code>ä¹‹é—´é€šè¿‡<code>isa</code>æŒ‡é’ˆè¿æ¥èµ·æ¥ï¼Œçˆ¶å­ç±»ä¹‹é—´é€šè¿‡<code>superclass</code>æŒ‡é’ˆè¿æ¥èµ·æ¥ã€‚é€šè¿‡è¿™æ ·ï¼Œä¸ç®¡æ˜¯<code>instance</code>è¿˜æ˜¯<code>class</code>ï¼Œå°±éƒ½å¯ä»¥è½»æ˜“çš„æ‰¾åˆ°å…¶æ‰€æ‹¥æœ‰çš„æ–¹æ³•ï¼Œå±æ€§ç­‰ä¿¡æ¯ã€‚</p><h3 id="instance"><a href="#instance" class="headerlink" title="instance"></a>instance</h3><p>é€šè¿‡alloc åˆ›å»ºçš„éƒ½æ˜¯instanceï¼Œallocåˆ†é…å†…å­˜ï¼Œinitè¿›è¡Œåˆå§‹åŒ–ã€‚</p><h3 id="class"><a href="#class" class="headerlink" title="class"></a>class</h3><p>ä¸ºä»€ä¹ˆè¦æœ‰classå¯¹è±¡ï¼Ÿå› ä¸ºè‹¹æœä½¿ç”¨classå¯¹è±¡æ¥ä¿å­˜instanceçš„å±æ€§ä¿¡æ¯ï¼Œå¯¹è±¡æ–¹æ³•ä¿¡æ¯ï¼Œç±»æ‰€éµå®ˆçš„åè®®ä¿¡æ¯ï¼Œæˆå‘˜å˜é‡ä¿¡æ¯ç­‰ç­‰ï¼Œè€Œä¸æ˜¯ä¿å­˜åœ¨instanceé‡Œï¼Œè¿™æ ·å¯ä»¥åœ¨å†…å­˜ä¸­ä»…ä¿å­˜ä¸€ä¸ªclasså¯¹è±¡å³å¯ã€‚</p><p>æˆ‘ä»¬ç»å¸¸è¯´instanceå®ä¾‹å¯¹è±¡æ˜¯ä¿å­˜åœ¨å †é‡Œé¢çš„ï¼Œé‚£classå’Œmeta-classå‘¢ã€‚ç­”æ¡ˆè‚¯å®šæ˜¯ç›¸åŒçš„ï¼Œå› ä¸ºclasså’Œmeta-classçš„æœ¬è´¨åŒæ ·ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥è‚¯å®šä¿å­˜åœ¨å †åŒºã€‚æˆ‘å°è¯•å»éªŒè¯äº†ä¸€ä¸‹ï¼ŒéªŒè¯çš„æ–¹æ³•è°ˆä¸ä¸Šå·§å¦™ï¼ŒæŒºæ„šè ¢çš„ï¼Œä½†æ˜¯èƒ½å¤ŸéªŒè¯ç»“è®ºå°±è¡Œã€‚éªŒè¯æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>æˆ‘ä»¬çŸ¥é“iOSç¨‹åºåœ¨å†…å­˜ä¸­çš„å¸ƒå±€<code>ä»ä½åˆ°é«˜</code>å¦‚ä¸‹ï¼š</p><p><code>ä»£ç åŒº</code> -&gt; <code>å¸¸é‡åŒº</code> -&gt; <code>å…¨å±€åŒº(å·²åˆå§‹åŒ–)</code> -&gt; <code>å…¨å±€åŒº(æœªåˆå§‹åŒ–)</code> -&gt; <code>å †åŒº</code> -&gt; <code>æ ˆåŒº</code></p><p>æˆ‘å°è¯•æ‰“å° å¸¸é‡åŒºå˜é‡çš„åœ°å€ï¼Œå…¨å±€åŒºå˜é‡çš„åœ°å€ï¼Œå †åŒºå˜é‡çš„åœ°å€ã€æ ˆåŒºå˜é‡çš„åœ°å€ã€‚æœ€åå†æ‰“å°ç±»å¯¹è±¡çš„åœ°å€ï¼Œçœ‹çœ‹ç±»å¯¹è±¡çš„åœ°å€å’Œä¸Šé¢æ‰€è¯´çš„æˆ‘æ˜ç¡®çŸ¥é“æ˜¯å“ªä¸ªåŒºçš„å˜é‡çš„åœ°å€æ¥è¿‘ï¼Œå°±è¯æ˜ç±»å¯¹è±¡åˆ°åº•æ˜¯åœ¨å“ªä¸ªåŒºå­˜æ”¾ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//num1æ˜¯å·²åˆå§‹åŒ–å˜é‡ï¼Œå­˜æ”¾åœ¨å…¨å±€åŒºçš„å·²åˆå§‹åŒ–åŒº</span></span><br><span class="line"><span class="hljs-keyword">int</span> num1 = <span class="hljs-number">200</span>;</span><br><span class="line"><span class="hljs-comment">//num2æ˜¯æœªåˆå§‹åŒ–å˜é‡ï¼Œå­˜æ”¾åœ¨å…¨å±€åŒºçš„æœªåˆå§‹åŒ–åŒº</span></span><br><span class="line"><span class="hljs-keyword">int</span> num2;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">int</span> main(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="hljs-keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="hljs-built_in">NSString</span> *str = <span class="hljs-string">@"a"</span>;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"stræŒ‡å‘å¸¸é‡åŒºåœ°å€ï¼š%p"</span>,str);</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"num1æŒ‡å‘å…¨å±€åŒº(å·²åˆå§‹åŒ–)åœ°å€ï¼š%p"</span>,&amp;num1);</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"num2æŒ‡å‘å…¨å±€åŒº(æœªåˆå§‹åŒ–)åœ°å€ï¼š%p"</span>,&amp;num2);</span><br><span class="line">        <span class="hljs-comment">//objectæŒ‡é’ˆæŒ‡å‘å †å†…å­˜ä¸­çš„ä¸€å—ã€‚ objectæŒ‡é’ˆæœ¬èº«åˆæ˜¯ä¿å­˜åœ¨æ ˆä¸Š</span></span><br><span class="line">        <span class="hljs-built_in">NSObject</span> *object = [[<span class="hljs-built_in">NSObject</span> alloc] init];</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"objectæŒ‡å‘çš„å †å†…å­˜ï¼š%p"</span>,object);</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"objectæŒ‡é’ˆåœ¨æ ˆä¸Šå­˜æ”¾çš„åœ°å€ï¼š%p"</span>,&amp;object);</span><br><span class="line">        Class objectClass = object_getClass(object);</span><br><span class="line">        Class objectMetaClass = object_getClass(objectClass);</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"objectClass æŒ‡å‘çš„åœ°å€ï¼š%p"</span>,objectClass);</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"objectMetaClass æŒ‡å‘çš„åœ°å€ï¼š%p"</span>,objectMetaClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°å¦‚ä¸‹</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stræŒ‡å‘å¸¸é‡åŒºåœ°å€ï¼š0x100001050</span><br><span class="line">num1æŒ‡å‘å…¨å±€åŒº(å·²åˆå§‹åŒ–)åœ°å€ï¼š0x1000012d0</span><br><span class="line">num2æŒ‡å‘å…¨å±€åŒº(æœªåˆå§‹åŒ–)åœ°å€ï¼š0x1000012d4</span><br><span class="line">objectæŒ‡å‘çš„å †å†…å­˜ï¼š0x101887690</span><br><span class="line">objectæŒ‡é’ˆåœ¨æ ˆä¸Šå­˜æ”¾çš„åœ°å€ï¼š0x7ffeefbff570</span><br><span class="line">objectClass æŒ‡å‘çš„åœ°å€ï¼š0x100b37140</span><br><span class="line">objectMetaClass æŒ‡å‘çš„åœ°å€ï¼š0x100b370f0</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶class å’Œ meta-classåœ°å€æ˜¯ä»‹äº num2(å…¨å±€åŒº(æœªåˆå§‹åŒ–)) å’Œ objectæŒ‡å‘çš„å †å†…å­˜ä¹‹é—´ã€‚åˆå› ä¸ºclasså’Œmeta-class è‚¯å®šä¸å¯èƒ½æ˜¯åœ¨å…¨å±€åŒº(æœªåˆå§‹åŒ–)ï¼Œæ‰€ä»¥é‚£è‚¯å®šæ˜¯åœ¨å †åŒºå•¦ã€‚</p><p>çŸ¥é“äº†classç±»å¯¹è±¡æ˜¯ç”¨æ¥ä¿å­˜å¯¹è±¡çš„å±æ€§ä¿¡æ¯ï¼Œå˜é‡ä¿¡æ¯ï¼Œæ–¹æ³•ä¿¡æ¯ç­‰ï¼Œé‚£ä»–åˆ°åº•æ˜¯æ€ä¹ˆä¿å­˜è¿™äº›ä¿¡æ¯çš„å‘¢ï¼Ÿ</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="hljs-comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="hljs-keyword">cache_t</span> cache;             <span class="hljs-comment">// formerly cache pointer and vtable</span></span><br><span class="line">    <span class="hljs-keyword">class_data_bits_t</span> bits;    <span class="hljs-comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">class_rw_t</span> *data() &#123; </span><br><span class="line">        <span class="hljs-keyword">return</span> bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">  .... çœç•¥</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//bits.data()</span></span><br><span class="line"><span class="hljs-keyword">class_rw_t</span>* data() &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">class_rw_t</span> *)(bits &amp; FAST_DATA_MASK);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æºç ï¼Œobjc_classä»…ä»…ä¹Ÿåªæ˜¯æœ‰4ä¸ªå˜é‡ï¼š</p><ol><li>isa</li><li>superclass</li><li>cache</li><li>bits</li></ol><p>isaï¼Œsuperclassæ˜¯ä»€ä¹ˆä¸Šæ–‡å·²ç»è®²è¿‡äº†ï¼Œcacheçœ‹åå­—å°±çŸ¥é“æ˜¯å’Œç¼“å­˜ç›¸å…³ï¼Œè¿™é‡Œæš‚æ—¶ä¸ä»‹ç»ã€‚é‚£å°±åªå‰©ä¸‹bitsè¿™ä¸€ä¸ªå˜é‡äº†ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯å’Œbitsæœ‰å…³ã€‚</p><p>æŸ¥çœ‹class_rw_t *data(){}æ–¹æ³•ï¼Œè¿”å›å€¼æ˜¯class_rw_tï¼š</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">class_rw_t</span> &#123;</span></span><br><span class="line">    <span class="hljs-comment">// Be warned that Symbolication knows the layout of this structure.</span></span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">class_ro_t</span> *ro;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">method_array_t</span> methods;</span><br><span class="line">    <span class="hljs-keyword">property_array_t</span> properties;</span><br><span class="line">    <span class="hljs-keyword">protocol_array_t</span> protocols;</span><br><span class="line"></span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">char</span> *demangledName;</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> SUPPORT_INDEXED_ISA</span></span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> index;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setFlags</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> <span class="hljs-built_in">set</span>)</span> </span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        OSAtomicOr32Barrier(<span class="hljs-built_in">set</span>, &amp;flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clearFlags</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> clear)</span> </span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        OSAtomicXor32Barrier(clear, &amp;flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// set and clear must not overlap</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">changeFlags</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> <span class="hljs-built_in">set</span>, <span class="hljs-keyword">uint32_t</span> clear)</span> </span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        assert((<span class="hljs-built_in">set</span> &amp; clear) == <span class="hljs-number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">uint32_t</span> oldf, newf;</span><br><span class="line">        <span class="hljs-keyword">do</span> &#123;</span><br><span class="line">            oldf = flags;</span><br><span class="line">            newf = (oldf | <span class="hljs-built_in">set</span>) &amp; ~clear;</span><br><span class="line">        &#125; <span class="hljs-keyword">while</span> (!OSAtomicCompareAndSwap32Barrier(oldf, newf, (<span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int32_t</span> *)&amp;flags));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">class_ro_t</span> &#123;</span></span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> instanceStart;</span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> instanceSize;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> reserved;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span> * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * name;</span><br><span class="line">    <span class="hljs-keyword">method_list_t</span> * baseMethodList;</span><br><span class="line">    <span class="hljs-keyword">protocol_list_t</span> * baseProtocols;</span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">ivar_list_t</span> * ivars;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span> * weakIvarLayout;</span><br><span class="line">    <span class="hljs-keyword">property_list_t</span> *baseProperties;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">method_list_t</span> *baseMethods() <span class="hljs-keyword">const</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> baseMethodList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹class_rw_tç»“æ„ä½“ä»£ç ã€‚å…¶ä¸­æœ‰å‡ ä¸ªå˜é‡ï¼š methodsï¼Œpropertiesï¼Œprotocolsï¼Œclass_ro_t *roã€‚</p><p>çœ‹åˆ°è¿™é‡Œå°±èƒ½æ˜ç™½äº†ï¼Œé€šè¿‡bits.data()=&gt; (class_rw_t *)(bits &amp; FAST_DATA_MASK) ,è·å–class_rw_tç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ä¿å­˜äº†ç›¸å…³ç±»çš„æ–¹æ³•ä¿¡æ¯ï¼Œå±æ€§ä¿¡æ¯ï¼Œåè®®ä¿¡æ¯ï¼Œä»¥åŠæˆå‘˜å˜é‡ä¿¡æ¯ç­‰ã€‚class_ro_tè¿™é‡Œï¼Œæˆ‘çŒœæµ‹roæ˜¯readonlyçš„æ„æ€ï¼Œä¿å­˜çš„æ˜¯åªè¯»ï¼Œä¸å¯å˜çš„ç±»ä¿¡æ¯ï¼ŒåŒ…æ‹¬æˆå‘˜å˜é‡ï¼Œç±»åç­‰ä¿¡æ¯</p><h3 id="meta-class"><a href="#meta-class" class="headerlink" title="meta-class"></a>meta-class</h3><p>é€šè¿‡<code>objc_getClass(class)</code>æ–¹æ³•æ¥è·å–meta-class(å…ƒç±»å¯¹è±¡)ã€‚</p><p>æ¯ä¸ªç±»åœ¨å†…å­˜ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªÂ·å¯¹è±¡ã€‚meta-classä¸classéƒ½æ˜¯Classç±»å‹ã€‚ä¸»è¦å­˜å‚¨ç±»æ–¹æ³•ä¿¡æ¯ç­‰ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class cls = [[Person <span class="hljs-keyword">class</span>] <span class="hljs-keyword">class</span>];</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç è·å–çš„clsæ˜¯classå¯¹è±¡(ç±»å¯¹è±¡)ï¼Œå¹¶ä¸æ˜¯meta-classå¯¹è±¡(å…ƒç±»å¯¹è±¡)ã€‚</p><p>åŸå› åœ¨äºï¼Œç¬¬ä¸€ä¸ªclass æ–¹æ³•æ˜¯ç±»æ–¹æ³•ï¼Œç¬¬äºŒä¸ªclassæ–¹æ³•ä»æ˜¯ç±»æ–¹æ³•ï¼ˆä¸ºä»€ä¹ˆç¬¬äºŒä¸ªclassä»ç„¶æ˜¯ç±»æ–¹æ³•ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªclassè°ƒç”¨åå¾—åˆ°çš„æ˜¯ç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡è°ƒç”¨çš„è‚¯å®šåˆç±»æ–¹æ³•å•¦ï¼‰ã€‚</p><p>çœ‹ä¸€ä¸‹<code>+(Class)class:</code>æ–¹æ³•çš„å®ç°å°±æ˜ç™½äº†ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+ (Class)<span class="hljs-keyword">class</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)<span class="hljs-keyword">class</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> object_getClass(<span class="hljs-keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class object_getClass(<span class="hljs-keyword">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (obj) <span class="hljs-keyword">return</span> obj-&gt;getIsa();</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> Nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="isaæŒ‡é’ˆ"><a href="#isaæŒ‡é’ˆ" class="headerlink" title="isaæŒ‡é’ˆ"></a>isaæŒ‡é’ˆ</h2><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">union</span> <span class="hljs-keyword">isa_t</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="hljs-keyword">isa_t</span>(<span class="hljs-keyword">uintptr_t</span> value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    <span class="hljs-keyword">uintptr_t</span> bits;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(ISA_BITFIELD)</span></span><br><span class="line">    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span></span><br><span class="line">        ISA_BITFIELD;  <span class="hljs-comment">// defined in isa.h</span></span><br><span class="line">        </span><br><span class="line"><span class="hljs-comment">//        uintptr_t nonpointer        : 1; /*0 è¡¨ç¤ºæ™®é€šçš„ isa æŒ‡é’ˆï¼Œ1 è¡¨ç¤ºä½¿ç”¨ä¼˜åŒ–ï¼Œå­˜å‚¨å¼•ç”¨è®¡æ•°*/</span></span><br><span class="line"><span class="hljs-comment">//        uintptr_t has_assoc         : 1;</span></span><br><span class="line"><span class="hljs-comment">//        uintptr_t has_cxx_dtor      : 1;  /*è¡¨ç¤ºè¯¥å¯¹è±¡æ˜¯å¦æœ‰ C++ æˆ– ARC çš„ææ„å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ææ„æ—¶æ›´å¿«*/</span></span><br><span class="line"><span class="hljs-comment">//        uintptr_t shiftcls          : 33; /*MACH_VM_MAX_ADDRESS 0x1000000000*/</span></span><br><span class="line"><span class="hljs-comment">//        uintptr_t magic             : 6;</span></span><br><span class="line"><span class="hljs-comment">//        uintptr_t weakly_referenced : 1;</span></span><br><span class="line"><span class="hljs-comment">//        uintptr_t deallocating      : 1;</span></span><br><span class="line"><span class="hljs-comment">//        uintptr_t has_sidetable_rc  : 1;  /*å¦‚æœä¸º1 è¡¨ç¤ºè¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨ isa æŒ‡é’ˆ*/</span></span><br><span class="line"><span class="hljs-comment">//        uintptr_t extra_rc          : 19;</span></span><br><span class="line">    &#125;;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šæ–‡æåˆ°ï¼Œinstanceçš„isaæŒ‡é’ˆæ˜¯æŒ‡å‘classï¼ˆç±»å¯¹è±¡ï¼‰ï¼Œå‘¢ä¹Ÿå°±æ˜¯è¯´isaæŒ‡é’ˆçš„å€¼å°±æ˜¯classçš„åœ°å€ã€‚ä½†æ˜¯ä»ä¸Šé¢çš„æºç å¯ä»¥çœ‹å‡ºï¼Œisaæ˜¯isa_tç±»å‹ï¼Œisa_tæ˜¯ä¸€ä¸ªunionã€‚</p><p>æŸ¥çœ‹å¦‚ä¸‹æºç ï¼Œisaéœ€è¦è¿›è¡Œä¸€æ¬¡ä½è¿ç®—ï¼Œæ‰èƒ½è®¡ç®—å‡ºçœŸå®åœ°å€ï¼š</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">inline</span> Class </span><br><span class="line">objc_object::ISA() </span><br><span class="line">&#123;</span><br><span class="line">    assert(!isTaggedPointer()); </span><br><span class="line">  <span class="hljs-comment">// SUPPORT_INDEXD_ISA å§‹ç»ˆæœª0</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> SUPPORT_INDEXED_ISA</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (isa.nonpointer) &#123;</span><br><span class="line">        <span class="hljs-keyword">uintptr_t</span> slot = isa.indexcls;</span><br><span class="line">        <span class="hljs-keyword">return</span> classForIndex((<span class="hljs-keyword">unsigned</span>)slot);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> (Class)isa.bits;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span></span><br><span class="line">    <span class="hljs-keyword">return</span> (Class)(isa.bits &amp; ISA_MASK);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æºç ä¸­å‘ç°ï¼ŒSUPPORT_INDEXD_ISA è¿™ä¸ªå®å§‹ç»ˆæœª0ï¼Œï¼Œä¸”isaæ˜¯è”åˆä½“unionï¼Œisa.bitså…¶å®å°±æ˜¯isaçš„å€¼ã€‚</p><p>æˆ‘åœ¨Macç”µè„‘ä¸Šï¼Œx86æ¶æ„ä¸‹æµ‹è¯•ï¼Œå‘ç°instanceçš„isaåœ°å€å’Œclassçš„åœ°å€æ˜¯ä¸€æ ·çš„ã€‚å¹¶ä¸”isa &amp; ISA_MASKåï¼Œç»“æœä»ç„¶æ˜¯isaçš„å€¼ã€‚</p><p>äºæ˜¯æˆ‘ä½¿ç”¨çœŸæœºæµ‹è¯•ï¼Œå‘ç°isaçš„å€¼å’Œclassçš„åœ°å€ç¡®å®ä¸ä¸€æ ·äº†ï¼Œéœ€è¦isa &amp; ISA_MASKï¼Œæ‰èƒ½è·å–classçš„åœ°å€</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">Class personClass = object_getClass(person);</span><br></pre></td></tr></table></figure><h2 id="ä¸€é“æµ‹è¯•é¢˜"><a href="#ä¸€é“æµ‹è¯•é¢˜" class="headerlink" title="ä¸€é“æµ‹è¯•é¢˜"></a>ä¸€é“æµ‹è¯•é¢˜</h2><p>åšä¸€ä¸ªå°æµ‹è¯•ï¼Œæ£€éªŒä¸Šé¢çš„å­¦ä¹ æˆæœã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">BOOL</span> res1 = [[<span class="hljs-built_in">NSObject</span> <span class="hljs-keyword">class</span>] isKindOfClass:[<span class="hljs-built_in">NSObject</span> <span class="hljs-keyword">class</span>]];</span><br><span class="line"><span class="hljs-built_in">BOOL</span> res2 = [[Person <span class="hljs-keyword">class</span>] isKindOfClass:[Person <span class="hljs-keyword">class</span>]];</span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%d %d"</span>,res1,res2);</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹ä»£ç æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆ<strong>è¿™é“é¢˜ç›®æœ¬èº«å°±å¾ˆæ‰¯ï¼Œæ²¡æœ‰ä»€ä¹ˆä»·å€¼ï¼Œä¼šä¸ä¸ä¼šæ— å…³ç´§è¦ï¼Œä»…ä»…å°±æ˜¯åŠ æ·±å¯¹ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡ä¹‹é—´å…³ç³»çš„ç†è§£ã€‚</strong>ï¼‰</p><p>ç­”æ¡ˆæ˜¯ res1 = 1 ,res2 = 0ã€‚ä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªç›¸ç­‰ï¼Œç¬¬äºŒä¸ªä¸ç›¸ç­‰ã€‚è¿™ä¸ªé—®é¢˜æ˜¯åœ¨ç½‘ä¸Šä¸€ç¯‡æ–‡ç« çœ‹åˆ°çš„ï¼š<a href="https://www.jianshu.com/p/b26b6feb58f6" target="_blank" rel="noopener">https://www.jianshu.com/p/b26b6feb58f6</a> <strong>è™½ç„¶ä½œè€…ç»™å‡ºçš„ç­”æ¡ˆæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯è§£é‡Šå´å®Œå…¨æ˜¯é”™è¯¯çš„</strong>ã€‚(ä¸çŸ¥é“ä¸ºä»€ä¹ˆç½‘ä¸Šå…³äºOCå¯¹è±¡æœ¬è´¨çš„æ–‡ç« çœŸçš„æ˜¯æ•°ä¸èƒœæ•°ï¼Œä½†æ˜¯çœŸå¿ƒæ²¡æœ‰ä»€ä¹ˆå‚è€ƒä»·å€¼ï¼Œè¦ä¹ˆæ˜¯å¤ªæµ…æ˜¾ï¼Œè¦ä¹ˆå°±æ˜¯å„ç§é”™è¯¯)</p><p><code>NSObject</code> æœ‰ä¸¤ä¸ª <code>isKindOfClass</code>æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å¯¹è±¡æ–¹æ³• ä¸€ä¸ªæ˜¯ç±»æ–¹æ³•ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="hljs-built_in">BOOL</span>)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    <span class="hljs-keyword">for</span> (Class tcls = [<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]; tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (tcls == cls) <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="hljs-built_in">BOOL</span>)isSubclassOfClass:(Class)cls &#123;</span><br><span class="line">    <span class="hljs-keyword">for</span> (Class tcls = <span class="hljs-keyword">self</span>; tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (tcls == cls) <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢é¢˜ç›®ä¸­çš„ä»£ç è°ƒç”¨çš„å¾ˆæ˜¾ç„¶æ˜¯<strong>+ç±»æ–¹æ³•</strong>ï¼Œä½†æ˜¯æˆ‘çœ‹çš„è¿™ç¯‡æ–‡ç« çš„ä½œè€…å´æ˜¯åœ¨æ‹¿<strong>-å¯¹è±¡æ–¹æ³•</strong>åœ¨è§£é‡Šï¼Œè¿™ä¸æ˜¯åœ¨è¯¯å¯¼ç¾¤ä¼—å˜›==ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="hljs-built_in">NSObject</span> <span class="hljs-keyword">class</span>] isKindOfClass:[<span class="hljs-built_in">NSObject</span> <span class="hljs-keyword">class</span>]];</span><br><span class="line"></span><br><span class="line">+ (<span class="hljs-built_in">BOOL</span>)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    <span class="hljs-keyword">for</span> (Class tcls = object_getClass((<span class="hljs-keyword">id</span>)<span class="hljs-keyword">self</span>); tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (tcls == cls) <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é‡Šï¼š</p><p>è¿™é‡Œåªè§£é‡Šç¬¬ä¸€ä¸ªä¸ºä»€ä¹ˆä¸º1ï¼Œä¹Ÿå°±æ˜¯trueï¼Œæ˜ç™½ç¬¬ä¸€ä¸ªè‡ªç„¶ç¬¬äºŒä¸ªä¹Ÿå°±æ˜ç™½äº†ã€‚</p><p>[NSObject class]è°ƒç”¨ +isKindOfClassæ–¹æ³•<br>+isKindOfClass å†…éƒ¨æ˜¯ä¸€ä¸ªforå¾ªç¯ï¼Œæ¯æ¬¡è°ƒç”¨ç»“æŸä¼š tcls = tcls-&gt;superclass<br>ç¬¬ä¸€æ¬¡forå¾ªç¯ï¼š<br><code>tcls</code> = object_getClass(self), å› ä¸ºselfæ˜¯ç±»å¯¹è±¡ï¼Œæ‰€ä»¥ç»“æœæ˜¯<code>meta-class</code>ï¼Œå³å…ƒç±»å¯¹è±¡</p><p><code>tcls</code>æ˜¯<code>NSObject meta-class</code><br><code>cls</code> æ˜¯ <code>NSObject class</code></p><p>æ‰€ä»¥æ˜¾ç„¶ä¸ç›¸ç­‰ï¼›<br>ç¬¬ä¸€æ¬¡forå¾ªç¯ç»“æŸï¼šè°ƒç”¨ tcls = tcls-&gt;superclass</p><p>å› ä¸º<code>NSObject</code>æ˜¯<code>rootClass</code>ï¼Œæ‰€ä»¥<code>NSObject meta-class</code>çš„<code>superclass</code>æŒ‡å‘çš„æ˜¯<code>NSObject class</code>ï¼Œæ‰€ä»¥è°ƒç”¨å®Œæ¯•åï¼Œ<code>tcls</code>å°±ä»<code>meta-class</code>å˜æˆäº† <code>NSObject class</code><br>ç¬¬äºŒæ¬¡forå¾ªç¯æ—¶ï¼š</p><p><code>tcls</code>æ˜¯<code>NSObject class</code> ï¼Œ<code>cls</code>ä¹Ÿæ˜¯<code>NSObject cls</code>ï¼Œæ‰€ä»¥ç›¸ç­‰ï¼Œè¿”å›<strong>true</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸¤å¹´å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼š&lt;a href=&quot;http://www.wuqihan.cn/2016/05/08/Objective-C%E5%AF%B9%E8%B1%A1%E8%AF%A6%E8%A7%A3/&quot;&gt;Objective-Cç±»å¯¹è±¡&lt;/a&gt;ã€‚å½“åˆå¯¹OCçš„ç†è§£è¿˜ä»…ä»…æ˜¯åˆšå…¥é—¨ï¼Œä¹Ÿæ²¡æœ‰é‡åˆ°é—®é¢˜çœ‹æºç çš„ä¹ æƒ¯ï¼Œæ‰€ä»¥ä¸¤å¹´åï¼Œé‡æ–°å¯¹Objective-Cå¯¹è±¡åšä¸€ä¸ªæ€»ç»“ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
    
      <category term="ç±»å¯¹è±¡" scheme="http://www.wuqihan.cn/tags/%E7%B1%BB%E5%AF%B9%E8%B1%A1/"/>
    
      <category term="Objective-C" scheme="http://www.wuqihan.cn/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>æ±‡ç¼–å­¦ä¹ è¸©å‘è®°å½•</title>
    <link href="http://www.wuqihan.cn/2018/05/28/%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    <id>http://www.wuqihan.cn/2018/05/28/æ±‡ç¼–å­¦ä¹ è¸©å‘è®°å½•/</id>
    <published>2018-05-28T11:15:03.000Z</published>
    <updated>2019-09-03T11:45:58.535Z</updated>
    
    <content type="html"><![CDATA[<p>å¯¹äºæ±‡ç¼–å­¦ä¹ ï¼Œç½‘ä¸Šçš„èµ„æºç›¸æ¯”é«˜çº§è¯­è¨€ç®—æ˜¯æŒºå°‘çš„äº†ã€‚è¿™é‡Œï¼Œè®°å½•ä¸‹åœ¨å­¦ä¹ æ±‡ç¼–è¿‡ç¨‹è¸©è¿‡çš„å‘å’Œé‡è¿‡çš„é—®é¢˜ã€‚</p><a id="more"></a><h2 id="mov-ax-ffffh"><a href="#mov-ax-ffffh" class="headerlink" title="mov ax ffffh"></a>mov ax ffffh</h2><p><strong>mov ax ffffh</strong>è¿™æ®µæŒ‡ä»¤ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚</p><p>åŸå› ï¼šå¤§äº9ffffhçš„åå…­è¿›åˆ¶æ•°æ®ï¼Œå¦‚æœa000hã€a001hâ€¦â€¦ffffhç­‰ï¼Œåœ¨ä¹¦å†™çš„æ—¶å€™éƒ½æ˜¯ä»¥å­—æ¯å¼€å¤´ã€‚è€Œ<strong>åœ¨æ±‡ç¼–æºç¨‹åºä¸­ï¼Œæ•°æ®ä¸èƒ½ä»¥å­—æ¯å¼€å¤´</strong>ï¼Œæ‰€ä»¥è¦åœ¨å‰é¢åŠ 0ã€‚</p><p>åº”è¯¥æ”¹ä¸ºï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov ax 0ffffh</span><br></pre></td></tr></table></figure><h2 id="mov-ax-0h"><a href="#mov-ax-0h" class="headerlink" title="mov ax [0h]"></a>mov ax [0h]</h2><p>æŠŠåœ°å€ä¸º 1000h:[0h]çš„å†…å­˜å•å…ƒçš„å†…å®¹èµ‹å€¼ç»™axæ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè¿™æ ·å†™</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ax,1000h</span><br><span class="line">mov ds,ax</span><br><span class="line">mov ax,[0h]</span><br></pre></td></tr></table></figure><p>è¿™æ®µæ±‡ç¼–ä»£ç æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯å…¶ä¸­<strong>mov ax,[0h]</strong>åœ¨<code>masm</code>ç¼–è¯‘å™¨ä¸­æ˜¯äº²æµ‹æ˜¯æ— æ³•è¾¾åˆ°é¢„æœŸçš„æ•ˆæœï¼Œä¼šè¢«è§£é‡Šä¸º <strong>mov ax,0h</strong></p><p>ä¸ºäº†è¾¾åˆ°é¢„æœŸæ•ˆæœï¼Œå¯ä»¥æŠŠæŒ‡ä»¤æ”¹ä¸º</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov ax,ds:[0h]</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä½¿ç”¨<code>emu8086</code>ç¼–å†™æ±‡ç¼–ä»£ç ï¼Œå°±ä¸ä¼šå‡ºç°ä¸Šé¢çš„é—®é¢˜ã€‚</p><p>è‡ªä»å‡ºç°è¿™ä¸ªé—®é¢˜ã€‚æˆ‘å°±å†ä¹Ÿä¸é€‚ç”¨<code>masm</code>ç¼–è¯‘äº†ï¼Œä»¥å…è¸©åˆ°è·Ÿå¤šçš„å‘ã€‚</p><h2 id="Debug-exeå¸¸ç”¨å‘½ä»¤"><a href="#Debug-exeå¸¸ç”¨å‘½ä»¤" class="headerlink" title="Debug.exeå¸¸ç”¨å‘½ä»¤"></a>Debug.exeå¸¸ç”¨å‘½ä»¤</h2><ul><li><p>r</p><p>æŸ¥çœ‹å„ä¸ªå¯„å­˜å™¨</p></li><li><p>d</p><p>æŸ¥çœ‹å†…å­˜å•å…ƒ/å¯„å­˜å™¨ä¸­çš„å†…å®¹</p></li><li><p>u</p><p>æŸ¥çœ‹å†…å­˜å•å…ƒå¯¹åº”çš„æŒ‡ä»¤</p></li><li><p>e</p><p>å†™å…¥æŒ‡ä»¤</p></li><li><p>t</p><p>æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤</p></li><li><p>g</p><p>g xxxx (xxxxä¸ºå†…å­˜ç‰©ç†åœ°å€)ã€‚è¡¨ç¤ºç¨‹åºç›´æ¥æ‰§è¡Œåˆ° xxxxå¯¹åº”çš„æŒ‡ä»¤ã€‚</p></li><li><p>p</p><p>å¦‚æœä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯intï¼Œè¦æƒ³æ­£ç¡®æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ˜¯ç”¨p</p><p>å¦‚æœé‡åˆ°loopæƒ³è‡ªåŠ¨æ‰§è¡Œå®Œloopï¼Œå¯ä»¥ä½¿ç”¨p</p></li></ul><h2 id="å¯„å­˜å™¨ä¸­æœ€å¤§å­˜å‚¨çš„åè¿›åˆ¶æ•°ä¸º65535"><a href="#å¯„å­˜å™¨ä¸­æœ€å¤§å­˜å‚¨çš„åè¿›åˆ¶æ•°ä¸º65535" class="headerlink" title="å¯„å­˜å™¨ä¸­æœ€å¤§å­˜å‚¨çš„åè¿›åˆ¶æ•°ä¸º65535"></a>å¯„å­˜å™¨ä¸­æœ€å¤§å­˜å‚¨çš„åè¿›åˆ¶æ•°ä¸º65535</h2><p>x86 CPUä¸º16ä½ï¼Œä¹Ÿå°±æ˜¯è¯´å¯„å­˜å™¨ä¸º16ä½ï¼Œæœ€å¤§å­˜å‚¨ä¸¤ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ªå­—ã€‚</p><p>å¯„å­˜å™¨å­˜å‚¨çš„æœ€å¤§16è¿›åˆ¶æ•°ä¸ºffffh = 16^4-1=65535</p><p>æ‰€ä»¥åœ¨ä½¿ç”¨åè¿›åˆ¶èµ‹å€¼çš„æ—¶å€™ï¼Œæ³¨æ„ä¸è¦è¶…è¿‡65535</p><h2 id="å¦‚æœæ®µä¸­çš„æ•°æ®å Nä¸ªå­—èŠ‚ï¼Œåˆ™ç¨‹åºåŠ è½½åï¼Œè¯¥æ®µå®é™…å æœ‰ç©ºé—´ä¸ºå¤šå°‘ï¼Ÿ"><a href="#å¦‚æœæ®µä¸­çš„æ•°æ®å Nä¸ªå­—èŠ‚ï¼Œåˆ™ç¨‹åºåŠ è½½åï¼Œè¯¥æ®µå®é™…å æœ‰ç©ºé—´ä¸ºå¤šå°‘ï¼Ÿ" class="headerlink" title="å¦‚æœæ®µä¸­çš„æ•°æ®å Nä¸ªå­—èŠ‚ï¼Œåˆ™ç¨‹åºåŠ è½½åï¼Œè¯¥æ®µå®é™…å æœ‰ç©ºé—´ä¸ºå¤šå°‘ï¼Ÿ"></a>å¦‚æœæ®µä¸­çš„æ•°æ®å Nä¸ªå­—èŠ‚ï¼Œåˆ™ç¨‹åºåŠ è½½åï¼Œè¯¥æ®µå®é™…å æœ‰ç©ºé—´ä¸ºå¤šå°‘ï¼Ÿ</h2><p>ã€Šæ±‡ç¼–è¯­è¨€ã€‹ç¬¬ä¸‰ç‰ˆè¿™æœ¬ä¹¦ ç»™çš„ç­”æ¡ˆæ˜¯ï¼šï¼ˆN/16+1)*16</p><p>è¿™ä¸ªç­”æ¡ˆæ˜¯ <code>é”™è¯¯</code></p><p>å¦‚æœå½“N = 16æ—¶ï¼Œå¦‚æœæŒ‰ç…§ç­”æ¡ˆï¼Œå¾—åˆ°çš„æ˜¯32ï¼Œå…¶å®è¿˜æ˜¯16ã€‚å¦‚æœä¸ç¡®å®šï¼Œå¯ä»¥è‡ªå·±åŠ¨æ‰‹æµ‹è¯•ä¸€ä¸‹(ç»è¿‡æˆ‘è‡ªå·±çš„æµ‹è¯•ã€ç¡®å®ä¸æ˜¯32ï¼Œè€Œæ˜¯16)</p><p>å‡†ç¡®ç­”æ¡ˆæ˜¯ï¼š</p><ul><li><p><strong>å½“Nå¯ä»¥è¢«16æ•´é™¤æ—¶</strong></p><p>å æœ‰çš„ç©ºé—´ä¸º<code>(N/16)*16</code></p></li><li><p><strong>å½“Nä¸å¯ä»¥è¢«16æ•´é™¤æ—¶</strong></p><p>å æœ‰çš„ç©ºé—´ä¸º<code>(N/16+1)*16</code></p></li></ul><p>ä¸Šé¢ä¸¤ç§æƒ…å†µæ€»ç»“æˆä¸€ä¸ªé€šç”¨çš„å…¬å¼ï¼š<code>((N+15)/16)*16</code></p><blockquote><p>8086æ±‡ç¼–ä¸­ æ¯ä¸ªæ®µéƒ½æ˜¯ä»¥16å­—èŠ‚æ¥å¯¹é½çš„</p></blockquote><p>è‡³äºä¸ºä»€ä¹ˆè¿™æ ·å­è®¾è®¡ï¼Œæˆ‘è§‰å¾—åº”è¯¥æ˜¯æ ¹æ®8086CPUç‰¹æ®Šçš„å¯»å€æ–¹å¼(æ®µåœ°å€*16+åç§»åœ°å€ )æœ‰å…³ã€‚æ¯”å¦‚ä¸€ä¸ªæ®µä¸­çš„æ•°æ®å äº†17ä¸ªå†…å­˜å•å…ƒï¼Œé‚£ä¸‹ä¸€ä¸ªæ®µï¼Œè‚¯å®šä¸æ˜¯ä»ç¬¬18ä¸ªå†…å­˜å•å…ƒå¼€å§‹ï¼Œå› ä¸ºæ®µåœ°å€èµ·å§‹åœ°å€ï¼Œå¿…é¡»æ˜¯16çš„æ•´æ•°å€ã€‚æ‰€ä»¥å¦‚æœä¸€ä¸ªæ®µä¸­çš„æ•°æ®å 17ä¸ªå†…å­˜å•å…ƒï¼Œé‚£ç´§æŒ¨ç€å®ƒçš„ä¸‹ä¸€ä¸ªæ®µè‚¯å®šæ˜¯ä»ç¬¬33ä¸ªå†…å­˜å•å…ƒ(ä¹Ÿå°±æ˜¯ç¼–å·32å¼€å§‹)å¼€å§‹ã€‚</p><p>å¦‚æœç†è§£äº†ä¸Šé¢çš„é—®é¢˜ï¼Œå¯ä»¥åŠ¨æ‰‹åšä¸€ä¸‹ä¸‹é¢çš„é¢˜ç›®ï¼Œå·©å›ºå¯¹ä¸Šé¢çš„ç†è§£</p><p><img src="https://i.loli.net/2019/09/03/hHUOXtumjiCQgkw.png" alt="æ±‡ç¼–é¢˜ç›®.png"></p><p>ç­”æ¡ˆï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line"></span><br><span class="line">a segment </span><br><span class="line">db 1,2,3,4,5,6,7,8</span><br><span class="line">a ends</span><br><span class="line"></span><br><span class="line">b segment</span><br><span class="line">db 1,2,3,4,5,6,7,8</span><br><span class="line">b ends</span><br><span class="line"></span><br><span class="line">c segment</span><br><span class="line">db 0,0,0,0,0,0,0,0</span><br><span class="line">c ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line">mov ax,a</span><br><span class="line">mov ds,ax</span><br><span class="line"></span><br><span class="line">mov bx,0  </span><br><span class="line">mov cx,8</span><br><span class="line">s:mov al,ds:[bx]</span><br><span class="line">add al,ds:[bx+16] ; æ³¨æ„ï¼ï¼ï¼è¿™é‡Œæ˜¯16 ä¸æ˜¯8 æˆ‘ç¬¬ä¸€æ¬¡å†™çš„æ—¶å€™å†™æˆäº†8 ç»“æœåœ¨è°ƒè¯•çš„æ—¶å€™å‘ç°äº†è¿™ä¸ªé”™è¯¯</span><br><span class="line">mov ds:[bx+32],al ; æ³¨æ„ï¼ï¼ï¼è¿™é‡Œæ˜¯32 ä¸æ˜¯16</span><br><span class="line">add bx,1</span><br><span class="line">loop s</span><br><span class="line"></span><br><span class="line">mov ax,4c00h</span><br><span class="line">int 21h</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¯¹äºæ±‡ç¼–å­¦ä¹ ï¼Œç½‘ä¸Šçš„èµ„æºç›¸æ¯”é«˜çº§è¯­è¨€ç®—æ˜¯æŒºå°‘çš„äº†ã€‚è¿™é‡Œï¼Œè®°å½•ä¸‹åœ¨å­¦ä¹ æ±‡ç¼–è¿‡ç¨‹è¸©è¿‡çš„å‘å’Œé‡è¿‡çš„é—®é¢˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://www.wuqihan.cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
      <category term="æ±‡ç¼–è¯­è¨€" scheme="http://www.wuqihan.cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/"/>
    
    
      <category term="8086æ±‡ç¼–" scheme="http://www.wuqihan.cn/tags/8086%E6%B1%87%E7%BC%96/"/>
    
  </entry>
  
  <entry>
    <title>CPUå¯»å€èƒ½åŠ›åˆ°åº•æ€ä¹ˆç†è§£ï¼Ÿ</title>
    <link href="http://www.wuqihan.cn/2018/05/19/CPU%E5%AF%BB%E5%9D%80%E8%83%BD%E5%8A%9B%E5%88%B0%E5%BA%95%E6%80%8E%E4%B9%88%E7%90%86%E8%A7%A3%EF%BC%9F/"/>
    <id>http://www.wuqihan.cn/2018/05/19/CPUå¯»å€èƒ½åŠ›åˆ°åº•æ€ä¹ˆç†è§£ï¼Ÿ/</id>
    <published>2018-05-18T17:04:33.000Z</published>
    <updated>2019-11-01T15:25:05.703Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h2><p>é¦–å…ˆè®²è§£ä¸€ä¸‹<code>å­˜å‚¨å™¨</code></p><p><code>å­˜å‚¨å™¨</code>æ˜¯è®¡ç®—æœºé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä»–æ˜¯ç”¨æ¥å­˜å‚¨æ•°æ®å’Œéƒ¨ä»¶ã€‚å­˜å‚¨å™¨çš„ç§ç±»å¾ˆå¤šï¼ŒæŒ‰å„ç§è¯´æ³•åˆ†ç±»ä¹Ÿæœ‰å¾ˆå¤šã€‚ä¸‹é¢ä¸»è¦è®²è§£ä¸€ç§é€šå¸¸æ™®éçš„è¯´æ³•</p><p>ç°ä»£è®¡ç®—æœºå­˜å‚¨å™¨æŒ‰<strong>ç”¨é€”</strong>åˆ†ç±»ï¼Œå¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><p>ä¸»å­˜å‚¨å™¨ï¼Œç®€ç§°ä¸»å­˜</p><ul><li>RAM</li><li>ROM</li></ul></li><li><p>è¾…åŠ©å­˜å‚¨å™¨</p></li><li><p>Cache(é«˜çº§ç¼“å†²å­˜å‚¨å™¨)   (å®ƒä½äºCPUä¸ä¸»å­˜ä¹‹é—´ï¼Œæ˜¯è¯»å†™é€Ÿåº¦æ¯”å†…å­˜è¿˜å¿«çš„å­˜å‚¨å™¨ï¼Œä»åå­—åº”è¯¥å°±çŸ¥é“å®ƒçš„ä½œç”¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³CPUå’Œä¸»å­˜é€Ÿåº¦ä¸åŒ¹é…è€Œè®¾è®¡çš„ï¼Œå› ä¸ºCPUä¸­å¯„å­˜å™¨çš„é€Ÿåº¦æ›´æ›´å¿«ï¼Œæ‰€ä»¥å‡ºç°äº†é€Ÿåº¦èƒ½æ¥è¿‘äºCPUçš„Cache)</p><a id="more"></a></li></ul><blockquote><p>é€šå¸¸æˆ‘ä»¬ä¼šæŠŠä¸»å­˜å‚¨å™¨å«åšå†…å­˜ã€‚ä½†æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šè¯´ï¼Œå†…å­˜æ˜¯ç”±ä¸»å­˜ï¼ˆæ¯”å¦‚å†…å­˜æ¡ï¼‰ã€Cacheä¸¤éƒ¨åˆ†ç»„æˆã€‚ä½†æ˜¯å¯èƒ½ç”±äºCacheç›¸å¯¹äºå†…å­˜æ¡å®¹é‡ç‰¹åˆ«å°ï¼Œä»¥åŠå¾ˆä¹…ä¹‹å‰çš„è®¡ç®—æœºæ²¡æœ‰Cacheï¼Œæ‰€ä»¥å¾ˆå¤šæƒ…å†µï¼Œå¤§å®¶å°±é»˜è®¤å†…å­˜å°±æ˜¯ä¸»å­˜çš„è¯´æ³•äº†ã€‚</p></blockquote><p>é€šè¿‡ä¸Šé¢ä»‹ç»å­˜å‚¨å™¨ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ å†…å­˜ æ˜¯å­˜å‚¨å™¨çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå«ä¸»å­˜ã€‚</p><p>å†…å­˜æ˜¯CPUèƒ½ç›´æ¥å¯»å€çš„å­˜å‚¨ç©ºé—´ã€‚è®¡ç®—æœºä¸­æ‰€æœ‰çš„ç¨‹åºçš„è¿è¡Œéƒ½æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„ã€‚</p><p>å†…å­˜çš„ç‰¹ç‚¹æ˜¯é€Ÿç‡å¾ˆå¿«ã€‚ï¼ˆè¿™ç‚¹å¤§å®¶éƒ½åº”è¯¥çŸ¥é“ã€‚ï¼‰</p><p>æˆ‘ä»¬å¹³æ—¶ä¼šè¯´ â€œæˆ‘çš„ç”µè„‘å†…å­˜å¤ªå°ï¼Œåªæœ‰4Gï¼Œéœ€è¦åŠ å†…å­˜æ¡â€ï¼Œè¿™é‡Œæ‰€è¯´çš„ <strong>4G</strong>æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><p>å†…å­˜ä¸­å«æœ‰å¤§é‡çš„å­˜å‚¨å•å…ƒï¼Œ<code>æ¯ä¸ªå­˜å‚¨å•å…ƒçš„å¤§å°éƒ½æ˜¯1B</code>ï¼Œæ‰€ä»¥ä¸Šé¢æ‰€è¯´çš„4Gå†…å­˜ï¼Œæ„æ€å°±æ˜¯å®ƒæ˜¯æœ‰2<sup>2</sup>*2<sup>30</sup>ä¸ªå­˜å‚¨å•å…ƒã€‚</p><p>è¿™äº›ä¸ªå­˜å‚¨å•å…ƒç»„æˆåœ¨ä¸€èµ·ï¼Œå°±å«åš <code>å†…å­˜ç©ºé—´</code>,é‚£ä½•ä¸ºå†…å­˜åœ°å€å‘¢ï¼Ÿåœ¨å†…å­˜ä¸­ï¼Œæ¯ä¸ªå­˜å‚¨å•å…ƒéƒ½æœ‰ä¸€ä¸ªç¼–å·ï¼Œè¿™ä¸ªç¼–å·é€šå¸¸ç”¨16è¿›åˆ¶è¡¨ç¤ºï¼Œä»0å¼€å§‹ç¼–å·ã€‚è¿™ä¸ªç¼–å·å°±å«åšå†…å­˜åœ°å€ã€‚</p><p>ç†è§£äº† <code>å†…å­˜åœ°å€</code>å’Œ <code>å†…å­˜ç©ºé—´</code> æ‰èƒ½å…±æ¸…æ¥šçš„æ˜ç™½CPUå¯»å€ã€‚</p><h2 id="å¯»å€ç©ºé—´"><a href="#å¯»å€ç©ºé—´" class="headerlink" title="å¯»å€ç©ºé—´"></a>å¯»å€ç©ºé—´</h2><p>CPU<code>å¯»å€</code>ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å†…å­˜åœ°å€ï¼Œæ‰¾åˆ°å¯¹åº”çš„å­˜å‚¨å•å…ƒã€‚ä¸Šé¢å·²ç»æåˆ°è¿‡ï¼Œä¸€ä¸ªå­˜å‚¨å•å…ƒæ˜¯1Bã€‚</p><p>è§£é‡Šå¯»å€èƒ½åŠ›ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸‹ <code>å¯»å€ç©ºé—´</code> ï¼ˆ<code>Addressing space</code>ï¼‰çš„æ¦‚å¿µã€‚</p><blockquote><p><code>å¯»å€ç©ºé—´</code>ä¸€èˆ¬æŒ‡çš„æ˜¯CPUå¯¹äº<a href="https://baike.baidu.com/item/å†…å­˜å¯»å€/1012006" target="_blank" rel="noopener">å†…å­˜å¯»å€</a>çš„èƒ½åŠ›ã€‚é€šä¿—åœ°è¯´ï¼Œå°±æ˜¯èƒ½æœ€å¤šç”¨åˆ°å¤šå°‘å†…å­˜ç©ºé—´çš„ä¸€ä¸ªé—®é¢˜ã€‚æ•°æ®åœ¨<a href="https://baike.baidu.com/item/å­˜å‚¨å™¨/1583185" target="_blank" rel="noopener">å­˜å‚¨å™¨</a>(RAM)ä¸­å­˜æ”¾æ˜¯æœ‰è§„å¾‹çš„ ï¼ŒCPUåœ¨è¿ç®—çš„æ—¶å€™éœ€è¦æŠŠæ•°æ®æå–å‡ºæ¥å°±éœ€è¦çŸ¥é“æ•°æ®å­˜æ”¾åœ¨å“ªé‡Œ ï¼Œè¿™æ—¶å€™å°±éœ€è¦æŒ¨å®¶æŒ¨æˆ·çš„æ‰¾ï¼Œè¿™å°±å«åšå¯»å€ï¼Œä½†å¦‚æœåœ°å€å¤ªå¤šè¶…å‡ºäº†CPUçš„èƒ½åŠ›èŒƒå›´ï¼ŒCPUå°±æ— æ³•æ‰¾åˆ°æ•°æ®äº†ã€‚ CPUæœ€å¤§èƒ½æŸ¥æ‰¾å¤šå¤§èŒƒå›´çš„åœ°å€å«åšå¯»å€èƒ½åŠ› ï¼ŒCPUçš„å¯»å€èƒ½åŠ›ä»¥<a href="https://baike.baidu.com/item/å­—èŠ‚/1096318" target="_blank" rel="noopener">å­—èŠ‚</a>ä¸ºå•ä½ ï¼Œå¦‚32ä½å¯»å€çš„CPUå¯ä»¥å¯»å€2çš„32æ¬¡æ–¹å¤§å°çš„åœ°å€ä¹Ÿå°±æ˜¯4Gï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ32ä½çš„CPUæœ€å¤§èƒ½æ­é…4Gå†…å­˜çš„åŸå›  ï¼Œå†å¤šçš„è¯CPUå°±æ‰¾ä¸åˆ°äº†ã€‚</p></blockquote><p>ä¸Šé¢æåˆ°äº†ä½•ä¸º<code>å¯»å€èƒ½åŠ›</code>ï¼Ÿå°±æ˜¯<code>CPUæœ€å¤§èƒ½æŸ¥æ‰¾å¤šå¤§èŒƒå›´çš„åœ°å€</code>ã€‚<strong>åƒä¸‡ä¸è¦ç†è§£ä¸ºCPUæœ€å¤§èƒ½æŸ¥æ‰¾å¤šå¤§çš„åœ°å€</strong> è™½ç„¶è·Ÿä¸Šä¸€å¥æ¯”ä»…ä»…å°‘äº†ä¸€ä¸ªâ€™èŒƒå›´â€™ï¼Œä½†æ˜¯å®Œå…¨æ˜¯ä¸¤ä¸ªæ„æ€ã€‚ æˆ‘æœ€å¼€å§‹å°±ç†è§£æˆäº† æœ€å¤§èƒ½æŸ¥æ‰¾åˆ°å¤šå¤§çš„åœ°å€ã€‚ã€‚ã€‚</p><p>æˆ–è€…ä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼š<strong>CPUæœ€å¤šèƒ½æŸ¥æ‰¾å¤šå°‘ä¸ªåœ°å€</strong> ï¼ˆè¿™é‡Œå¤šå°‘ä¸ªåœ°å€ï¼ŒæŒ‡å¾—æ˜¯å¤šå°‘ä¸ªå­˜å‚¨å•å…ƒï¼Œå­˜å‚¨å•ä½æœ€å°å•ä½æ˜¯Byteï¼Œä¸æ˜¯bï¼‰ ã€‚æˆ–è€…å¯ä»¥ç†è§£ä¸º <strong>CPUå¯ä»¥å¯¹å¤šå°‘ä¸ªå­˜å‚¨å•å…ƒè¿›è¡Œå¯»å€</strong></p><p>åˆ°äº†è¿™é‡Œ åº”è¯¥å°±æ˜ç™½äº†<code>å¯»å€èƒ½åŠ›</code>çš„æ¦‚å¿µï¼Œä½†æ˜¯è¿˜ä¸å¤Ÿã€‚ã€‚</p><blockquote><p>æ³¨æ„ï¼šæ–‡ä¸­çš„â€œå­˜å‚¨å•å…ƒâ€æˆ–è€…â€œå†…å­˜å•å…ƒâ€æ„æ€æ˜¯ä¸€æ ·çš„ã€‚â€å†…å­˜ç©ºé—´â€å’Œâ€å­˜å‚¨ç©ºé—´â€ æ„æ€ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><h2 id="å¯»å€èƒ½åŠ›-Byte-or-Bite"><a href="#å¯»å€èƒ½åŠ›-Byte-or-Bite" class="headerlink" title="å¯»å€èƒ½åŠ› Byte or Bite?"></a>å¯»å€èƒ½åŠ› Byte or Bite?</h2><p>æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š</p><blockquote><p>8086CPUçš„åœ°å€æ€»çº¿å®½åº¦æ˜¯<code>20</code>ï¼Œé‚£ä¹ˆä»–çš„å¯»å€èƒ½åŠ›æ˜¯å¤§å‘¢</p></blockquote><p>çœ‹åˆ°è¿™é‡Œå¦‚æœä¸æ˜ç™½ä»€ä¹ˆæ˜¯åœ°å€æ€»çº¿ï¼Œè¯·çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç«  : <a href="http://www.wuqihan.cn/2018/05/15/å…¥é—¨æ±‡ç¼–è¯­è¨€/">å…¥é—¨æ±‡ç¼–è¯­è¨€</a></p><p>åœ°å€æ€»çº¿çš„å®½åº¦å†³å®šäº†CPUçš„å¯»å€èƒ½åŠ›ï¼Œå®½åº¦æ˜¯20ï¼Œä¹Ÿå°±ä»£è¡¨æœ‰20æ ¹å¯¼çº¿ï¼Œ æ¯æ ¹å¯¼çº¿å‘å°„çš„æ˜¯é«˜ã€ä½ç”µä¿¡å·ä¸¤ç§æƒ…å†µï¼Œæ‰€ä»¥å¯»å€èƒ½åŠ›ä¸º 2<sup>20</sup>B = <code>1M</code> </p><p>ä½†æ˜¯è¿™é‡Œå¯èƒ½ä¼šå‡ºç°å¾ˆå¤šäººéƒ½çº³é—·çš„é—®é¢˜ï¼Œ20æ ¹å¯¼çº¿ï¼Œä¸å°±æ˜¯20ä½å—ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯2<sup>20</sup>bã€‚é‚£ä¸ºä»€ä¹ˆæ˜¯ 2<sup>20</sup>B ï¼Œè€Œä¸æ˜¯2<sup>20</sup>b å‘¢ï¼Ÿ ï¼ˆBä¸ºByte/å­—èŠ‚ï¼Œbä¸ºbite/ä½ï¼‰</p><blockquote><p><code>ä½</code> ï¼Œè¡¨ç¤ºçš„æ˜¯äºŒè¿›åˆ¶ä½ï¼Œä¸€èˆ¬ç§°ä¸ºæ¯”ç‰¹ï¼Œå³0æˆ–1ï¼Œ<strong>æ˜¯è®¡ç®—æœºå­˜å‚¨çš„æœ€å°å•ä½</strong></p><p>å­—èŠ‚æ˜¯è®¡ç®—æœºä¸­æ•°æ®å¤„ç†çš„åŸºæœ¬å•ä½ï¼›è®¡ç®—æœºä»¥å­—èŠ‚ä¸ºå•ä½å­˜å‚¨å’Œè§£é‡Šä¿¡æ¯ï¼Œè§„å®šä¸€ä¸ªå­—èŠ‚ç”±8ä¸ªäºŒè¿›åˆ¶ä½æ„æˆï¼Œå³1B = 8b</p></blockquote><p>å› ä¸ºåœ°å€æ€»çº¿çš„å®½åº¦å†³å®šäº†CPUçš„ å¯»å€èƒ½åŠ›ï¼Œé‚£ä½•ä¸ºå¯»å€èƒ½åŠ›å‘¢ï¼Œè¯´é¢æåˆ°äº†ï¼Œå¯»å€èƒ½åŠ›å¯ä»¥ç†è§£ä¸ºCPUå¯ä»¥å¯¹å¤šå°‘ä¸ªå­˜å‚¨å•å…ƒè¿›è¡Œå¯»å€ï¼Œåœ°å€æ€»çº¿æ˜¯20ï¼Œé‚£ä¹ˆå°±ä»£è¡¨æœ€å¤šèƒ½æ‰¾åˆ°2<sup>20</sup>ä¸ªå­˜å‚¨å•å…ƒï¼Œåˆå› ä¸º8086ä¸­ä¸€ä¸ªå­˜å‚¨å•å…ƒæ˜¯1Bæ‰€ä»¥ï¼Œè¿™é‡Œæ˜¯2<sup>20</sup>B</p><p>çœ‹åˆ°è¿™é‡Œå¯èƒ½åˆä¼šç»§ç»­ç³Šæ¶‚ï¼Œå› ä¸ºä½ å¯èƒ½ä¸æ˜ç™½å­˜å‚¨å•å…ƒã€å†…å­˜åœ°å€ã€å†…å­˜ç©ºé—´åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä»–ä»¬ä¹‹é—´æœ‰ä»€ä¹ˆçš„è”ç³»ï¼Œæ‰€ä»¥å¾€ä¸‹çœ‹â€¦â€¦</p><h2 id="å†…å­˜åœ°å€ã€å†…å­˜å•å…ƒå’Œå†…å­˜ç©ºé—´"><a href="#å†…å­˜åœ°å€ã€å†…å­˜å•å…ƒå’Œå†…å­˜ç©ºé—´" class="headerlink" title="å†…å­˜åœ°å€ã€å†…å­˜å•å…ƒå’Œå†…å­˜ç©ºé—´"></a>å†…å­˜åœ°å€ã€å†…å­˜å•å…ƒå’Œå†…å­˜ç©ºé—´</h2><p>é¦–å…ˆã€‚åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œå¯èƒ½æœ‰æ—¶å€™ä½ çœ‹åˆ°çš„å†…å­˜åœ°å€æ˜¯4ä½16è¿›åˆ¶ï¼ˆ0x0001ï¼‰ï¼Œæœ‰æ—¶å€™ä½ çœ‹åˆ°çš„å†…å­˜åœ°å€æ˜¯8ä½16è¿›åˆ¶(0x00000001)ã€‚è¿™ä¸¤ä¸ªå†…å­˜åœ°å€éƒ½æ˜¯è¡¨ç¤ºç¼–å·å¤§å°ä¸ºåè¿›åˆ¶1çš„å†…å­˜åœ°å€ï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªç”¨4ä½16è¿›åˆ¶ï¼Ÿå¦å¤–ä¸€ä¸ªåˆç”¨8ä½16è¿›åˆ¶ï¼Ÿ(æ³¨æ„ï¼Œ0x0001 å’Œ 0x00000001 ä»…ä»…æ˜¯è¡¨ç¤ºæ–¹å¼ä¸ä¸€æ ·ï¼Œæ•°å€¼å¤§å°å¯æ˜¯ç›¸ç­‰çš„ï¼Œå¯åˆ«æè¿·ç³Šäº†ï¼ï¼‰</p><p><img src="https://i.loli.net/2019/08/18/aW98uSNHC54Jl6i.png" alt="8ä½16è¿›åˆ¶"></p><p><img src="https://i.loli.net/2019/08/18/eWXBPmOLKAdtYnD.png" alt="4ä½16è¿›åˆ¶"></p><p>è¿™å°±æ˜¯å› ä¸ºå¯»å€èƒ½åŠ›çš„é—®é¢˜ã€‚CPUå¯»å€èƒ½åŠ›è¾¾ä¸åˆ°8ä½16è¿›åˆ¶ï¼Œæ‰€ä»¥ç”¨4ä½16è¿›åˆ¶è¡¨ç¤ºå°±å¯ä»¥ï¼Œç†è®ºä¸Šä½ ç¡¬è¦ç”¨8ä½16è¿›åˆ¶è¡¨ç¤ºä¹Ÿå¯ä»¥ã€‚åªä¸è¿‡ä½ å¯»å€èƒ½åŠ›ä½ï¼Œä¸å¯èƒ½è¶…è¿‡4ä½ã€‚æ‰€ä»¥ å¯»å€èƒ½åŠ›ä½ï¼Œä¸ä¼šè¶…è¿‡4ä½çš„å°±ç”¨4ä½16è¿›åˆ¶ï¼Œèƒ½å¤Ÿè¶…è¿‡4çš„cpuå°±ç”¨8ä½16è¿›åˆ¶ã€‚</p><p>æ¥ä¸‹æ¥å°±è§£é‡Šä¸€ä¸‹<code>å†…å­˜åœ°å€</code>å’Œ <code>å†…å­˜å•å…ƒ</code></p><p><code>å†…å­˜åœ°å€</code> ä»…ä»…æ˜¯ä¸€ä¸ªæ ‡å·ï¼Œä»£è¡¨ä¸€ä¸ªå†…å­˜å•å…ƒã€‚åœ¨è®¡ç®—æœºä¸­å­˜å‚¨å™¨çš„å®¹é‡æ˜¯ä»¥å­—èŠ‚Bä¸ºåŸºæœ¬å•ä½çš„ï¼Œæ‰€ä»¥ä¸€ä¸ªå†…å­˜åœ°å€ä»£è¡¨ä¸€ä¸ªå­—èŠ‚ 1B = 8b çš„å†…å­˜å•å…ƒï¼Œä¹Ÿå¯ä»¥è¯´ä¸€ä¸ªå†…å­˜å•å…ƒå 8bæˆ–1Bçš„å­˜å‚¨ç©ºé—´ã€‚</p><p>æˆ‘ä»¬å¹³æ—¶ç»å¸¸è¯´32ä½æ“ä½œ ç³»ç»Ÿï¼Œæœ€å¤šæ”¯æŒ4Gå†…å­˜ç©ºé—´ã€‚å°±æ˜¯å› ä¸º2<sup>32</sup>B = 4G</p><p>æ‰€ä»¥è¿™é‡Œçš„ç»“è®ºå°±æ˜¯ï¼š<code>ç”¨4ä½16è¿›åˆ¶è¡¨ç¤ºçš„å†…å­˜åœ°å€å’Œç”¨8ä½16è¿›åˆ¶è¡¨ç¤ºçš„å†…å­˜åœ°å€ï¼Œå…¶å®éƒ½æ˜¯ä»£è¡¨ä¸€ä¸ª8ä½/1å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼ŒæŠŠè¿™8ä½/1å­—èŠ‚çš„å­˜å‚¨ç©ºé—´å«åšä¸€ä¸ªå†…å­˜å•å…ƒ</code></p><p>æ¯”å¦‚ä¸€ä¸ªæ±‰å­—â€œä¸­â€åœ¨è®¡ç®—æœºä¸­æ˜¯å¦‚ä½•å­˜å‚¨å‘¢ï¼Œä¸€ä¸ªæ±‰å­—ï¼Œéœ€è¦ä¸¤ä¸ªå­˜å‚¨å•å…ƒï¼Œä¹Ÿå°±æ˜¯2Bå¤§å°ï¼Œè¿™2Bå­˜å‚¨ç©ºé—´æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å…¨éƒ¨æ‰¾åˆ°ï¼Œåªéœ€è¦æ‰¾åˆ°æœ€å¼€å§‹çš„ä¸€éƒ¨åˆ†ï¼Œå°±èƒ½æ‰¾åˆ°è¿™ä¸ªâ€œä¸­â€</p><p>æ‰€ä»¥ï¼Œå†…å­˜åœ°å€æ˜¯å†…å¯¸ä¸­å­˜å‚¨æ•°æ®çš„ä¸€ä¸ªæ ‡è¯†ï¼Œå¹¶ä¸æ˜¯æ•°æ®æœ¬èº«ï¼Œé€šè¿‡å†…å­˜åœ°å€å¯ä»¥çŸ¥é“å†…å­˜å½“ä¸­å­˜å‚¨çš„æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®å¯èƒ½å 1ä¸ªå†…å­˜å•å…ƒï¼Œä¹Ÿå¯èƒ½å å¤šä¸ªå†…å­˜å•å…ƒã€‚ </p><p>å¯ä»¥æŠ½è±¡çš„æŠŠå†…å­˜ç©ºé—´æ¯”ä½œæˆ¿å­ğŸ¡ï¼Œå¦‚æœæƒ³è¦æ‰¾åˆ°æˆ¿å­ï¼Œå°±éœ€è¦é€šè¿‡ğŸšªé—¨ç‰Œå·æ¥æ‰¾ï¼Œæ‰€ä»¥å†…å­˜åœ°å€å°±å¯ä»¥æ¯”ä½œé—¨ç‰Œå·ï¼Œé‚£è¿™ä¸ªæˆ¿å­å¤šå¤§å‘¢ï¼Œå°±å¯ä»¥ç§°ä¸ºå äº†å¤šå°‘çš„å†…å­˜ç©ºé—´ã€‚é‚£è¿™ä¸ªæˆ¿å­é‡Œå¯èƒ½è¿˜åŒ…æ‹¬æœ‰å¨æˆ¿ã€å§å®¤ã€å«ç”Ÿé—´ï¼Œè¿™äº›ç»Ÿç»Ÿä¸ç”¨ç»§ç»­æ‰¾äº†ï¼Œå› ä¸ºæœ‰äº†é—¨ç‰Œå·ï¼ˆå†…å­˜åœ°å€ï¼‰ï¼Œå°±èƒ½æ‰¾åˆ°æˆ¿å­ï¼ˆæ•°æ®ï¼Œæ•´ä¸ªå†…å­˜ç©ºé—´ï¼‰ï¼Œæ‰¾åˆ°æˆ¿å­è‡ªç„¶å°±èƒ½æ‰¾æ‰“å±‹é‡Œçš„å¨æˆ¿ã€å§å®¤â€¦â€¦(ä¸€ä¸ªä¸ªå†…å­˜å•å…ƒ)ã€‚å¦å¤–ï¼Œé—¨ç‰Œå·æ˜¯è´´åœ¨æˆ¿å­ä¸Šçš„ï¼Œæ‰€ä»¥å†…å­˜åœ°å€ä¸å ç”¨å†…å­˜ç©ºé—´ï¼Œä¸è¦å’Œå¹³æ—¶å¼€å‘ä¸­çš„æŒ‡é’ˆè¿™ä¸€æ¦‚å¿µææ··æ·†ã€‚</p><blockquote><p>å‚è€ƒï¼š</p><p><a href="[https://baike.baidu.com/item/%E5%AF%BB%E5%9D%80%E7%A9%BA%E9%97%B4](https://baike.baidu.com/item/å¯»å€ç©ºé—´">ã€Šç™¾åº¦ç™¾ç§‘-å¯»å€ç©ºé—´ã€‹</a>)</p><p><a href="http://www.asmedu.net/bbs/pasteinfo.jsp?part=1&amp;level=book&amp;kind=1002&amp;qkSg=2&amp;qID=27391&amp;readSg=1" target="_blank" rel="noopener">ã€Šæ±‡ç¼–è¯­è¨€è®ºå›ã€‹</a></p><p><a href="https://www.kancloud.cn/chandler/programming_road/695585" target="_blank" rel="noopener">ã€Šå†…å­˜æ¦‚å¿µã€‹</a></p><p><a href="https://www.cnblogs.com/VIPler/p/4282584.html" target="_blank" rel="noopener">ã€Šå…³äºå†…å­˜åœ°å€å’Œå†…å­˜ç©ºé—´çš„æ¦‚å¿µã€‹</a></p><p><a href="https://www.cnblogs.com/Lanht/p/10780364.html" target="_blank" rel="noopener">ã€Šå†…å­˜åœ°å€ä¸å†…å­˜ç©ºé—´ã€‹</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å†…å­˜&quot;&gt;&lt;a href=&quot;#å†…å­˜&quot; class=&quot;headerlink&quot; title=&quot;å†…å­˜&quot;&gt;&lt;/a&gt;å†…å­˜&lt;/h2&gt;&lt;p&gt;é¦–å…ˆè®²è§£ä¸€ä¸‹&lt;code&gt;å­˜å‚¨å™¨&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;å­˜å‚¨å™¨&lt;/code&gt;æ˜¯è®¡ç®—æœºé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä»–æ˜¯ç”¨æ¥å­˜å‚¨æ•°æ®å’Œéƒ¨ä»¶ã€‚å­˜å‚¨å™¨çš„ç§ç±»å¾ˆå¤šï¼ŒæŒ‰å„ç§è¯´æ³•åˆ†ç±»ä¹Ÿæœ‰å¾ˆå¤šã€‚ä¸‹é¢ä¸»è¦è®²è§£ä¸€ç§é€šå¸¸æ™®éçš„è¯´æ³•&lt;/p&gt;
&lt;p&gt;ç°ä»£è®¡ç®—æœºå­˜å‚¨å™¨æŒ‰&lt;strong&gt;ç”¨é€”&lt;/strong&gt;åˆ†ç±»ï¼Œå¯ä»¥åˆ†ä¸ºï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ä¸»å­˜å‚¨å™¨ï¼Œç®€ç§°ä¸»å­˜&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;RAM&lt;/li&gt;
&lt;li&gt;ROM&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;è¾…åŠ©å­˜å‚¨å™¨&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Cache(é«˜çº§ç¼“å†²å­˜å‚¨å™¨)   (å®ƒä½äºCPUä¸ä¸»å­˜ä¹‹é—´ï¼Œæ˜¯è¯»å†™é€Ÿåº¦æ¯”å†…å­˜è¿˜å¿«çš„å­˜å‚¨å™¨ï¼Œä»åå­—åº”è¯¥å°±çŸ¥é“å®ƒçš„ä½œç”¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³CPUå’Œä¸»å­˜é€Ÿåº¦ä¸åŒ¹é…è€Œè®¾è®¡çš„ï¼Œå› ä¸ºCPUä¸­å¯„å­˜å™¨çš„é€Ÿåº¦æ›´æ›´å¿«ï¼Œæ‰€ä»¥å‡ºç°äº†é€Ÿåº¦èƒ½æ¥è¿‘äºCPUçš„Cache)&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;
    
    </summary>
    
      <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://www.wuqihan.cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
      <category term="æ±‡ç¼–è¯­è¨€" scheme="http://www.wuqihan.cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/"/>
    
    
      <category term="8086æ±‡ç¼–" scheme="http://www.wuqihan.cn/tags/8086%E6%B1%87%E7%BC%96/"/>
    
      <category term="å¯»å€èƒ½åŠ›" scheme="http://www.wuqihan.cn/tags/%E5%AF%BB%E5%9D%80%E8%83%BD%E5%8A%9B/"/>
    
      <category term="cpu" scheme="http://www.wuqihan.cn/tags/cpu/"/>
    
      <category term="å†…å­˜" scheme="http://www.wuqihan.cn/tags/%E5%86%85%E5%AD%98/"/>
    
  </entry>
  
  <entry>
    <title>ä¼˜é›…çš„ä½¿ç”¨NSNotification.Name</title>
    <link href="http://www.wuqihan.cn/2018/05/18/%E4%BC%98%E9%9B%85%E7%9A%84%E4%BD%BF%E7%94%A8NSNotification-name/"/>
    <id>http://www.wuqihan.cn/2018/05/18/ä¼˜é›…çš„ä½¿ç”¨NSNotification-name/</id>
    <published>2018-05-18T04:34:36.000Z</published>
    <updated>2019-12-02T16:48:52.612Z</updated>
    
    <content type="html"><![CDATA[<p>Swift 3ä¹‹å‰ä½¿ç”¨é€šçŸ¥ï¼š</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-type">NSNotificationCenter</span>.defaultCenter().post(<span class="hljs-string">"kReceiveMessageNoti"</span>)</span><br></pre></td></tr></table></figure><p>Swift 3ä¹‹å</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-type">NotificationCenter</span>.<span class="hljs-keyword">default</span>.post(<span class="hljs-type">Notification</span>.<span class="hljs-type">Name</span>(rawValue: <span class="hljs-string">"kReceiveMessageNoti"</span>))</span><br></pre></td></tr></table></figure><a id="more"></a><p>æ˜¾ç„¶ è¿™ç§ä½¿ç”¨å…¨å±€å­—ç¬¦ä¸²å¸¸äº®çš„æ–¹æ³•ä¸æ˜¯å¾ˆå¥½ã€‚</p><p>æˆ‘åœ¨é˜…è¯»<code>Almofire</code>çš„æ—¶å€™å‘ç°ï¼Œä½œè€…æ˜¯è¿™æ ·ä½¿ç”¨é€šçŸ¥çš„ï¼š</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">Notification</span>.<span class="hljs-title">Name</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Task</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> <span class="hljs-type">DidResume</span> = <span class="hljs-type">Notification</span>.<span class="hljs-type">Name</span>(rawValue: <span class="hljs-string">"org.alamofire.notification.name.task.didResume"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ—¶å€™ï¼š</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-type">NotificationCenter</span>.<span class="hljs-keyword">default</span>.post(</span><br><span class="line">            name: <span class="hljs-type">Notification</span>.<span class="hljs-type">Name</span>.<span class="hljs-type">Task</span>.<span class="hljs-type">DidResume</span>,</span><br><span class="line">            object: <span class="hljs-keyword">self</span>,</span><br><span class="line">            userInfo: [<span class="hljs-type">Notification</span>.<span class="hljs-type">Key</span>.<span class="hljs-type">Task</span>: task]</span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨<code>extension</code>ä¸ºNotification.Nameæ·»åŠ ä¸€ä¸ªç»“æ„ä½“ï¼Œåœ¨ç»“æ„ä½“ä¸Šæ·»åŠ  é™æ€å¸¸é‡åŠæ³•ã€‚ç›´æ¥ä½¿ç”¨é™æ€å¸¸é‡å°±å¯ä»¥ï¼Œä½†æ˜¯ä½œè€…åˆä½¿ç”¨äº† ç»“æ„ä½“ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸ºäº†ç»™é€šçŸ¥åç§°åˆ†ç±»ã€‚</p><p>æ˜¾ç„¶è¿™ç§æ–¹æ³•æ¯”æˆ‘ä»¬ç›´æ¥ä½¿ç”¨å¸¸é‡å­—ç¬¦ä¸²è¦å¥½å¾ˆå¤šã€‚ä¸‹é¢ã€‚å†ç»™å‡ºæˆ‘ä½¿ç”¨enumçš„æ–¹æ³•</p><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">DDNotificationName</span>: <span class="hljs-title">String</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">/// æ³¨é”€æˆåŠŸ</span></span><br><span class="line">    <span class="hljs-keyword">case</span> logoutSuccess</span><br><span class="line">    <span class="hljs-comment">/// ç™»å½•æˆåŠŸ</span></span><br><span class="line">    <span class="hljs-keyword">case</span> loginSuccess</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//æ”¶åˆ°æ¶ˆæ¯</span></span><br><span class="line">    <span class="hljs-keyword">case</span> receiveMessage</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">var</span> name: <span class="hljs-type">NSNotification</span>.<span class="hljs-type">Name</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-type">NSNotification</span>.<span class="hljs-type">Name</span>(<span class="hljs-string">"k"</span> + rawValue)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight swift hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-type">NotificationCenter</span>.<span class="hljs-keyword">default</span>.post(name: <span class="hljs-type">DDNotificationName</span>.loginSuccess.name, object: <span class="hljs-literal">nil</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Swift 3ä¹‹å‰ä½¿ç”¨é€šçŸ¥ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight swift hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;hljs-type&quot;&gt;NSNotificationCenter&lt;/span&gt;.defaultCenter().post(&lt;span class=&quot;hljs-string&quot;&gt;&quot;kReceiveMessageNoti&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Swift 3ä¹‹å&lt;/p&gt;
&lt;figure class=&quot;highlight swift hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;hljs-type&quot;&gt;NotificationCenter&lt;/span&gt;.&lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt;.post(&lt;span class=&quot;hljs-type&quot;&gt;Notification&lt;/span&gt;.&lt;span class=&quot;hljs-type&quot;&gt;Name&lt;/span&gt;(rawValue: &lt;span class=&quot;hljs-string&quot;&gt;&quot;kReceiveMessageNoti&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Swift" scheme="http://www.wuqihan.cn/categories/Swift/"/>
    
    
      <category term="swift tips" scheme="http://www.wuqihan.cn/tags/swift-tips/"/>
    
  </entry>
  
  <entry>
    <title>å…¥é—¨æ±‡ç¼–è¯­è¨€</title>
    <link href="http://www.wuqihan.cn/2018/05/15/%E5%85%A5%E9%97%A8%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/"/>
    <id>http://www.wuqihan.cn/2018/05/15/å…¥é—¨æ±‡ç¼–è¯­è¨€/</id>
    <published>2018-05-15T13:07:50.000Z</published>
    <updated>2019-11-06T14:04:12.593Z</updated>
    
    <content type="html"><![CDATA[<h2 id="äº†è§£æ±‡ç¼–è¯­è¨€"><a href="#äº†è§£æ±‡ç¼–è¯­è¨€" class="headerlink" title="äº†è§£æ±‡ç¼–è¯­è¨€"></a>äº†è§£æ±‡ç¼–è¯­è¨€</h2><h3 id="ç¼–ç¨‹è¯­è¨€çš„å‘å±•"><a href="#ç¼–ç¨‹è¯­è¨€çš„å‘å±•" class="headerlink" title="ç¼–ç¨‹è¯­è¨€çš„å‘å±•"></a>ç¼–ç¨‹è¯­è¨€çš„å‘å±•</h3><ul><li>æœºå™¨è¯­è¨€<ul><li>ç”±0å’Œ1ç»„æˆ</li></ul></li><li>æ±‡ç¼–è¯­è¨€ ï¼ˆ<strong>Assembly Language</strong>ï¼‰<ul><li>ç”¨ç¬¦å·ä»£æ›¿äº†0å’Œ1ï¼Œæ¯”æœºå™¨è¯­è¨€ä¾¿äºé˜…è¯»å’Œæœºç¿¼</li></ul></li><li>é«˜çº§è¯­è¨€<ul><li>C\C++\Java\Swiftç­‰ï¼Œæ›´æ¥è¿‘äººç±»è‡ªç„¶è¯­è¨€</li></ul></li></ul><a id="more"></a><p>åˆ†åˆ«ç”¨ä¸Šé¢ä¸‰ç§è¯­è¨€å®ç°ï¼š å°†å¯„å­˜å™¨BXçš„å†…å®¹é€äººå¯„å­˜å™¨AX</p><p>æœºå™¨è¯­è¨€ï¼š 10010100010101 </p><p>æ±‡ç¼–è¯­è¨€ï¼šmov ax,bx</p><p>é«˜çº§è¯­è¨€ï¼šax = bx</p><p>ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œè¶Šä½çº§çš„è¯­è¨€ï¼Œè¶Šæ˜¯éš¾ä»¥ç†è§£ã€‚ã€‚ã€‚</p><p><img src="https://i.loli.net/2019/08/17/67PdqwxGugaCYmE.png" alt="æ±‡ç¼–è¯­è¨€çš„å‘å±•"></p><ul><li><p><font color="#FF6347">æ±‡ç¼–è¯­è¨€</font> ä¸ <font color="#FF6347"><strong>æœºå™¨è¯­è¨€</strong></font> ä¸€ä¸€å¯¹åº”ï¼Œæ¯ä¸€æ¡æœºå™¨æŒ‡ä»¤éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤</p></li><li><font color="#FF6347"><strong>æ±‡ç¼–è¯­è¨€</strong></font> å¯ä»¥é€šè¿‡ç¼–è¯‘å¾—åˆ°<font color="#FF6347"><strong>æœºå™¨è¯­è¨€</strong></font>ï¼Œ<font color="#FF6347"><strong>æœºå™¨è¯­è¨€</strong></font>å¯ä»¥é€šè¿‡åæ±‡ç¼–å¾—åˆ°<font color="#FF6347"><strong>æ±‡ç¼–è¯­è¨€</strong></font> </li><li><font color="#FF6347"><strong>é«˜çº§è¯­è¨€</strong></font>å¯ä»¥é€šè¿‡ç¼–è¯‘å¾—åˆ°<font color="#FF6347"><strong>æ±‡ç¼–è¯­è¨€</strong></font> \ <font color="#FF6347"><strong>æœºå™¨è¯­è¨€</strong></font>ï¼Œä½†<font color="#FF6347"><strong>æ±‡ç¼–è¯­è¨€</strong></font> \ <font color="#FF6347"><strong>æœºå™¨è¯­è¨€</strong></font>å‡ ä¹ä¸å¯èƒ½è¿˜åŸæˆ<font color="#FF6347"><strong>é«˜çº§è¯­è¨€</strong></font></li></ul><h3 id="æ±‡ç¼–è¯­è¨€çš„ç‰¹ç‚¹"><a href="#æ±‡ç¼–è¯­è¨€çš„ç‰¹ç‚¹" class="headerlink" title="æ±‡ç¼–è¯­è¨€çš„ç‰¹ç‚¹"></a>æ±‡ç¼–è¯­è¨€çš„ç‰¹ç‚¹</h3><ul><li><code>æ‰€æœ‰é«˜çº§è¯­è¨€ï¼ˆCã€Swiftã€Javaç­‰ï¼‰éƒ½æ˜¯åŸºäºæ“ä½œç³»ç»Ÿï¼Œæ— æ³•è„±ç¦»äºæ“ä½œç³»ç»Ÿä¹‹å¤–ã€‚ä½†æ˜¯æ±‡ç¼–æ˜¯åŸºäºç¡¬ä»¶ï¼ˆå¯ä»¥è¯´æ˜¯CPUï¼‰çš„è¯­è¨€ã€‚</code></li><li>å¯ä»¥ç›´æ¥è®¿é—®ã€æ§åˆ¶å„ç§ç¡¬ä»¶è®¾å¤‡ï¼Œæ¯”å¦‚å­˜å‚¨å™¨ã€CPUç­‰ï¼Œèƒ½æœ€å¤§é™åº¦çš„å‘æŒ¥ç¡¬ä»¶çš„åŠŸèƒ½</li><li>æ±‡ç¼–æŒ‡ä»¤æ˜¯æœºå™¨æŒ‡ä»¤çš„åŠ©è®°ç¬¦ï¼ŒåŒæœºå™¨æŒ‡ä»¤ä¸€ä¸€å¯¹åº”ã€‚æ¯ä¸€ç§CPUéƒ½æœ‰è‡ªå·±çš„æœºå™¨æŒ‡ä»¤é›†\æ±‡ç¼–æŒ‡ä»¤é›†ï¼Œæ‰€ä»¥æ±‡ç¼–è¯­è¨€ä¸å…·å¤‡å¯ç§»æ¤æ€§</li><li>çŸ¥è¯†ç‚¹è¿‡å¤šï¼Œå¼€å‘è€…éœ€è¦å¯¹CPUç­‰ç¡¬ä»¶ç»“æ„æœ‰æ‰€äº†è§£ï¼Œä¸æ˜“äºç¼–å†™ã€è°ƒè¯•ã€ç»´æŠ¤</li><li>ä¸åŒºåˆ†å¤§å°å†™ã€æ¯”å¦‚ mov å’ŒMOVæ˜¯ä¸€æ ·çš„</li><li>æ±‡ç¼–è¯­è¨€ç§ç±»å¾ˆå¤š<ul><li>8086æ±‡ç¼–</li><li>Win32æ±‡ç¼–</li><li>Win64æ±‡ç¼–</li><li>AT&amp;Tæ±‡ç¼–ï¼ˆMacã€iOSæ¨¡æ‹Ÿå™¨ï¼‰</li><li>ARMæ±‡ç¼–ï¼ˆåµŒå…¥å¼è®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯æ‰‹æœºç”µè§†è½¦è½½ç³»ç»Ÿä¹‹ç±»ï¼‰ </li></ul></li></ul><h3 id="æ±‡ç¼–è¯­è¨€VSé«˜çº§è¯­è¨€"><a href="#æ±‡ç¼–è¯­è¨€VSé«˜çº§è¯­è¨€" class="headerlink" title="æ±‡ç¼–è¯­è¨€VSé«˜çº§è¯­è¨€"></a>æ±‡ç¼–è¯­è¨€VSé«˜çº§è¯­è¨€</h3><p>é‡‡ç”¨é«˜çº§è¯­è¨€C++å’Œæ±‡ç¼–è¯­è¨€ç¼–å†™åŒä¸€ä¸ªåŠŸèƒ½ ï¼š å°†a+bçš„ç»“æœèµ‹å€¼ç»™cï¼Œç„¶ååœ¨å±å¹•ä¸Šæ‰“å°cçš„ç»“æœ</p><table><thead><tr><th>è¯­è¨€</th><th>æºæ–‡ä»¶å¤§å°</th><th>ç›®æ ‡æ–‡ä»¶å¤§å°</th><th>å¯æ‰§è¡Œæ–‡ä»¶å¤§å°</th></tr></thead><tbody><tr><td><font color="#FF6347">æ±‡ç¼–è¯­è¨€</font></td><td><font color="#FF6347">è¿‘400å­—èŠ‚</font></td><td><font color="#FF6347">è¿‘200å­—èŠ‚</font></td><td><font color="#FF6347">è¿‘600å­—èŠ‚</font></td></tr><tr><td>C++</td><td>è¿‘150å­—èŠ‚</td><td>è¿‘550å­—èŠ‚</td><td>è¿‘9000å­—èŠ‚</td></tr></tbody></table><h2 id="CPUæ€»çº¿"><a href="#CPUæ€»çº¿" class="headerlink" title="CPUæ€»çº¿"></a>CPUæ€»çº¿</h2><p><img src="https://i.loli.net/2019/08/17/NYDB6UtSolcFLr2.jpg" width="400" height="260" align="center"><br>æ¯ä¸€ä¸ªCPUèŠ¯ç‰‡éƒ½æœ‰è®¸å¤š<code>ç®¡è„š</code>ï¼ˆä¸Šå›¾å³è¾¹é“¶è‰²çš„è§¦è§’ï¼‰ï¼Œè¿™äº›<code>ç®¡è„š</code>å’Œ<code>æ€»çº¿</code>ç›¸è¿ï¼ŒCPUé€šè¿‡<code>æ€»çº¿</code>è·Ÿå¤–éƒ¨è¿›è¡Œäº¤äº’ï¼›</p><p>æ€»çº¿ï¼šä¸€æ ¹æ ¹å¯¼çº¿çš„é›†åˆ</p><p>æ€»çº¿çš„åˆ†ç±»ï¼š</p><ul><li>åœ°å€æ€»çº¿</li><li>æ•°æ®æ€»çº¿</li><li>æ§åˆ¶æ€»çº¿</li></ul><p><img src="https://i.loli.net/2019/08/18/rSysNhakF9p3V2M.png" alt="ç»“æ„.png"></p><h3 id="åœ°å€æ€»çº¿"><a href="#åœ°å€æ€»çº¿" class="headerlink" title="åœ°å€æ€»çº¿"></a>åœ°å€æ€»çº¿</h3><p>å®ƒçš„å®½åº¦å†³å®šäº†CPUçš„ <code>å¯»å€èƒ½åŠ›</code> ï¼ˆä»€ä¹ˆæ˜¯å¯»å€èƒ½åŠ›ï¼ŒæŒ‡å®ƒèƒ½æ‰¾åˆ°å¤šå¤§çš„åœ°å€ï¼‰</p><p>8086çš„åœ°å€æ€»çº¿å®½åº¦æ˜¯20ï¼Œæ‰€ä»¥å¯»å€èƒ½åŠ›å³ä¸º2<sup>20</sup>B = 2<sup>10</sup>B <em> 2<sup> 10</sup>=1KB </em> 2<sup>10</sup> = 1KB * 1024 = 1M</p><blockquote><p>ä»€ä¹ˆæ˜¯<code>å¯»å€èƒ½åŠ›</code>ï¼Ÿ<code>å¯»å€èƒ½åŠ›</code>ä¸ºä»€ä¹ˆå¦‚ä¸Šé¢è¿™æ ·è®¡ç®—ï¼Ÿ</p><p>ç”±äºè§£é‡Šèµ·æ¥ç¯‡å¹…ä¸çŸ­ï¼Œæ‰€ä»¥æ–°å†™ä¸€ç¯‡æ–‡ç« ä¸“é—¨è®¨è®º <a href="http://www.wuqihan.cn/2018/05/19/CPUå¯»å€èƒ½åŠ›åˆ°åº•æ€ä¹ˆç†è§£ï¼Ÿ/">ã€ŠCPUå¯»å€èƒ½åŠ›åˆ°åº•æ€ä¹ˆç†è§£ï¼Ÿã€‹</a></p></blockquote><h3 id="æ•°æ®æ€»çº¿"><a href="#æ•°æ®æ€»çº¿" class="headerlink" title="æ•°æ®æ€»çº¿"></a>æ•°æ®æ€»çº¿</h3><p>å®ƒçš„å®½åº¦å†³å®šäº†CPUçš„å•æ¬¡æ•°æ®ä¼ é€é‡ï¼Œä¹Ÿå°±æ˜¯æ•°æ®ä¼ é€é€Ÿåº¦</p><p>8086çš„æ•°æ®æ€»çº¿å®½åº¦æ˜¯16ï¼Œæ‰€ä»¥å•æ¬¡æœ€å¤§ä¼ é€’2ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚å› ä¸º16æ ¹çº¿ï¼Œä»£è¡¨16ä½ï¼Œ8ä½ç­‰äº1å­—èŠ‚ï¼Œæ‰€ä»¥æ˜¯2å­—èŠ‚ã€‚</p><font color="green">æ³¨æ„ï¼ï¼è¿™é‡Œçš„æ•°æ®æ€»çº¿åƒä¸‡ä¸è¦å’Œä¸Šé¢çš„åœ°å€æ€»çº¿ææ··ï¼Œå®Œå…¨æ˜¯ä¸¤ç äº‹å„¿</font><h3 id="æ§åˆ¶æ€»çº¿"><a href="#æ§åˆ¶æ€»çº¿" class="headerlink" title="æ§åˆ¶æ€»çº¿"></a>æ§åˆ¶æ€»çº¿</h3><p>å®ƒçš„å®½åº¦å†³å®šäº†CPUå¯¹å…¶ä»–å™¨ä»¶çš„æ§åˆ¶èƒ½åŠ›ã€èƒ½æœ‰å¤šå°‘ç§æ§åˆ¶</p><p>æ§åˆ¶æ€»çº¿  çŸ¥é“å¤§æ¦‚å°±è¡Œï¼Œä¸éœ€è¦æ·±ç©¶</p><h2 id="8086çš„å¯»å€æ–¹å¼"><a href="#8086çš„å¯»å€æ–¹å¼" class="headerlink" title="8086çš„å¯»å€æ–¹å¼"></a>8086çš„å¯»å€æ–¹å¼</h2><p>CPUè®¿é—®å†…å­˜å•å…ƒæ—¶ï¼Œè¦ç»™å‡ºå†…å­˜å•å…ƒçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯å†…å­˜åœ°å€</p><p>8086CPUè™½ç„¶æ˜¯16ä½CPUï¼Œä½†æ˜¯å®ƒæœ‰20ä½åœ°å€æ€»çº¿ï¼Œå¯ä»¥ä¼ é€20ä½çš„åœ°å€ï¼Œ1Mçš„å¯»å€èƒ½åŠ›</p><p>å†…éƒ¨åœ°å€16ä½ï¼Œä½†æ˜¯å´èƒ½ä¼ é€å‡º20ä½çš„åœ°å€ï¼ŒåŸå› æ˜¯ï¼š <code>8086é‡‡ç”¨ä¸€ç§åœ¨å†…éƒ¨ç”¨2ä¸ª16ä½åœ°å€åˆæˆçš„æ–¹æ³•æ¥ç”Ÿæˆ1ä¸ª20ä½çš„ç‰©ç†åœ°å€</code></p><p><img src="https://i.loli.net/2019/08/28/HVx6WCMfve8I5lr.png" alt></p><p>åœ°å€åŠ æ³•å™¨é‡‡ç”¨ <code>ç‰©ç†åœ°å€=æ®µåœ°å€*16+åç§»åœ°å€</code>çš„æ–¹æ³•ç”¨æ®µåœ°å€å’Œåç§»åœ°å€åˆæˆç‰©ç†åœ°å€ã€‚ä¾‹å¦‚ï¼Œ8086CPUè¦è®¿é—®123C8Hçš„å†…å­˜å•å…ƒæ˜¯ï¼Œå¯ä»¥é€šè¿‡1230H*10H+00C8H</p><h2 id="ä¸»è¦å¯„å­˜å™¨"><a href="#ä¸»è¦å¯„å­˜å™¨" class="headerlink" title="ä¸»è¦å¯„å­˜å™¨"></a>ä¸»è¦å¯„å­˜å™¨</h2><p><img src="https://i.loli.net/2019/08/28/tCGUrPq9BoKMpa5.jpg" alt="å¯„å­˜å™¨"> </p><p>8086æœ‰14ä¸ªå¯„å­˜å™¨ï¼Œéƒ½æ˜¯16ä½ã€‚å¯ä»¥å­˜æ”¾2ä¸ªå­—èŠ‚ï¼ˆ2ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªå­—wordï¼‰</p><h3 id="é€šç”¨å¯„å­˜å™¨"><a href="#é€šç”¨å¯„å­˜å™¨" class="headerlink" title="é€šç”¨å¯„å­˜å™¨"></a>é€šç”¨å¯„å­˜å™¨</h3><p>AXã€BXã€CXã€DXè¿™4ä¸ªå¯„å­˜å™¨é€šå¸¸ç”¨æ¥å­˜æ”¾ä¸€èˆ¬æ€§çš„æ•°æ®ï¼Œç§°ä¸ºé€šç”¨å¯„å­˜å™¨(æœ‰æ—¶ä¹Ÿæœ‰ç‰¹å®šç”¨é€”)ï¼›é€šå¸¸ï¼ŒCPUä¼šå…ˆå°†å†…å­˜ä¸­çš„æ•°æ®å­˜å‚¨åˆ°é€šç”¨å¯„å­˜å™¨ä¸­ï¼Œç„¶åå†å¯¹é€šç”¨å¯„å­˜å™¨ä¸­çš„æ•°æ®è¿›è¡Œè¿ç®—ã€‚</p><h3 id="æ®µå¯„å­˜å™¨"><a href="#æ®µå¯„å­˜å™¨" class="headerlink" title="æ®µå¯„å­˜å™¨"></a>æ®µå¯„å­˜å™¨</h3><p>8086æœ‰4ä¸ªæ®µå¯„å­˜å™¨:CSã€DSã€SSã€ESï¼Œå½“CPUéœ€è¦è®¿é—®å†…å­˜æ—¶ç”±è¿™4ä¸ªæ®µå¯„å­˜å™¨æä¾›å†…å­˜å•å…ƒçš„æ®µåœ°å€ã€‚</p><h3 id="æ§åˆ¶å¯„å­˜å™¨"><a href="#æ§åˆ¶å¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶å¯„å­˜å™¨"></a>æ§åˆ¶å¯„å­˜å™¨</h3><p>æœ€å¸¸ç”¨çš„æ§åˆ¶å¯„å­˜å™¨IPï¼Œé€šå¸¸å’ŒCSä»£ç æ®µå¯„å­˜å™¨æ­é…ä½¿ç”¨ï¼Œä¸ºCSæœåŠ¡</p><p>CSä¸ºä»£ç æ®µå¯„å­˜å™¨ï¼ŒIPä¸ºæŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ï¼Œå®ƒä»¬æŒ‡ç¤ºäº†CPUå½“å‰è¦è¯»å–æŒ‡ä»¤çš„åœ°å€ï¼›</p><p>ä»»æ„æ—¶åˆ»ï¼Œ8086CPUéƒ½ä¼šå°†CS:IPæŒ‡å‘ çš„æŒ‡ä»¤ä½œä¸ºä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</p><p><img src="https://i.loli.net/2019/08/28/l6MsRdmqjJnUeHr.png" alt="æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹"></p><p>ä¸Šå›¾æœ‰æ‰§è¡Œé¡ºåºç¼–å·ï¼Œè¯¦ç»†æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li><code>CS</code>ã€<code>IP</code>ä¸­çš„å†…å®¹é€å…¥<code>åœ°å€åŠ æ³•å™¨</code>ï¼Œå¾—åˆ°ç‰©ç†åœ°å€ 20000H</li><li><code>åœ°å€åŠ æ³•å™¨</code>å°†ç‰©ç†åœ°å€é€å…¥<code>è¾“å…¥è¾“å‡ºæ§åˆ¶ç”µè·¯</code></li><li><code>è¾“å…¥è¾“å‡ºæ§åˆ¶ç”µè·¯</code>å°†ç‰©ç†åœ°å€2000Hé€ä¸Š <code>åœ°å€æ€»çº¿</code></li><li>ä»åœ°å€ä¸º20000Hçš„å†…å­˜å•å…ƒå¼€å§‹ï¼Œå­˜æ”¾çš„æœºå™¨æŒ‡ä»¤B8 23 01é€šè¿‡æ•°æ®æ€»çº¿è¢«é€å…¥CPU</li><li><code>è¾“å…¥è¾“å‡ºæ§åˆ¶ç”µè·¯</code>å°†æœºå™¨æŒ‡ä»¤B8 23 01é€å…¥ <code>æŒ‡ä»¤ç¼“å†²å™¨</code></li><li>è¯»å–ä¸€æ¡æŒ‡ä»¤åï¼ŒIPä¸­çš„å€¼è‡ªåŠ¨å¢åŠ ï¼Œä»¥ä½¿CPUå¯ä»¥è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚å› ä¸ºB82301æ˜¯3ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥IPä¸­çš„å€¼åŠ 3 ï¼Œæ­¤æ—¶CS:IPæŒ‡å‘å†…å­˜å•å…ƒ2000H:0003H</li><li><code>æ‰§è¡Œæ§åˆ¶å™¨</code>æ‰§è¡ŒæŒ‡ä»¤ B8 23 01å³ mov ax,0123h</li><li>å›åˆ°ç¬¬1æ­¥ï¼Œé‡å¤ä»¥ä¸Šçš„æ­¥éª¤ï¼Œåªä¸è¿‡ç¬¬ä¸€æ¡ä¸­çš„CSä»ç„¶ä¸º2000Hï¼Œä½†æ˜¯iPå·²ç»åœ¨ç¬¬6æ­¥ä¸­æ”¹ä¸ºäº†0003H</li></ol><h2 id="æ±‡ç¼–è¯­è¨€å­¦ä¹ èµ„æ–™æ•´ç†"><a href="#æ±‡ç¼–è¯­è¨€å­¦ä¹ èµ„æ–™æ•´ç†" class="headerlink" title="æ±‡ç¼–è¯­è¨€å­¦ä¹ èµ„æ–™æ•´ç†"></a>æ±‡ç¼–è¯­è¨€å­¦ä¹ èµ„æ–™æ•´ç†</h2><p><a href="https://book.douban.com/subject/25726019/" target="_blank" rel="noopener">ã€Šæ±‡ç¼–è¯­è¨€(ç¬¬ä¸‰ç‰ˆ)ã€‹-ç‹çˆ½</a>  </p><p><img src="https://i.loli.net/2019/08/18/Jga6Iu49SPHy5n3.jpg"> </p><p>è±†ç“£9.2åˆ† å¿…çœ‹ï¼ï¼æ­£åœ¨è¯»è¿™æœ¬ä¹¦ï¼ŒçœŸçš„æ˜¯ç‰¹åˆ«å€¼å¾—æ¨èï¼æ˜¯æˆ‘æ‰€æœ‰è¯»è¿‡çš„å›½å†…è®¡ç®—æœºç±»ä¹¦ç±ä¸­æˆ‘è§‰å¾—å†™å¾—æœ€å¥½çš„ä¸€æœ¬ã€‚</p><p><a href="http://www.asmedu.net/bbs/forum.jsp" target="_blank" rel="noopener">ã€Šæ±‡ç¼–è¯­è¨€è®ºå›ã€‹</a></p><p>å·²ç»å¾ˆå°‘æœ‰äººè®¨è®ºäº†ã€‚ä½†æ˜¯é‡Œé¢æœ‰å¾ˆå¤šä»¥å‰è®¨è®ºçš„é—®é¢˜å’Œè§£ç­”ï¼Œå¾ˆæœ‰å‚è€ƒä»·å€¼</p><p><a href="https://www.bilibili.com/video/av22872043/" target="_blank" rel="noopener">ã€Šé›¶åŸºç¡€å…¥é—¨å­¦ä¹ æ±‡ç¼–è¯­è¨€ã€‹- å°ç”²é±¼</a></p><p>è¿™æ˜¯ä¸€å¥—è§†é¢‘ï¼Œæ²¡æœ‰çœ‹è¿‡ï¼Œä½†æ˜¯åœ¨ç½‘ä¸ŠæŸ¥æ‰¾æ±‡ç¼–ç›¸å…³çš„èµ„æ–™çš„æ—¶å€™ï¼Œå‘ç°å¾ˆå¤šç½‘å‹éƒ½æ˜¯çœ‹è¿‡è¿™å¥—è§†é¢‘ï¼Œå¯¹äºå…¥é—¨åº”è¯¥ä¸é”™ã€‚ ä¸Šå¤§å­¦çš„æ—¶å€™è®°å¾—æœ‰çœ‹è¿‡ä»–çš„å…¥é—¨Cè¯­è¨€è§†é¢‘</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;äº†è§£æ±‡ç¼–è¯­è¨€&quot;&gt;&lt;a href=&quot;#äº†è§£æ±‡ç¼–è¯­è¨€&quot; class=&quot;headerlink&quot; title=&quot;äº†è§£æ±‡ç¼–è¯­è¨€&quot;&gt;&lt;/a&gt;äº†è§£æ±‡ç¼–è¯­è¨€&lt;/h2&gt;&lt;h3 id=&quot;ç¼–ç¨‹è¯­è¨€çš„å‘å±•&quot;&gt;&lt;a href=&quot;#ç¼–ç¨‹è¯­è¨€çš„å‘å±•&quot; class=&quot;headerlink&quot; title=&quot;ç¼–ç¨‹è¯­è¨€çš„å‘å±•&quot;&gt;&lt;/a&gt;ç¼–ç¨‹è¯­è¨€çš„å‘å±•&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;æœºå™¨è¯­è¨€&lt;ul&gt;
&lt;li&gt;ç”±0å’Œ1ç»„æˆ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;æ±‡ç¼–è¯­è¨€ ï¼ˆ&lt;strong&gt;Assembly Language&lt;/strong&gt;ï¼‰&lt;ul&gt;
&lt;li&gt;ç”¨ç¬¦å·ä»£æ›¿äº†0å’Œ1ï¼Œæ¯”æœºå™¨è¯­è¨€ä¾¿äºé˜…è¯»å’Œæœºç¿¼&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;é«˜çº§è¯­è¨€&lt;ul&gt;
&lt;li&gt;C\C++\Java\Swiftç­‰ï¼Œæ›´æ¥è¿‘äººç±»è‡ªç„¶è¯­è¨€&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://www.wuqihan.cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
      <category term="æ±‡ç¼–è¯­è¨€" scheme="http://www.wuqihan.cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/"/>
    
    
      <category term="8086æ±‡ç¼–" scheme="http://www.wuqihan.cn/tags/8086%E6%B1%87%E7%BC%96/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Block</title>
    <link href="http://www.wuqihan.cn/2018/01/11/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Block/"/>
    <id>http://www.wuqihan.cn/2018/01/11/æ·±å…¥ç†è§£Block/</id>
    <published>2018-01-11T08:52:33.000Z</published>
    <updated>2020-01-28T10:16:46.147Z</updated>
    
    <content type="html"><![CDATA[<h2 id="blockçš„æœ¬è´¨"><a href="#blockçš„æœ¬è´¨" class="headerlink" title="blockçš„æœ¬è´¨"></a>blockçš„æœ¬è´¨</h2><p>blockçœ‹ä¸Šå»æ˜¯â€œå¸¦æœ‰è‡ªåŠ¨å˜é‡å€¼çš„åŒ¿åå‡½æ•°â€ï¼Œå®é™…ä¸Šæ˜¯ä½œä¸ºææ™®é€šçš„Cè¯­è¨€æºä»£ç æ¥å¤„ç†çš„ã€‚é€šè¿‡æ”¯æŒBlockçš„ç¼–è¯‘å™¨ï¼Œå°†å«æœ‰Blockè¯­æ³•çš„æºä»£ç è½¬æ¢ä¸ºä¸€èˆ¬Cè¯­è¨€ç¼–è¯‘å™¨èƒ½å¤Ÿå¤„ç†çš„æºä»£ç ã€‚</p><p>åœ¨å®é™…ç¼–è¯‘æ—¶æ— æ³•è½¬æ¢ä¸ºæˆ‘ä»¬èƒ½å¤Ÿç†è§£çš„æºä»£ç ï¼Œä½†clang(LLVMç¼–è¯‘å™¨)å…·æœ‰è½¬æ¢ä¸ºæˆ‘ä»¬å¯è¯»æºä»£ç çš„åŠŸèƒ½ã€‚é€šè¿‡â€œ-rewrite-objcâ€é€‰é¡¹å°±èƒ½å°†å«æœ‰Blockè¯­æ³•çš„æºä»£ç è½¬æ¢ä¸ºC++ä»£ç ã€‚</p><a id="more"></a><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">Â Â  Â </span><br><span class="line">Â  Â  <span class="hljs-keyword">void</span> (^blk)(<span class="hljs-keyword">void</span>) = ^&#123;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Block\n"</span>);&#125;;</span><br><span class="line">Â Â  Â </span><br><span class="line">Â  Â  blk();</span><br><span class="line">Â Â  Â </span><br><span class="line">Â  Â  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æºä»£ç çš„Blockè¯­æ³•æœ€ä¸ºç®€å•ï¼Œå®ƒçœç•¥äº†è¿”å›å€¼ç±»å‹ä»¥åŠå‚æ•°åˆ—è¡¨ã€‚é€šè¿‡clangå¯å˜æ¢ä¸ºä¸€ä¸‹å½¢å¼ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">block_impl</span> &#123;</span></span><br><span class="line">Â  <span class="hljs-keyword">void</span> *isa;</span><br><span class="line">Â  <span class="hljs-keyword">int</span> Flags;</span><br><span class="line">Â  <span class="hljs-keyword">int</span> Reserved;</span><br><span class="line">Â  <span class="hljs-keyword">void</span> *FuncPtr;<span class="hljs-comment">//å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//__main_block_impl_0ç»“æ„ä½“ç›¸å½“äºåŸºäºobjc_objectç»“æ„ä½“çš„Objective-Cå¯¹è±¡çš„ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> &#123;</span></span><br><span class="line">Â  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">block_impl</span> <span class="hljs-title">impl</span>;</span></span><br><span class="line">Â  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span>* <span class="hljs-title">Desc</span>;</span></span><br><span class="line">  <span class="hljs-comment">//ç»“æ„ä½“çš„æ„é€ å‡½æ•° (Cæ˜¯ä¸å…è®¸è¿™ä¹ˆå†™çš„,C++æ‰å¯ä»¥)</span></span><br><span class="line">Â  __main_block_impl_0(<span class="hljs-keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="hljs-keyword">int</span> flags=<span class="hljs-number">0</span>) &#123;</span><br><span class="line">    <span class="hljs-comment">//é€šè¿‡isaæŒ‡é’ˆï¼Œå¯ä»¥æƒ³åˆ°blockå®è´¨æ˜¯OCçš„å¯¹è±¡</span></span><br><span class="line">    <span class="hljs-comment">// isaæŒ‡å‘blockçš„ç±»å¯¹è±¡objc_classç»“æ„ä½“ã€‚blockçš„ç±»å¯¹è±¡é€šè¿‡&amp;_NSConcreteStackBlockåˆå§‹åŒ–ã€‚</span></span><br><span class="line">Â  Â  impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">Â  Â  impl.Flags = flags;</span><br><span class="line">    <span class="hljs-comment">//impl.FuncPträ¿å­˜blockæ‰§è¡Œçš„å†…å®¹ã€‚åœ¨è¿™é‡Œå°±æ˜¯__main_block_func_0è¿™ä¸ªcè¯­è¨€å‡½æ•°</span></span><br><span class="line">Â  Â  impl.FuncPtr = fp;</span><br><span class="line">Â  Â  Desc = desc;</span><br><span class="line">Â  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//- é€šè¿‡blockä½¿ç”¨çš„åŒ¿åå‡½æ•°å®é™…ä¸Šæ˜¯è¢«ä½œä¸ºç®€å•çš„cè¯­è¨€å‡½æ•°æ¥å¤„ç†ã€‚å¦å¤–æ ¹æ®blockè¯­æ³•æ‰€å±çš„å‡½æ•°å(æ­¤å¤„ä¸ºmain)å’Œè¯¥blockè¯­æ³•æ‰€åœ¨è¯¥å‡½æ•°å‡ºç°çš„é¡ºåºå€¼(æ­¤å¤„ä¸º0)æ¥ç»™ç»clangå˜æ¢çš„å‡½æ•°å‘½åã€‚</span></span><br><span class="line"><span class="hljs-comment">//- è¯¥å‡½æ•°çš„å‚æ•°__cselfç›¸å½“äºc++å®ä¾‹æ–¹æ³•ä¸­æŒ‡å‘å®ä¾‹è‡ªèº«çš„å˜é‡thisï¼Œæˆ–æ˜¯OCä¸­çš„selfï¼Œå³__cselfä¸ºæŒ‡å‘Blockå€¼å¾—å˜é‡ã€‚</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Block\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span> &#123;</span></span><br><span class="line">Â  <span class="hljs-keyword">size_t</span> reserved;</span><br><span class="line">Â  <span class="hljs-keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="hljs-keyword">void</span> (*blk)(<span class="hljs-keyword">void</span>) = ((<span class="hljs-keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="hljs-keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">//blkä¸ºä»€ä¹ˆèƒ½ç›´æ¥è°ƒç”¨FuncPtrå‘¢ï¼Œä¸æ˜¯åº”è¯¥blk-&gt;imp.FuncPtrå—ï¼Œå› ä¸ºè¿™é‡Œè¿›è¡Œäº†å¼ºåˆ¶è½¬æ¢ï¼ŒæŠŠblk</span></span><br><span class="line"><span class="hljs-comment">//è½¬ä¸ºäº†implï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·è½¬å‘¢ï¼Œå› ä¸ºimplæ˜¯blkçš„ç¬¬ä¸€ä¸ªå˜é‡ï¼Œæ‰€ä»¥ä»–ä»¬ä¸¤ä¸ªçš„åœ°å€å…¶å®æ˜¯ä¸€æ ·çš„ã€‚</span></span><br><span class="line">Â  Â  ((<span class="hljs-keyword">void</span> (*)(Â·__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨mainæ–¹æ³•ä¸­ï¼Œåˆå§‹åŒ–äº†blockï¼Œå¹¶è°ƒç”¨äº†æ‰§è¡Œäº†blockï¼Œé€šè¿‡clangè½¬æ¢çš„æºä»£ç ç”±äºè½¬æ¢è¾ƒå¤šï¼Œçœ‹èµ·æ¥ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œä¼˜åŒ–å»æ‰è½¬æ¢éƒ¨åˆ†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//è¯¥æºä»£ç å°†__main_block_impl_0ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ï¼Œå³æ ˆä¸Šç”Ÿæˆçš„__main_block_impl_0ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆï¼Œèµ‹å€¼ç»™__main_block_impl_0ç»“æ„ä½“æŒ‡é’ˆç±»å‹çš„å˜é‡ã€‚</span></span><br><span class="line"><span class="hljs-comment">//ä¸‹é¢ä¸¤è¡Œå¯¹åº”çš„ä»£ç æ˜¯ï¼švoid (^blk)(void) = ^&#123;printf("Block\n");&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//__main_block_impl_0çš„æ„é€ å‡½æ•°éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸Šé¢æºä»£ç ä¸­æ„é€ å‡½æ•°å‚æ•°æœ‰3ä¸ªï¼Œæœ€åä¸€ä¸ªæœ‰é»˜è®¤å€¼ï¼Œå¯ä»¥ä¸ä¼ ï¼Œæ‰€ä»¥è¿™é‡Œä¼ çš„æ˜¯ä¸¤ä¸ªå‚æ•°ï¼š</span></span><br><span class="line"><span class="hljs-comment">//- ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯blockä¸­æ‰€æ‰§è¡Œçš„å…·ä½“å†…å®¹ï¼Œç”±blockè¯­æ³•è½¬æ¢çš„Cè¯­è¨€å‡½æ•°ã€‚</span></span><br><span class="line"><span class="hljs-comment">//- ç¬¬äºŒä¸ªå‚æ•°æ˜¯é™æ€å…¨å±€å˜é‡åˆå§‹åŒ–çš„__main_block_desc_0ç»“æ„ä½“å®ä¾‹æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="hljs-comment">// å¯¹åº”è¿™ä¸€éƒ¨åˆ†æºä»£ç ï¼š</span></span><br><span class="line"><span class="hljs-comment">//  static struct __main_block_desc_0 &#123;</span></span><br><span class="line"><span class="hljs-comment">//Â  size_t reserved;</span></span><br><span class="line"><span class="hljs-comment">//Â  size_t Block_size;</span></span><br><span class="line"><span class="hljs-comment">//  &#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</span></span><br><span class="line"><span class="hljs-comment">//  ç”±æ­¤å¯çŸ¥ï¼Œè¯¥æºä»£ç ä½¿ç”¨blockï¼Œå³__main_block_impl_0ç»“æ„ä½“å®ä¾‹çš„å¤§å°è¿›è¡Œåˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> <span class="hljs-title">tmp</span> = __<span class="hljs-title">main_block_impl_0</span>(__<span class="hljs-title">main_block_func_0</span>,&amp;__<span class="hljs-title">main_block_desc_0_DATA</span>);</span><span class="hljs-comment">//è¿™é‡Œè°ƒç”¨çš„æ˜¯__main_block_impl_0çš„æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> *<span class="hljs-title">blk</span> = &amp;<span class="hljs-title">tmp</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//è¿™å°±æ˜¯ç®€å•åœ°ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè°ƒç”¨å‡½æ•°ï¼ŒFuncPtrå‡½æ•°ä¼ å…¥çš„å‚æ•°__cself,è¿™é‡Œä¸ºblkï¼Œæ‰€ä»¥ä¹Ÿè¯æ˜äº†__cselfæŒ‡å‘blockè‡ªèº«ã€‚æŠŠblcä¼ ç»™FuncPtrï¼Œä¸ºäº†å°±æ˜¯åœ¨FuncPtré‡Œé¢è°ƒç”¨block</span></span><br><span class="line">blk-&gt;FuncPtr(blk);</span><br></pre></td></tr></table></figure><p>ç»“è®ºï¼š<code>block</code>æ˜¯æŒ‡å‘<code>ç»“æ„ä½“</code>çš„<code>æŒ‡é’ˆ</code>ï¼Œåˆå› ä¸ºè¯¥ç»“æ„ä½“å«æœ‰<code>isaæŒ‡é’ˆ</code>ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥è¯´<code>block</code>æœ¬è´¨å°±æ˜¯<code>OCå¯¹è±¡</code>ã€‚</p><h2 id="blockå˜é‡æ•è·æœºåˆ¶"><a href="#blockå˜é‡æ•è·æœºåˆ¶" class="headerlink" title="blockå˜é‡æ•è·æœºåˆ¶"></a>blockå˜é‡æ•è·æœºåˆ¶</h2><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">int</span> dmy = <span class="hljs-number">256</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> val = <span class="hljs-number">10</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *fmt = <span class="hljs-string">"val = %d\n"</span>;</span><br><span class="line">    <span class="hljs-keyword">void</span> (^blk)(<span class="hljs-keyword">void</span>) = ^&#123;<span class="hljs-built_in">printf</span>(fmt,val);&#125;;</span><br><span class="line">    </span><br><span class="line">    blk();</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ä¸Šé¢æˆªè·å˜é‡å€¼çš„ æºä»£ç é€šè¿‡clangè¿›è¡Œè½¬æ¢ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">block_impl</span> <span class="hljs-title">impl</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span>* <span class="hljs-title">Desc</span>;</span></span><br><span class="line">  <span class="hljs-comment">/*blockè¯­æ³•è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡è¢«ä½œä¸ºæˆå‘˜å˜é‡è¿½åŠ åˆ°äº†__main_block_impl_0ç»“æ„ä½“ä¸­ï¼šfmtã€valæ²¡æœ‰ä½¿ç”¨çš„å±€éƒ¨å˜é‡ä¸ä¼šè¢«è¿½åŠ */</span></span><br><span class="line">  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *fmt;</span><br><span class="line">  <span class="hljs-keyword">int</span> val;</span><br><span class="line">  <span class="hljs-comment">/*åœ¨åˆå§‹åŒ–ç»“æ„ä½“å®ä¾‹æ—¶ï¼Œæ ¹æ®ä¼ é€’ç»™æ„é€ å‡½æ•°çš„å‚æ•°å¯¹ç”±è‡ªåŠ¨å˜é‡è¿½åŠ çš„æˆå‘˜å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚ç”±æ­¤å¯çŸ¥ï¼Œåœ¨__main_block_impl_0ç»“æ„ä½“å®ä¾‹ä¸­ï¼Œè‡ªåŠ¨å˜é‡å€¼è¢«æˆªè·*/</span></span><br><span class="line">  __main_block_impl_0(<span class="hljs-keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *_fmt, <span class="hljs-keyword">int</span> _val, <span class="hljs-keyword">int</span> flags=<span class="hljs-number">0</span>) : fmt(_fmt), val(_val) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="hljs-comment">//bound by copyè¿™é‡Œçš„æ³¨é‡Šè¡¨ç¤ºï¼Œblockå¯¹å®ƒå¼•ç”¨çš„å±€éƒ¨å˜é‡åšäº†åªè¯»æ‹·è´ï¼Œä¹Ÿå°±æ˜¯è¯´blockå¼•ç”¨çš„æ˜¯å±€éƒ¨å˜é‡çš„å‰¯æœ¬ã€‚æ‰€ä»¥åœ¨æ‰§è¡Œblockè¯­æ³•åï¼Œå³ä½¿æ”¹å†™blockä¸­ä½¿ç”¨çš„å±€éƒ¨å˜é‡çš„å€¼ä¹Ÿä¸ä¼šå½±å“blockæ‰§è¡Œæ—¶å±€éƒ¨å˜é‡çš„å€¼ã€‚</span></span><br><span class="line">  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *fmt = __cself-&gt;fmt; <span class="hljs-comment">// bound by copy</span></span><br><span class="line">  <span class="hljs-keyword">int</span> val = __cself-&gt;val; <span class="hljs-comment">// bound by copy</span></span><br><span class="line">  <span class="hljs-built_in">printf</span>(fmt,val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-keyword">size_t</span> reserved;</span><br><span class="line">  <span class="hljs-keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> dmy = <span class="hljs-number">256</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> val = <span class="hljs-number">10</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *fmt = <span class="hljs-string">"val = %d\n"</span>;</span><br><span class="line">    <span class="hljs-keyword">void</span> (*blk)(<span class="hljs-keyword">void</span>) = ((<span class="hljs-keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="hljs-keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, fmt, val));</span><br><span class="line"></span><br><span class="line">    ((<span class="hljs-keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»çš„æ¥è¯´ï¼Œæ‰€è°“â€œæˆªè·è‡ªåŠ¨å˜é‡å€¼â€æ„å‘³ç€åœ¨æ‰§è¡Œblockè¯­æ³•æ—¶ï¼Œblockè¯­æ³•è¡¨è¾¾å¼æ‰€ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡å€¼æ¥ä¿å­˜åˆ°blockçš„ç»“æ„ä½“å®ä¾‹ä¸­ã€‚</p><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œblockä¸èƒ½ç›´æ¥ä½¿ç”¨Cè¯­è¨€æ•°ç»„ç±»å‹çš„è‡ªåŠ¨å˜é‡ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºblockæˆªè·è‡ªåŠ¨å˜é‡æ—¶ï¼Œæ˜¯é€šè¿‡å°†å€¼ä¼ é€’ç»™ç»“æ„ä½“çš„æ„é€ å‡½æ•°è¿›è¡Œä¿å­˜ã€‚å› ä¸ºcè¯­è¨€ä¸å…è®¸è¿™ç§èµ‹å€¼</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">char</span> a[<span class="hljs-number">10</span>])</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">char</span> b[<span class="hljs-number">10</span>] = a;<span class="hljs-comment">//æ­¤å¤„æŠ¥é”™ï¼šArray initializer must be an initializer or string literal</span></span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>,b[<span class="hljs-number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="blockè¯´æ˜ç¬¦"><a href="#blockè¯´æ˜ç¬¦" class="headerlink" title="__blockè¯´æ˜ç¬¦"></a>__blockè¯´æ˜ç¬¦</h2><p>å†æ¥å›é¡¾å‰é¢æˆªè·è‡ªåŠ¨å˜é‡å€¼å¾—ä¾‹å­</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^&#123;<span class="hljs-built_in">printf</span>(fmt,val);&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æºä»£ç è½¬æ¢å¦‚ä¸‹</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *fmt = __cself-&gt;fmt; <span class="hljs-comment">// bound by copy</span></span><br><span class="line">  <span class="hljs-keyword">int</span> val = __cself-&gt;val; <span class="hljs-comment">// bound by copy</span></span><br><span class="line">  <span class="hljs-built_in">printf</span>(fmt,val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>blockä¸­æ‰€ä½¿ç”¨çš„è¢«æˆªè·è‡ªåŠ¨å˜é‡å°±å¦‚â€œå¸¦æœ‰è‡ªåŠ¨å˜é‡å€¼çš„åŒ¿åå‡½æ•°â€æ‰€è¯´ï¼Œä»…æˆªè·è‡ªåŠ¨å˜é‡ã€‚blockä¸­ä½¿ç”¨è‡ªåŠ¨å˜é‡åï¼Œåœ¨blockçš„ç»“æ„ä½“å®ä¾‹ä¸­é‡å†™è¯¥è‡ªåŠ¨å˜é‡ä¹Ÿä¸ä¼šæ”¹å˜åŸå…ˆæˆªè·çš„è‡ªåŠ¨å˜é‡ã€‚</p><p>å¦‚æœåœ¨blockä¸­ä¿®æ”¹æˆªè·è‡ªåŠ¨å˜é‡çš„å€¼ä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯ï¼Œå› ä¸ºåœ¨å®ç°ä¸Šä¸èƒ½æ”¹å†™æˆªè·è‡ªåŠ¨å˜é‡çš„å€¼ã€‚</p><p>è§£å†³è¿™ç§é—®é¢˜æœ‰ä¸¤ä¸ªæ–¹æ³•ã€‚</p><h3 id="ç¬¬ä¸€ç§ï¼šCè¯­è¨€ä¸­æœ‰å‡ ç§å˜é‡å…è®¸blockæ”¹å†™å€¼ï¼š"><a href="#ç¬¬ä¸€ç§ï¼šCè¯­è¨€ä¸­æœ‰å‡ ç§å˜é‡å…è®¸blockæ”¹å†™å€¼ï¼š" class="headerlink" title="ç¬¬ä¸€ç§ï¼šCè¯­è¨€ä¸­æœ‰å‡ ç§å˜é‡å…è®¸blockæ”¹å†™å€¼ï¼š"></a>ç¬¬ä¸€ç§ï¼šCè¯­è¨€ä¸­æœ‰å‡ ç§å˜é‡å…è®¸blockæ”¹å†™å€¼ï¼š</h3><ul><li>é™æ€å±€éƒ¨å˜é‡</li><li>é™æ€å…¨å±€å˜é‡</li><li>å…¨å±€å˜é‡</li></ul><p>è™½ç„¶blockè¯­æ³•çš„åŒ¿åå‡½æ•°éƒ¨åˆ†ç®€å•åœ°å˜æ¢ä¸ºäº†cè¯­è¨€å‡½æ•°ï¼Œä½†ä»è¿™ä¸ªå˜æ¢çš„å‡½æ•°ä¸­è®¿é—®é™æ€å…¨å±€å˜é‡/å…¨å±€å˜é‡å¹¶æ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Œå¯ç›´æ¥ä½¿ç”¨ã€‚ä½†æ˜¯é™æ€å±€éƒ¨å˜é‡çš„æƒ…å†µä¸‹ï¼Œè½¬æ¢åçš„å‡½æ•°åŸæœ¬å°±è®¾ç½®åœ¨å«æœ‰blockè¯­æ³•çš„å‡½æ•°å¤–é¢ï¼Œæ‰€ä»¥æ— æ³•åœ¨å˜é‡ä½œç”¨åŸŸè®¿é—®ã€‚</p><p>çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span> global_val = <span class="hljs-number">1</span>;</span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> static_global_val = <span class="hljs-number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> static_val = <span class="hljs-number">3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">void</span> (^blk)(<span class="hljs-keyword">void</span>) = ^&#123;</span><br><span class="line">        global_val *= <span class="hljs-number">1</span>;</span><br><span class="line">        static_global_val *= <span class="hljs-number">2</span>;</span><br><span class="line">        static_val *= <span class="hljs-number">3</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    blk();</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æºä»£ç è½¬æ¢åå¦‚ä¸‹ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span> global_val = <span class="hljs-number">1</span>;</span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> static_global_val = <span class="hljs-number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">block_impl</span> <span class="hljs-title">impl</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span>* <span class="hljs-title">Desc</span>;</span></span><br><span class="line">  <span class="hljs-comment">//å°†é™æ€å±€éƒ¨å˜é‡çš„åœ°å€ä½œä¸ºæˆå‘˜å˜é‡ä¿å­˜</span></span><br><span class="line">  <span class="hljs-keyword">int</span> *static_val;</span><br><span class="line">  __main_block_impl_0(<span class="hljs-keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="hljs-keyword">int</span> *_static_val, <span class="hljs-keyword">int</span> flags=<span class="hljs-number">0</span>) : static_val(_static_val) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="hljs-keyword">int</span> *static_val = __cself-&gt;static_val; <span class="hljs-comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">  global_val *= <span class="hljs-number">1</span>;</span><br><span class="line">  static_global_val *= <span class="hljs-number">2</span>;</span><br><span class="line">  (*static_val) *= <span class="hljs-number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-keyword">size_t</span> reserved;</span><br><span class="line">  <span class="hljs-keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> static_val = <span class="hljs-number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">void</span> (*blk)(<span class="hljs-keyword">void</span>) = ((<span class="hljs-keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="hljs-keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;static_val));</span><br><span class="line"></span><br><span class="line">    ((<span class="hljs-keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è½¬æ¢åçš„ä»£ç å¯ä»¥å¾—çŸ¥ï¼Œå¯¹é™æ€å…¨å±€å˜é‡å’Œå…¨å±€å˜é‡çš„è®¿é—®ä¸è½¬æ¢å‰å®Œå…¨ç›¸åŒï¼Œå› ä¸ºä»–ä»¬æ˜¯å…¨å±€å˜é‡ï¼Œä¸ç®¡åœ¨å“ªé‡Œéƒ½å¯ä»¥è®¿é—®åˆ°ï¼Œæ²¡æœ‰ä½œç”¨åŸŸçš„é™åˆ¶ã€‚ä½†æ˜¯å¯¹äºé™æ€å±€éƒ¨å˜é‡ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨æŒ‡é’ˆæ¥è®¿é—®å‘¢ï¼Ÿ</p><p>å› ä¸ºé™æ€å±€éƒ¨å˜é‡åœ¨å…¶æ‰€åœ¨å‡½æ•°ç»“æŸåï¼Œæ˜¯ä»ç„¶å­˜åœ¨çš„ï¼ˆè‡ªåŠ¨å˜é‡åœ¨å‡½æ•°ç»“æŸåå°±ä¸å­˜åœ¨ï¼‰ï¼Œä½†åˆå› ä¸ºåœ¨å…¶ä»–å‡½æ•°ä¸­æ— æ³•å¼•ç”¨åˆ°è¯¥é™æ€å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥é€šè¿‡å°†é™æ€å±€éƒ¨å˜é‡çš„æŒ‡é’ˆä¼ é€’ç»™blockç»“æ„ä½“çš„æ„é€ å‡½æ•°å¹¶ä½œä¸ºæˆå‘˜å˜é‡ä¿å­˜ï¼Œæ˜¯è¶…å‡ºä½œç”¨åŸŸä½¿ç”¨é™æ€å±€éƒ¨å˜é‡çš„æœ€ç®€å•æ–¹æ³•ã€‚</p><p>é™æ€å±€éƒ¨å˜é‡çš„è¿™ç§æ–¹æ³•ä¹Ÿé€‚ç”¨äºè‡ªåŠ¨å˜é‡çš„è®¿é—®ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºå‰é¢å·²ç»æåˆ°äº†ï¼Œåœ¨å˜é‡ä½œç”¨åŸŸç»“æŸçš„åŒæ—¶ï¼Œé™æ€å±€éƒ¨å˜é‡æ²¡æœ‰è¢«åºŸå¼ƒï¼Œè€Œè‡ªåŠ¨å˜é‡è¢«åºŸå¼ƒæ‰äº†ï¼Œæ‰€ä»¥å°†ä¸èƒ½é€šè¿‡æŒ‡é’ˆè®¿é—®åŸæ¥çš„è‡ªåŠ¨å˜é‡ã€‚</p><h3 id="ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨â€-blockè¯´æ˜ç¬¦â€"><a href="#ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨â€-blockè¯´æ˜ç¬¦â€" class="headerlink" title="ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨â€__blockè¯´æ˜ç¬¦â€"></a>ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨â€__blockè¯´æ˜ç¬¦â€</h3><p>â€<code>__block</code>è¯´æ˜ç¬¦â€œ,æ›´å‡†ç¡®çš„è¡¨è¿°æ–¹å¼ä¸ºâ€__blockå­˜å‚¨åŸŸç±»è¯´æ˜ç¬¦â€ã€‚</p><p>ä¸‹é¢æ˜¯ä½¿ç”¨__blockä¿®é¥°è‡ªåŠ¨å˜é‡çš„ä»£ç ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    __block <span class="hljs-keyword">int</span> val = <span class="hljs-number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">void</span> (^blk)(<span class="hljs-keyword">void</span>) = ^ &#123;</span><br><span class="line">        val = <span class="hljs-number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    blk();</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å˜æ¢åå¦‚ä¸‹ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">Block_byref_val_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-keyword">void</span> *__isa;</span><br><span class="line">  __Block_byref_val_0 *__forwarding;</span><br><span class="line">  <span class="hljs-keyword">int</span> __flags;</span><br><span class="line">  <span class="hljs-keyword">int</span> __size;</span><br><span class="line">  <span class="hljs-keyword">int</span> val;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">block_impl</span> <span class="hljs-title">impl</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span>* <span class="hljs-title">Desc</span>;</span></span><br><span class="line">  __Block_byref_val_0 *val; <span class="hljs-comment">// by ref</span></span><br><span class="line">  __main_block_impl_0(<span class="hljs-keyword">void</span> *fp, struct __main_block_desc_0 *desc, __Block_byref_val_0 *_val, <span class="hljs-keyword">int</span> flags=<span class="hljs-number">0</span>) : val(_val-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    </span><br><span class="line">    __Block_byref_val_0 *val = __cself-&gt;val; <span class="hljs-comment">// bound by ref</span></span><br><span class="line"></span><br><span class="line">    (val-&gt;__forwarding-&gt;val) = <span class="hljs-number">1</span>;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;</span><br><span class="line">    _Block_object_assign((<span class="hljs-keyword">void</span>*)&amp;dst-&gt;val, (<span class="hljs-keyword">void</span>*)src-&gt;val, <span class="hljs-number">8</span><span class="hljs-comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="hljs-keyword">void</span>*)src-&gt;val, <span class="hljs-number">8</span><span class="hljs-comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-keyword">size_t</span> reserved;</span><br><span class="line">  <span class="hljs-keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="hljs-keyword">void</span> (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</span><br><span class="line">  <span class="hljs-keyword">void</span> (*dispose)(struct __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    __attribute__((__blocks__(byref))) __Block_byref_val_0 val = &#123;(<span class="hljs-keyword">void</span>*)<span class="hljs-number">0</span>,(__Block_byref_val_0 *)&amp;val, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(__Block_byref_val_0), <span class="hljs-number">10</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">void</span> (*blk)(<span class="hljs-keyword">void</span>) = ((<span class="hljs-keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="hljs-keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, <span class="hljs-number">570425344</span>));</span><br><span class="line">    ((<span class="hljs-keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªæ˜¯åœ¨è‡ªåŠ¨å˜é‡ä¸Šé™„åŠ äº†__blockè¯´æ˜ç¬¦ï¼Œæºä»£ç é‡å°±æ€¥å‰§å¢åŠ ã€‚</p><p>__blockä¿®é¥°çš„valå˜é‡</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="hljs-keyword">int</span> val = <span class="hljs-number">10</span>;</span><br></pre></td></tr></table></figure><p>ï¼Œè½¬æ¢æˆäº†ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">Block_byref_val_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-keyword">void</span> *__isa;</span><br><span class="line">  __Block_byref_val_0 *__forwarding;</span><br><span class="line">  <span class="hljs-keyword">int</span> __flags;</span><br><span class="line">  <span class="hljs-keyword">int</span> __size;</span><br><span class="line">  <span class="hljs-keyword">int</span> val;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œèƒ½å¤Ÿå‘ç°ï¼Œ__blockä¿®é¥°çš„è‡ªåŠ¨å˜é‡ä¹ŸåŒblockä¸€æ ·å˜æˆäº†__Block_byref_val<em>0ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ï¼Œå³æ ˆä¸Šç”Ÿæˆçš„\</em>_Block_byref_val_0ç»“æ„ä½“å®ä¾‹ã€‚</p><p>å†æ¥çœ‹ä¸€ä¸‹__blockå˜é‡èµ‹å€¼çš„ä»£ç ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^ &#123;</span><br><span class="line">       val = <span class="hljs-number">1</span>;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure><p>è¯¥æºä»£ç è½¬æ¢å¦‚ä¸‹ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    </span><br><span class="line">    __Block_byref_val_0 *val = __cself-&gt;val; <span class="hljs-comment">// bound by ref</span></span><br><span class="line"></span><br><span class="line">    (val-&gt;__forwarding-&gt;val) = <span class="hljs-number">1</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>blockçš„__main_block_impl<em>0ç»“æ„ä½“å®ä¾‹æŒæœ‰æŒ‡å‘å˜é‡çš„\</em>_Block_byref_bal_0ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆã€‚__Block_byref_bal_0ç»“æ„ä½“å®ä¾‹çš„æˆå‘˜å˜é‡__forwardingæŒæœ‰æŒ‡å‘è¯¥å®ä¾‹è‡ªèº«çš„æŒ‡é’ˆã€‚é€šè¿‡æˆå‘˜å˜é‡__forwardingè®¿é—®æˆå‘˜å˜é‡valã€‚</p><p>è¿™é‡Œä¼šé‡åˆ°3ä¸ªé—®é¢˜</p><p>1.ä¸ºä»€ä¹ˆ_<em>blockå˜é‡çš„\</em>_Block_byref_val_0ç»“æ„ä½“ä¸æ”¾åœ¨__main_block_impl_0ç»“æ„ä½“ä¸­ï¼Ÿ</p><p>è¿™æ ·åšæ˜¯ä¸ºäº†åœ¨å¤šä¸ªBlockä¸­ä½¿ç”¨__blockå˜é‡ã€‚è¾¾åˆ°å¤ç”¨æ•ˆæœï¼Œä»è€ŒèŠ‚çœä¸å¿…è¦çš„ç©ºé—´å¼€é”€ã€‚</p><p>2.blockè¶…å‡ºå˜é‡ä½œç”¨åŸŸå¯å­˜åœ¨çš„ç†ç”±</p><p>3.__blockå˜é‡çš„ç»“æ„ä½“æˆå‘˜å˜é‡__forwardingå­˜åœ¨çš„ç†ç”±ã€‚</p><p>é—®é¢˜2å’Œ3ï¼Œç•™åˆ°ä¸‹é¢è®²è§£</p><h2 id="Blockå­˜å‚¨åŸŸ"><a href="#Blockå­˜å‚¨åŸŸ" class="headerlink" title="Blockå­˜å‚¨åŸŸ"></a>Blockå­˜å‚¨åŸŸ</h2><p>é€šè¿‡å‰é¢çš„è¯´æ˜å¯çŸ¥ï¼Œblockè½¬æ¢ä¸ºblockçš„ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ï¼Œ_<em>blockå˜é‡è½¬æ¢ä¸º\</em>_blockå˜é‡çš„ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ã€‚</p><p>blockä¹Ÿæ˜¯Objective-Cå¯¹è±¡ï¼Œblockçš„ç±»æœ‰ï¼š</p><ul><li>_NSConcreteStackBlock</li><li>_NSConcreteGlobalBlock</li><li>_NSConcreteMallocBlock</li></ul><h3 id="å…¨å±€block"><a href="#å…¨å±€block" class="headerlink" title="å…¨å±€block"></a>å…¨å±€block</h3><p>ç‰¹ç‚¹ï¼šåº”ç”¨ç¨‹åºåœ¨å®ƒå°±åœ¨ã€‚</p><ul><li>åœ¨è®°å½•å…¨å±€å˜é‡çš„åœ°æ–¹å†™blockçš„æ—¶å€™ï¼Œblockä¸ºå…¨å±€block</li><li>ä¸åœ¨ä¹¦å†™å…¨å±€å˜é‡çš„åœ°æ–¹ï¼Œåªè¦ä¸æˆªè·è‡ªåŠ¨å˜é‡ï¼Œä¸ç®¡ç”¨ä»€ä¹ˆä¿®é¥°ç¬¦ä¿®é¥°ï¼Œéƒ½æ˜¯å…¨å±€blockã€‚</li></ul><p>å…¨å±€å˜é‡å…¨éƒ¨ç²—æ”¾åœ¨é™æ€å­˜å‚¨åŒºï¼Œåœ¨ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ç»™å…¨å±€å˜é‡åˆ†é…å­˜å‚¨åŒºï¼Œç¨‹åºæ‰§è¡Œå®Œæ¯•å°±é‡Šæ”¾ã€‚å®ƒä»¬å æ®å›ºå®šçš„å­˜å‚¨å•å…ƒã€‚</p><h3 id="æ ˆblock"><a href="#æ ˆblock" class="headerlink" title="æ ˆblock"></a>æ ˆblock</h3><p>ç‰¹ç‚¹ï¼šå£°æ˜å‘¨æœŸç”±ç³»ç»Ÿæ§åˆ¶ï¼Œè¶…å‡ºå…¶æ‰€åœ¨ä½œç”¨åŸŸå³é”€æ¯ã€‚</p><p>æˆªè·è‡ªåŠ¨å˜é‡ä¸”æ²¡æœ‰å¼ºæŒ‡é’ˆå¼•ç”¨çš„æ—¶å€™ï¼Œä¸ºæ ˆblockã€‚æ ˆblockå› ä¸ºå­˜å‚¨åœ¨æ ˆä¸Šï¼Œæ‰€ä»¥åœ¨è¶…å‡ºå…¶ä½œç”¨åŸŸæ—¶è¢«é”€æ¯ï¼Œä¸ä¼šå­˜åœ¨äº†ã€‚</p><p>åœ¨ARCä¸‹ã€‚ä¼šé»˜è®¤æ·»åŠ __strongä¿®é¥°ç¬¦ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šå‡ºç°æ ˆblockã€‚</p><p>å¤§å¤šæ•°æƒ…å†µç¼–è¯‘å™¨ä¼šä¼šåœ¨é€‚å½“çš„åœ°æ–¹æ·»åŠ ä¿®é¥°ï¼ŒæŠŠblockä»æ ˆå¤åˆ¶åˆ°å †ï¼Œæ¯”å¦‚å°†blockä½œä¸ºå‡½æ•°è¿”å›å€¼æ—¶ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å¤–çš„æƒ…å†µä¸‹éœ€è¦æ‰‹åŠ¨ç”Ÿæˆä»£ç ï¼Œå°†blockä»æ ˆå¤åˆ¶åˆ°å †ä¸Šã€‚</p><p>ç¼–è¯‘å™¨ä¸èƒ½è¿›è¡Œåˆ¤æ–­æ˜¯ä»€ä¹ˆæ ·çš„çŠ¶å†µå‘¢ï¼Ÿå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>å‘æ–¹æ³•æˆ–å‡½æ•°çš„å‚æ•°ä¸­ä¼ é€’blockæ—¶</li></ul><p>ä½†æ˜¯å¦‚æœåœ¨æ–¹æ³•æˆ–å‡½æ•°å†…éƒ¨é€‚å½“åœ°å¤åˆ¶äº†ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œé‚£ä¹ˆå°±ä¸å¿…åœ¨è°ƒç”¨è¯¥æ–¹æ³•æˆ–å‡½æ•°å‰æ‰‹åŠ¨å¤åˆ¶äº†ã€‚ä»¥ä¸‹æ–¹æ³•æˆ–å‡½æ•°ä¸ç”¨æ‰‹åŠ¨å¤åˆ¶ï¼š</p><ul><li>Cocoaæ¡†æ¶çš„æ–¹æ³•ä¸”æ–¹æ³•åä¸­å«æœ‰usingBlockç­‰æ—¶</li><li>GCDçš„api</li></ul><p>ä»¥ä¸‹ä¸¤ä¸ªä¾‹å­åœ¨ARCä¸‹éƒ½ä¸ºæ ˆblockï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (id)getBlockArray &#123;</span><br><span class="line">    int val = 10;</span><br><span class="line">    return [[NSArrary alloc] initWithObjects:</span><br><span class="line">            ^&#123;NSLog(@&quot;blk0:%d&quot;,val);&#125;,</span><br><span class="line">            ^&#123;NSLog(@&quot;blk0:%d&quot;,val);&#125;,</span><br><span class="line">            nil</span><br><span class="line">           ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//æ ˆblock</span><br><span class="line">int i = 0;</span><br><span class="line">NSLog(@&quot;%@&quot;,^&#123;NSLog(@&quot;%d&quot;,i);&#125;);//è¾“å‡ºç»“æœ __NSStackBlock__: 0x7fff57aada78&gt;</span><br></pre></td></tr></table></figure><h3 id="å †block"><a href="#å †block" class="headerlink" title="å †block"></a>å †block</h3><p>ç‰¹ç‚¹ï¼šæ²¡æœ‰å¼ºæŒ‡é’ˆå¼•ç”¨å³é”€æ¯ï¼Œç”Ÿå‘½å‘¨æœŸç”±ç¨‹åºå‘˜æ‰‹åŠ¨ç®¡ç†</p><p>æ ˆblockæœ‰å¼ºæŒ‡é’ˆstrong/copyå¼•ç”¨å°±ä¼šè¢«copyåˆ°å †ä¸­ï¼Œå˜æˆå †block</p><p>é€šè¿‡å¯¹ç€3ç±»blockçš„è§£é‡Šï¼Œä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆblockåœ¨è¶…å‡ºå…¶ä½œç”¨åŸŸä»ç„¶å¯ä»¥å­˜åœ¨ã€‚</p><h2 id="blockå˜é‡å­˜å‚¨åŸŸ"><a href="#blockå˜é‡å­˜å‚¨åŸŸ" class="headerlink" title="__blockå˜é‡å­˜å‚¨åŸŸ"></a>__blockå˜é‡å­˜å‚¨åŸŸ</h2><p>blockä»æ ˆå¤åˆ¶åˆ°å †æ—¶å¯¹__blockå˜é‡äº§ç”Ÿçš„å½±å“ï¼š</p><table><thead><tr><th>__blockå˜é‡çš„é…ç½®å­˜å‚¨åŸŸ</th><th>blockä»æ ˆå¤åˆ¶åˆ°å †æ—¶çš„å½±å“</th></tr></thead><tbody><tr><td>æ ˆ</td><td>ä»æ ˆå¤åˆ¶åˆ°å †å¹¶è¢«blockæŒæœ‰</td></tr><tr><td>å †</td><td>è¢«blockæŒæœ‰</td></tr></tbody></table><p>åœ¨ä¸€ä¸ªblockä¸­ä½¿ç”¨_<em>blockå˜é‡ï¼Œåˆ™å½“è¯¥blockä»æ ˆå¤åˆ¶åˆ°å †æ—¶ï¼Œä½¿ç”¨çš„æ‰€æœ‰\</em>_blockå˜é‡ä¹Ÿå¿…å®šé…ç½®åœ¨æ ˆä¸Šã€‚è¿™äº›__blockå˜é‡ä¹Ÿå…¨éƒ¨ä»æ ˆå¤åˆ¶åˆ°å¯¹ä¸Šã€‚æ­¤æ—¶blockæŒæœ‰__blockå˜é‡ã€‚å³ä½¿åœ¨è¯¥blockå·²å¤åˆ¶åˆ°å †çš„æƒ…å†µä¸‹ï¼Œå¤åˆ¶Blockä¹Ÿå¯¹æ‰€ä½¿ç”¨çš„__blockå˜é‡æ²¡æœ‰ä»»ä½•å½±å“ã€‚</p><p>åœ¨å¤šä¸ªblockä¸­ä½¿ç”¨__blockå˜é‡ï¼Œå› ä¸ºæœ€å…ˆä¼šå°†æ‰€æœ‰çš„blocké…ç½®åœ¨æ ˆä¸Šï¼Œæ‰€ä»¥__blockå˜é‡ä¹Ÿä¼šé…ç½®åœ¨æ ˆä¸Šã€‚åœ¨ä»»ä½•ä¸€ä¸ªblockä»æ ˆå¤åˆ¶åˆ°å †æ—¶ï¼Œ__blockå˜é‡ä¹Ÿä¼šä¸€å¹¶ä»æ ˆå¤åˆ¶åˆ°å †å¹¶è¢«è¯¥blockæ‰€æŒæœ‰ã€‚å½“å‰©ä¸‹çš„blockä»æ ˆå¤åˆ¶åˆ°å †æ—¶ï¼Œè¢«å¤åˆ¶çš„blockæŒæœ‰__blockå˜é‡ï¼Œå¹¶å¢åŠ __blockå˜é‡çš„å¼•ç”¨è®¡æ•°ã€‚</p><p>å¦‚æœé…ç½®åœ¨å †ä¸Šçš„blockè¢«åºŸå¼ƒï¼Œé‚£ä¹ˆå®ƒä¼šé‡Šæ”¾æ‰€æŒæœ‰çš„_<em>blockå˜é‡ï¼Œå½“è¯¥\</em>_blockå˜é‡æ²¡æœ‰æŒæœ‰è€…æ—¶ï¼Œå°±ä¼šé‡Šæ”¾ã€‚</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/block1.jpg" alt="IMG_49827612A50D-1"></p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/block2.jpg" alt="01522122826_.pic_h"></p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ­¤æ€è€ƒæ–¹å¼ä¸OCçš„å¼•ç”¨è®¡æ•°å†…å­˜ç®¡ç†å®Œå…¨ç›¸åŒã€‚</p><p>çœ‹å¦‚ä¸‹æºä»£ç ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    __block <span class="hljs-keyword">int</span> val = <span class="hljs-number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//åœ¨arcä¸‹ï¼Œä¸ç”¨copyå°±å¯ä»¥äº†ã€‚å› ä¸ºé»˜è®¤ä¼šæœ‰__strongä¿®é¥°ç¬¦</span></span><br><span class="line">    <span class="hljs-keyword">void</span> (^blk)(<span class="hljs-keyword">void</span>) = [^&#123;++val;&#125; copy];</span><br><span class="line">    </span><br><span class="line">    ++val;</span><br><span class="line">    </span><br><span class="line">    blk();</span><br><span class="line">    <span class="hljs-comment">//æ‰“å°ç»“æœä¸º2ã€‚è¯´æ˜æ ˆä¸Šçš„valç»“æ„ä½“ï¼Œå’Œå †ä¸Šçš„valç»“æ„ä½“ï¼ŒæŒ‡å‘åŒä¸€å—å†…å­˜åœ°å€ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢ä¼šç»™å‡ºç­”æ¡ˆã€‚</span></span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¬æ¢åå¦‚ä¸‹ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">block_impl</span> <span class="hljs-title">impl</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span>* <span class="hljs-title">Desc</span>;</span></span><br><span class="line">  __Block_byref_val_0 *val; <span class="hljs-comment">// by ref</span></span><br><span class="line">  __main_block_impl_0(<span class="hljs-keyword">void</span> *fp, struct __main_block_desc_0 *desc, __Block_byref_val_0 *_val, <span class="hljs-keyword">int</span> flags=<span class="hljs-number">0</span>) : val(_val-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_val_0 *val = __cself-&gt;val; <span class="hljs-comment">// bound by ref</span></span><br><span class="line">  ++(val-&gt;__forwarding-&gt;val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((<span class="hljs-keyword">void</span>*)&amp;dst-&gt;val, (<span class="hljs-keyword">void</span>*)src-&gt;val, <span class="hljs-number">8</span><span class="hljs-comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="hljs-keyword">void</span>*)src-&gt;val, <span class="hljs-number">8</span><span class="hljs-comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-keyword">size_t</span> reserved;</span><br><span class="line">  <span class="hljs-keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="hljs-keyword">void</span> (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</span><br><span class="line">  <span class="hljs-keyword">void</span> (*dispose)(struct __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//åªç•™ä¸‹mainå‡½æ•°ï¼Œå…¶ä»–éƒ¨åˆ†è¿™é‡Œçœç•¥</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    __attribute__((__blocks__(byref))) __Block_byref_val_0 val = &#123;(<span class="hljs-keyword">void</span>*)<span class="hljs-number">0</span>,(__Block_byref_val_0 *)&amp;val, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(__Block_byref_val_0), <span class="hljs-number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">void</span> (*blk)(<span class="hljs-keyword">void</span>) = ((<span class="hljs-keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="hljs-keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, <span class="hljs-number">570425344</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//æ³¨æ„è¿™é‡Œï¼</span></span><br><span class="line">    ++(val.__forwarding-&gt;val);</span><br><span class="line">    </span><br><span class="line">    ((<span class="hljs-keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,(val.__forwarding-&gt;val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°æºä»£ç ä¸­ï¼Œåˆ©ç”¨copyæ–¹æ³•å¤åˆ¶ä½¿ç”¨äº†_<em>blockå˜é‡çš„blockï¼Œblockå’Œ\</em>_blockå˜é‡ä¸¤è€…å‡ä»æ ˆå¤åˆ¶åˆ°äº†å †ä¸Šã€‚ä»£ç ä¸­æœ‰ä¸¤å¤„ä½¿ç”¨åˆ°äº†valï¼Œä¸€å¤„æ˜¯åœ¨blockçš„åŒ¿åå‡½æ•°é‡Œï¼Œä½¿ç”¨çš„æ˜¯å †ä¸Šçš„valï¼Œå¦ä¸€å¤„æ˜¯å¤åˆ¶å‰æ ˆä¸Šçš„__blockå˜é‡çš„ç»“æ„ä½“å®ä¾‹çš„åœ°å€ã€‚</p><p>é‚£æ˜¯å¦‚ä½•ä¿è¯ï¼Œä¸ç®¡__blockå˜é‡æ˜¯é…ç½®åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Šï¼Œéƒ½èƒ½å¤Ÿæ­£ç¡®çš„è®¿é—®è¯¥å˜é‡å‘¢ï¼Ÿ</p><p><strong>å› ä¸ºæ ˆä¸Šçš„_<em>blockå˜é‡ç”¨ç»“æ„ä½“å®ä¾‹åœ¨\</em>_blockå˜é‡ä»æ ˆå¤åˆ¶åˆ°å †ä¸Šæ—¶ï¼Œä¼šå°†æˆå‘˜å˜é‡__forwardingçš„å€¼æ›¿æ¢ä¸ºå¤åˆ¶ç›®æ ‡ä¸Šçš„__blockå˜é‡ç»“æ„ä½“å®ä¾‹çš„åœ°å€ã€‚æ‰€ä»¥å°±ç®—ä½¿ç”¨æ ˆä¸Šçš„__blockå˜é‡ã€‚è®¿é—®çš„å…¶å®è¿˜æ˜¯å †ä¸Šçš„é‚£ä¸ªã€‚</strong>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/block3.jpg" alt="mage-20180327152425"></p><p>é€šè¿‡è¯¥åŠŸèƒ½ï¼Œæ— è®ºæ˜¯åœ¨blockè¯­æ³•ä¸­ã€blockè¯­æ³•å¤–ä½¿ç”¨_<em>blockå˜é‡ï¼Œè¿˜æ˜¯\</em>_blockå˜é‡é…ç½®åœ¨æ ˆä¸Šæˆ–å †ä¸Šï¼Œéƒ½å¯ä»¥é¡ºåˆ©åœ°è®¿é—®åŒä¸€ä¸ª__blockå˜é‡ã€‚</p><h2 id="æˆªè·å¯¹è±¡"><a href="#æˆªè·å¯¹è±¡" class="headerlink" title="æˆªè·å¯¹è±¡"></a>æˆªè·å¯¹è±¡</h2><p>æ¥çœ‹ä¸€ä¸‹åœ¨blockè¯­æ³•ä¸­ä½¿ç”¨å¯¹è±¡çš„è¯­æ³•ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">blk_t blk;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-built_in">NSMutableArray</span> *array = [[<span class="hljs-built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    blk = ^(<span class="hljs-keyword">id</span> obj) &#123;</span><br><span class="line">        [array addObject:obj];</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">blk([<span class="hljs-built_in">NSObject</span> new]);</span><br><span class="line">blk([<span class="hljs-built_in">NSObject</span> new]);</span><br><span class="line">blk([<span class="hljs-built_in">NSObject</span> new]);</span><br></pre></td></tr></table></figure><p>å˜é‡ä½œç”¨åŸŸç»“æŸçš„åŒæ—¶ï¼Œå˜é‡arrayè¢«åºŸå¼ƒï¼Œå…¶å¼ºå¼•ç”¨å¤±æ•ˆï¼Œå› æ­¤èµ‹å€¼ç»™å˜é‡çš„arrayçš„NSMutableArrayç±»çš„å¯¹è±¡å¿…å®šè¢«é‡Šæ”¾å¹¶åºŸå¼ƒã€‚ä½†æ˜¯ä¸Šè¿°ä»£ç èƒ½å¤Ÿè¿è¡Œæ­£å¸¸ã€‚è¿™ä¸€ç»“æœæ„å‘³ç€èµ‹å€¼ç»™å˜é‡arrayçš„NSMutableArrayç±»çš„å¯¹è±¡åœ¨è¯¥æºä»£ç æœ€åblockçš„æ‰§è¡Œéƒ¨åˆ†è¶…å‡ºå…¶ä½œç”¨åŸŸè€Œå­˜åœ¨ã€‚é€šè¿‡ç¼–è¯‘è½¬æ¢åçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*<span class="hljs-keyword">blk_t</span>)</span><span class="hljs-params">(id)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">block_impl</span> <span class="hljs-title">impl</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span>* <span class="hljs-title">Desc</span>;</span></span><br><span class="line">  id <span class="hljs-built_in">array</span>;<span class="hljs-comment">//è¿™é‡Œæ˜¯åœ¨arcç¯å¢ƒä¸‹ï¼Œé»˜è®¤æœ‰__strongä¿®é¥°ç¬¦ã€‚å¼ºå¼•ç”¨</span></span><br><span class="line">  __main_block_impl_0(<span class="hljs-keyword">void</span> *fp, struct __main_block_desc_0 *desc, id _array, <span class="hljs-keyword">int</span> flags=<span class="hljs-number">0</span>) : <span class="hljs-built_in">array</span>(_array) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself, id obj) &#123;</span><br><span class="line">  id <span class="hljs-built_in">array</span> = __cself-&gt;<span class="hljs-built_in">array</span>; <span class="hljs-comment">// bound by copy</span></span><br><span class="line">  ((<span class="hljs-keyword">void</span> (*)(id, SEL, ObjectType))(<span class="hljs-keyword">void</span> *)objc_msgSend)((id)<span class="hljs-built_in">array</span>, sel_registerName(<span class="hljs-string">"addObject:"</span>), (id)obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((<span class="hljs-keyword">void</span>*)&amp;dst-&gt;<span class="hljs-built_in">array</span>, (<span class="hljs-keyword">void</span>*)src-&gt;<span class="hljs-built_in">array</span>, <span class="hljs-number">3</span><span class="hljs-comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="hljs-keyword">void</span>*)src-&gt;<span class="hljs-built_in">array</span>, <span class="hljs-number">3</span><span class="hljs-comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-keyword">size_t</span> reserved;</span><br><span class="line">  <span class="hljs-keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="hljs-keyword">void</span> (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</span><br><span class="line">  <span class="hljs-keyword">void</span> (*dispose)(struct __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/* @autoreleasepool */</span></span><br><span class="line">    &#123; __AtAutoreleasePool __autoreleasepool;</span><br><span class="line">     </span><br><span class="line">     <span class="hljs-keyword">blk_t</span> blk;</span><br><span class="line">     </span><br><span class="line">        &#123;</span><br><span class="line">            id <span class="hljs-built_in">array</span> = ((NSMutableArray *(*)(id, SEL))(<span class="hljs-keyword">void</span> *)objc_msgSend)((id)((NSMutableArray *(*)(id, SEL))(<span class="hljs-keyword">void</span> *)objc_msgSend)((id)objc_getClass(<span class="hljs-string">"NSMutableArray"</span>), sel_registerName(<span class="hljs-string">"alloc"</span>)), sel_registerName(<span class="hljs-string">"init"</span>));</span><br><span class="line"></span><br><span class="line">            blk = ((<span class="hljs-keyword">void</span> (*)(id))&amp;__main_block_impl_0((<span class="hljs-keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, <span class="hljs-built_in">array</span>, <span class="hljs-number">570425344</span>));</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="hljs-comment">//(*blk-&gt;impl.FuncPtr)(blk, [NSObject new]);</span></span><br><span class="line">        ((<span class="hljs-keyword">void</span> (*)(__block_impl *, id))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk, ((NSObject *(*)(id, SEL))(<span class="hljs-keyword">void</span> *)objc_msgSend)((id)objc_getClass(<span class="hljs-string">"NSObject"</span>), sel_registerName(<span class="hljs-string">"new"</span>)));</span><br><span class="line">        ((<span class="hljs-keyword">void</span> (*)(__block_impl *, id))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk, ((NSObject *(*)(id, SEL))(<span class="hljs-keyword">void</span> *)objc_msgSend)((id)objc_getClass(<span class="hljs-string">"NSObject"</span>), sel_registerName(<span class="hljs-string">"new"</span>)));</span><br><span class="line">        ((<span class="hljs-keyword">void</span> (*)(__block_impl *, id))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk, ((NSObject *(*)(id, SEL))(<span class="hljs-keyword">void</span> *)objc_msgSend)((id)objc_getClass(<span class="hljs-string">"NSObject"</span>), sel_registerName(<span class="hljs-string">"new"</span>)));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„è¢«èµ‹å€¼NSMutableArrayå¯¹è±¡å¹¶è¢«æˆªè·çš„è‡ªåŠ¨å˜é‡arrayã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®ƒæ˜¯blockç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡ï¼š</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">block_impl</span> <span class="hljs-title">impl</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">main_block_desc_0</span>* <span class="hljs-title">Desc</span>;</span></span><br><span class="line">    <span class="hljs-comment">//æ³¨æ„è¿™é‡Œ</span></span><br><span class="line">  id __strong <span class="hljs-built_in">array</span>;</span><br><span class="line">    </span><br><span class="line">  __main_block_impl_0(<span class="hljs-keyword">void</span> *fp, struct __main_block_desc_0 *desc, id _array, <span class="hljs-keyword">int</span> flags=<span class="hljs-number">0</span>) : <span class="hljs-built_in">array</span>(_array) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨Objective-Cä¸­ï¼ŒCè¯­è¨€ç»“æ„ä½“ä¸èƒ½å«æœ‰é™„æœ‰_<em>strongä¿®é¥°ç¬¦çš„å˜é‡ï¼ˆæ¢å¥è¯è¯´ï¼šå¯¹è±¡å‹å˜é‡ä¸èƒ½ä½œä¸ºCè¯­è¨€ç»“æ„ä½“çš„æˆå‘˜ï¼‰ã€‚å› ä¸ºç¼–è¯‘å™¨ä¸çŸ¥é“ä½•æ—¶è¿›è¡ŒCè¯­è¨€ç»“æ„ä½“çš„åˆå§‹åŒ–å’ŒåºŸå¼ƒæ“ä½œï¼Œä¸èƒ½å¾ˆå¥½åœ°ç®¡ç†å†…å­˜ã€‚ä½†æ˜¯Objective-Cè¿è¡Œæ—¶åº“èƒ½å¤Ÿå‡†ç¡®æŠŠæ¡blockä»æ ˆå¤åˆ¶åˆ°å †ä»¥åŠå †ä¸Šçš„blockè¢«åºŸå¼ƒçš„æ—¶æœºï¼Œå› æ­¤blockç»“æ„ä½“ä¸­å³ä½¿å«æœ‰å¯¹è±¡å‹å˜é‡ï¼Œä¹Ÿå¯ä»¥æ°å½“åœ°è¿›è¡Œåˆå§‹åŒ–å’ŒåºŸå¼ƒã€‚ä¸ºæ­¤éœ€è¦ä½¿ç”¨\</em>_main_block_desc_0ç»“æ„ä½“ä¸­å¢åŠ çš„æˆå‘˜å˜é‡copyå’Œdisposeï¼ˆè¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å‡½æ•°ï¼‰ï¼Œä»¥åŠä½œä¸ºæŒ‡é’ˆèµ‹å€¼ç»™è¯¥æˆå‘˜å˜é‡çš„__main_block_copy_0å‡½æ•°å’Œ__main_block_dispose_0å‡½æ•°ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;</span><br><span class="line">    _Block_object_assign((<span class="hljs-keyword">void</span>*)&amp;dst-&gt;<span class="hljs-built_in">array</span>, (<span class="hljs-keyword">void</span>*)src-&gt;<span class="hljs-built_in">array</span>, <span class="hljs-number">3</span><span class="hljs-comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __main_block_dispose_0(struct __main_block_impl_0*src)&#123;</span><br><span class="line">    _Block_object_dispose((<span class="hljs-keyword">void</span>*)src-&gt;<span class="hljs-built_in">array</span>, <span class="hljs-number">3</span><span class="hljs-comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿè½¬æ¢åçš„ä»£ç ï¼Œä¸Šé¢ä¸¤ä¸ªå‡½æ•°åŒ…æ‹¬ä½¿ç”¨æŒ‡é’ˆå…¨éƒ¨éƒ½æ²¡æœ‰è¢«è°ƒç”¨ã€‚é‚£ä¹ˆè¿™äº›å‡½æ•°æ˜¯ä»å“ªå„¿è°ƒç”¨å‘¢ï¼Ÿ</p><table><thead><tr><th>å‡½æ•°</th><th>è°ƒç”¨æ—¶æœº</th></tr></thead><tbody><tr><td>copyå‡½æ•°</td><td>æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †æ—¶</td></tr><tr><td>disposeå‡½æ•°</td><td>å †ä¸Šçš„blockè¢«åºŸå¼ƒæ—¶</td></tr></tbody></table><p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™æ ˆä¸Šçš„blockä¼šå¤åˆ¶åˆ°å †å‘¢ï¼Ÿ</p><ul><li>è°ƒç”¨blockçš„copy/strongå®ä¾‹æ–¹æ³•</li><li>blockä½œä¸ºå‡½æ•°è¿”å›å€¼è¿”å›æ—¶</li><li>å°†blockèµ‹å€¼ç»™é™„æœ‰__storngä¿®é¥°ç¬¦idç±»å‹çš„ç±»æˆ–blockç±»å‹æˆå‘˜å˜é‡æ—¶</li><li>åœ¨æ–¹æ³•ä¸­å«æœ‰usingBlockçš„Cocoaæ¡†æ¶æ–¹æ³•æˆ–GCDçš„apiä¸­ä¼ é€’blockæ—¶</li></ul><p>ä¹Ÿå°±æ˜¯è¯´è™½ç„¶ä»æºä»£ç æ¥çœ‹ï¼Œåœ¨ä¸Šé¢è¿™äº›æƒ…å†µä¸‹æ ˆä¸Šçš„blockè¢«èµ‹å€¼åˆ°å †ä¸Šï¼Œä½†å…¶å®å¯å½’ç»“ä¸º_Block<em>copyå‡½æ•°è¢«è°ƒç”¨æ—¶blockä»æ ˆå¤åˆ¶åˆ°å †ã€‚ç›¸å¯¹çš„ï¼Œåœ¨é‡Šæ”¾å¤åˆ¶åˆ°å †ä¸Šçš„blockåï¼Œè°éƒ½ä¸æŒæœ‰blockè€Œä½¿å…¶è¢«åºŸå¼ƒæ—¶è°ƒç”¨disoposeå‡½æ•°ã€‚è¿™ç›¸å½“äºå¯¹è±¡çš„deallocæ–¹æ³•ã€‚æœ‰äº†è¿™ç§æ„é€ ï¼Œé€šè¿‡ä½¿ç”¨é™„æœ‰__strongä¿®é¥°ç¬¦çš„è‡ªåŠ¨å˜é‡ï¼Œblockä¸­æˆªè·çš„å¯¹è±¡å°±èƒ½å¤Ÿè¶…å‡ºå…¶å˜é‡ä½œç”¨åŸŸè€Œå­˜åœ¨ã€‚è™½ç„¶è¿™ç§ä½¿ç”¨copyå‡½æ•°ï¼Œdisposeå‡½æ•°çš„æ–¹æ³•åœ¨ä¹‹å‰æ²¡æœ‰è®²è§£ï¼Œä½†å®é™…ä¸Šåœ¨\</em>_blockå˜é‡ä¸­å·²ç»ç”¨åˆ°äº†ã€‚</p><h2 id="blockä¿®é¥°å˜é‡å’Œå¯¹è±¡"><a href="#blockä¿®é¥°å˜é‡å’Œå¯¹è±¡" class="headerlink" title="__blockä¿®é¥°å˜é‡å’Œå¯¹è±¡"></a>__blockä¿®é¥°å˜é‡å’Œå¯¹è±¡</h2><p><code>__block</code>è¯´æ˜ç¬¦å¯æŒ‡å®šä»»ä½•ç±»å‹çš„è‡ªåŠ¨å˜é‡ã€‚ä¸‹é¢æŒ‡å®šç”¨äºèµ‹å€¼Objective-Cå¯¹è±¡çš„idç±»å‹è‡ªåŠ¨å˜é‡ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="hljs-keyword">id</span> obj = [<span class="hljs-built_in">NSObject</span> new];</span><br></pre></td></tr></table></figure><p>å…¶ä»£ç ç­‰åŒäºï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="hljs-keyword">id</span> __<span class="hljs-keyword">strong</span> obj = [<span class="hljs-built_in">NSObject</span> new];</span><br></pre></td></tr></table></figure><p>æ”¹ä»£ç å¯é€šè¿‡clangè½¬æ¢å¦‚ä¸‹ï¼š</p><p>åœ¨_<em>blockå˜é‡ä¸ºé™„æœ‰\</em>_strongä¿®é¥°ç¬¦çš„idç±»å‹æˆ–å¯¹è±¡ç±»å‹è‡ªåŠ¨å˜é‡çš„æƒ…å†µä¸‹ä¼šå‘ç”ŸåŒæ ·çš„è¿‡ç¨‹ã€‚å½“__blockå˜é‡ä»æ ˆå¤åˆ¶åˆ°å †ä¸Šæ—¶ï¼Œä½¿ç”¨_Block_object_assignå‡½æ•°ï¼ŒæŒæœ‰èµ‹å€¼ç»™__blockå˜é‡çš„å¯¹è±¡ã€‚å½“å †ä¸Šçš„__blockå˜é‡è¢«åºŸå¼ƒæ—¶ï¼Œåˆ™ä½¿ç”¨_Block_object_disposeå‡½æ•°é‡Šæ”¾èµ‹å€¼ç»™__blockå˜é‡çš„å¯¹è±¡ã€‚</p><p>å¦‚æœ__blockå’Œ__weakä¸€èµ·ä½¿ç”¨ï¼Œåˆ™blockä¸ä¼šè¢«æŒæœ‰ï¼Œæ‰€ä»¥ä¸èµ·ä½œç”¨ã€‚__blockä¸èƒ½å’Œ__autoreleasingä¸€èµ·ä½¿ç”¨ï¼Œä¼šç¼–è¯‘é”™è¯¯ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>blockæˆªè·è‡ªåŠ¨å˜é‡æ—¶ä¸ç®¡æˆªè·çš„è‡ªåŠ¨å˜é‡æ˜¯å¯¹è±¡ç±»å‹è¿˜æ˜¯åŸºæœ¬ç±»å‹ï¼Œéƒ½ä¼šåœ¨blockç»“æ„ä½“å†…éƒ¨å»ºç«‹ä¸€ä¸ªæˆå‘˜å˜é‡è¿›è¡Œå­˜å‚¨ï¼Œæ•°æ®ç±»å‹ä¸ä¸æˆªè·çš„è‡ªåŠ¨å˜é‡æ•°æ®ç±»å‹ç›¸åŒã€‚</li></ol><p>ä¸ºä»€ä¹ˆä¸èƒ½ä¿®æ”¹æˆªè·çš„è‡ªåŠ¨å˜é‡ï¼Ÿ</p><ul><li>å¯¹äºå€¼ç±»å‹ï¼Œæ˜¯ç®€å•çš„å€¼ä¼ é€’ã€‚ï¼ˆä¸ºä»€ä¹ˆä¸ç›´æ¥ä¼ é€’æŒ‡é’ˆå‘¢ï¼Ÿå› ä¸ºå€¼ç±»å‹ä¿å­˜åœ¨æ ˆä¸Šï¼Œå°±ç®—ä¼ é€’äº†æŒ‡é’ˆï¼Œå€¼ç±»å‹åœ¨å‡½æ•°ç»“æŸåå°±é”€æ¯äº†ã€‚æ‰€ä»¥ä¼ é€’æŒ‡é’ˆä¹Ÿæ²¡æœ‰æ„ä¹‰ã€‚ï¼‰</li><li>å¯¹äºå¯¹è±¡ç±»å‹æ˜¯æŒ‡é’ˆæµ…å¤åˆ¶ï¼ˆæµ…æ‹·è´å°±æ˜¯æ‹·è´æŒ‡å‘åŸæ¥å¯¹è±¡çš„æŒ‡é’ˆï¼Œä½¿åŸå¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1ï¼Œå¯ä»¥ç†è§£ä¸ºåˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘åŸå¯¹è±¡çš„æ–°æŒ‡é’ˆè€Œå·²ï¼Œå¹¶æ²¡æœ‰åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤åˆ¶åçš„å˜é‡ä¿®æ”¹è¿™ä»½å†…å­˜ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹å¤–éƒ¨è‡ªåŠ¨å˜é‡ä½¿å…¶æŒ‡å‘å¦ä¸€å—å†…å­˜åŒºåŸŸï¼‰ã€‚</li></ul><ol><li><p>ä¸ºä»€ä¹ˆä½¿ç”¨__blockåå°±å¯ä»¥ä¿®æ”¹æˆªè·çš„è‡ªåŠ¨å˜é‡ï¼Ÿ</p><p>è¢«ä¿®é¥°äº†_<em>blockçš„è‡ªåŠ¨å˜é‡ä¸ç®¡æ˜¯åŸºæœ¬ç±»å‹è¿˜æ˜¯å¯¹è±¡ç±»å‹éƒ½ä¼šè¢«å°è£…åˆ°ä¸€ä¸ªç»“æ„ä½“ç±»å‹å˜é‡ä¸­ï¼Œè¡¨é¢ä¸Šçœ‹åˆ°çš„æ˜¯blockæˆªè·çš„æ˜¯è‡ªåŠ¨å˜é‡ï¼Œå…¶å®æ˜¯è¿™ä¸ªç»“æ„ä½“ç±»å‹å˜é‡çš„æŒ‡é’ˆï¼Œå› æ­¤å¯ä»¥ä¿®æ”¹è‡ªåŠ¨å˜é‡ã€‚å¹¶ä¸”å½“blockä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šæ—¶ï¼Œæ ˆä¸Šçš„\</em>_blockä¿®é¥°çš„è‡ªåŠ¨å˜é‡çš„ç»“æ„ä½“ç±»å‹å˜é‡çš„forwardingæŒ‡é’ˆä¼šæŒ‡å‘å †ä¸Šçš„__blockä¿®é¥°çš„è‡ªåŠ¨å˜é‡çš„ç»“æ„ä½“ç±»å‹å˜é‡ã€‚æ‰€ä»¥ä¸ç®¡æ˜¯åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Šï¼Œåœ¨blockå†…è¿˜æ˜¯åœ¨blockå¤–ä¿®æ”¹ä½¿ç”¨__blockä¿®é¥°çš„è‡ªåŠ¨å˜é‡ï¼Œä¿®æ”¹çš„éƒ½æ˜¯åŒä¸€å—å†…å­˜åŒºåŸŸã€‚</p></li></ol><blockquote><p>å‚è€ƒï¼š</p><p><a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00DE60G3S" target="_blank" rel="noopener">ã€ŠObjective-Cé«˜çº§ç¼–ç¨‹:iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹</a></p><p><a href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/" target="_blank" rel="noopener">ã€Šè°ˆObjective-C blockçš„å®ç°-å”å·§ã€‹</a></p><p><a href="http://www.desgard.com/iOS-Source-Probe/Objective-C/Runtime/%E6%B5%85%E8%B0%88%20block%EF%BC%882%EF%BC%89%20-%20%E6%88%AA%E8%8E%B7%E5%8F%98%E9%87%8F%E6%96%B9%E5%BC%8F.html" target="_blank" rel="noopener">ã€Šæµ…è°ˆ block - æˆªè·å˜é‡æ–¹å¼ã€‹</a></p><p><a href="https://www.cnblogs.com/acBool/p/5146639.html" target="_blank" rel="noopener">ã€ŠiOSä¸­çš„æ·±å¤åˆ¶ä¸æµ…å¤åˆ¶ã€‹</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;blockçš„æœ¬è´¨&quot;&gt;&lt;a href=&quot;#blockçš„æœ¬è´¨&quot; class=&quot;headerlink&quot; title=&quot;blockçš„æœ¬è´¨&quot;&gt;&lt;/a&gt;blockçš„æœ¬è´¨&lt;/h2&gt;&lt;p&gt;blockçœ‹ä¸Šå»æ˜¯â€œå¸¦æœ‰è‡ªåŠ¨å˜é‡å€¼çš„åŒ¿åå‡½æ•°â€ï¼Œå®é™…ä¸Šæ˜¯ä½œä¸ºææ™®é€šçš„Cè¯­è¨€æºä»£ç æ¥å¤„ç†çš„ã€‚é€šè¿‡æ”¯æŒBlockçš„ç¼–è¯‘å™¨ï¼Œå°†å«æœ‰Blockè¯­æ³•çš„æºä»£ç è½¬æ¢ä¸ºä¸€èˆ¬Cè¯­è¨€ç¼–è¯‘å™¨èƒ½å¤Ÿå¤„ç†çš„æºä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å®é™…ç¼–è¯‘æ—¶æ— æ³•è½¬æ¢ä¸ºæˆ‘ä»¬èƒ½å¤Ÿç†è§£çš„æºä»£ç ï¼Œä½†clang(LLVMç¼–è¯‘å™¨)å…·æœ‰è½¬æ¢ä¸ºæˆ‘ä»¬å¯è¯»æºä»£ç çš„åŠŸèƒ½ã€‚é€šè¿‡â€œ-rewrite-objcâ€é€‰é¡¹å°±èƒ½å°†å«æœ‰Blockè¯­æ³•çš„æºä»£ç è½¬æ¢ä¸ºC++ä»£ç ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
    
      <category term="Block" scheme="http://www.wuqihan.cn/tags/Block/"/>
    
  </entry>
  
  <entry>
    <title>macOSã€Darwinã€XNU</title>
    <link href="http://www.wuqihan.cn/2017/11/05/macOS%E3%80%81Darwin%E3%80%81XNU/"/>
    <id>http://www.wuqihan.cn/2017/11/05/macOSã€Darwinã€XNU/</id>
    <published>2017-11-05T14:19:09.000Z</published>
    <updated>2019-11-05T14:31:59.263Z</updated>
    
    <content type="html"><![CDATA[<p>OS X is the platform, Darwin is the operating system, and XNU is the kernel. Namely, the XNU kernel is the core piece of software that provides resource management, hardware abstraction, and scheduling. Darwin consists of the XNU kernel and basic software run by there kernel to provide a UNIX environment. OS X is built atop Darwin and provides a collection of frameworks and services that implement the user interface and main application libraries. Darwin and XNU are open source software, but the frameworks that make up the OS X platform on top of Darwin, are not.</p><a id="more"></a><blockquote><p>å¼•ç”¨è‡ªï¼š<a href="https://www.quora.com/Whats-the-difference-between-Mac-OS-X-Darwin-OS-and-a-popular-Linux-distribution-like-Ubuntu-What-can-be-done-on-Darwin" target="_blank" rel="noopener">https://www.quora.com/Whats-the-difference-between-Mac-OS-X-Darwin-OS-and-a-popular-Linux-distribution-like-Ubuntu-What-can-be-done-on-Darwin</a></p><p>è¿™é‡Œè¯´çš„OS Xï¼Œå°±æ˜¯macOSï¼Œåœ¨10.12ç‰ˆæœ¬å¼€å§‹(2016å¹´)ï¼Œè‹¹æœOS Xæ­£å¼æ”¹åä¸ºmacOSã€‚</p></blockquote><p>maxOS/iOSæ˜¯å¹³å°ï¼ŒDarwinæ˜¯æ“ä½œç³»ç»Ÿï¼ŒXNUæ˜¯å†…æ ¸ã€‚å³ï¼ŒXNUå†…æ ¸æ˜¯æä¾›èµ„æºç®¡ç†ï¼Œç¡¬ä»¶æŠ½è±¡å’Œè°ƒåº¦çš„æ ¸å¿ƒè½¯ä»¶ã€‚Darwinç”±XNUå†…æ ¸å’Œç”±è¯¥å†…æ ¸è¿è¡Œçš„åŸºæœ¬è½¯ä»¶ç»„æˆï¼Œä»¥æä¾›UNIXç¯å¢ƒã€‚macOSå’ŒiOSéƒ½æ˜¯æ„å»ºåœ¨Darwinä¹‹ä¸Šï¼Œå¹¶æä¾›äº†å®ç°ç”¨æˆ·ç•Œé¢å’Œä¸»è¦åº”ç”¨ç¨‹åºåº“çš„æ¡†æ¶å’ŒæœåŠ¡çš„é›†åˆã€‚Darwinå’ŒXNUæ˜¯å¼€æºè½¯ä»¶ï¼Œä½†åŸºäºDarwinä¹‹ä¸Šçš„macOS/iOSå¹³å°çš„æ¡†æ¶æ˜¯é—­æºçš„ã€‚</p><p><img src="https://i.loli.net/2019/11/05/atdEfhUTZMD2JXw.png" alt="Mac_OS_X_architecture.png"></p><blockquote><p>æ¨èé˜…è¯»ï¼š</p><p><a href="https://developer.apple.com/library/archive/documentation/Darwin/Conceptual/KernelProgramming/Architecture/Architecture.html" target="_blank" rel="noopener">Apple Kernel Programming</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;OS X is the platform, Darwin is the operating system, and XNU is the kernel. Namely, the XNU kernel is the core piece of software that provides resource management, hardware abstraction, and scheduling. Darwin consists of the XNU kernel and basic software run by there kernel to provide a UNIX environment. OS X is built atop Darwin and provides a collection of frameworks and services that implement the user interface and main application libraries. Darwin and XNU are open source software, but the frameworks that make up the OS X platform on top of Darwin, are not.&lt;/p&gt;
    
    </summary>
    
      <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://www.wuqihan.cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
      <category term="æ“ä½œç³»ç»Ÿ" scheme="http://www.wuqihan.cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="Darwin" scheme="http://www.wuqihan.cn/tags/Darwin/"/>
    
      <category term="macOS" scheme="http://www.wuqihan.cn/tags/macOS/"/>
    
      <category term="XNU" scheme="http://www.wuqihan.cn/tags/XNU/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ç»§æ‰¿ç±»ç°‡ï¼ˆä¾‹å¦‚NSStringï¼‰</title>
    <link href="http://www.wuqihan.cn/2017/05/15/%E5%A6%82%E4%BD%95%E7%BB%A7%E6%89%BF%E7%B1%BB%E7%B0%87/"/>
    <id>http://www.wuqihan.cn/2017/05/15/å¦‚ä½•ç»§æ‰¿ç±»ç°‡/</id>
    <published>2017-05-15T08:51:53.000Z</published>
    <updated>2018-08-18T03:09:24.799Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä»Šå¤©ä¹‹å‰ å¦‚æœæœ‰äººé—®æˆ‘ å¦‚æœç»™NSStringæ·»åŠ ä¸€ä¸ªæ–¹æ³• ï¼Œæˆ‘æœ€å…ˆæƒ³åˆ°çš„æ–¹æ³•è‚¯å®šå°±æ˜¯ä½¿ç”¨Categoryã€‚ä¸€ç›´è§‰å¾—NSStringæ˜¯ä¸èƒ½è¢«ç»§æ‰¿çš„ï¼Œå› ä¸ºå®ƒæ˜¯ç±»ç°‡ï¼Œå…¶å®å¦‚æœçœŸçš„æƒ³ç»§æ‰¿ï¼Œä¹Ÿæ˜¯æœ‰åŠæ³•çš„ã€‚<br>        åœ¨Cocoaæ¡†æ¶é‡Œæœ‰è®¸å¤šç±»ç°‡ï¼Œæ¯”å¦‚NSArrayï¼ŒNSStringï¼ŒNSNumberï¼ˆå…·ä½“ä»€ä¹ˆæ˜¯ç±»ç°‡å°±ä¸è§£é‡Šäº†ã€‚ç½‘ä¸Šå…³äºç±»ç°‡çš„ä»‹ç»å¾ˆå¤šï¼‰ã€‚</p><p>å…·ä½“å…³äºå¦‚ä½•ä¸ºç±»ç°‡æ·»åŠ å­ç±»ï¼Œéœ€è¦éµå®ˆå‡ æ¡è§„åˆ™ï¼š</p><blockquote><ol><li>å­ç±»åº”è¯¥ç»§æ‰¿è‡ªç±»ç°‡ä¸­çš„æŠ½è±¡åŸºç±»ã€‚</li><li>å­ç±»åº”è¯¥è‡ªå®šä¹‰è‡ªå·±çš„æ•°æ®å­˜å‚¨æ–¹å¼ã€‚ï¼ˆå¼€å‘è€…ç¼–å†™NSArrayå­ç±»æ—¶ï¼Œå¿…é¡»ç”¨ä¸€ä¸ªå®ä¾‹å˜é‡æ¥å­˜æ”¾æ•°ç»„ä¸­çš„å¯¹è±¡ã€‚è¿™ä¼¼ä¹ä¸å¤§å®¶é¢„æƒ³çš„ä¸åŒï¼Œæˆ‘ä»¬ä»¥ä¸ºNSArrayè‡ªå·±è‚¯å®šä¼šä¿å­˜é‚£äº›å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨å­ç±»ä¸­å°±æ— é¡»å†ä¿å­˜ä¸€ä»½äº†ã€‚ä½†æ˜¯å¤§å®¶è¦è®°ä½ï¼ŒNSArrayæœ¬èº«åªä¸è¿‡æ˜¯åŒ…åœ¨å…¶ä»–éšè—å¯¹è±¡å¤–é¢çš„å£³ï¼Œå®ƒä»…ä»…å®šä¹‰äº†æ‰€æœ‰æ•°ç»„éƒ½éœ€å…·å¤‡çš„ä¸€äº›æ¥å£ã€‚å¯¹äºè¿™ä¸ªè‡ªå®šä¹‰çš„æ•°ç»„ç±»æ¥è¯´ï¼Œå¯ä»¥ç”¨NSArrayæ¥ä¿å­˜å…¶å®ä¾‹ï¼‰ã€‚</li><li>å­ç±»åº”å½“è¦†å†™è¶…ç±»æ–‡æ¡£ä¸­æŒ‡æ˜éœ€è¦è¦†å†™çš„æ–¹æ³•ã€‚</li></ol></blockquote><a id="more"></a><p>æ¥ä¸‹æ¥å°±åŠ¨æ‰‹å®ç°å¦‚ä½•ç»§æ‰¿NSArray å’Œ NSStringã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#import <span class="hljs-meta-string">"WUArray.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">WUArray</span>()</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-built_in">NSArray</span> *_storeArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">WUArray</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="hljs-keyword">instancetype</span>)initWithArray:(<span class="hljs-built_in">NSArray</span> *)array &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-keyword">super</span> init]) &#123;</span><br><span class="line">        _storeArray = [<span class="hljs-built_in">NSArray</span> arrayWithArray:array];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#pragma mark - override</span></span><br><span class="line">- (<span class="hljs-built_in">NSUInteger</span>)count &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> _storeArray.count;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="hljs-keyword">id</span>)objectAtIndex:(<span class="hljs-built_in">NSUInteger</span>)index &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> [_storeArray objectAtIndex:index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">@end</span></span><br></pre></td></tr></table></figure><p>######ä»¥ä¸Šä¸ºWUArray.mæ–‡ä»¶</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#import <span class="hljs-meta-string">"WUString.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">WUString</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-built_in">NSString</span> *_storeString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">WUString</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="hljs-keyword">instancetype</span>)initWithString:(<span class="hljs-built_in">NSString</span> *)aString &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-keyword">self</span> init]) &#123;</span><br><span class="line">        _storeString = [[<span class="hljs-built_in">NSString</span> stringWithString:aString] <span class="hljs-keyword">copy</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="hljs-built_in">NSUInteger</span>)length &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> [_storeString length];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="hljs-keyword">unichar</span>)characterAtIndex:(<span class="hljs-built_in">NSUInteger</span>)index &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> [_storeString characterAtIndex:index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">@end</span></span><br></pre></td></tr></table></figure><p>######ä»¥ä¸Šä¸ºWUString.m æ–‡ä»¶</p><p>å®ç°å®Œä¹‹å æ¥éªŒè¯ä¸€ä¸‹ï¼š<br><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WUString *str = [[WUString alloc] initWithString:<span class="hljs-string">@"123456789"</span>];</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,[str substringFromIndex:<span class="hljs-number">5</span>]); <span class="hljs-comment">//æ§åˆ¶å°æ‰“å°è¾“å‡ºä¸º 6789</span></span><br><span class="line">    </span><br><span class="line">    WUArray *array = [[WUArray alloc] initWithArray:@[<span class="hljs-string">@"h"</span>,<span class="hljs-string">@"e"</span>,<span class="hljs-string">@"l"</span>,<span class="hljs-string">@"l"</span>,<span class="hljs-string">@"0"</span>]];</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,[array componentsJoinedByString:<span class="hljs-string">@"."</span>]); <span class="hljs-comment">//æ§åˆ¶å°æ‰“å°è¾“å‡ºä¸º h.e.l.l.o</span></span><br></pre></td></tr></table></figure></p><p>åœ¨ç»§æ‰¿çš„æ—¶å€™ å…³äºè¦å…·ä½“è¦†å†™è¶…ç±»çš„å“ªå‡ ä¸ªæ–¹æ³•ï¼ŒNSStringçš„å¤´æ–‡ä»¶é‡Œé¢å†™çš„æœ‰ï¼š<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/* NSString primitives. A minimal subclass of NSString just needs to implement these two, along with an init method appropriate for that subclass. We also recommend overriding getCharacters:range: for performance.</span><br><span class="line"> */</span><br><span class="line">@property (readonly) NSUInteger length;</span><br><span class="line">- (unichar)characterAtIndex:(NSUInteger)index;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä»Šå¤©ä¹‹å‰ å¦‚æœæœ‰äººé—®æˆ‘ å¦‚æœç»™NSStringæ·»åŠ ä¸€ä¸ªæ–¹æ³• ï¼Œæˆ‘æœ€å…ˆæƒ³åˆ°çš„æ–¹æ³•è‚¯å®šå°±æ˜¯ä½¿ç”¨Categoryã€‚ä¸€ç›´è§‰å¾—NSStringæ˜¯ä¸èƒ½è¢«ç»§æ‰¿çš„ï¼Œå› ä¸ºå®ƒæ˜¯ç±»ç°‡ï¼Œå…¶å®å¦‚æœçœŸçš„æƒ³ç»§æ‰¿ï¼Œä¹Ÿæ˜¯æœ‰åŠæ³•çš„ã€‚&lt;br&gt;        åœ¨Cocoaæ¡†æ¶é‡Œæœ‰è®¸å¤šç±»ç°‡ï¼Œæ¯”å¦‚NSArrayï¼ŒNSStringï¼ŒNSNumberï¼ˆå…·ä½“ä»€ä¹ˆæ˜¯ç±»ç°‡å°±ä¸è§£é‡Šäº†ã€‚ç½‘ä¸Šå…³äºç±»ç°‡çš„ä»‹ç»å¾ˆå¤šï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“å…³äºå¦‚ä½•ä¸ºç±»ç°‡æ·»åŠ å­ç±»ï¼Œéœ€è¦éµå®ˆå‡ æ¡è§„åˆ™ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;å­ç±»åº”è¯¥ç»§æ‰¿è‡ªç±»ç°‡ä¸­çš„æŠ½è±¡åŸºç±»ã€‚&lt;/li&gt;
&lt;li&gt;å­ç±»åº”è¯¥è‡ªå®šä¹‰è‡ªå·±çš„æ•°æ®å­˜å‚¨æ–¹å¼ã€‚ï¼ˆå¼€å‘è€…ç¼–å†™NSArrayå­ç±»æ—¶ï¼Œå¿…é¡»ç”¨ä¸€ä¸ªå®ä¾‹å˜é‡æ¥å­˜æ”¾æ•°ç»„ä¸­çš„å¯¹è±¡ã€‚è¿™ä¼¼ä¹ä¸å¤§å®¶é¢„æƒ³çš„ä¸åŒï¼Œæˆ‘ä»¬ä»¥ä¸ºNSArrayè‡ªå·±è‚¯å®šä¼šä¿å­˜é‚£äº›å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨å­ç±»ä¸­å°±æ— é¡»å†ä¿å­˜ä¸€ä»½äº†ã€‚ä½†æ˜¯å¤§å®¶è¦è®°ä½ï¼ŒNSArrayæœ¬èº«åªä¸è¿‡æ˜¯åŒ…åœ¨å…¶ä»–éšè—å¯¹è±¡å¤–é¢çš„å£³ï¼Œå®ƒä»…ä»…å®šä¹‰äº†æ‰€æœ‰æ•°ç»„éƒ½éœ€å…·å¤‡çš„ä¸€äº›æ¥å£ã€‚å¯¹äºè¿™ä¸ªè‡ªå®šä¹‰çš„æ•°ç»„ç±»æ¥è¯´ï¼Œå¯ä»¥ç”¨NSArrayæ¥ä¿å­˜å…¶å®ä¾‹ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;å­ç±»åº”å½“è¦†å†™è¶…ç±»æ–‡æ¡£ä¸­æŒ‡æ˜éœ€è¦è¦†å†™çš„æ–¹æ³•ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>RAC(å››)ä¿¡å·é«˜é˜¶æ“ä½œ</title>
    <link href="http://www.wuqihan.cn/2017/03/10/RAC-%E5%9B%9B-%E4%BF%A1%E5%8F%B7%E9%AB%98%E9%98%B6%E6%93%8D%E4%BD%9C/"/>
    <id>http://www.wuqihan.cn/2017/03/10/RAC-å››-ä¿¡å·é«˜é˜¶æ“ä½œ/</id>
    <published>2017-03-10T06:42:50.000Z</published>
    <updated>2020-01-28T10:07:24.989Z</updated>
    
    <content type="html"><![CDATA[<h3 id="é«˜é˜¶ä¿¡å·"><a href="#é«˜é˜¶ä¿¡å·" class="headerlink" title="é«˜é˜¶ä¿¡å·"></a>é«˜é˜¶ä¿¡å·</h3><p>å¯¹æ•°ç»„çš„æ“ä½œå¯ä»¥æœ‰äºŒç»´æ•°ç»„ï¼Œå¤šç»´æ•°ç»„ã€‚åŒæ ·ï¼Œä¿¡å·ä¹Ÿæ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œç»å¸¸ä¼šé‡åˆ°äºŒç»´ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯ä¿¡å·ä¸­å‘é€çš„å€¼ä¹Ÿä¸ºä¿¡å·ã€‚</p><a id="more"></a><h4 id="å‡é˜¶å’Œé™é˜¶"><a href="#å‡é˜¶å’Œé™é˜¶" class="headerlink" title="å‡é˜¶å’Œé™é˜¶"></a>å‡é˜¶å’Œé™é˜¶</h4><p><strong>(ä¸‹å›¾è±å½¢å›¾ä¾‹ä»£è¡¨ä¿¡å·ï¼Œåœ†åœˆä»£è¡¨å€¼)</strong></p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac4_1.jpg" alt="image-20180418143626144"></p><h4 id="åˆ›å»ºé«˜é˜¶ä¿¡å·"><a href="#åˆ›å»ºé«˜é˜¶ä¿¡å·" class="headerlink" title="åˆ›å»ºé«˜é˜¶ä¿¡å·"></a>åˆ›å»ºé«˜é˜¶ä¿¡å·</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RACSiganl *siganl = [RACSignal <span class="hljs-keyword">return</span>:@<span class="hljs-number">1</span>];</span><br><span class="line"></span><br><span class="line">RACSiganl *signalHighOrder = [RACSiganl <span class="hljs-keyword">return</span>:signal];</span><br><span class="line">RACSiganl *anotherSignal = [signal map:^<span class="hljs-keyword">id</span>(<span class="hljs-keyword">id</span> value) &#123;</span><br><span class="line"><span class="hljs-keyword">return</span> [RACSignal <span class="hljs-keyword">return</span>:value];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h4 id="è®¢é˜…é«˜çº§ä¿¡å·"><a href="#è®¢é˜…é«˜çº§ä¿¡å·" class="headerlink" title="è®¢é˜…é«˜çº§ä¿¡å·"></a>è®¢é˜…é«˜çº§ä¿¡å·</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RACSiganl *siganl = @[@<span class="hljs-number">1</span>,@<span class="hljs-number">2</span>,@<span class="hljs-number">3</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *highOrderSignal = [signal map:^<span class="hljs-keyword">id</span>(RACSiganl *aSiganl) &#123;</span><br><span class="line">    [aSignal subscribeNext:^(<span class="hljs-keyword">id</span> x) &#123;</span><br><span class="line">        <span class="hljs-comment">//...</span></span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="é™é˜¶æ“ä½œ"><a href="#é™é˜¶æ“ä½œ" class="headerlink" title="é™é˜¶æ“ä½œ"></a>é™é˜¶æ“ä½œ</h3><h4 id="SwitchToLatests"><a href="#SwitchToLatests" class="headerlink" title="SwitchToLatests"></a>SwitchToLatests</h4><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac4_2.jpg" alt="image-20180418144538812"></p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac4_3.jpg" alt="image-20180418144441907"></p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac4_4.jpg" alt="image-20180418144546449"></p><p>ä½¿ç”¨switchToLatestsæ–¹æ³•é™é˜¶æ—¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>æ–°çš„ä¿¡å·ä¼šæŠŠæ—§çš„ä¿¡å·æˆªæ–­</strong></p><h4 id="if-then-else"><a href="#if-then-else" class="headerlink" title="if/then/else"></a>if/then/else</h4><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac4_5.jpg" alt="image-20180418144726566"></p><p>çœ‹ä¸€ä¸‹ifThenElseæ–¹æ³•çš„å®ç°ä»£ç ï¼Œå¯ä»¥å¾ˆå®¹æ˜“ç†è§£ã€‚å®ƒçš„æœ¬è´¨è¿˜æ˜¯ä½¿ç”¨äº†SwitchToLatestsã€‚</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ (RACSignal *)if:(RACSignal *)boolSignal then:(RACSignal *)trueSignal else:(RACSignal *)falseSignal &#123;</span><br><span class="line">NSCParameterAssert(boolSignal != nil);</span><br><span class="line">NSCParameterAssert(trueSignal != nil);</span><br><span class="line">NSCParameterAssert(falseSignal != nil);</span><br><span class="line"></span><br><span class="line">return [[[boolSignal</span><br><span class="line">map:^(NSNumber *value) &#123;</span><br><span class="line">NSCAssert([value isKindOfClass:NSNumber.class], @&quot;Expected %@ to send BOOLs, not %@&quot;, boolSignal, value);</span><br><span class="line"></span><br><span class="line">return (value.boolValue ? trueSignal : falseSignal);</span><br><span class="line">&#125;]</span><br><span class="line">switchToLatest]</span><br><span class="line">setNameWithFormat:@&quot;+if: %@ then: %@ else: %@&quot;, boolSignal, trueSignal, falseSignal];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„æ–¹æ³•è¿˜æœ‰SwitchCasesDefaultSignal:</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">+ (RACSignal *)<span class="hljs-keyword">switch</span>:(RACSignal *)signal cases:(<span class="hljs-built_in">NSDictionary</span> *)cases <span class="hljs-keyword">default</span>:(RACSignal *)defaultSignal &#123;</span><br><span class="line"><span class="hljs-built_in">NSCParameterAssert</span>(signal != <span class="hljs-literal">nil</span>);</span><br><span class="line"><span class="hljs-built_in">NSCParameterAssert</span>(cases != <span class="hljs-literal">nil</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">id</span> key <span class="hljs-keyword">in</span> cases) &#123;</span><br><span class="line"><span class="hljs-keyword">id</span> value __attribute__((unused)) = cases[key];</span><br><span class="line"><span class="hljs-built_in">NSCAssert</span>([value isKindOfClass:RACSignal.class], <span class="hljs-string">@"Expected all cases to be RACSignals, %@ isn't"</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">NSDictionary</span> *<span class="hljs-keyword">copy</span> = [cases <span class="hljs-keyword">copy</span>];</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> [[[signal</span><br><span class="line">map:^(<span class="hljs-keyword">id</span> key) &#123;</span><br><span class="line"><span class="hljs-keyword">if</span> (key == <span class="hljs-literal">nil</span>) key = RACTupleNil.tupleNil;</span><br><span class="line"></span><br><span class="line">RACSignal *signal = <span class="hljs-keyword">copy</span>[key] ?: defaultSignal;</span><br><span class="line"><span class="hljs-keyword">if</span> (signal == <span class="hljs-literal">nil</span>) &#123;</span><br><span class="line"><span class="hljs-built_in">NSString</span> *description = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-built_in">NSLocalizedString</span>(<span class="hljs-string">@"No matching signal found for value %@"</span>, <span class="hljs-string">@""</span>), key];</span><br><span class="line"><span class="hljs-keyword">return</span> [RACSignal error:[<span class="hljs-built_in">NSError</span> errorWithDomain:RACSignalErrorDomain code:RACSignalErrorNoMatchingCase userInfo:@&#123; <span class="hljs-built_in">NSLocalizedDescriptionKey</span>: description &#125;]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> signal;</span><br><span class="line">&#125;]</span><br><span class="line">switchToLatest]</span><br><span class="line">setNameWithFormat:<span class="hljs-string">@"+switch: %@ cases: %@ default: %@"</span>, signal, cases, defaultSignal];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Flatten"><a href="#Flatten" class="headerlink" title="Flatten"></a>Flatten</h4><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac4_6.jpg" alt="image-20180418144742256"></p><p>flattenä¸SwitchToLatestsä¸åŒçš„æ˜¯ï¼Œæ–°çš„ä¿¡å·ä¸ä¼šæˆªæ–­æ—§çš„ä¿¡å·ã€‚å®ƒç›¸å½“äºæ˜¯ä½¿ç”¨<strong>**merge:</strong>æ–¹æ³•æŠŠä¿¡å·ä¸­çš„æ‰€æœ‰ä¿¡å·éƒ½åˆå¹¶åœ¨äº†ä¸€èµ·ã€‚</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac4_7.jpg" alt="image-20180418144755171"></p><p>flattenï¼šè¿™ä¸ªå¸¦å‚æ•°çš„æ–¹æ³• çš„å‚æ•°ç±»å‹æ˜¯NSUIntegerã€‚æ‹¿ä¸Šå›¾ä¸¾ä¾‹å­å°±æ˜¯è¯´ï¼Œå½“å‰è¿™ä¸ªå‚æ•°ä¸º2ï¼Œé‚£è¿™ä¸ªå€¼å°±ä»£è¡¨çš„æ˜¯å½“å‰æœ€å¤šå±•å¼€çš„ä¿¡å·ï¼ŒsignalAä¸­æœ‰4ä¸ªä¿¡å·ï¼Œæœ€å¤šåŒæ—¶å±•å¼€ä¸¤ä¸ªä¿¡å·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé¦–å…ˆèƒ½å¤Ÿä¸€æ¬¡è®¢é˜…å‰ä¸¤ä¸ªä¿¡å·ï¼Œå¦‚æœè¿™é‡Œä¸¤ä¸ªä¿¡å·éƒ½æ²¡æ‰§è¡Œå®Œï¼Œ å°±ä¸èƒ½è®¢é˜…ç¬¬ä¸‰ä¸ªï¼Œå½“ å‰ä¸¤ä¸ªä¿¡å·å…¶ä¸­æœ‰ä¸€ä¸ªä¿¡å·ç»“æŸä¹‹åï¼Œæ‰ä¼šå»è®¢é˜…ç¬¬ä¸‰ä¸ªä¿¡å·ï¼Œè¿™æ ·ä¾æ¬¡ç±»æ¨ã€‚ </p><h4 id="Concat"><a href="#Concat" class="headerlink" title="Concat"></a>Concat</h4><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac4_8.jpg" alt="image-20180418144801999"></p><p>å¯¹äºä¸€ä¸ªè¿”å›aä¿¡å·ã€bä¿¡å·çš„é«˜é˜¶ä¿¡å·è°ƒç”¨flatten:1ï¼Œç­‰ä»·äº[aä¿¡å· concat:bä¿¡å·]ã€‚</p><p>å¯¹äºé«˜çº§ä¿¡å·ï¼Œä¹Ÿæœ‰ä¸€ä¸ª- (RACSIgnal *)concat;æ–¹æ³•ï¼Œå°±æ˜¯ç›¸å½“äºè°ƒç”¨flatten:1</p><h4 id="FlattenMap"><a href="#FlattenMap" class="headerlink" title="FlattenMap"></a>FlattenMap</h4><p>flattenMapå°±æ˜¯ å…ˆmapä¸ºé«˜é˜¶ä¿¡å·åœ¨è°ƒç”¨flattené™é˜¶</p><p>çœ‹ä¸€ä¸‹ RACStream.mæ–‡ä»¶ä¸­ flattenMap: ã€flattenã€mapï¼šçš„å®ç°</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (__kindof RACStream *)flattenMap:(__kindof RACStream * (^)(<span class="hljs-keyword">id</span> value))block &#123;</span><br><span class="line">Class <span class="hljs-keyword">class</span> = <span class="hljs-keyword">self</span>.class;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> bind:^&#123;</span><br><span class="line"><span class="hljs-keyword">return</span> ^(<span class="hljs-keyword">id</span> value, <span class="hljs-built_in">BOOL</span> *stop) &#123;</span><br><span class="line"><span class="hljs-keyword">id</span> stream = block(value) ?: [<span class="hljs-keyword">class</span> empty];</span><br><span class="line"><span class="hljs-built_in">NSCAssert</span>([stream isKindOfClass:RACStream.class], <span class="hljs-string">@"Value returned from -flattenMap: is not a stream: %@"</span>, stream);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> stream;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;] setNameWithFormat:<span class="hljs-string">@"[%@] -flattenMap:"</span>, <span class="hljs-keyword">self</span>.name];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (__kindof RACStream *)flatten &#123;</span><br><span class="line"><span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> flattenMap:^(<span class="hljs-keyword">id</span> value) &#123;</span><br><span class="line"><span class="hljs-keyword">return</span> value;</span><br><span class="line">&#125;] setNameWithFormat:<span class="hljs-string">@"[%@] -flatten"</span>, <span class="hljs-keyword">self</span>.name];</span><br><span class="line">&#125;</span><br><span class="line">- (__kindof RACStream *)map:(<span class="hljs-keyword">id</span> (^)(<span class="hljs-keyword">id</span> value))block &#123;</span><br><span class="line"><span class="hljs-built_in">NSCParameterAssert</span>(block != <span class="hljs-literal">nil</span>);</span><br><span class="line"></span><br><span class="line">Class <span class="hljs-keyword">class</span> = <span class="hljs-keyword">self</span>.class;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> flattenMap:^(<span class="hljs-keyword">id</span> value) &#123;</span><br><span class="line"><span class="hljs-keyword">return</span> [<span class="hljs-keyword">class</span> <span class="hljs-keyword">return</span>:block(value)];</span><br><span class="line">&#125;] setNameWithFormat:<span class="hljs-string">@"[%@] -map:"</span>, <span class="hljs-keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡çœ‹æ–¹æ³•çš„å®ç°ï¼Œå¯ä»¥çœ‹å‡ºï¼Œflattenå’Œmapæ–¹æ³•éƒ½æ˜¯åŸºäºflattenMap:çš„ï¼Œè¿˜æœ‰filterï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (__kindof RACStream *)filter:(<span class="hljs-built_in">BOOL</span> (^)(<span class="hljs-keyword">id</span> value))block &#123;</span><br><span class="line"><span class="hljs-built_in">NSCParameterAssert</span>(block != <span class="hljs-literal">nil</span>);</span><br><span class="line"></span><br><span class="line">Class <span class="hljs-keyword">class</span> = <span class="hljs-keyword">self</span>.class;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> flattenMap:^ <span class="hljs-keyword">id</span> (<span class="hljs-keyword">id</span> value) &#123;</span><br><span class="line"><span class="hljs-keyword">if</span> (block(value)) &#123;</span><br><span class="line"><span class="hljs-keyword">return</span> [<span class="hljs-keyword">class</span> <span class="hljs-keyword">return</span>:value];</span><br><span class="line">&#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line"><span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span>.empty;</span><br><span class="line">&#125;</span><br><span class="line">&#125;] setNameWithFormat:<span class="hljs-string">@"[%@] -filter:"</span>, <span class="hljs-keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹flattenMapæ–¹æ³•å®ç°ã€‚å‘ç°å®ƒæ˜¯åŸºäºbind:æ–¹æ³•çš„ã€‚RACä¸­çš„æ–¹æ³•å‡ ä¹æ‰€æœ‰éƒ½æ˜¯åŸºäºbindæ–¹æ³•å®ç°çš„ï¼Œå®ƒæ˜¯RACçš„æ ¸å¿ƒæ–¹æ³•ã€‚<strong>è¿™ä¸ªbindæ–¹æ³•æ„Ÿè§‰æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘æš‚æ—¶ä¹Ÿä¸å¤ªç†è§£ï¼Œä»¥åå†ç ”ç©¶</strong>ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;é«˜é˜¶ä¿¡å·&quot;&gt;&lt;a href=&quot;#é«˜é˜¶ä¿¡å·&quot; class=&quot;headerlink&quot; title=&quot;é«˜é˜¶ä¿¡å·&quot;&gt;&lt;/a&gt;é«˜é˜¶ä¿¡å·&lt;/h3&gt;&lt;p&gt;å¯¹æ•°ç»„çš„æ“ä½œå¯ä»¥æœ‰äºŒç»´æ•°ç»„ï¼Œå¤šç»´æ•°ç»„ã€‚åŒæ ·ï¼Œä¿¡å·ä¹Ÿæ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œç»å¸¸ä¼šé‡åˆ°äºŒç»´ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯ä¿¡å·ä¸­å‘é€çš„å€¼ä¹Ÿä¸ºä¿¡å·ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
    
      <category term="ReactiveCocoa" scheme="http://www.wuqihan.cn/tags/ReactiveCocoa/"/>
    
  </entry>
  
  <entry>
    <title>RAC(ä¸‰)RACSignalå„ç±»æ“ä½œ</title>
    <link href="http://www.wuqihan.cn/2017/01/08/RAC-%E4%B8%89-RACSignal%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
    <id>http://www.wuqihan.cn/2017/01/08/RAC-ä¸‰-RACSignalåŸºæœ¬ä½¿ç”¨/</id>
    <published>2017-01-08T05:20:24.000Z</published>
    <updated>2020-01-28T10:07:17.541Z</updated>
    
    <content type="html"><![CDATA[<h3 id="è·å¾—ä¸€ä¸ªä¿¡å·çš„æ–¹å¼"><a href="#è·å¾—ä¸€ä¸ªä¿¡å·çš„æ–¹å¼" class="headerlink" title="è·å¾—ä¸€ä¸ªä¿¡å·çš„æ–¹å¼"></a>è·å¾—ä¸€ä¸ªä¿¡å·çš„æ–¹å¼</h3><h4 id="å•å…ƒä¿¡å·"><a href="#å•å…ƒä¿¡å·" class="headerlink" title="å•å…ƒä¿¡å·"></a>å•å…ƒä¿¡å·</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal1 = [RACSignal <span class="hljs-keyword">return</span>:<span class="hljs-string">@"Some value"</span>];</span><br><span class="line">RACSignal *signal2 = [RACSignal error:errorObject];</span><br><span class="line">RACSignal *signal3 = [RACSignal empty];</span><br><span class="line">RACSignal *signal4 = [RACSignal never];</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="åŠ¨æ€ä¿¡å·"><a href="#åŠ¨æ€ä¿¡å·" class="headerlink" title="åŠ¨æ€ä¿¡å·"></a>åŠ¨æ€ä¿¡å·</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal5 = [RACSignal createSignal:^RACDisposable * _Nullable(<span class="hljs-keyword">id</span>&lt;RACSubscriber&gt;  _Nonnull subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="hljs-number">1</span>];</span><br><span class="line">    [subscriber sendNext:@<span class="hljs-number">2</span>];</span><br><span class="line">    [subscriber sendError:errorObject];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="hljs-keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h4 id="Cocoaæ¡¥æ¥"><a href="#Cocoaæ¡¥æ¥" class="headerlink" title="Cocoaæ¡¥æ¥"></a>Cocoaæ¡¥æ¥</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal6 = [button rac_signalForSelector:<span class="hljs-keyword">@selector</span>(setFrame:)];</span><br><span class="line">RACSignal *signal7 = [button rac_signalForControlEvents:<span class="hljs-built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">RACSignal *signal8 = [button rac_willDeallocSignal];</span><br><span class="line">RACSignal *signal9 = RACObserve(button, backgroundColor);</span><br></pre></td></tr></table></figure><h4 id="ä¿¡å·å˜æ¢"><a href="#ä¿¡å·å˜æ¢" class="headerlink" title="ä¿¡å·å˜æ¢"></a>ä¿¡å·å˜æ¢</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal10 = [signal1 map:^<span class="hljs-keyword">id</span> _Nullable(<span class="hljs-built_in">NSString</span>*  _Nullable value) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> [value substringFromIndex:<span class="hljs-number">1</span>];</span><br><span class="line">    &#125;]</span><br></pre></td></tr></table></figure><h4 id="åºåˆ—è½¬æ¢"><a href="#åºåˆ—è½¬æ¢" class="headerlink" title="åºåˆ—è½¬æ¢"></a>åºåˆ—è½¬æ¢</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal11 = [RACSequence <span class="hljs-keyword">return</span>:@<span class="hljs-number">1</span>].signal;</span><br></pre></td></tr></table></figure><h3 id="è®¢é˜…ä¸€ä¸ªä¿¡å·çš„æ–¹å¼"><a href="#è®¢é˜…ä¸€ä¸ªä¿¡å·çš„æ–¹å¼" class="headerlink" title="è®¢é˜…ä¸€ä¸ªä¿¡å·çš„æ–¹å¼"></a>è®¢é˜…ä¸€ä¸ªä¿¡å·çš„æ–¹å¼</h3><p><strong>æ³¨æ„Signalæ˜¯push-driven(æ¨é©±åŠ¨)</strong></p><h4 id="åŸºæœ¬è®¢é˜…æ–¹æ³•-subscribe"><a href="#åŸºæœ¬è®¢é˜…æ–¹æ³•-subscribe" class="headerlink" title="åŸºæœ¬è®¢é˜…æ–¹æ³• subscribe"></a>åŸºæœ¬è®¢é˜…æ–¹æ³• subscribe</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[signal1 subscribeNext:^(<span class="hljs-keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,x);</span><br><span class="line">&#125; error:^(<span class="hljs-built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,error);</span><br><span class="line">&#125; completed:^&#123;</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"complete"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h4 id="ç»‘å®š"><a href="#ç»‘å®š" class="headerlink" title="ç»‘å®š"></a>ç»‘å®š</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAC(view,backgroundColor) = signal10;</span><br></pre></td></tr></table></figure><h4 id="Cocoaæ¡¥æ¥-1"><a href="#Cocoaæ¡¥æ¥-1" class="headerlink" title="Cocoaæ¡¥æ¥"></a>Cocoaæ¡¥æ¥</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[view rac_liftSelector:<span class="hljs-keyword">@selector</span>(convertPoint:toView:) withSignals:signal1,signal2, <span class="hljs-literal">nil</span>];</span><br><span class="line">[view rac_liftSelector:<span class="hljs-keyword">@selector</span>(convertPoint:toView:) withSignalsFromArray:@[signal1,signal2]];</span><br><span class="line">[view rac_liftSelector:<span class="hljs-keyword">@selector</span>(convertPoint:toView:) withSignalOfArguments:signal5];</span><br></pre></td></tr></table></figure><h3 id="åˆ†æè®¢é˜…è¿‡ç¨‹"><a href="#åˆ†æè®¢é˜…è¿‡ç¨‹" class="headerlink" title="åˆ†æè®¢é˜…è¿‡ç¨‹"></a>åˆ†æè®¢é˜…è¿‡ç¨‹</h3><p>RACSignalçš„å¸¸è§ç”¨æ³•ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="hljs-comment">// part 1:[RACSignal createSignal]æ¥è·å¾—signal</span></span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable * _Nullable(<span class="hljs-keyword">id</span>&lt;RACSubscriber&gt;  _Nonnull subscriber) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment">// part 3: è¿›å…¥didSubscribeï¼Œé€šè¿‡[subscriber sendNext:]æ¥æ‰§è¡Œnext block</span></span><br><span class="line">        [subscriber sendNext:@<span class="hljs-number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="hljs-number">2</span>];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<span class="hljs-comment">//è¿™é‡Œå¿½ç•¥RACDisposableï¼Œæš‚æ—¶ä¸è®²</span></span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line"><span class="hljs-comment">// part 2 : [signal subscribeNext:]æ¥è·å¾—subscriberï¼Œç„¶åè¿›è¡Œsubscriptionï¼Œerrorå’Œcompleteä¸è®¨è®ºä¸nextä¸€æ ·ã€‚ï¼ˆRACSignalé‡Œé¢ä¿å­˜çš„äº‹ä»¶åˆ†ä¸º3ä¸­ã€‚ä¸€ç§æ˜¯å€¼valueï¼Œä¸€ç§æ˜¯errorï¼Œä¸€ç§æ˜¯completeã€‚ï¼‰</span></span><br><span class="line">    [signal subscribeNext:^(<span class="hljs-keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="hljs-comment">//...</span></span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RACSignalçš„Subscriptionè¿‡ç¨‹æ¦‚æ‹¬èµ·æ¥å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><h4 id="æ­¥éª¤ä¸€ï¼š-RACSignal-createSignal-æ¥è·å¾—signal"><a href="#æ­¥éª¤ä¸€ï¼š-RACSignal-createSignal-æ¥è·å¾—signal" class="headerlink" title="æ­¥éª¤ä¸€ï¼š[RACSignal createSignal]æ¥è·å¾—signal"></a>æ­¥éª¤ä¸€ï¼š[RACSignal createSignal]æ¥è·å¾—signal</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//RACSignal.mä¸­ï¼š</span></span><br><span class="line">+ ( RACSignal *)createSignal:( RACDisposable * (^)( <span class="hljs-keyword">id</span> &lt; RACSubscriber &gt; subscriber))didSubscribe &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> [ RACDynamicSignal   createSignal :didSubscribe];</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">//RACDynamicSignal.mä¸­</span></span><br><span class="line">+ ( RACSignal *)createSignal:( RACDisposable * (^)( <span class="hljs-keyword">id</span> &lt; RACSubscriber &gt; subscriber))didSubscribe &#123;</span><br><span class="line">  RACDynamicSignal *signal = [[ <span class="hljs-keyword">self</span>   alloc ] init ];</span><br><span class="line"> signal-&gt; _didSubscribe = [didSubscribe <span class="hljs-keyword">copy</span> ];</span><br><span class="line">  <span class="hljs-keyword">return</span> [signal setNameWithFormat : <span class="hljs-string">@"+createSignal:"</span> ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[RACSignal createSignal]ä¼šè°ƒç”¨å­ç±»RACDynamicSignalçš„createSignalæ¥è¿”å›ä¸€ä¸ªsignalï¼Œå¹¶åœ¨signalä¸­ä¿å­˜åé¢çš„ didSubscribeè¿™ä¸ªblock</p><h4 id="æ­¥éª¤äºŒï¼š-signal-subscribeNext-æ¥è·å¾—subscriberï¼Œç„¶åè¿›è¡Œsubscription"><a href="#æ­¥éª¤äºŒï¼š-signal-subscribeNext-æ¥è·å¾—subscriberï¼Œç„¶åè¿›è¡Œsubscription" class="headerlink" title="æ­¥éª¤äºŒï¼š[signal subscribeNext:]æ¥è·å¾—subscriberï¼Œç„¶åè¿›è¡Œsubscription"></a>æ­¥éª¤äºŒï¼š[signal subscribeNext:]æ¥è·å¾—subscriberï¼Œç„¶åè¿›è¡Œsubscription</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//RACSignal.mä¸­ï¼š</span></span><br><span class="line">- ( RACDisposable *)subscribeNext:( <span class="hljs-keyword">void</span> (^)( <span class="hljs-keyword">id</span> x))nextBlock &#123;</span><br><span class="line">  RACSubscriber *o = [ RACSubscriber   subscriberWithNext :nextBlock error : <span class="hljs-literal">NULL</span>   completed : <span class="hljs-literal">NULL</span> ];</span><br><span class="line">  <span class="hljs-keyword">return</span> [ <span class="hljs-keyword">self</span>  subscribe :o];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//RACSubscriber.mä¸­ï¼š</span></span><br><span class="line">+ ( <span class="hljs-keyword">instancetype</span> )subscriberWithNext:( <span class="hljs-keyword">void</span> (^)( <span class="hljs-keyword">id</span> x))next error:( <span class="hljs-keyword">void</span> (^)( <span class="hljs-built_in">NSError</span> *error))error completed:( <span class="hljs-keyword">void</span> (^)( <span class="hljs-keyword">void</span> ))completed &#123;</span><br><span class="line">  RACSubscriber *subscriber = [[ <span class="hljs-keyword">self</span>   alloc ] init ];</span><br><span class="line"> subscriber-&gt; _next = [next <span class="hljs-keyword">copy</span> ];</span><br><span class="line"> subscriber-&gt; _error = [error <span class="hljs-keyword">copy</span> ];</span><br><span class="line"> subscriber-&gt; _completed = [completed <span class="hljs-keyword">copy</span> ];</span><br><span class="line">  <span class="hljs-keyword">return</span> subscriber;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//RACDynamicSignal.mä¸­ï¼š</span></span><br><span class="line">- (RACDisposable *)subscribe:(<span class="hljs-keyword">id</span>&lt;RACSubscriber&gt;)subscriber &#123;</span><br><span class="line">    RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line">    subscriber = [[RACPassthroughSubscriber alloc] initWithSubscriber:subscriber signal:<span class="hljs-keyword">self</span> disposable:disposable];</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.didSubscribe != <span class="hljs-literal">NULL</span>) &#123;</span><br><span class="line">        RACDisposable *schedulingDisposable = [RACScheduler.subscriptionScheduler schedule:^&#123;</span><br><span class="line">            RACDisposable *innerDisposable = <span class="hljs-keyword">self</span>.didSubscribe(subscriber);</span><br><span class="line">            [disposable addDisposable:innerDisposable];</span><br><span class="line">        &#125;];</span><br><span class="line">        [disposable addDisposable:schedulingDisposable];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> disposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>[signal subscribeNext]å…ˆä¼šè·å¾—ä¸€ä¸ªsubscriberï¼Œè¿™ä¸ªsubscriberä¸­ä¿å­˜äº†nextBlockã€errorBlockã€completedBlock</li><li>ç”±äºè¿™ä¸ªsignalå…¶å®æ˜¯RACDynamicSignalç±»å‹çš„ï¼Œè¿™ä¸ª[self subscribe]æ–¹æ³•ä¼šè°ƒç”¨æ­¥éª¤ä¸€ä¸­ä¿å­˜çš„didSubscribeï¼Œå‚æ•°å°±æ˜¯1ä¸­çš„subscriber</li></ol><h4 id="æ­¥éª¤ä¸‰ï¼šè¿›å…¥didSubscribeï¼Œé€šè¿‡-subscriber-sendNext-æ¥æ‰§è¡Œnext-block"><a href="#æ­¥éª¤ä¸‰ï¼šè¿›å…¥didSubscribeï¼Œé€šè¿‡-subscriber-sendNext-æ¥æ‰§è¡Œnext-block" class="headerlink" title="æ­¥éª¤ä¸‰ï¼šè¿›å…¥didSubscribeï¼Œé€šè¿‡[subscriber sendNext:]æ¥æ‰§è¡Œnext block"></a>æ­¥éª¤ä¸‰ï¼šè¿›å…¥didSubscribeï¼Œé€šè¿‡[subscriber sendNext:]æ¥æ‰§è¡Œnext block</h4><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//RACSubscriber.mä¸­ï¼š</span></span><br><span class="line">- (<span class="hljs-keyword">void</span>)sendNext:(<span class="hljs-keyword">id</span>)value &#123;</span><br><span class="line">    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">void</span> (^nextBlock)(<span class="hljs-keyword">id</span>) = [<span class="hljs-keyword">self</span>.next <span class="hljs-keyword">copy</span>];</span><br><span class="line">        <span class="hljs-keyword">if</span> (nextBlock == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">return</span>;</span><br><span class="line">        nextBlock(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="signalçš„subscriptionè¿‡ç¨‹å›é¡¾"><a href="#signalçš„subscriptionè¿‡ç¨‹å›é¡¾" class="headerlink" title="signalçš„subscriptionè¿‡ç¨‹å›é¡¾"></a>signalçš„subscriptionè¿‡ç¨‹å›é¡¾</h4><p>ä»ä¸Šé¢çš„ä¸‰ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬çœ‹å‡ºï¼š</p><ul><li>å…ˆé€šè¿‡createSignalå’ŒsubscribeNextè¿™ä¸¤ä¸ªè°ƒç”¨ï¼Œå£°æ˜äº†æµä¸­valueåˆ°æ¥æ—¶çš„å¤„ç†æ–¹å¼</li><li>didSubscribe blockå—ä¸­å¼‚æ­¥å¤„ç†å®Œæ¯•ä¹‹åï¼Œsubscriberè¿›è¡ŒsendNextï¼Œè‡ªåŠ¨å¤„ç†</li></ul><h3 id="RACTuple"><a href="#RACTuple" class="headerlink" title="RACTuple"></a>RACTuple</h3><p>RACå®šä¹‰çš„ä¸€ç§æ•°æ®ç±»å‹ã€‚ç±»ä¼¼Swiftä¸­çš„tupleã€‚è¿™é‡Œä¸å¤šä»‹ç»ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RACTuple *tuple = RACTuplePack(@<span class="hljs-number">1</span>,<span class="hljs-string">@"haha"</span>);</span><br><span class="line"><span class="hljs-keyword">id</span> first = tuple.first;</span><br><span class="line"><span class="hljs-keyword">id</span> last = tuple.last;</span><br><span class="line"><span class="hljs-keyword">id</span> idnex1 = tuple[<span class="hljs-number">1</span>];</span><br><span class="line">RACTupleUnpack(<span class="hljs-built_in">NSNumber</span> *num,<span class="hljs-built_in">NSString</span> *str) = tuple;</span><br></pre></td></tr></table></figure><h3 id="RACSignalå„ç±»æ“ä½œ"><a href="#RACSignalå„ç±»æ“ä½œ" class="headerlink" title="RACSignalå„ç±»æ“ä½œ"></a>RACSignalå„ç±»æ“ä½œ</h3><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_1.jpg" alt="image-20180418141948795"></p><h4 id="å¯¹å€¼æ“ä½œ"><a href="#å¯¹å€¼æ“ä½œ" class="headerlink" title="å¯¹å€¼æ“ä½œ"></a>å¯¹å€¼æ“ä½œ</h4><h5 id="map-mapReplace"><a href="#map-mapReplace" class="headerlink" title="map/mapReplace"></a>map/mapReplace</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_2.jpg" alt="image-20180418142054959"></p><h5 id="reduceEach"><a href="#reduceEach" class="headerlink" title="reduceEach"></a>reduceEach</h5><p>åªèƒ½ç”¨åœ¨tupleä¸Šã€‚tupleä¸ªæ•°å°‘äº†ä¼šæŒ‚ï¼Œå¤šäº†åªå»å’Œå‚æ•°ç›¸åŒçš„ä¸ªæ•°ã€‚</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_3.jpg" alt="image-20180418142116897"></p><h5 id="Scan"><a href="#Scan" class="headerlink" title="Scan"></a>Scan</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_4.jpg" alt="image-20180418142914659"></p><h5 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h5><p>not/and/or/reduceApply/materialize/dematerialize;</p><h4 id="å¯¹æ•°é‡æ“ä½œ"><a href="#å¯¹æ•°é‡æ“ä½œ" class="headerlink" title="å¯¹æ•°é‡æ“ä½œ"></a>å¯¹æ•°é‡æ“ä½œ</h4><h5 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_5.jpg" alt="image-20180418142238131"></p><h5 id="ignore-ignoreValues-distinctUntilChanged"><a href="#ignore-ignoreValues-distinctUntilChanged" class="headerlink" title="ignore/ignoreValues/distinctUntilChanged"></a>ignore/ignoreValues/distinctUntilChanged</h5><p>è¿™å‡ ä¸ªæ ¹æ®è‹±æ–‡å¾ˆå®¹æ˜“ç†è§£</p><h5 id="take"><a href="#take" class="headerlink" title="take"></a>take</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_6.jpg" alt="image-20180418142354763"></p><h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_7.jpg" alt="image-20180418142404053"></p><h5 id="å…¶ä»–-1"><a href="#å…¶ä»–-1" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_8.jpg" alt="image-20180418142450462"></p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_9.jpg" alt="image-20180418142504248"></p><h5 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_10.jpg" alt="image-20180418142541910"></p><h5 id="Repeat"><a href="#Repeat" class="headerlink" title="Repeat"></a>Repeat</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_11.jpg" alt="image-20180418142600575"></p><h5 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_12.jpg" alt="image-20180418142618562"></p><h5 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_13.jpg" alt="image-20180418142824458"></p><h5 id="Aggregate"><a href="#Aggregate" class="headerlink" title="Aggregate"></a>Aggregate</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_14.jpg" alt="image-20180418142845070"></p><h4 id="å‰¯ä½œç”¨æ“ä½œ"><a href="#å‰¯ä½œç”¨æ“ä½œ" class="headerlink" title="å‰¯ä½œç”¨æ“ä½œ"></a>å‰¯ä½œç”¨æ“ä½œ</h4><p>doNext</p><h4 id="æ—¶é—´æ“ä½œ"><a href="#æ—¶é—´æ“ä½œ" class="headerlink" title="æ—¶é—´æ“ä½œ"></a>æ—¶é—´æ“ä½œ</h4><h5 id="Delay"><a href="#Delay" class="headerlink" title="Delay"></a>Delay</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_15.jpg" alt="image-20180418142954495"></p><h5 id="Throttle"><a href="#Throttle" class="headerlink" title="Throttle"></a>Throttle</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_16.jpg" alt="image-20180418143010615"></p><h4 id="ç»„åˆæ“ä½œ"><a href="#ç»„åˆæ“ä½œ" class="headerlink" title="ç»„åˆæ“ä½œ"></a>ç»„åˆæ“ä½œ</h4><h5 id="Concat"><a href="#Concat" class="headerlink" title="Concat"></a>Concat</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_17.jpg" alt="image-20180418143043116"></p><h5 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_18.jpg" alt="image-20180418143118995"></p><p>mergeç”¨å¤„å¾ˆå¤šï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *appearSignal = [[<span class="hljs-keyword">self</span> rac_signalForSelector:<span class="hljs-keyword">@selector</span>(viewDidAppear:)]] mapReplace:@YES];</span><br><span class="line">RACSignal *disappearSignal = [[<span class="hljs-keyword">self</span> rac_signalForSelector:<span class="hljs-keyword">@selector</span>(viewWillDisAppear:)]] mapReplace:@NO];</span><br><span class="line">RACSignal *activeSignal = [RACSignal merge:@[appearSignal,disappearSignal]];</span><br></pre></td></tr></table></figure><h5 id="Zip"><a href="#Zip" class="headerlink" title="Zip"></a>Zip</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_19.jpg" alt="image-20180418143328779"></p><h5 id="CombineLatest"><a href="#CombineLatest" class="headerlink" title="CombineLatest"></a>CombineLatest</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_20.jpg" alt="image-20180418143345994"></p><h5 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_21.jpg" alt="image-20180418143409171"></p><h5 id="TakeUntil"><a href="#TakeUntil" class="headerlink" title="TakeUntil"></a>TakeUntil</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_22.jpg" alt="image-20180418143453317"></p><h5 id="TakeUntilReplacement"><a href="#TakeUntilReplacement" class="headerlink" title="TakeUntilReplacement"></a>TakeUntilReplacement</h5><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac3_23.jpg" alt="image-20180418143511093"></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;è·å¾—ä¸€ä¸ªä¿¡å·çš„æ–¹å¼&quot;&gt;&lt;a href=&quot;#è·å¾—ä¸€ä¸ªä¿¡å·çš„æ–¹å¼&quot; class=&quot;headerlink&quot; title=&quot;è·å¾—ä¸€ä¸ªä¿¡å·çš„æ–¹å¼&quot;&gt;&lt;/a&gt;è·å¾—ä¸€ä¸ªä¿¡å·çš„æ–¹å¼&lt;/h3&gt;&lt;h4 id=&quot;å•å…ƒä¿¡å·&quot;&gt;&lt;a href=&quot;#å•å…ƒä¿¡å·&quot; class=&quot;headerlink&quot; title=&quot;å•å…ƒä¿¡å·&quot;&gt;&lt;/a&gt;å•å…ƒä¿¡å·&lt;/h4&gt;&lt;figure class=&quot;highlight objc hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;RACSignal *signal1 = [RACSignal &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt;:&lt;span class=&quot;hljs-string&quot;&gt;@&quot;Some value&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RACSignal *signal2 = [RACSignal error:errorObject];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RACSignal *signal3 = [RACSignal empty];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RACSignal *signal4 = [RACSignal never];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
    
      <category term="ReactiveCocoa" scheme="http://www.wuqihan.cn/tags/ReactiveCocoa/"/>
    
  </entry>
  
  <entry>
    <title>RAC(äºŒ)åŸºç¡€çŸ¥è¯†</title>
    <link href="http://www.wuqihan.cn/2017/01/01/RAC-%E4%BA%8C-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <id>http://www.wuqihan.cn/2017/01/01/RAC-äºŒ-åŸºç¡€çŸ¥è¯†/</id>
    <published>2017-01-01T09:11:36.000Z</published>
    <updated>2020-01-28T10:06:43.150Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ ¸å¿ƒç»„ä»¶"><a href="#æ ¸å¿ƒç»„ä»¶" class="headerlink" title="æ ¸å¿ƒç»„ä»¶"></a>æ ¸å¿ƒç»„ä»¶</h3><ul><li>RACStream RACSequence RACSignal</li><li>RACSubscriber</li><li>RACDisposable</li><li>RACScheduler</li><li>Cocoaæ¡†æ¶é€‚é…å·¥å…·</li></ul><a id="more"></a><h3 id="RACStreamçš„ä¸¤ä¸ªå­ç±»ï¼šSequence-amp-Signal"><a href="#RACStreamçš„ä¸¤ä¸ªå­ç±»ï¼šSequence-amp-Signal" class="headerlink" title="RACStreamçš„ä¸¤ä¸ªå­ç±»ï¼šSequence &amp; Signal"></a>RACStreamçš„ä¸¤ä¸ªå­ç±»ï¼šSequence &amp; Signal</h3><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac2_1.jpg" alt="image-20180414122918648"></p><p>RACStreamè¡¨ç¤ºä¸€ä¸ªæ•°æ®æµçš„ç±»ã€‚è¿™ä¸ªæµä¸ä¸€å®šæ˜¯åŸºäºæ—¶é—´çš„ï¼Œæ‰€ä»¥å®ƒæœ‰ä¸¤ä¸ªå­ç±»RACSequenceå’ŒRACSignalã€‚</p><ul><li>RACSequenceæ˜¯åŸºäºç©ºé—´çš„æ•°æ®æµ</li><li>RACSignalæ˜¯åŸºäºæ—¶é—´çš„æ•°æ®æµ</li></ul><p>å¯¹æ¯”RACSequenceå’ŒRACSignalï¼ŒåŸºäºç©ºé—´çš„æ•°æ®æµå’ŒåŸºäºæ—¶é—´çš„æ•°æ®æµåˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><ol><li><p><strong>Sequenceæ˜¯Pull-Driven(æ‹‰é©±åŠ¨)ï¼ŒSignalæ˜¯Push-driven(æ¨é©±åŠ¨)</strong></p><p>pull-driverè¡¨ç¤ºæ•°æ®çš„å˜åŒ–æ˜¯ç”±æ‹‰å–è€…å†³å®šçš„ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œsequenceå°±å¥½æ¯”ä¸€æœ¬ä¹¦ï¼Œæˆ‘ä»¬çœ‹ä¹¦ï¼Œæƒ³çœ‹åˆ°å“ªé¡µå°±å¯ä»¥ç¿»åˆ°å“ªé¡µå»çœ‹ï¼Œçœ‹ä»€ä¹ˆå†…å®¹è¯»å–ä»€ä¹ˆæ•°æ®ï¼Œæ˜¯ç”±æˆ‘ä»¬å†³å®šï¼Œè€Œä¸æ˜¯ç”±ä¹¦ï¼ˆsequenceï¼‰å†³å®šã€‚</p><p>push-driverè¡¨ç¤ºæ•°æ®çš„å˜åŒ–æ˜¯ç”±æ¨é€è€…å†³å®šçš„ï¼Œä¸pull-driveråˆšå¥½ç›¸åã€‚å¯ä»¥æŠŠSignalæ¯”ä½œç”µè§†ä½“è‚²ç›´æ’­ã€‚çœ‹ä»€ä¹ˆå†…å®¹è¯»å–ä»€ä¹ˆæ•°æ®ï¼Œæ˜¯ç”±ç”µè§†(Signal)å†³å®šçš„ï¼Œå¦‚æœæˆ‘ä»¬å»ä¸Šä¸ªå«ç”Ÿé—´ä¹Ÿæ— æ³•æš‚åœä½“è‚²ç›´æ’­ï¼Œä¸­é—´çš„æ•°æ®å°±ä¼šé”™è¿‡ã€‚</p></li><li><p>Sequenceé‡Œé¢å¯ä»¥ä»…ä»…å­˜æ”¾ä»»ä½•ç±»å‹çš„æ•°æ®ã€‚RACSignalé‡Œé¢ä¸ä»…åŒ…å«æ•°æ®ï¼Œä¹ŸåŒ…å«ä¿¡å·çš„çŠ¶æ€ï¼ˆåé¢ä¼šäº†è§£åˆ°ä¿¡å·çŠ¶æ€ï¼‰ã€‚</p></li></ol><h3 id="RACSequenceçš„ç®€å•ä½¿ç”¨"><a href="#RACSequenceçš„ç®€å•ä½¿ç”¨" class="headerlink" title="RACSequenceçš„ç®€å•ä½¿ç”¨"></a>RACSequenceçš„ç®€å•ä½¿ç”¨</h3><p>RACSequenceä½¿ç”¨çš„æƒ…å†µå¾ˆå°‘ã€‚è¿™é‡Œå°±ç®€å•ä»‹ç»ä¸€ä¸‹å¸¸ç”¨æ–¹æ³•</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//åˆ›å»º</span></span><br><span class="line">   RACSequence *sequence1 = [RACSequence <span class="hljs-keyword">return</span>:@<span class="hljs-number">1</span>];</span><br><span class="line">   RACSequence *sequence2 = [RACSequence sequenceWithHeadBlock:^<span class="hljs-keyword">id</span> _Nullable&#123;</span><br><span class="line">       <span class="hljs-keyword">return</span> @<span class="hljs-number">2</span>;</span><br><span class="line">   &#125; tailBlock:^RACSequence * _Nonnull&#123;</span><br><span class="line">       <span class="hljs-keyword">return</span> sequence1;</span><br><span class="line">   &#125;];</span><br><span class="line">   RACSequence *sequence3 = @[@<span class="hljs-number">1</span>,@<span class="hljs-number">2</span>,@<span class="hljs-number">3</span>].rac_sequence;</span><br><span class="line">   </span><br><span class="line">   <span class="hljs-comment">//å˜æ¢</span></span><br><span class="line">   RACSequence *mappedSequence = [sequence1 map:^<span class="hljs-keyword">id</span> _Nullable(<span class="hljs-built_in">NSNumber</span>* value) &#123;</span><br><span class="line">       <span class="hljs-keyword">return</span> @(value.integerValue*<span class="hljs-number">3</span>);</span><br><span class="line">   &#125;];</span><br><span class="line">   RACSequence *concatedSequence = [sequence2 concat:mappedSequence];</span><br><span class="line">   RACSequence *mergerdSequence = [RACSequence zip:@[concatedSequence,sequence3]];</span><br><span class="line">   </span><br><span class="line">   <span class="hljs-comment">//éå†</span></span><br><span class="line">   <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,mergerdSequence.head);</span><br><span class="line">   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">id</span> value <span class="hljs-keyword">in</span> mergerdSequence) &#123;</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,value);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="RACSignalçš„ç®€å•ä½¿ç”¨"><a href="#RACSignalçš„ç®€å•ä½¿ç”¨" class="headerlink" title="RACSignalçš„ç®€å•ä½¿ç”¨"></a>RACSignalçš„ç®€å•ä½¿ç”¨</h3><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//åˆ›å»º</span></span><br><span class="line">   RACSignal *signal1 = [RACSignal <span class="hljs-keyword">return</span>:<span class="hljs-string">@"hello"</span>];</span><br><span class="line">   RACSignal *signal2 = [RACSignal createSignal:^RACDisposable * _Nullable(<span class="hljs-keyword">id</span>&lt;RACSubscriber&gt;  _Nonnull subscriber) &#123;</span><br><span class="line">       [subscriber sendNext:@<span class="hljs-number">1</span>];</span><br><span class="line">       [subscriber sendNext:@<span class="hljs-number">2</span>];</span><br><span class="line">       [subscriber sendCompleted];</span><br><span class="line">       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;</span><br><span class="line">   &#125;];</span><br><span class="line">   RACSignal *signal3 = RACObserve(<span class="hljs-keyword">self</span>.view, backgroundColor);</span><br><span class="line">   </span><br><span class="line">   <span class="hljs-comment">//å˜æ¢</span></span><br><span class="line">   RACSignal *mappedSignal = [signal1 map:^<span class="hljs-keyword">id</span> _Nullable(<span class="hljs-built_in">NSString</span>* value) &#123;</span><br><span class="line">       <span class="hljs-keyword">return</span> [value stringByAppendingString:<span class="hljs-string">@" word"</span>];</span><br><span class="line">   &#125;];</span><br><span class="line">   RACSignal *concatedSignal = [mappedSignal concat:signal2];</span><br><span class="line">   RACSignal *mergeSignal = [mappedSignal merge:@[concatedSignal,signal3]];</span><br><span class="line">   </span><br><span class="line">   <span class="hljs-comment">//éå†</span></span><br><span class="line">   [mergeSignal subscribeNext:^(<span class="hljs-keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,x);</span><br><span class="line">   &#125; completed:^&#123;</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"completed"</span>);</span><br><span class="line">   &#125;];</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»…ä»…æ˜¯å¯¹RACSignalåšåˆæ­¥äº†è§£ã€‚å…·ä½“æ–¹æ³•åˆ°åº•æ€ä¹ˆç”¨ã€‚åé¢çš„æ–‡ç« ä¼šè®²åˆ°ã€‚</p><h3 id="RACSubscriber-amp-RACDisposable"><a href="#RACSubscriber-amp-RACDisposable" class="headerlink" title="RACSubscriber &amp; RACDisposable"></a>RACSubscriber &amp; RACDisposable</h3><p>Subscription(è®¢é˜…è€…)è¡¨â½°ç­‰å¾…æˆ–è€…èƒ½å¤Ÿç­‰å¾…ä¿¡å·å‘é€äº‹ä»¶çš„ä»»æ„å¯¹è±¡ã€‚åœ¨æ¡†æ¶ä¸­ä½¿ç”¨RACSubscriberåè®®è¡¨ç¤º,ä¹Ÿå³ä»»æ„å®ç°äº†RACSubscriberåè®®çš„å¯¹è±¡éƒ½å¯ä»¥æ˜¯è®¢é˜…è€…ã€‚å¯ä»¥é€šè¿‡è°ƒâ½¤ -subscribeNext:error:completed:â½…æ³•æ¥åˆ›å»ºè®¢é˜…ã€‚RACStreamå’ŒRACSignalç±»çš„å¤§å¤šæ“ä½œä¹Ÿä¼šâ¾ƒå·±åˆ›å»ºè®¢é˜…ã€‚è®¢é˜…ä¼šå¯¹Signalså¯¹è±¡å¼•â½¤è®¡æ•°åŠ 1,å½“ä¿¡å·å‘é€é”™è¯¯æˆ–è€…å®Œæˆäº‹ä»¶å,ä¼šâ¾ƒåŠ¨è¢«å¤„ç†,ä¸éœ€è¦â½¤æˆ·å…³â¼¼å†…å­˜ç®¡ç†ã€‚å½“ç„¶,â½¤æˆ·ä¹Ÿå¯ä»¥â¼¿åŠ¨å¤„ç†ã€‚</p><p>RACDisposableç±»â½¤äºå–æ¶ˆè®¢é˜…æˆ–è€…æ¸…ç†èµ„æºã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†Subscriberã€Disposableã€Signalä¸‰è€…çš„å…³ç³»</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/rac2_2.jpg" alt="image-20180414154509246"></p><h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><ul><li>ç”¨æ¥åšè°ƒåº¦</li><li>ä»£æ›¿GCD</li><li>å¼‚æ­¥ä¸å¹¶å‘</li></ul><p>schedulerç”±RACSchedulerç±»è¡¨ç¤º,å®ƒæ˜¯ä¿¡å·æ‰§è¡Œä»»åŠ¡æ—¶æ‰€åœ¨çš„é˜Ÿåˆ—(queue)æˆ–è€…ä¿¡å·æ‰§â¾å®Œåå°†ç»“æœæ”¾åˆ°é˜Ÿåˆ—â¾¥æ‰§è¡Œ,å¯ä»¥è®¤ä¸ºå°±æ˜¯gcdâ¾¥çš„queuesã€‚schedulerâ½€æŒå–æ¶ˆæ“ä½œ,â½½ä¸”å®ƒæ€»æ˜¯ä¸²è¡Œåœ°æ‰§â¾ä»»åŠ¡ã€‚è¿™æœ‰åˆ©äºé¿å…æ­»é”ã€‚RACScheduleræœ‰æ—¶å€™ä¹Ÿç±»ä¼¼NSOperationQueue,ä½†å®ƒä¸å…è®¸ä»»åŠ¡é—´ç›¸äº’ä¾èµ–ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;æ ¸å¿ƒç»„ä»¶&quot;&gt;&lt;a href=&quot;#æ ¸å¿ƒç»„ä»¶&quot; class=&quot;headerlink&quot; title=&quot;æ ¸å¿ƒç»„ä»¶&quot;&gt;&lt;/a&gt;æ ¸å¿ƒç»„ä»¶&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;RACStream RACSequence RACSignal&lt;/li&gt;
&lt;li&gt;RACSubscriber&lt;/li&gt;
&lt;li&gt;RACDisposable&lt;/li&gt;
&lt;li&gt;RACScheduler&lt;/li&gt;
&lt;li&gt;Cocoaæ¡†æ¶é€‚é…å·¥å…·&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
    
      <category term="ReactiveCocoa" scheme="http://www.wuqihan.cn/tags/ReactiveCocoa/"/>
    
  </entry>
  
  <entry>
    <title>RAC(ä¸€)å‡½æ•°å“åº”å¼ç¼–ç¨‹æ¦‚è¿°</title>
    <link href="http://www.wuqihan.cn/2016/12/14/RAC-%E4%B8%80-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%A6%82%E8%BF%B0/"/>
    <id>http://www.wuqihan.cn/2016/12/14/RAC-ä¸€-å‡½æ•°å¼ç¼–ç¨‹æ¦‚è¿°/</id>
    <published>2016-12-14T04:05:11.000Z</published>
    <updated>2020-01-28T10:07:00.715Z</updated>
    
    <content type="html"><![CDATA[<p>ReactiveCocoaæ˜¯ä¸€ç§æ–°çš„ç¼–ç¨‹èŒƒå¼(å³å‡½æ•°å“åº”å¼ç¼–ç¨‹)ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªåŸºç¡€åº“ã€‚æ˜¯åœ¨é¢å‘å¯¹è±¡è¯­è¨€çš„åŸºç¡€ä¸Šï¼Œå¯¹å‡½æ•°å“åº”å¼ç¼–ç¨‹çš„å®ç°ã€‚æœ¬æ–‡ä¸»è¦è®²è§£å‡½æ•°å¼ç¼–ç¨‹å’Œå“åº”å¼ç¼–ç¨‹ã€‚</p><a id="more"></a><h3 id="ç¼–ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ç¼–ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ç¼–ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ç¼–ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æ ¹æ®å†¯è¯ºä¾æ›¼ä½“ç³»ç»“æ„ã€‚ç¼–ç¨‹å°±æ˜¯ï¼šå¯¹è¾“å…¥è®¾å¤‡è¿›è¡Œé‡‡æ ·ï¼Œæœ€ç»ˆé€šè¿‡è®¡ç®—è®¾å¤‡è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°çš„ç»“æœé€šè¿‡è¾“å‡ºè®¾å¤‡è¾“å‡ºï¼Œè¿™å°±æ˜¯ç¼–ç¨‹ã€‚</p><p>ç¼–ç¨‹ä¹Ÿå¯ä»¥æ˜¯ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå½¢æˆä¸€ç§ä¸šåŠ¡æ¨¡å¼ï¼Œæœ€åé€šè¿‡æŠŠè¿™ä¸ªæ¨¡å¼è½¬æ¢ä¸ºä»£ç å®ç°çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚</p><h3 id="é¢å‘è¿‡ç¨‹-vs-é¢å‘å¯¹è±¡"><a href="#é¢å‘è¿‡ç¨‹-vs-é¢å‘å¯¹è±¡" class="headerlink" title="é¢å‘è¿‡ç¨‹ vs é¢å‘å¯¹è±¡"></a>é¢å‘è¿‡ç¨‹ vs é¢å‘å¯¹è±¡</h3><p>â€œé¢å‘è¿‡ç¨‹â€å’Œâ€œé¢å‘å¯¹è±¡â€æŒ‡çš„æ˜¯ç¼–ç¨‹æ€æƒ³ï¼Œå®ƒä»¬å±äºåŒä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œéƒ½æ˜¯å‘½ä»¤å¼ç¼–ç¨‹ã€‚</p><h3 id="å‘½ä»¤å¼ç¼–ç¨‹-vs-å‡½æ•°å¼ç¼–ç¨‹"><a href="#å‘½ä»¤å¼ç¼–ç¨‹-vs-å‡½æ•°å¼ç¼–ç¨‹" class="headerlink" title="å‘½ä»¤å¼ç¼–ç¨‹ vs å‡½æ•°å¼ç¼–ç¨‹"></a>å‘½ä»¤å¼ç¼–ç¨‹ vs å‡½æ•°å¼ç¼–ç¨‹</h3><p>æ‰€æœ‰çš„å‘½ä»¤å¼ç¼–ç¨‹éƒ½è¢«è®¾è®¡æ¥é«˜æ•ˆåœ°ä½¿ç”¨å†¯è¯ºä¾æ›¼ä½“ç³»ç»“æ„çš„è®¡ç®—æœºã€‚å®é™…ä¸Šï¼Œæœ€åˆçš„å‘½ä»¤å¼è¯­è¨€çš„ç›®çš„å°±æ˜¯å–ä»£æ±‡ç¼–è¯­è¨€ï¼Œå¯¹æœºå™¨æŒ‡ä»¤è¿›è¡Œè¿›ä¸€æ­¥æŠ½è±¡ã€‚å› æ­¤ï¼Œå‘½ä»¤å¼è¯­è¨€å¸¦æœ‰å¼ºçƒˆçš„ç¡¬ä»¶ç»“æ„ç‰¹å¾ã€‚å‘½ä»¤å¼è¯­è¨€çš„æ ¸å¿ƒç‰¹æ€§æœ‰ï¼šæ¨¡æ‹Ÿå­˜å‚¨å•å…ƒçš„å˜é‡ã€åŸºäºä¼ è¾“æ“ä½œçš„èµ‹å€¼è¯­å¥ï¼Œä»¥åŠè¿­ä»£å½¢å¼çš„å¾ªç¯è¿ç®—ã€‚å‘½ä»¤å¼è¯­è¨€çš„åŸºç¡€æ˜¯<strong>è¯­å¥</strong>ï¼ˆç‰¹åˆ«æ˜¯èµ‹å€¼ï¼‰ï¼Œå®ƒä»¬é€šè¿‡ä¿®æ”¹å­˜å‚¨å™¨çš„å€¼è€Œäº§ç”Ÿå‰¯ä½œç”¨çš„æ–¹å¼å»å½±å“åç»­çš„è®¡ç®—ã€‚</p><p>å‡½æ•°å¼è¯­è¨€è®¾è®¡çš„åŸºç¡€æ˜¯æ•°å­¦å‡½æ•°ï¼Œå‡½æ•°å¼ç¨‹åºè®¾è®¡æŠŠç¨‹åºçš„è¾“å‡ºå®šä¹‰ä¸ºå…¶è¾“å…¥çš„ä¸€ä¸ªæ•°å­¦å‡½æ•°ï¼Œåœ¨è¿™é‡Œæ²¡æœ‰å†…éƒ¨çŠ¶æ€ï¼Œä¹Ÿæ²¡æœ‰å‰¯ä½œç”¨ã€‚å‡½æ•°å¼è¯­è¨€è¿›è¡Œè®¡ç®—çš„ä¸»è¦æ˜¯å°†å‡½æ•°ä½œç”¨ä¸ç»™å®šå‚æ•°ä¹‹ä¸Šã€‚å‡½æ•°å¼è¯­è¨€æ²¡æœ‰å‘½ä»¤å¼è¯­è¨€æ‰€å¿…éœ€çš„é‚£ç§å˜é‡ï¼Œå¯ä»¥æ²¡æœ‰èµ‹å€¼è¯­å¥ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰å¾ªç¯ã€‚ä¸€ä¸ªç¨‹åºå°±æ˜¯å‡½æ•°å®šä¹‰å’Œå‡½æ•°åº”ç”¨çš„è¯´æ˜ï¼›ä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œå°±æ˜¯å¯¹å‡½æ•°åº”ç”¨çš„æ±‚å€¼ã€‚</p><p>çœ‹ä¸‹é¢ä¸¤æ®µä»£ç ï¼ŒåŠŸèƒ½éƒ½ä¸ºæ±‚ä¸€ä¸ªæ•°çš„é˜¶ä¹˜ï¼ˆn!ï¼‰ï¼Œä¸‹é¢ä¸¤æ®µä»£ç åˆ†åˆ«ä»£è¡¨äº†å‘½ä»¤å¼ç¼–ç¨‹ å’Œ å‡½æ•°å¼ç¼–ç¨‹ã€‚</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//å‘½ä»¤å¼ç¼–ç¨‹</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">factorial1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> result = <span class="hljs-number">1</span>;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= x; ++i) &#123;</span><br><span class="line">        result *= i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//å‡½æ•°å¼ç¼–ç¨‹</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">factorial2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (x == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;</span><br><span class="line">    <span class="hljs-keyword">return</span> x * factorial2(x<span class="hljs-number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸éš¾ç†è§£ï¼Œä¸¤ä¸ªæ–¹æ³•çš„ä½œç”¨ç›¸åŒã€‚éƒ½ä¸ºæ±‚ä¸€ä¸ªæ•°çš„é˜¶ä¹˜ï¼ˆn!ï¼‰ã€‚é‚£ä¹ˆä¸¤æ®µä»£ç æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><ul><li><p>çœ‹å¾…è¿ç®—ä¸æ‡‚</p><p>factorial1æŠŠè¿ç®—çœ‹åšæ˜¯cpuçš„è¿ç®—ï¼Œæœ‰å­˜å‚¨ï¼Œåˆ›å»ºã€è®¡ç®—ï¼Œè¿”å›å€¼ï¼ˆåŸºäºå†¯è¯ºä¾æ›¼ä½“ç³»ç»“æ„ï¼‰ã€‚</p><p>factorial2æ›´æ¥è¿‘æ•°å­¦è®¡ç®—ï¼Œæ›´å¤šçš„æ˜¯æè¿°ä¸€ç§è¿ç®—ã€‚nçš„é˜¶ä¹˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé‚£å°±æ˜¯n! = n * (n-1)!ã€‚æ‰€ä»¥factorial2å°±æ˜¯åœ¨è¡¨è¿°è¿™ç§è¿ç®—ã€‚</p></li><li><p>factorial1æ˜¯åŸºäºè¯­å¥çš„(èµ‹å€¼è¯­å¥ã€forå¾ªç¯è¯­å¥)ï¼Œfactorial2æ˜¯åŸºäºè¡¨è¾¾å¼çš„ï¼ˆè¡¨è¾¾å¼æ˜¯æŒ‡æœ‰å€¼è¿”å›çš„å°±å«åšè¡¨è¾¾å¼ï¼‰ã€‚</p></li><li><p>factorial1æ˜¯åŸºäºçŠ¶æ€é‡çš„ï¼Œå°±æ˜¯ä»£ç ä¸­çš„resultï¼Œè¦èµ‹å€¼ï¼Œæ¯”è¾ƒã€‚factorial2æ˜¯åŸºäºä¸å˜é‡çš„ï¼Œä»£ç ä¸­æ²¡æœ‰ä»»ä½•ä¿®æ”¹å€¼çš„æ“ä½œã€‚</p></li></ul><p>factorial1 ä¸ factorial2çš„å¯¹æ¯”ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤å¼ç¼–ç¨‹ä¸å‡½æ•°å¼ç¼–ç¨‹çš„å¯¹æ¯”ã€‚åƒæˆ‘ä»¬å¹³æ—¶æ¥è§¦çš„cã€ocã€javaéƒ½æ˜¯å‘½ä»¤å¼ç¼–ç¨‹å¾ˆå°‘ä¼šæ¥è§¦åˆ°çº¯å‡½æ•°å¼ç¼–ç¨‹çš„ç¼–ç¨‹è¯­è¨€,æ¯”å¦‚Erlangã€clojureã€Scalaã€‚</p><h3 id="æ€»ç»“å‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹ç‚¹"><a href="#æ€»ç»“å‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹ç‚¹" class="headerlink" title="æ€»ç»“å‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹ç‚¹"></a>æ€»ç»“å‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹ç‚¹</h3><ul><li><p>å‡½æ•°æ˜¯â€œç¬¬ä¸€ç­‰å…¬æ°‘â€</p><p>æ‰€è°“â€œç¬¬ä¸€ç­‰å…¬æ°‘â€ï¼ŒæŒ‡çš„æ˜¯å‡½æ•°ä¸å…¶ä»–æ•°æ®ç±»å‹ä¸€æ ·ï¼Œå¤„äºå¹³ç­‰åœ°ä½ï¼Œå¯ä»¥èµ‹å€¼ç»™å…¶ä»–å˜é‡ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥å¦ä¸€ä¸ªå‡½æ•°ï¼Œæˆ–è€…ä½œä¸ºåˆ«çš„å‡½æ•°çš„è¿”å›å€¼ã€‚</p></li><li><p>åªç”¨è¡¨è¾¾å¼ï¼Œä¸ç”¨è¯­å¥</p><p>â€œè¡¨è¾¾å¼â€æ˜¯ä¸€ä¸ªå•çº¯çš„è¿ç®—è¿‡ç¨‹ï¼Œæ€»æ˜¯æœ‰è¿”å›å€¼ï¼›â€è¯­å¥â€ï¼ˆstatementï¼‰æ˜¯æ‰§è¡ŒæŸç§æ“ä½œï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚å‡½æ•°å¼ç¼–ç¨‹è¦æ±‚ï¼Œåªä½¿ç”¨è¡¨è¾¾å¼ï¼Œä¸ä½¿ç”¨è¯­å¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€æ­¥éƒ½æ˜¯å•çº¯çš„è¿ç®—ï¼Œè€Œä¸”éƒ½æœ‰è¿”å›å€¼ã€‚</p><p>åŸå› æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„å¼€å‘åŠ¨æœºï¼Œä¸€å¼€å§‹å°±æ˜¯ä¸ºäº†å¤„ç†è¿ç®—ï¼ˆcomputationï¼‰ï¼Œä¸è€ƒè™‘ç³»ç»Ÿçš„è¯»å†™ï¼ˆI/Oï¼‰ã€‚â€è¯­å¥â€å±äºå¯¹ç³»ç»Ÿçš„è¯»å†™æ“ä½œï¼Œæ‰€ä»¥å°±è¢«æ’æ–¥åœ¨å¤–ã€‚</p><p>å½“ç„¶ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œä¸åšI/Oæ˜¯ä¸å¯èƒ½çš„ã€‚å› æ­¤ï¼Œç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œå‡½æ•°å¼ç¼–ç¨‹åªè¦æ±‚æŠŠI/Oé™åˆ¶åˆ°æœ€å°ï¼Œä¸è¦æœ‰ä¸å¿…è¦çš„è¯»å†™è¡Œä¸ºï¼Œä¿æŒè®¡ç®—è¿‡ç¨‹çš„å•çº¯æ€§ã€‚</p></li><li><p>æ²¡æœ‰â€œå‰¯ä½œç”¨â€</p><p>æ‰€è°“â€œå‰¯ä½œç”¨â€ï¼ŒæŒ‡çš„æ˜¯å‡½æ•°å†…éƒ¨ä¸å¤–éƒ¨äº’åŠ¨ï¼ˆæœ€å…¸å‹çš„æƒ…å†µï¼Œå°±æ˜¯ä¿®æ”¹å…¨å±€å˜é‡çš„å€¼ï¼‰ï¼Œäº§ç”Ÿè¿ç®—ä»¥å¤–çš„å…¶ä»–ç»“æœã€‚</p><p>å‡½æ•°å¼ç¼–ç¨‹å¼ºè°ƒæ²¡æœ‰â€å‰¯ä½œç”¨â€ï¼Œæ„å‘³ç€å‡½æ•°è¦ä¿æŒç‹¬ç«‹ï¼Œæ‰€æœ‰åŠŸèƒ½å°±æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„å€¼ï¼Œæ²¡æœ‰å…¶ä»–è¡Œä¸ºï¼Œå°¤å…¶æ˜¯ä¸å¾—ä¿®æ”¹å¤–éƒ¨å˜é‡çš„å€¼ã€‚</p><p>è¿™ä¸ªä¸å¤ªå®¹æ˜“ç†è§£ï¼Œé€šä¿—ä¸€ç‚¹çš„è¯´ï¼Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨å‘½ä»¤å¼ç¼–ç¨‹å¼€å‘å·¥ç¨‹ä¸­æœ‰ç»å¸¸ä¼šæœ‰å¦‚ä¸‹åœºæ™¯ï¼šfun1()è°ƒç”¨å®Œä¹‹åæ‰èƒ½è°ƒç”¨fun2()ã€‚é‚£è¿™ç§æƒ…å†µåœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­å°±ä¸ä¼šå‡ºç°ã€‚å› ä¸ºæ¯ä¸ªå‡½æ•°éƒ½æ˜¯æ²¡æœ‰å‰¯ä½œç”¨çš„ï¼Œä¸å½±å“å¤–éƒ¨å˜é‡ï¼Œæ‰€ä»¥func1()è¿˜æ˜¯func2è°å…ˆè°ƒç”¨ï¼Œéƒ½æ— æ‰€è°“ã€‚</p></li><li><p>ä¸ä¿®æ”¹çŠ¶æ€</p><p>ä¸Šä¸€ç‚¹å·²ç»æåˆ°ï¼Œå‡½æ•°å¼ç¼–ç¨‹åªæ˜¯è¿”å›æ–°çš„å€¼ï¼Œä¸ä¿®æ”¹ç³»ç»Ÿå˜é‡ã€‚å› æ­¤ï¼Œä¸ä¿®æ”¹å˜é‡ï¼Œä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹ã€‚åœ¨å…¶ä»–ç±»å‹çš„è¯­è¨€ä¸­ï¼Œå˜é‡å¾€å¾€ç”¨æ¥ä¿å­˜â€çŠ¶æ€â€ã€‚ä¸ä¿®æ”¹å˜é‡ï¼Œæ„å‘³ç€çŠ¶æ€ä¸èƒ½ä¿å­˜åœ¨å˜é‡ä¸­ã€‚å‡½æ•°å¼ç¼–ç¨‹ä½¿ç”¨å‚æ•°ä¿å­˜çŠ¶æ€ï¼Œæœ€å¥½çš„ä¾‹å­å°±æ˜¯é€’å½’ã€‚</p></li><li><p>å¼•ç”¨é€æ˜</p><p>å¼•ç”¨é€æ˜ï¼ŒæŒ‡çš„æ˜¯å‡½æ•°çš„è¿è¡Œä¸ä¾èµ–äºå¤–éƒ¨å˜é‡æˆ–â€çŠ¶æ€â€ï¼Œåªä¾èµ–äºè¾“å…¥çš„å‚æ•°ï¼Œä»»ä½•æ—¶å€™åªè¦å‚æ•°ç›¸åŒï¼Œå¼•ç”¨å‡½æ•°æ‰€å¾—åˆ°çš„è¿”å›å€¼æ€»æ˜¯ç›¸åŒçš„ã€‚</p><p>æœ‰äº†å‰é¢çš„ç¬¬ä¸‰ç‚¹å’Œç¬¬å››ç‚¹ï¼Œè¿™ç‚¹æ˜¯å¾ˆæ˜¾ç„¶çš„ã€‚å…¶ä»–ç±»å‹çš„è¯­è¨€ï¼Œå‡½æ•°çš„è¿”å›å€¼å¾€å¾€ä¸ç³»ç»ŸçŠ¶æ€æœ‰å…³ï¼Œä¸åŒçš„çŠ¶æ€ä¹‹ä¸‹ï¼Œè¿”å›å€¼æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™å°±å«â€å¼•ç”¨ä¸é€æ˜â€ï¼Œå¾ˆä¸åˆ©äºè§‚å¯Ÿå’Œç†è§£ç¨‹åºçš„è¡Œä¸ºã€‚</p></li><li><p>æƒ°æ€§è®¡ç®—<strong>ï¼ˆï¼Ÿï¼Ÿæœ‰ç‚¹ç–‘é—®<a href="http://www.nowamagic.net/academy/detail/1220550" target="_blank" rel="noopener">å‡½æ•°å¼ç¼–ç¨‹çš„æƒ°æ€§æ±‚å€¼</a>ï¼‰</strong>  </p></li></ul><h3 id="å“åº”å¼ç¼–ç¨‹"><a href="#å“åº”å¼ç¼–ç¨‹" class="headerlink" title="å“åº”å¼ç¼–ç¨‹"></a>å“åº”å¼ç¼–ç¨‹</h3><p>åœ¨è®¡ç®—æœºä¸­ï¼Œå“åº”å¼ç¼–ç¨‹æ˜¯ä¸€ç§é¢å‘æ•°æ®æµå’Œå˜åŒ–ä¼ æ’­çš„ç¼–ç¨‹èŒƒå¼ã€‚è¿™æ„å‘³ç€å¯ä»¥åœ¨ç¼–ç¨‹è¯­è¨€ä¸­å¾ˆæ–¹ä¾¿åœ°è¡¨è¾¾é™æ€æˆ–åŠ¨æ€çš„æ•°æ®æµï¼Œè€Œç›¸å…³çš„è®¡ç®—æ¨¡å‹ä¼šè‡ªåŠ¨å°†å˜åŒ–çš„å€¼é€šè¿‡æ•°æ®æµè¿›è¡Œä¼ æ’­ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨å‘½ä»¤å¼ç¼–ç¨‹ç¯å¢ƒä¸­ï¼Œa=b+cè¡¨ç¤ºå°†è¡¨è¾¾å¼çš„ç»“æœèµ‹ç»™aï¼Œè€Œä¹‹åæ”¹å˜bæˆ–cçš„å€¼ä¸ä¼šå½±å“aã€‚ä½†åœ¨å“åº”å¼ç¼–ç¨‹ä¸­ï¼Œaçš„å€¼ä¼šéšç€bæˆ–cçš„æ›´æ–°è€Œæ›´æ–°ã€‚</p><p>ç”µå­è¡¨æ ¼ç¨‹åºå°±æ˜¯å“åº”å¼ç¼–ç¨‹çš„ä¸€ä¸ªä¾‹å­ã€‚å•å…ƒæ ¼å¯ä»¥åŒ…å«å­—é¢å€¼æˆ–ç±»ä¼¼â€=B1+C1â€çš„å…¬å¼ï¼Œè€ŒåŒ…å«å…¬å¼çš„å•å…ƒæ ¼çš„å€¼ä¼šä¾æ®å…¶ä»–å•å…ƒæ ¼çš„å€¼çš„å˜åŒ–è€Œå˜åŒ– ã€‚</p><p>åœ¨ioså¼€å‘ä¸­ï¼Œautolayoutå°±æ˜¯ä½¿ç”¨äº†å“åº”å¼ç¼–ç¨‹ã€‚å“åº”å¼ç¼–ç¨‹ç†è§£èµ·æ¥åº”è¯¥ä¼šç®€å•ä¸€ç‚¹ï¼Œè¿™é‡Œå°±ä¸å¤šè§£é‡Šã€‚</p><h3 id="ReactiveCocoaæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ReactiveCocoaæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ReactiveCocoaæ˜¯ä»€ä¹ˆï¼Ÿ"></a>ReactiveCocoaæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>ä¸Šé¢è®²äº†å‡½æ•°å¼ç¼–ç¨‹ å’Œ å“åº”å¼ç¼–ç¨‹ã€‚é‚£ä¹ˆReactiveCocoa å°±æ˜¯ç»“åˆäº†å‡½æ•°å¼ç¼–ç¨‹å’Œå“åº”å¼ç¼–ç¨‹çš„ç‰¹ç‚¹ï¼š</p><ul><li>å‡½æ•°å¼ç¼–ç¨‹ï¼šå°†è¿ç®—è¿‡ç¨‹å°½é‡å†™æˆä¸€äº›åˆ—çš„å‡½æ•°è°ƒç”¨ã€‚</li><li>å“åº”å¼ç¼–ç¨‹ï¼šé¢å¯¹ç¦»æ•£æ•°æ®æµä»¥åŠå¯¹ç¦»æ•£æ•°æ®æµè¿›è¡Œæ“ä½œã€‚</li></ul><p>ï¼Œæä¾›<strong>åŸºäºæ—¶é—´å˜åŒ–çš„æ•°æ®æµ</strong>çš„ç»„åˆå’Œå˜æ¢ï¼Œå°†è¾“å…¥è½¬åŒ–ä¸ºè¾“å‡ºåœ¨æ—¶é—´ä¸Šçš„æŒç»­è¿‡ç¨‹çš„ä¸€ç§æ–¹å¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ReactiveCocoaæ˜¯ä¸€ç§æ–°çš„ç¼–ç¨‹èŒƒå¼(å³å‡½æ•°å“åº”å¼ç¼–ç¨‹)ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªåŸºç¡€åº“ã€‚æ˜¯åœ¨é¢å‘å¯¹è±¡è¯­è¨€çš„åŸºç¡€ä¸Šï¼Œå¯¹å‡½æ•°å“åº”å¼ç¼–ç¨‹çš„å®ç°ã€‚æœ¬æ–‡ä¸»è¦è®²è§£å‡½æ•°å¼ç¼–ç¨‹å’Œå“åº”å¼ç¼–ç¨‹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
    
      <category term="ReactiveCocoa" scheme="http://www.wuqihan.cn/tags/ReactiveCocoa/"/>
    
  </entry>
  
  <entry>
    <title>iOSå†…å­˜ç®¡ç†è¯¦è§£</title>
    <link href="http://www.wuqihan.cn/2016/08/20/iOS%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    <id>http://www.wuqihan.cn/2016/08/20/iOSå†…å­˜ç®¡ç†/</id>
    <published>2016-08-20T08:16:43.000Z</published>
    <updated>2020-01-28T10:14:12.232Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†…å­˜ç®¡ç†-å¼•ç”¨è®¡æ•°"><a href="#å†…å­˜ç®¡ç†-å¼•ç”¨è®¡æ•°" class="headerlink" title="å†…å­˜ç®¡ç†/å¼•ç”¨è®¡æ•°"></a>å†…å­˜ç®¡ç†/å¼•ç”¨è®¡æ•°</h2><p>Objective-Cçš„å†…å­˜ç®¡ç†æ–¹å¼ï¼šå¼•ç”¨è®¡æ•°</p><h3 id="å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼"><a href="#å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼" class="headerlink" title="å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼"></a>å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼</h3><table><thead><tr><th style="text-align:left">å¯¹è±¡æ“ä½œ</th><th>Objective-Cæ–¹æ³•</th></tr></thead><tbody><tr><td style="text-align:left">ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡</td><td>alloc/new/copy/mutableCopyç­‰æ–¹æ³•</td></tr><tr><td style="text-align:left">æŒæœ‰å¯¹è±¡</td><td>retainæ–¹æ³•</td></tr><tr><td style="text-align:left">é‡Šæ”¾å¯¹è±¡</td><td>releaseæ–¹æ³•</td></tr><tr><td style="text-align:left">åºŸå¼ƒå¯¹è±¡</td><td>deallocæ–¹æ³•</td></tr></tbody></table><p>â€‹    <a id="more"></a></p><p>â€‹    è¿™äº›æœ‰å…³Objective-Cå†…å­˜ç®¡ç†çš„æ–¹æ³•ï¼Œå®é™…ä¸Šä¸åŒ…æ‹¬åœ¨è¯¥è¯­è¨€ä¸­ï¼Œè€Œæ˜¯åŒ…å«åœ¨Cocoaæ¡†æ¶ä¸­ç”¨äºOS Xã€iOSåº”ç”¨å¼€å‘ã€‚<strong>Cocoaæ¡†æ¶ä¸­Foundationæ¡†æ¶ç±»åº“çš„NSObjectç±»æ‹…è´Ÿå†…å­˜ç®¡ç†çš„èŒè´£</strong>ã€‚</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/arc1.jpg" alt="IMG_3B1C737308BF-1"></p><ul><li><p>è‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±æŒæœ‰</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// è‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡</span></span><br><span class="line"><span class="hljs-keyword">id</span> obj = [[<span class="hljs-built_in">NSObject</span> alloc] init];</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨alloc/new/copy/mutableCopyçš„æ–¹æ³•ï¼Œå–å¾—çš„å¯¹è±¡éƒ½æ˜¯è‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰çš„ã€‚</p><p>ç”¨è¿™äº›ä»¥å¤–çš„æ–¹æ³•å–å¾—çš„å¯¹è±¡ï¼Œå› ä¸ºéè‡ªå·±ç”Ÿæˆï¼Œæ‰€ä»¥è‡ªå·±ä¸æ˜¯å¯¹è±¡çš„æŒæœ‰è€…ã€‚</p><p>copyæ–¹æ³•åˆ©ç”¨åŸºäºNSCopyingæ–¹æ³•çº¦å®šï¼Œç”±å„ç±»å®ç°çš„copyWithZone:æ–¹æ³•ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡çš„å‰¯æœ¬ï¼Œmutableä¸copyç±»ä¼¼  ã€‚ç”¨copy/mutableCopyæ–¹æ³•ç”Ÿæˆçš„å¯¹è±¡ï¼Œè™½ç„¶æ˜¯å¯¹è±¡çš„å‰¯æœ¬ï¼Œä½†åŒallcoã€newæ–¹æ³•ä¸€æ ·ï¼Œåœ¨â€œè‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡â€è¿™ç‚¹ä¸Šæ²¡æœ‰æ”¹å˜ã€‚</p></li><li><p>éè‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±ä¹Ÿèƒ½æŒæœ‰</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">å–å¾—éè‡ªå·±ç”Ÿæˆå¯¹è±¡ï¼Œä¸æŒæœ‰</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-keyword">id</span> obj = [<span class="hljs-built_in">NSMutableArray</span> array];</span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">è‡ªå·±æŒæœ‰</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line">[obj reatin];</span><br></pre></td></tr></table></figure><p>é€šè¿‡retainæ–¹æ³•ï¼Œéè‡ªå·±ç”Ÿæˆçš„åƒ å¯ä»¥è¢«è‡ªå·±æ‰€æŒæœ‰ã€‚</p></li><li><p>ä¸å†éœ€è¦è‡ªå·±æŒæœ‰çš„å¯¹è±¡æ—¶é‡Šæ”¾</p><p>ç”¨alloc/new/copy/mutableCopyæ–¹æ³•ç”Ÿæˆå¹¶æŒæœ‰çš„å¯¹è±¡ï¼Œæˆ–è€…ç”¨retainæ–¹æ³•æŒæœ‰çš„å¯¹è±¡ï¼Œä¸€æ—¦ä¸å†éœ€è¦ï¼ŒåŠ¡å¿…è¦ç”¨releaseæ–¹æ³•è¿›è¡Œé‡Šæ”¾ã€‚</p></li><li><p>æ— æ³•é‡Šæ”¾éè‡ªå·±æŒæœ‰çš„å¯¹è±¡</p></li></ul><blockquote><p>å†…å­˜ç®¡ç†é»„é‡‘æ³•åˆ™ï¼š</p><p>The basic rule to apple is everything thatincreases the reference counter with alloc,[mutable]copy[WithZone:] or retainis in charge of the corresponding [auto]release.</p><p>å¦‚æœä¸€ä¸ªå¯¹è±¡ä½¿ç”¨äº†allocï¼Œ[mutable] copyï¼Œretainï¼Œé‚£ä¹ˆä½ å¿…é¡»ä½¿ç”¨ç›¸åº”çš„[auto]release</p></blockquote><h3 id="è‹¹æœå¯¹äºå¼•ç”¨è®¡æ•°çš„å®ç°"><a href="#è‹¹æœå¯¹äºå¼•ç”¨è®¡æ•°çš„å®ç°" class="headerlink" title="è‹¹æœå¯¹äºå¼•ç”¨è®¡æ•°çš„å®ç°"></a>è‹¹æœå¯¹äºå¼•ç”¨è®¡æ•°çš„å®ç°</h3><p>åœ¨NSObjectç±»çš„allocç±»æ–¹æ³•ä¸Šè®¾ç½®æ–­ç‚¹ï¼Œè¿½è¸ªç¨‹åºçš„æ‰§è¡Œã€‚ä»¥ä¸‹åˆ—å‡ºäº†æ‰§è¡Œæ‰€è°ƒç”¨çš„æ–¹æ³•å’Œå‡½æ•°ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+alloc</span><br><span class="line">+allocWithZone:</span><br><span class="line">class_createInstance</span><br><span class="line"><span class="hljs-built_in">calloc</span></span><br></pre></td></tr></table></figure><p>allocç±»æ–¹æ³•é¦–å…ˆè°ƒç”¨allocWithZone:ç±»æ–¹æ³•ï¼Œç„¶åè°ƒç”¨class_createInstanceå‡½æ•°ï¼Œæœ€åé€šè¿‡è°ƒç”¨callocæ¥åˆ†é…å†…å­˜å—ã€‚</p><p>retainCount/retain/releaseå®ä¾‹æ–¹æ³•åˆæ˜¯æ€ä¹ˆå®ç°å‘¢ï¼ŸåŒåˆšæ‰çš„æ–¹æ³•ä¸€æ ·ï¼Œä¸‹é¢åˆ—å‡ºå„ä¸ªæ–¹æ³•åˆ†åˆ«è°ƒç”¨çš„æ–¹æ³•å’Œå‡½æ•°ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-retainCount</span><br><span class="line">__CFDoExternRefOperation</span><br><span class="line">CFBasicHashGetCountOfKey</span><br></pre></td></tr></table></figure><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-retain</span><br><span class="line">__CFDoExternRefOperation</span><br><span class="line">CFBasicHashAddValue</span><br></pre></td></tr></table></figure><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-release</span><br><span class="line">__CFDoExternRefOperation</span><br><span class="line">CFBasicHashRemoveValue</span><br><span class="line">(CFBasicHashRemoveValueè¿”å›<span class="hljs-number">0</span>æ—¶ï¼Œ-releaseè°ƒç”¨dealloc)</span><br></pre></td></tr></table></figure><p>å„ä¸ªæ–¹æ³•éƒ½é€šè¿‡åŒä¸€ä¸ª__CFDoExternRefOperationå‡½æ•°ï¼Œè°ƒç”¨äº†ä¸€ç³»åˆ—åç§°ç›¸ä¼¼çš„å‡½æ•°ã€‚å¦‚è¿™äº›å‡½æ•°åçš„å‰ç¼€â€CFâ€æ‰€ç¤ºï¼Œå¥¹ä»¬åŒ…å«äºCoreFoundationæ¡†æ¶æºä»£ç ä¸­ï¼Œå³æ˜¯CFRuntime.cçš„CFDoExternRefOperationå‡½æ•°ã€‚ä¸ºäº†ç†è§£å…¶å®ç°ï¼Œä¸‹é¢ç®€åŒ–è¯¥å‡½æ•°çš„æºä»£ç ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">int</span> __CFDoExternRefOperation(<span class="hljs-keyword">uintptr_t</span> op, id obj) &#123;</span><br><span class="line"></span><br><span class="line">    CFBasicHashRef table = å–å¾—å¯¹è±¡çš„æ•£åˆ—è¡¨(obj);</span><br><span class="line">    <span class="hljs-keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">switch</span> (op) &#123;</span><br><span class="line">    <span class="hljs-keyword">case</span> OPERATION_retainCount:</span><br><span class="line">        count = CFBasicHashGetCountOfKey(table, obj);</span><br><span class="line">        <span class="hljs-keyword">return</span> count;</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">case</span> OPERATION_retain:</span><br><span class="line">        count = CFBasicHashAddValue(table, obj);</span><br><span class="line">        <span class="hljs-keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">case</span> OPERATION_release:</span><br><span class="line">        count = CFBasicHashRemoveValue(table, obj);</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> == count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>__CFDoExternRefOperationé€šè¿‡switchè¯­å¥ é’ˆå¯¹ä¸åŒçš„æ“ä½œæ¥è¿›è¡Œå…·ä½“çš„æ–¹æ³•è°ƒç”¨ï¼ŒretainCount/retain/releaseå®ä¾‹æ–¹æ³•ä¹Ÿè®¸å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="hljs-built_in">NSUInteger</span>)retainCount</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">NSUInteger</span>)____CFDoExternRefOperation(OPERATION_retainCount,<span class="hljs-keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="hljs-keyword">id</span>)<span class="hljs-keyword">retain</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">id</span>)____CFDoExternRefOperation(OPERATION_retain,<span class="hljs-keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="hljs-keyword">void</span>)release</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> ____CFDoExternRefOperation(OPERATION_release,<span class="hljs-keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šï¼Œå¯ä»¥çœ‹å‡ºè‹¹æœçš„å¤§æ¦‚å®ç°å°±æ˜¯å°†å¼•ç”¨è®¡æ•°ä¿å­˜åœ¨å¼•ç”¨è®¡æ•°è¡¨çš„è®°å½•ä¸­ï¼Œè€Œä¸æ˜¯ä¿å­˜åœ¨å¯¹è±¡å ç”¨å†…å­˜å—å¤´éƒ¨ä¸­ã€‚é‡‡ç”¨æ•£åˆ—è¡¨(å¼•ç”¨è®¡æ•°è¡¨)æ¥ç®¡ç†å¼•ç”¨è®¡æ•°ã€‚</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/arc2.jpg" alt="IMG_75C55E500AB3-1"></p><p>è¿™æ ·çš„å¥½å¤„æ˜¯ï¼š</p><ul><li>ä¸ç”¨åœ¨æ¯ä¸ªå¯¹è±¡å†…å­˜å—ä¸­è€ƒè™‘å¼•ç”¨è®¡æ•°æ‰€å çš„å†…å­˜</li><li>å¼•ç”¨æŠ€æœ¯è¡¨å„è®°å½•ä¸­å­˜æœ‰å†…å­˜åœ°å€ï¼Œå¯ä»å„ä¸ªè®°å½•è¿½æº¯åˆ°å„å¯¹è±¡çš„å†…å­˜å—ï¼ˆå³ä½¿å‡ºç°æ•…éšœå¯¼è‡´å¯¹è±¡å ç”¨çš„å†…å­˜å—æŸåï¼Œä½†åªè¦å¼•ç”¨è®¡æ•°è¡¨æ²¡æœ‰è¢«ç ´åï¼Œå°±èƒ½å¤Ÿç¡®è®¤å„ä¸ªå†…å­˜å—çš„ä½ç½®ï¼‰</li></ul><p>å¦å¤–ï¼Œåœ¨åˆ©ç”¨å·¥å…·æ£€æµ‹å†…å­˜æ³„æ¼æ—¶ï¼Œå¼•ç”¨è®¡æ•°è¡¨çš„å„è®°å½•ä¹Ÿæœ‰åŠ©äºæ£€æµ‹å„å¯¹è±¡çš„æŒæœ‰è€…æ˜¯å¦å­˜åœ¨ã€‚</p><h2 id="Autorelease"><a href="#Autorelease" class="headerlink" title="Autorelease"></a>Autorelease</h2><p>ä½¿ç”¨autoreleaseï¼Œå¯ä½¿å–å¾—çš„å¯¹è±¡å­˜åœ¨ä½†è‡ªå·±ä¸æŒæœ‰å¯¹è±¡ã€‚autoreleaseæä¾› è¿™æ ·çš„åŠŸèƒ½ï¼Œä½¿å¯¹è±¡åœ¨è¶…å‡ºæŒ‡å®šçš„ç”Ÿå­˜èŒƒå›´æ—¶èƒ½å¤Ÿè‡ªåŠ¨å¹¶æ­£ç¡®åœ°é‡Šæ”¾(è‡ªåŠ¨è°ƒç”¨releaseæ–¹æ³•)ã€‚</p><h3 id="autoreleaseçš„å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹"><a href="#autoreleaseçš„å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹" class="headerlink" title="autoreleaseçš„å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹"></a>autoreleaseçš„å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</h3><ol><li>ç”Ÿæˆå¹¶æŒæœ‰NSAutoreleasePoolå¯¹è±¡</li><li>è°ƒç”¨å·²åˆ†é…å¯¹è±¡çš„autoreleaseå®ä¾‹æ–¹æ³•</li><li>åºŸå¼ƒNSAutoreleasePoolå¯¹è±¡</li></ol><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/arc3.jpg" alt="image-20180408170302393"></p><p>NSAutoreleasePoolå¯¹è±¡çš„ç”Ÿå­˜å‘¨æœŸç›¸å½“äºCè¯­è¨€å˜é‡çš„ä½œç”¨åŸŸã€‚å¯¹äºæ‰€æœ‰è°ƒç”¨è¿‡autoreleaseå®ä¾‹æ–¹æ³•çš„å¯¹è±¡ï¼Œåœ¨åºŸå¼ƒNSAutoreleasePoolå¯¹è±¡æ—¶ï¼Œéƒ½å°†è°ƒç”¨releaseå®ä¾‹æ–¹æ³•ã€‚</p><p>ç”¨æºä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSAutoReleasePool *pool = [[NSAutoReleasePool alloc] init];</span><br><span class="line">id obj = [[NSObject alloc] init];</span><br><span class="line">[obj autorelease];</span><br><span class="line">[pool drain];</span><br></pre></td></tr></table></figure><blockquote><p>NSAutoreleasePoolå¯¹è±¡çš„é”€æ¯æ˜¯è°ƒç”¨ drain() æ–¹æ³•</p></blockquote><p>ARCä¸­ä½¿ç”¨NSAutoReleasePoolï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@autoreleasepool&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">//åœ¨&#123;&#125;ä¸­å­˜æ”¾çš„å¯¹è±¡ä¼šåœ¨&#125;åé‡Šæ”¾æ‰</span></span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨NSAutoreleasePoolå‡å°‘å†…å­˜å³°å€¼"><a href="#ä½¿ç”¨NSAutoreleasePoolå‡å°‘å†…å­˜å³°å€¼" class="headerlink" title="ä½¿ç”¨NSAutoreleasePoolå‡å°‘å†…å­˜å³°å€¼"></a>ä½¿ç”¨NSAutoreleasePoolå‡å°‘å†…å­˜å³°å€¼</h3><p>åœ¨å¤§é‡äº§ç”Ÿautoreleaseçš„å¯¹è±¡æ—¶ï¼Œåªè¦ä¸åºŸå¼ƒNSAutoReleasePoolå¯¹è±¡ï¼Œé‚£ä¹ˆç”Ÿæˆçš„å¯¹è±¡å°±ä¸èƒ½è¢«é‡Šæ”¾ï¼Œå› æ­¤æœ‰æ—¶ä¼šäº§ç”Ÿå†…å­˜ä¸è¶³çš„ç°è±¡ã€‚å…¸å‹çš„ä¾‹å­æ˜¯è¯»å…¥å¤§é‡å›¾è±¡çš„åŒæ—¶æ”¹å˜å…¶å°ºå¯¸ã€‚å›¾è±¡æ–‡ä»¶è¯»å…¥åˆ°NSDataå¯¹è±¡ï¼Œå¹¶ç”ŸæˆUIImageå¯¹è±¡ï¼Œæ”¹å˜è¯¥å¯¹è±¡çš„å°ºå¯¸åç”Ÿæˆæ–°çš„UIImageå¯¹è±¡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå°±ä¼šå¤§é‡ç”Ÿæˆautoreleaseå¯¹è±¡ã€‚</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, i &lt; å›¾åƒæ•°, ++i) &#123;</span><br><span class="line">    <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">     *è¯»å…¥å›¾åƒ</span></span><br><span class="line"><span class="hljs-comment">     *å¤§é‡äº§ç”Ÿautoreleaseå¯¹è±¡</span></span><br><span class="line"><span class="hljs-comment">     *ç”±äºæ²¡æœ‰åºŸå¼ƒNSAutoreleasePoolå¯¹è±¡</span></span><br><span class="line"><span class="hljs-comment">     *æœ€ç»ˆå¯¼è‡´å†…å­˜ä¸è¶³</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤æƒ…å†µä¸‹ï¼Œæœ‰å¿…è¦åœ¨é€‚å½“åœ°æ–¹ç”Ÿæˆã€æŒæœ‰æˆ–åºŸå¼ƒNSAutoreleasePoolå¯¹è±¡ã€‚</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; å›¾åƒæ•°; ++i) &#123;</span><br><span class="line">    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];</span><br><span class="line">    <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">     *è¯»å…¥å›¾åƒ</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    [pool drain];</span><br><span class="line">    <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">    *é€šè¿‡[pool drain],</span></span><br><span class="line"><span class="hljs-comment">    *autoreleaseçš„å¯¹è±¡è¢«ä¸€èµ·åºŸå¼ƒ</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾"><a href="#autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾" class="headerlink" title="autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾"></a>autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾</h3><p>å¾ˆå¤šäººçš„ç­”æ¡ˆæ˜¯â€œå½“å‰ä½œç”¨åŸŸå¤§æ‹¬å·ç»“æŸæ—¶é‡Šæ”¾â€ï¼Œæ˜¾ç„¶æ²¡æœ‰æ­£ç¡®ç†è§£autoreleaseçš„æœºåˆ¶ã€‚åœ¨æ²¡æœ‰æ‰‹åŠ¨æ·»åŠ autoreleasepoolçš„æƒ…å†µä¸‹ï¼Œ<strong>autoreleaseå¯¹è±¡æ˜¯åœ¨å½“å‰runloopè¿­ä»£ç»“æŸæ—¶é‡Šæ”¾çš„</strong>ã€‚è€Œå®ƒèƒ½å¤Ÿé‡Šæ”¾çš„åŸå› æ˜¯ç³»ç»Ÿåœ¨æ¯ä¸ªrunloopè¿­ä»£ä¸­éƒ½åŠ å…¥äº†è‡ªåŠ¨é‡Šæ”¾æ± Pushå’ŒPopã€‚</p><p>çœ‹ä¸‹é¢ä»£ç ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__<span class="hljs-keyword">weak</span> <span class="hljs-keyword">id</span> reference = <span class="hljs-literal">nil</span>;</span><br><span class="line">- (<span class="hljs-keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="hljs-keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    __autoreleasing Person *p = [[Person alloc] init];</span><br><span class="line">    reference = p;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,reference);<span class="hljs-comment">//Console: &lt;Person: 0x60000000f170&gt;</span></span><br><span class="line">&#125;</span><br><span class="line">- (<span class="hljs-keyword">void</span>)viewWillAppear:(<span class="hljs-built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="hljs-keyword">super</span> viewWillAppear:animated];</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,reference);<span class="hljs-comment">//Console: &lt;Person: 0x60000000f170&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="hljs-keyword">void</span>)viewDidAppear:(<span class="hljs-built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="hljs-keyword">super</span> viewDidAppear:animated];</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,reference);<span class="hljs-comment">//Console: (null)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸ªvcåœ¨loadViewä¹‹åä¾¿addåˆ°äº†windowå±‚çº§ä¸Šï¼Œæ‰€ä»¥<code>viewDidLoad</code>å’Œ<code>viewWillAppear</code>æ˜¯åœ¨åŒä¸€ä¸ªrunloopè°ƒç”¨çš„ï¼Œå› æ­¤åœ¨<code>viewWillAppear</code>ä¸­ï¼Œè¿™ä¸ªautoreleaseçš„å˜é‡ä¾ç„¶æœ‰å€¼ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å¹²é¢„autoreleaseå¯¹è±¡çš„é‡Šæ”¾æ—¶æœºï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__<span class="hljs-keyword">weak</span> <span class="hljs-keyword">id</span> reference = <span class="hljs-literal">nil</span>;</span><br><span class="line">- (<span class="hljs-keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="hljs-keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        __autoreleasing Person *p = [[Person alloc] init];</span><br><span class="line">        reference = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,reference);<span class="hljs-comment">//Console: (null)</span></span><br><span class="line">&#125;</span><br><span class="line">- (<span class="hljs-keyword">void</span>)viewWillAppear:(<span class="hljs-built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="hljs-keyword">super</span> viewWillAppear:animated];</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,reference);<span class="hljs-comment">//Console: (null)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="hljs-keyword">void</span>)viewDidAppear:(<span class="hljs-built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="hljs-keyword">super</span> viewDidAppear:animated];</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,reference);<span class="hljs-comment">//Console: (null)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è‹¹æœå¯¹äºautoreleaseçš„å®ç°"><a href="#è‹¹æœå¯¹äºautoreleaseçš„å®ç°" class="headerlink" title="è‹¹æœå¯¹äºautoreleaseçš„å®ç°"></a>è‹¹æœå¯¹äºautoreleaseçš„å®ç°</h3><p>autoreleaseå®ä¾‹æ–¹æ³•çš„æœ¬è´¨å°±æ˜¯è°ƒç”¨NSAutoreleasePoolå¯¹è±¡çš„addObjectæ–¹æ³•ã€‚</p><p>ç³»ç»Ÿåœ¨æ¯ä¸ªrunloopè¿­ä»£ä¸­éƒ½åŠ å…¥äº†è‡ªåŠ¨é‡Šæ”¾æ± çš„Pushå’ŒPopæ–¹æ³•ã€‚å…·ä½“ä¸ºrunloopå¼€å§‹çš„æ—¶å€™è°ƒç”¨AutoreleasePoolPageçš„Pushæ–¹æ³•ï¼Œç»“æŸçš„æ—¶å€™è°ƒç”¨Popæ–¹æ³•ã€‚</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">objc_autoreleasePoolPush</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> AutoreleasePoolPage::push();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">objc_autoreleasePoolPop</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *ctxt)</span> </span>&#123;</span><br><span class="line">    AutoreleasePoolPage::pop(ctxt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆAutoreleasePoolPageæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ</p><p>AutoReleasePoolPageæ˜¯ä¸€ä¸ªC++çš„ç±»ï¼Œåœ¨NSObject.mmä¸­å®šä¹‰æ˜¯ï¼š</p><figure class="highlight c++ hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AutoreleasePoolPage</span> &#123;</span></span><br><span class="line">    <span class="hljs-keyword">magic_t</span> <span class="hljs-keyword">const</span> magic;</span><br><span class="line">    id *next;</span><br><span class="line">    <span class="hljs-keyword">pthread_t</span> <span class="hljs-keyword">const</span> thread;</span><br><span class="line">    AutoreleasePoolPage * <span class="hljs-keyword">const</span> parent;</span><br><span class="line">    AutoreleasePoolPage *child;</span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> <span class="hljs-keyword">const</span> depth;</span><br><span class="line">    <span class="hljs-keyword">uint32_t</span> hiwat;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p>magic ç”¨äºå¯¹å½“å‰ AutoreleasePoolPage`<strong>å®Œæ•´æ€§</strong>çš„æ ¡éªŒ</p></li><li><p>thread ä¿å­˜äº†å½“å‰æ‰€åœ¨çš„çº¿ç¨‹</p></li></ul><p>æ¯ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± éƒ½æ˜¯ç”±ä¸€ç³»åˆ—çš„AutoreleasePoolPageç»„æˆçš„ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªAutoreleasePoolPageçš„å¤§å°éƒ½æ˜¯4096å­—èŠ‚(0x1000)</p><p>è‡ªåŠ¨é‡Šæ”¾æ± ä¸­çš„AutoreleasePoolPageæ˜¯ä»¥<strong>åŒå‘é“¾è¡¨</strong>çš„å½¢å¼é“¾æ¥èµ·æ¥çš„ï¼š</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/arc4.jpg" alt="image-20180420215336249"></p><p>parent å’Œ child å°±æ˜¯ç”¨æ¥æ„é€ åŒå‘é“¾è¡¨çš„æŒ‡é’ˆã€‚</p><h3 id="autoreleaseå’Œrunloopçš„å…³ç³»"><a href="#autoreleaseå’Œrunloopçš„å…³ç³»" class="headerlink" title="autoreleaseå’Œrunloopçš„å…³ç³»"></a>autoreleaseå’Œrunloopçš„å…³ç³»</h3><p>runloopå¼€å§‹å¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºautoreleasePoolï¼Œç»“æŸçš„æ—¶å€™ä¼šé”€æ¯autoreleasePool</p><h2 id="ARC"><a href="#ARC" class="headerlink" title="ARC"></a>ARC</h2><p>å¼•ç”¨è®¡æ•°å†…å­˜ç®¡ç†çš„æœ¬è´¨éƒ¨åˆ†åœ¨ARCä¸­å¹¶æ²¡æœ‰æ”¹å˜ã€‚ARCåªæ˜¯è‡ªåŠ¨å¸®æˆ‘ä»¬å¤„ç†â€œå¼•ç”¨è®¡æ•°â€çš„ç›¸å…³éƒ¨åˆ†ã€‚</p><h3 id="æ‰€æœ‰æƒä¿®é¥°ç¬¦"><a href="#æ‰€æœ‰æƒä¿®é¥°ç¬¦" class="headerlink" title="æ‰€æœ‰æƒä¿®é¥°ç¬¦"></a>æ‰€æœ‰æƒä¿®é¥°ç¬¦</h3><p>ARCæœ‰æ•ˆæ—¶ï¼Œidç±»å‹å’Œå¯¹è±¡ç±»å‹åŒCè¯­è¨€å…¶ä»–ç±»å‹ä¸åŒï¼Œå…¶ç±»å‹ä¸Šå¿…é¡»é™„åŠ æ‰€æœ‰æƒä¿®é¥°ç¬¦ã€‚æ‰€æœ‰æƒä¿®é¥°ç¬¦ä¸€å…±æœ‰4ä¸­ã€‚</p><ul><li><p>__strong</p><p>__strongä¿®é¥°ç¬¦æ˜¯idç±»å‹å’Œå¯¹è±¡ç±»å‹é»˜è®¤çš„æ‰€æœ‰æƒä¿®é¥°ç¬¦ã€‚__strongä¿®é¥°ç¬¦è¡¨ç¤ºå¯¹å¯¹è±¡çš„â€œå¼ºå¼•ç”¨â€ï¼ŒæŒæœ‰å¼ºå¼•ç”¨çš„å˜é‡åœ¨è¶…å‡ºå…¶ä½œç”¨åŸŸæ—¶è¢«åºŸå¼ƒï¼Œéšç€å¼ºå¼•ç”¨çš„å¤±æ•ˆï¼Œå¼•ç”¨çš„å¯¹è±¡ä¼šéšä¹‹é‡Šæ”¾ã€‚</p><p>__strongä¿®é¥°ç¬¦ä¿®é¥°çš„å˜é‡ï¼Œä¸ä»…ä»…åªåœ¨å˜é‡ä½œç”¨åŸŸä¸­ï¼Œåœ¨èµ‹å€¼ä¸Šä¹Ÿèƒ½å¤Ÿæ­£ç¡®åœ°ç®¡ç†å…¶å¯¹è±¡çš„æ‰€æœ‰è€…ã€‚</p><p>é€šè¿‡__strongä¿®é¥°ç¬¦ï¼Œä¸å¿…å†é”®å…¥retainæˆ–è€…releaseï¼Œå®Œç¾åœ°æ»¡è¶³äº†â€œå¼•ç”¨æŠ€æœ¯å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼â€</p></li><li><p>__weak</p><p>å¤šç”¨æ¥è§£å†³â€œå¾ªç¯å¼•ç”¨â€çš„é—®é¢˜ã€‚</p><p>__weakä¿®é¥°ç¬¦è¿˜æœ‰å¦å¤–ä¸€ä¸ªä¼˜ç‚¹ï¼Œåœ¨æŒæœ‰æŸå¯¹è±¡çš„å¼±å¼•ç”¨æ—¶ï¼Œè‹¥è¯¥å¯¹è±¡è¢«åºŸå¼ƒï¼Œåˆ™æ­¤å¼±å¼•ç”¨å°†è‡ªåŠ¨å¤±æ•ˆä¸”å¤„äºnilè¢«èµ‹å€¼çš„çŠ¶æ€ï¼ˆç©ºå¼±å¼•ç”¨ï¼‰ã€‚</p></li><li><p>__unsafe_unretained</p><p>__unsafe_unretainedä¿®é¥°ç¬¦æ­£å¦‚å…¶åunsafeæ‰€ç¤ºï¼Œæ˜¯ä¸å®‰å…¨çš„æ‰€æœ‰æƒä¿®é¥°ç¬¦ã€‚å°½ç®¡ARCå¼çš„å†…å­˜ç®¡ç†æ˜¯ç¼–è¯‘å™¨çš„å·¥ä½œï¼Œä½†é™„æœ‰ __unsafe_unretainedä¿®é¥°ç¬¦çš„å˜é‡ä¸å±äºç¼–è¯‘å™¨çš„å†…å­˜ç®¡ç†å¯¹è±¡ã€‚</p><p>å’Œ__weakä¸€æ ·éƒ½æ˜¯å¼±å¼•ç”¨ã€‚ä½†æ˜¯å½“å¼•ç”¨çš„å¯¹è±¡è¢«åºŸå¼ƒåï¼ŒæŒ‡é’ˆä¸ä¼šç½®ä¸ºnilï¼Œä¼šé€ æˆé‡æŒ‡é’ˆ</p></li><li><p>__autoreleasing</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* ARCæ— æ•ˆ */</span></span><br><span class="line"><span class="hljs-built_in">NSAutoreleasePool</span> *pool = [[<span class="hljs-built_in">NSAutoreleasePool</span> alloc] init];</span><br><span class="line"><span class="hljs-keyword">id</span> obj = [[<span class="hljs-built_in">NSObject</span> alloc] init];</span><br><span class="line">[obj autorelease];</span><br><span class="line">[pool drain];</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/* ARCæœ‰æ•ˆ ä¸ä¸Šé¢ä»£ç ç­‰ä»· */</span></span><br><span class="line"><span class="hljs-keyword">@autoreleasepool</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">id</span> __autoreleaseing obj = [[<span class="hljs-built_in">NSObject</span> alloc] init];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ARCæœ‰æ•ˆæ—¶ï¼ŒautoreleaseåŠŸèƒ½æ˜¯èµ·ä½œç”¨çš„ã€‚ç”¨@autorelasepoolå—æ›¿ä»£NSAutoreleasePoolç±»ï¼Œç”¨é™„æœ‰__autoreleasingä¿®é¥°ç¬¦çš„å˜é‡æ›¿ä»£autoreleaseæ–¹æ³•ã€‚</p><p>å¯¹è±¡èµ‹å€¼ç»™é™„æœ‰__autoreleaseä¿®é¥°ç¬¦çš„å˜é‡ç­‰ä»·äºåœ¨ARCæ— æ•ˆæ—¶è°ƒç”¨å¯¹è±¡çš„autoreleaseæ–¹æ³•ï¼Œå³å¯¹è±¡è¢«æ³¨å†Œåˆ°autoreleasepoolã€‚</p><p>æ˜¾ç¤ºåœ°é™„åŠ _<em>autoreleaseingä¿®é¥°ç¬¦åŒæ˜¾ç¤ºåœ°é™„åŠ \</em>_strongä¿®é¥°ç¬¦ä¸€æ ·ç½•è§ï¼Œæ‰€ä»¥åœ¨ARCä¸­ç»å¸¸éæ˜¾ç¤ºåœ°ä½¿ç”¨___autoreleasingä¿®é¥°ç¬¦ã€‚</p><p>éæ˜¾ç¤ºåœ°ä½¿ç”¨__autoreleaseingä¿®é¥°ç¬¦çš„åˆ—å­ï¼š</p><p>1)  </p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id __weak obj1 = obj0;</span><br><span class="line">NSLog(@&quot;class=%@&quot;,[obj1 class]);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä»£ç ä¸ä¸Šé¢çš„ç›¸åŒï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id __weak obj1 = obj0;</span><br><span class="line">id __autoreleasing tmp = obj1;</span><br><span class="line">NSLog(@&quot;class=%@&quot;,[tmp class]);</span><br></pre></td></tr></table></figure><p><strong>åœ¨è®¿é—®åˆ°weakä¿®é¥°ç¬¦çš„å˜é‡æ—¶å¿…é¡»è®¿é—®æ³¨å†Œåˆ°autoreleasepoolçš„å¯¹è±¡</strong>ã€‚è¿™æ˜¯å› ä¸ºweakä¿®é¥°ç¬¦åªæŒæœ‰å¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œè€Œåœ¨è®¿é—®å¼•ç”¨å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥å¯¹è±¡æœ‰å¯èƒ½è¢«åºŸå¼ƒã€‚å¦‚æœæŠŠè¦è®¿é—®çš„å¯¹è±¡æ³¨å†Œåˆ°autoreleasepoolä¸­ï¼Œé‚£ä¹ˆåœ¨@autoreleasepoolå—ç»“æŸä¹‹å‰éƒ½èƒ½ç¡®ä¿è¯¥å¯¹è±¡å­˜åœ¨ã€‚å› æ­¤ï¼Œä½¿ç”¨å¯Œæœ‰weakä¿®é¥°ç¬¦çš„å˜é‡æ—¶å°±å¿…å®šè¦ä½¿ç”¨æ³¨å†Œåˆ°autoreleasepoolä¸­çš„å¯¹è±¡ã€‚</p><p>2ï¼‰</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="hljs-keyword">id</span>)array &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> [<span class="hljs-built_in">NSMutableArray</span> new];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æºä»£ç ç­‰åŒäºï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="hljs-keyword">id</span>)array &#123;</span><br><span class="line">    <span class="hljs-keyword">id</span> obj = [<span class="hljs-built_in">NSMutableArray</span> new];</span><br><span class="line">    <span class="hljs-keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºreturnä½¿å¾—å¯¹è±¡å˜é‡è¶…å‡ºå…¶ä½œç”¨åŸŸï¼Œæ‰€ä»¥è¯¥å¼ºå¼•ç”¨å¯¹åº”çš„è‡ªå·±æŒæœ‰çš„å¯¹è±¡ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œä½†è¯¥å¯¹è±¡ä½œä¸ºè¿”å›å€¼ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†å…¶æ³¨å†Œåˆ°autoreleasePoolã€‚</p><p>3)</p><p>idçš„æŒ‡é’ˆæˆ–å¯¹è±¡çš„æŒ‡é’ˆåœ¨æ²¡æœ‰æ˜¾ç¤ºæŒ‡å®šæ—¶ä¼šè¢«é™„åŠ ä¸Š__autoreleasingä¿®é¥°ç¬¦</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSError *error = nil;</span><br><span class="line">Bool result = [obj performOperationWithError:&amp;error];</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„å£°æ˜ä¸ºï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)performOperationWithError:(NSError **)error;</span><br></pre></td></tr></table></figure><p>ç­‰åŒäºä¸€ä¸‹æºä»£ç ï¼š</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)performOperationWithError:(NSError * __autoreleasing*)error;</span><br></pre></td></tr></table></figure></li></ul><h3 id="è§„åˆ™"><a href="#è§„åˆ™" class="headerlink" title="è§„åˆ™"></a>è§„åˆ™</h3><ul><li><p>ä¸èƒ½ä½¿ç”¨retain/release/retainCount/autorelease</p></li><li><p>ä¸èƒ½ä½¿ç”¨NSAllocateObject/NSDeallocateObject</p></li><li><p>é¡»éµå®ˆå†…å­˜ç®¡ç†çš„æ–¹æ³•å‘½åè§„åˆ™</p></li><li><p>ä¸è¦æ˜¾ç¤ºè°ƒç”¨dealloc</p></li><li><p>ä½¿ç”¨@autoreleasepoolå—ä»£æ›¿NSAutoreleasePool</p></li><li><p>ä¸èƒ½ä½¿ç”¨åŒºåŸŸ(NSZone)</p><p>ä¸ç®¡ARCæ˜¯å¦æœ‰æ•ˆï¼ŒåŒºåŸŸåœ¨ç°åœ¨çš„è¿è¡Œæ—¶ç³»ç»Ÿä¸­å·²å•çº¯åœ°è¢«å¿½ç•¥</p></li><li><p>å¯¹è±¡å‹å˜é‡ä¸èƒ½ä½œä¸ºCè¯­è¨€ç»“æ„ä½“çš„æˆå‘˜</p><p>Cè¯­è¨€çš„è§„çº¦ä¸Šæ²¡æœ‰æ–¹æ³•æ¥ç®¡ç†ç»“æ„ä½“æˆå‘˜çš„ç”Ÿå‘½å‘¨æœŸã€‚å› ä¸ºARCæŠŠå†…å­˜ç®¡ç†çš„å·¥ä½œåˆ†é…ç»™ç¼–è¯‘å™¨ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å¿…é¡»èƒ½å¤ŸçŸ¥é“å¹¶ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ä¾‹å¦‚Cè¯­è¨€çš„è‡ªåŠ¨å˜é‡(å±€éƒ¨å˜é‡)å¯ä½¿ç”¨è¯¥å˜é‡çš„ä½œç”¨äºæ¥ç®¡ç†å¯¹è±¡ã€‚ä½†æ˜¯å¯¹äºCè¯­è¨€çš„ç»“æ„ä½“æˆå‘˜æ¥è¯´ï¼Œè¿™åœ¨æ ‡å‡†ä¸Šå°±æ˜¯ä¸å¯å®ç°çš„ã€‚</p><p>å¦‚æœéè¦æŠŠå¯¹è±¡å‹å˜é‡åŠ å…¥åˆ°ç»“æ„ä½“é‡æ—¶ï¼Œå¯å¼ºåˆ¶è½¬æ¢ä¸ºvoid *æˆ–æ˜¯é™„åŠ è§é¢æ‰€è¿°çš„__unsafe_unretainedä¿®é¥°ç¬¦ï¼ˆé™„æœ‰___unsafe_unretainedä¿®é¥°ç¬¦çš„å˜é‡ä¸å±äºç¼–è¯‘å™¨çš„å†…å­˜ç®¡ç†å¯¹è±¡ã€‚å¦‚æœç®¡ç†æ—¶ä¸æ³¨æ„èµ‹å€¼å¯¹è±¡çš„æ‰€æœ‰è€…ï¼Œä¾¿æœ‰å¯èƒ½é­é‡å†…å­˜æ³„æ¼æˆ–ç¨‹åºå´©æºƒï¼‰</p></li><li><p>æ˜¾ç¤ºè½¬æ¢idå’Œvoid *</p><p>é€šè¿‡_<em>bridgeï¼Œidå’Œvoidèƒ½å¤Ÿç›¸äº’è½¬æ¢ã€‚ä½†æ˜¯\</em>_bridgeè½¬æ¢ï¼Œå…¶å®‰å…¨æ€§ä¸èµ‹å€¼ç»™__unsafe_unretainedä¿®é¥°ç¬¦ç›¸è¿‘ï¼Œç”šè‡³ä¼šæ›´ä½ã€‚å¦‚æœç®¡ç†æ—¶ä¸æ³¨æ„èµ‹å€¼å¯¹è±¡çš„æ‰€æœ‰è€…ï¼Œå°±ä¼šå› æ‚¬å‚æŒ‡é’ˆè€Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p><p>__bridgeè½¬æ¢ä¸­è¿˜æœ‰å¦å¤–ä¸¤ç§è½¬æ¢ï¼Œåˆ†åˆ«æ˜¯__bridge_retainedè½¬æ¢å’Œ__bridge_transferè½¬æ¢</p></li></ul><p>## </p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å†…å­˜ç®¡ç†-å¼•ç”¨è®¡æ•°&quot;&gt;&lt;a href=&quot;#å†…å­˜ç®¡ç†-å¼•ç”¨è®¡æ•°&quot; class=&quot;headerlink&quot; title=&quot;å†…å­˜ç®¡ç†/å¼•ç”¨è®¡æ•°&quot;&gt;&lt;/a&gt;å†…å­˜ç®¡ç†/å¼•ç”¨è®¡æ•°&lt;/h2&gt;&lt;p&gt;Objective-Cçš„å†…å­˜ç®¡ç†æ–¹å¼ï¼šå¼•ç”¨è®¡æ•°&lt;/p&gt;
&lt;h3 id=&quot;å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼&quot;&gt;&lt;a href=&quot;#å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼&quot; class=&quot;headerlink&quot; title=&quot;å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼&quot;&gt;&lt;/a&gt;å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;å¯¹è±¡æ“ä½œ&lt;/th&gt;
&lt;th&gt;Objective-Cæ–¹æ³•&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡&lt;/td&gt;
&lt;td&gt;alloc/new/copy/mutableCopyç­‰æ–¹æ³•&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;æŒæœ‰å¯¹è±¡&lt;/td&gt;
&lt;td&gt;retainæ–¹æ³•&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;é‡Šæ”¾å¯¹è±¡&lt;/td&gt;
&lt;td&gt;releaseæ–¹æ³•&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;åºŸå¼ƒå¯¹è±¡&lt;/td&gt;
&lt;td&gt;deallocæ–¹æ³•&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;â€‹&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
    
      <category term="å†…å­˜ç®¡ç†" scheme="http://www.wuqihan.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Grand Central Dispatch</title>
    <link href="http://www.wuqihan.cn/2016/07/18/Grand-Central-Dispatch/"/>
    <id>http://www.wuqihan.cn/2016/07/18/Grand-Central-Dispatch/</id>
    <published>2016-07-18T07:21:44.000Z</published>
    <updated>2020-01-28T10:08:12.877Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><ul><li>ä»€ä¹ˆæ˜¯GCD<ul><li>å…¨ç¨‹ï¼šGrand Central Dispatchï¼ˆå¼ºå¤§çš„ä¸­æ¢è°ƒåº¦å™¨ï¼‰</li><li>çº¯Cè¯­è¨€ï¼Œæä¾›äº†éå¸¸å¼ºå¤§çš„å‡½æ•°</li></ul></li><li>GCDçš„ä¼˜åŠ¿<ul><li>GCDä¼šè‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„CPUå†…æ ¸</li><li>GCDä¼šè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºçº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€é”€æ¯çº¿ç¨‹ï¼‰</li><li>ç¨‹åºå‘˜åªéœ€è¦å‘Šè¯‰GCDæƒ³è¦æ‰§è¡Œä»€ä¹ˆä»»åŠ¡ï¼Œä¸éœ€è¦ç¼–å†™ä»»ä½•çº¿ç¨‹ç®¡ç†ä»£ç </li></ul></li></ul><a id="more"></a><h3 id="ä»»åŠ¡å’Œé˜Ÿåˆ—"><a href="#ä»»åŠ¡å’Œé˜Ÿåˆ—" class="headerlink" title="ä»»åŠ¡å’Œé˜Ÿåˆ—"></a>ä»»åŠ¡å’Œé˜Ÿåˆ—</h3><ul><li>GCDä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µ<ul><li>ä»»åŠ¡ï¼šæ‰§è¡Œä»€ä¹ˆæ“ä½œ</li><li>é˜Ÿåˆ—ï¼šç”¨æ¥å­˜æ”¾ä»»åŠ¡</li></ul></li><li>GCDçš„ä½¿ç”¨æœ‰ä¸¤ä¸ªæ­¥éª¤<ul><li>å®šåˆ¶ä»»åŠ¡</li><li>å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­<ul><li>GCDä¼šè‡ªåŠ¨å°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å–å‡ºæ¥ï¼Œæ”¾åˆ°å¯¹åº”çš„çº¿ç¨‹ä¸­æ‰§è¡Œ</li><li>ä»»åŠ¡çš„å–å‡ºéµå¾ªé˜Ÿåˆ—çš„FIFOï¼ˆç°é‡‘å…ˆå‡ºï¼‰åŸåˆ™</li></ul></li></ul></li></ul><h3 id="æ‰§è¡Œä»»åŠ¡"><a href="#æ‰§è¡Œä»»åŠ¡" class="headerlink" title="æ‰§è¡Œä»»åŠ¡"></a>æ‰§è¡Œä»»åŠ¡</h3><ul><li><p>GCDä¸­æœ‰ä¸¤ä¸ªç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„å¸¸ç”¨å‡½æ•°</p><ul><li><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     ç”¨åŒæ­¥çš„æ–¹å¼æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">     @param queue#&gt; é˜Ÿåˆ— description#&gt;</span></span><br><span class="line"><span class="hljs-comment">     @param void blockä»»åŠ¡</span></span><br><span class="line"><span class="hljs-comment">     @return</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-built_in">dispatch_sync</span>(&lt;<span class="hljs-meta">#dispatch_queue_t  _Nonnull queue#&gt;, <span class="hljs-meta-string">&lt;#^(void)block#&gt;</span>);</span></span><br></pre></td></tr></table></figure></li><li><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     ç”¨å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(&lt;<span class="hljs-meta">#dispatch_queue_t  _Nonnull queue#&gt;, <span class="hljs-meta-string">&lt;#^(void)block#&gt;</span>);</span></span><br></pre></td></tr></table></figure></li></ul><blockquote><p>è¿˜æœ‰ä¸ªç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„å‡½æ•°ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;     <span class="hljs-comment">//ç¬¬ä¸€ä¸ªå‚æ•°queue ä¸èƒ½æ˜¯å…¨å±€çš„å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line">&gt; <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">&gt; dispatch_barrier_asyncå‡½æ•°çš„ä½œç”¨ä¸barrierçš„æ„æ€ç›¸åŒ,åœ¨è¿›ç¨‹ç®¡ç†ä¸­èµ·åˆ°ä¸€ä¸ªæ …æ çš„ä½œç”¨,å®ƒç­‰å¾…æ‰€æœ‰ä½äºbarrierå‡½æ•°ä¹‹å‰çš„æ“ä½œæ‰§è¡Œå®Œæ¯•åæ‰§è¡Œ,å¹¶ä¸”åœ¨barrierå‡½æ•°æ‰§è¡Œä¹‹å,barrierå‡½æ•°ä¹‹åçš„æ“ä½œæ‰ä¼šå¾—åˆ°æ‰§è¡Œ,è¯¥å‡½æ•°éœ€è¦åŒdispatch_queue_createå‡½æ•°ç”Ÿæˆçš„concurrent Dispatch Queue  é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨</span></span><br><span class="line"><span class="hljs-comment">&gt; */</span></span><br><span class="line">&gt;     dispatch_barrier_async(&lt;<span class="hljs-meta">#dispatch_queue_t  _Nonnull queue#&gt;, <span class="hljs-meta-string">&lt;#^(void)block#&gt;</span>);</span></span><br><span class="line">&gt;     dispatch_barrier_sync(&lt;<span class="hljs-meta">#dispatch_queue_t  _Nonnull queue#&gt;, <span class="hljs-meta-string">&lt;#^(void)block#&gt;</span>);</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote></li><li><p>åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«</p><ul><li>åŒæ­¥ï¼šåªèƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›</li><li>å¼‚æ­¥ï¼šåªèƒ½åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå±€åˆ«å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›</li></ul><blockquote><p>åŒæ­¥ã€å¼‚æ­¥ã€å¹¶å‘ã€ä¸²è¡Œ è¦åˆ†æ¸…æ¥š</p><ul><li>åŒæ­¥å’Œå¼‚æ­¥ä¸»è¦å½±å“ï¼šèƒ½ä¸èƒ½å¼€å¯æ–°çš„çº¿ç¨‹<ul><li>åŒæ­¥ï¼šåªæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›</li><li>å¼‚æ­¥ï¼šå¯ä»¥åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›</li></ul></li><li>å¹¶å‘å’Œä¸²è¡Œä¸»è¦å½±å“ï¼šä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼<ul><li>å¹¶å‘ï¼šå…è®¸å¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œ</li><li>ä¸²è¡Œï¼šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</li></ul></li></ul></blockquote></li><li><p>dispatch_async å’Œ dispatch_sync è¿˜è¦ä¸€ä¸ªå¾ˆé‡è¦çš„åŒºåˆ«</p><ul><li><p>å¼‚æ­¥æ‰§è¡Œ ä¼šç«‹åˆ»è¿”å›</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//éªŒè¯å¼‚æ­¥æ‰§è¡Œä¼šç«‹åˆ»è¿”å›</span></span><br><span class="line">   <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;</span><br><span class="line">       <span class="hljs-comment">//å­çº¿ç¨‹</span></span><br><span class="line">       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSInteger</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;</span><br><span class="line">           <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"22222"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"33333"</span>);</span><br><span class="line">   <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">   å…ˆæ‰“å°33333</span></span><br><span class="line"><span class="hljs-comment">   æœ€åæ‰æ˜¯2222ã€‚ã€‚ã€‚</span></span><br><span class="line"><span class="hljs-comment">   */</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><ul><li><p>åŒæ­¥æ‰§è¡Œä¼šç­‰å¾…æ‰§è¡Œç»“æŸåæ‰è¿”å›</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//éªŒè¯åŒæ­¥æ‰§è¡Œä¼šç­‰å¾…æ‰§è¡Œç»“æŸåè¿”å›</span></span><br><span class="line">   <span class="hljs-built_in">dispatch_sync</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;</span><br><span class="line">       <span class="hljs-comment">//å› ä¸ºæ˜¯åŒæ­¥ã€‚ä¸ä¼šå¼€å¯çº¿ç¨‹ï¼Œæ‰€ä»¥ä»ç„¶æ˜¯mainçº¿ç¨‹</span></span><br><span class="line">       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSInteger</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;</span><br><span class="line">           <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"22222"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"33333"</span>);</span><br><span class="line">   <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">   å…ˆæ‰“å°å®Œæ‰€æœ‰22222</span></span><br><span class="line"><span class="hljs-comment">   æœ€åæ‰ä¼šæ‰“å°33333</span></span><br><span class="line"><span class="hljs-comment">   */</span></span><br></pre></td></tr></table></figure><p>æ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ åœ¨ä¸»çº¿ç¨‹åŒæ­¥è°ƒç”¨ä»»åŠ¡åœ¨mainQueueé‡Œï¼Œå°±ä¼šé€ æˆæ­»é”çš„æƒ…å†µã€‚å› ä¸ºï¼š<br>1ï¼‰:dispatch_syncåœ¨ç­‰å¾…blockè¯­å¥æ‰§è¡Œå®Œæˆï¼Œè€Œblockè¯­å¥éœ€è¦åœ¨ä¸»çº¿ç¨‹é‡Œæ‰§è¡Œï¼Œæ‰€ä»¥dispatch_syncå¦‚æœåœ¨ä¸»çº¿ç¨‹è°ƒç”¨å°±ä¼šé€ æˆæ­»é”<br>2ï¼‰:dispatch_syncæ˜¯åŒæ­¥çš„ï¼Œæœ¬èº«å°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œä¹Ÿå³ä¸»çº¿ç¨‹ã€‚è€Œåˆå¾€ä¸»çº¿ç¨‹é‡Œå¡è¿›å»ä¸€ä¸ªblockï¼Œæ‰€ä»¥å°±ä¼šå‘ç”Ÿæ­»é”ã€‚</p></li></ul><h3 id="åˆ›å»ºé˜Ÿåˆ—"><a href="#åˆ›å»ºé˜Ÿåˆ—" class="headerlink" title="åˆ›å»ºé˜Ÿåˆ—"></a>åˆ›å»ºé˜Ÿåˆ—</h3><h4 id="é˜Ÿåˆ—çš„ç±»å‹"><a href="#é˜Ÿåˆ—çš„ç±»å‹" class="headerlink" title="é˜Ÿåˆ—çš„ç±»å‹"></a>é˜Ÿåˆ—çš„ç±»å‹</h4><ul><li>GCDçš„é˜Ÿåˆ—å¯ä»¥åˆ†ä¸º2å¤§ç±»å‹<ul><li>å¹¶å‘é˜Ÿåˆ—<ul><li>å¯ä»¥è®©å¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼ˆè‡ªåŠ¨å¼€å¯å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼‰</li><li>å¹¶å‘åŠŸèƒ½åªæœ‰åœ¨å¼‚æ­¥ï¼ˆdispatch_asyncï¼‰å‡½æ•°ä¸‹æ‰æœ‰æ•ˆ</li></ul></li><li>ä¸²è¡Œé˜Ÿåˆ—<ul><li>è®©ä»»åŠ¡ä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°æ‰§è¡Œï¼ˆä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼‰</li></ul></li></ul></li></ul><h4 id="å¦‚ä½•åˆ›å»ºå¹¶å‘é˜Ÿåˆ—"><a href="#å¦‚ä½•åˆ›å»ºå¹¶å‘é˜Ÿåˆ—" class="headerlink" title="å¦‚ä½•åˆ›å»ºå¹¶å‘é˜Ÿåˆ—"></a>å¦‚ä½•åˆ›å»ºå¹¶å‘é˜Ÿåˆ—</h4><p>ç¬¬ä¸€ç§æ–¹æ³•ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_create(<span class="hljs-string">"com.a"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§æ–¹æ³•ï¼šä½¿ç”¨ç³»ç»Ÿæä¾›çš„ Global Dispatch Queue</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<span class="hljs-comment">//ç¬¬ä¸€ä¸ªè®¾ç½®ä¼˜å…ˆçº§ï¼Œä»…ä»…æ˜¯å¤§è‡´ä¼˜å…ˆçº§ã€‚ç¬¬äºŒä¸ªæš‚æ—¶æ²¡ç”¨</span></span><br></pre></td></tr></table></figure><h4 id="å¦‚ä½•åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—"><a href="#å¦‚ä½•åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="å¦‚ä½•åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—"></a>å¦‚ä½•åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—</h4><p>ç¬¬ä¸€ç§æ–¹æ³•ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_create(<span class="hljs-string">"com.b"</span>, <span class="hljs-literal">NULL</span>);</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šã€ŠiOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹ä¸­è®²åˆ° ä½¿ç”¨dispatch_queue_create()åˆ›å»ºçš„DispatchQueueåœ¨ARCä¸­ä¹Ÿéœ€è¦æ‰‹åŠ¨è°ƒç”¨dispatch_releaseï¼ˆï¼‰æ–¹æ³•é‡Šæ”¾ã€‚ç»è¿‡éªŒè¯ï¼ŒiOS6ä»¥åçš„ARCä¸­å°±ä¸éœ€è¦äº†ã€‚</p></blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„ä½¿ç”¨Serial Disparch Queueæ—¶ï¼Œå…¶ç”Ÿæˆä¸ªæ•°çš„é—®é¢˜ï¼ŒConcurrent Dispatch Queueèƒ½å¤Ÿå¹¶è¡Œæ‰§è¡Œå¤šä¸ªè¿½åŠ å¤„ç†ï¼ˆä¹Ÿå°±æ˜¯ä¼šå¼€å¯å¤šæ¡çº¿ç¨‹å»å¤„ç†è¿½åŠ åˆ°é˜Ÿåˆ—ä¸­çš„çš„å¤šä¸ªä»»åŠ¡ï¼‰ï¼Œè€ŒSerial Dispatch QueueåŒæ—¶åªèƒ½æ‰§è¡Œä¸€ä¸ªè¿½åŠ å¤„ç†ï¼ˆä¹Ÿå°±æ˜¯åªèƒ½å¼€å¯ä¸€æ¡çº¿ç¨‹ï¼‰ã€‚</p><p>ä½†æ˜¯å½“é€šè¿‡dispatch_queue_create()ç”Ÿæˆå¤šä¸ªSerial Dispatch Queueæ—¶ï¼Œå„ä¸ªSerial Dispatch Queueå°†å¹¶è¡Œæ‰§è¡Œï¼ˆ<strong>å‰ææ˜¯ä½¿ç”¨å¼‚æ­¥æ–¹å¼</strong>ï¼‰ã€‚è™½ç„¶åœ¨ä¸€ä¸ªSerial Dispatch Queueä¸­åŒæ—¶åªèƒ½æ‰§è¡Œä¸€ä¸ªè¿½åŠ å¤„ç†ï¼Œä½†å¦‚æœå°†å¤„ç†åˆ†åˆ«è¿½åŠ åˆ°4ä¸ªSerial Dispatch Queueä¸­ï¼Œå„ä¸ªSerial Dispatch Queueæ‰§è¡Œä¸€ä¸ªï¼Œå³ä¸ºå¹¶è¡Œæ‰§è¡Œ4ä¸ªå¤„ç†ã€‚â‰ˆ å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/gcd1.png" alt="å¤šä¸ªSerial Dispatch Queue"></p><p>å¦‚æœç”Ÿæˆ2000ä¸ªSerial Dispatch Queueï¼Œé‚£ä¹ˆå°±ç”Ÿæˆ2000ä¸ªçº¿ç¨‹ï¼Œå¦‚æœè¿‡å¤šä½¿ç”¨ï¼Œå°±ä¼šæ¶ˆè€—å¤§é‡å†…å­˜ï¼Œå¼•èµ·å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¤§å¹…åº¦é™ä½ç³»ç»Ÿçš„æ€§èƒ½ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•ï¼šç›´æ¥ä½¿ç”¨ä¸»é˜Ÿåˆ—ï¼ˆä¸»é˜Ÿåˆ—æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼‰</p><h3 id="GCDçš„å…¶ä»–å‡½æ•°"><a href="#GCDçš„å…¶ä»–å‡½æ•°" class="headerlink" title="GCDçš„å…¶ä»–å‡½æ•°"></a>GCDçš„å…¶ä»–å‡½æ•°</h3><h4 id="dispatch-set-target-queue"><a href="#dispatch-set-target-queue" class="headerlink" title="dispatch_set_target_queue"></a>dispatch_set_target_queue</h4><ol><li><p>å˜æ›´Dispatch Queueçš„æ‰§è¡Œä¼˜å…ˆçº§ã€‚<br>dispatch_queue_createå‡½æ•°ç”Ÿæˆçš„Dispatch Queueä¸ç®¡æ˜¯Serial Dispatch Queueè¿˜æ˜¯Concurrent Dispatch Queueï¼Œéƒ½ä½¿ç”¨ä¸é»˜è®¤ä¼˜å…ˆçº§Global Dispatch Queueç›¸åŒæ‰§è¡Œä¼˜å…ˆçº§çš„çº¿ç¨‹ã€‚</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> dispatch_queue_t serialQueue = dispatch_queue_create(&quot;com.oukavip.www&quot;,NULL);</span><br><span class="line">    dispatch_queue_t globalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND,0);</span><br><span class="line">   dispatch_set_target_queue(serialQueue, globalQueue);</span><br><span class="line">   // ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¦è®¾ç½®ä¼˜å…ˆçº§çš„queue,ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‚ç…§ç‰©ï¼Œæ—¢å°†ç¬¬ä¸€ä¸ªqueueçš„ä¼˜å…ˆçº§å’Œç¬¬äºŒä¸ªqueueçš„ä¼˜å…ˆçº§è®¾ç½®ä¸€æ ·ã€‚</span><br><span class="line">//ç¬¬ä¸€ä¸ªå‚æ•°å¦‚æœæŒ‡å®šç³»ç»Ÿæä¾›çš„Main/Global Dispatch Queueåˆ™ä¸çŸ¥é“ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼Œå› æ­¤è¿™äº›å‡ä¸å¯ä»¥æŒ‡å®šã€‚</span><br></pre></td></tr></table></figure></li><li><p>å°†Dispatch QueueæŒ‡å®šä¸ºdispatch_set_target_queueå‡½æ•°çš„å‚æ•°è¿˜å¯ä»¥ä½œæˆDispatch Queueçš„æ‰§è¡Œé˜¶å±‚ï¼Œé‚£ä¹ˆåŸæœ¬åº”å¹¶è¡Œæ‰§è¡Œçš„å¤šä¸ªSerial Dispatch Queueï¼Œåœ¨ç›®æ ‡Serial Dispatch Queueä¸Šåªèƒ½åŒæ—¶æ‰§è¡Œä¸€ä¸ªå¤„ç†ã€‚ï¼ˆä¿®æ”¹ç”¨æˆ·é˜Ÿåˆ—çš„ç›®æ ‡é˜Ÿåˆ—ï¼Œä½¿å¤šä¸ªQueueåœ¨ç›®æ ‡Queueä¸Šä¸€æ¬¡åªæœ‰ä¸€ä¸ªæ‰§è¡Œï¼‰</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_queue_t</span> targetQueue = dispatch_queue_create(<span class="hljs-string">"targetQueue"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="hljs-string">"queue1"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="hljs-built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="hljs-string">"queue1"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//è®¾ç½®å‚è€ƒ</span></span><br><span class="line">    dispatch_set_target_queue(queue1, targetQueue);</span><br><span class="line">    dispatch_set_target_queue(queue2, targetQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"job3 in"</span>);</span><br><span class="line">        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">2.</span>f];</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"job3 out"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"job2 in"</span>);</span><br><span class="line">        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">1.</span>f];</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"job2 out"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"job1 in"</span>);</span><br><span class="line">        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">3.</span>f];</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"job1 out"</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>æ‰“å°è¾“å‡ºä¸ºï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">48.144492</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">3693</span>:<span class="hljs-number">336603</span>] job3 in</span><br><span class="line"><span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">50.148901</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">3693</span>:<span class="hljs-number">336603</span>] job3 out</span><br><span class="line"><span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">50.149213</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">3693</span>:<span class="hljs-number">336603</span>] job2 in</span><br><span class="line"><span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">51.153663</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">3693</span>:<span class="hljs-number">336603</span>] job2 out</span><br><span class="line"><span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">51.154019</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">3693</span>:<span class="hljs-number">336603</span>] job1 in</span><br><span class="line"><span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">54.157262</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">3693</span>:<span class="hljs-number">336603</span>] job1 out</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ‰“å°çš„ç»“æœè¯´æ˜æˆ‘ä»¬è®¾ç½®äº†queue1å’Œqueue2é˜Ÿåˆ—ä»¥targetQueueé˜Ÿåˆ—ä¸ºå‚ç…§å¯¹è±¡ï¼Œé‚£ä¹ˆqueue1å’Œqueue2ä¸­çš„ä»»åŠ¡å°†æŒ‰ç…§targetQueueçš„é˜Ÿåˆ—å¤„ç†ã€‚</p><p>åœ¨å¿…é¡»å°†ä¸å¯å¹¶è¡Œæ‰§è¡Œçš„å¤„ç†è¿½åŠ åˆ°å¤šä¸ªSerial Dispatch Queueä¸­æ—¶ï¼Œå¦‚æœä½¿ç”¨dispatch_set_target_queueå‡½æ•°å°†ç›®æ ‡åˆ¶å®šä¸ºæŸä¸€ä¸ªSerial Dispatch Queueï¼Œå³å¯é˜²æ­¢å¤„ç†å¹¶è¡Œæ‰§è¡Œã€‚</p><p>é€‚ç”¨åœºæ™¯ï¼šä¸€èˆ¬éƒ½æ˜¯æŠŠä¸€ä¸ªä»»åŠ¡æ”¾åˆ°ä¸€ä¸ªä¸²è¡Œçš„queueä¸­ï¼Œå¦‚æœè¿™ä¸ªä»»åŠ¡è¢«æ‹†åˆ†äº†ï¼Œè¢«æ”¾ç½®åˆ°å¤šä¸ªä¸²è¡Œçš„queueä¸­ï¼Œä½†å®é™…è¿˜æ˜¯éœ€è¦è¿™ä¸ªä»»åŠ¡åŒæ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºå¤šä¸ªä¸²è¡Œqueueä¹‹é—´æ˜¯å¹¶è¡Œçš„ã€‚è¿™æ—¶å€™dispatch_set_target_queueå°†èµ·åˆ°ä½œç”¨ã€‚</p></li></ol><h4 id="dispatch-after"><a href="#dispatch-after" class="headerlink" title="dispatch_after"></a>dispatch_after</h4><p>æƒ³åœ¨æŒ‡å®šæ—¶é—´åæ‰§è¡Œå¤„ç†ï¼Œå¯ä½¿ç”¨dispatch_afterå‡½æ•°æ¥å®ç°ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//åœ¨3ç§’åå°†æŒ‡å®šçš„blockè¿½åŠ åˆ°Main Dispatch Queueä¸­</span></span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number">3</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"waited at last three seconds."</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>dispatch_afterå‡½æ•°å¹¶ä¸æ˜¯åœ¨æŒ‡å®šæ—¶é—´åæ‰§è¡Œå¤„ç†ï¼Œè€Œåªæ˜¯åœ¨æŒ‡å®šæ—¶é—´è¿½åŠ å¤„ç†åˆ°Dispatch Queueã€‚æ­¤æºä»£ç ä¸åœ¨3ç§’åç”¨dispatch_asyncå‡½æ•°è¿½åŠ blockåˆ°Main Dispatch Queueç›¸åŒã€‚</p><p>å› ä¸ºMain Dispatch Queueåœ¨ä¸»çº¿ç¨‹çš„RunLoopä¸­æ‰§è¡Œï¼Œæ‰€ä»¥åœ¨æ¯”å¦‚æ¯éš”1/60ç§’æ‰§è¡Œçš„RunLoopä¸­ï¼Œblockæœ€å¿«åœ¨3ç§’åæ‰§è¡Œï¼Œæœ€æ…¢åœ¨3+1/60ç§’åæ‰§è¡Œã€‚å¹¶ä¸”Main Dispatch Queueæœ‰å¤§é‡å¤„ç†è¿½åŠ æˆ–ä¸»çº¿ç¨‹çš„å¤„ç†æœ¬èº«æœ‰å»¶è¿Ÿæ—¶ï¼Œè¿™ä¸ªæ—¶é—´ä¼šæ›´é•¿ã€‚å¦‚æœæƒ³åœ¨å¤§è‡´å»¶è¿Ÿæ—¶é—´æ‰§è¡Œå¤„ç†ï¼Œè¯¥å‡½æ•°æ˜¯éå¸¸æœ‰æ•ˆçš„ã€‚</p><h4 id="disparch-group-t"><a href="#disparch-group-t" class="headerlink" title="disparch_group_t"></a>disparch_group_t</h4><p>æ— è®ºå‘ä»€ä¹ˆæ ·çš„Dispatch Queueä¸­è¿½åŠ å¤„ç†ï¼Œä½¿ç”¨Dispatch Groupéƒ½å¯ä»¥ç›‘è§†è¿™äº›å¤„ç†æ‰§è¡Œçš„ç»“æŸã€‚ä¸€æ—¦æ£€æµ‹åˆ°æ‰€æœ‰å¤„ç†æ‰§è¡Œç»“æŸï¼Œå°±å¯å°†ç»“æŸçš„å¤„ç†è¿½åŠ åˆ°Dispatch Queueä¸­ã€‚è¿™å°±æ˜¯ä½¿ç”¨Dispatch Groupçš„åŸå› ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>);</span><br><span class="line">   dispatch_group_t group = dispatch_group_create();</span><br><span class="line">   </span><br><span class="line">   dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"blk0"</span>);</span><br><span class="line">   &#125;);</span><br><span class="line">   dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"blk1"</span>);</span><br><span class="line">   &#125;);</span><br><span class="line">   dispatch_group_async(group, dispatch_queue_create(<span class="hljs-string">"com.wuqh.queue"</span>, <span class="hljs-literal">NULL</span>), ^&#123;</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"blk2"</span>);</span><br><span class="line">       [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">5</span>];</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"blk2done"</span>);</span><br><span class="line">   &#125;);</span><br><span class="line">   </span><br><span class="line">   dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"done"</span>);</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œåœ¨Dispatch Gourpä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨dispatch_group_waitå‡½æ•°ä»…ç­‰å¾…å…¨éƒ¨å¤„ç†æ‰§è¡Œç»“æŸã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>);</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"blk0"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"blk1"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_async(group, dispatch_queue_create(<span class="hljs-string">"com.wuqh.queue"</span>, <span class="hljs-literal">NULL</span>), ^&#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"blk2"</span>);</span><br><span class="line">        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">5</span>];</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"blk2done"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="hljs-comment">//ç¨‹åºä¼šä¸€ç›´åœç•™åœ¨æ­¤å¤„ç­‰å¾…gourpä¸­çš„ä»»åŠ¡ï¼Œç›´åˆ°å…¨éƒ¨æ‰§è¡Œå®Œæ¯•æ‰ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="hljs-comment">//ä¹Ÿå°±æ˜¯è¯´ï¼Œæ„å‘³ç€ä¸€æ—¦è°ƒç”¨dispatch_group_waitå‡½æ•°ï¼Œè¯¥å‡½æ•°å°±å¤„äºè°ƒç”¨çš„çŠ¶æ€è€Œä¸è¿”å›ã€‚å³æ‰§è¡Œdispatch</span></span><br><span class="line"><span class="hljs-comment">//_group_waitå‡½æ•°çš„çº¿ç¨‹åœæ­¢ã€‚åœ¨ç»è¿‡dispatch_group_waitå‡½æ•°ä¸­æŒ‡å®šæ—¶é—´æˆ–ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œç»“æŸä¹‹å‰</span></span><br><span class="line"><span class="hljs-comment">//æ‰§è¡Œè¯¥å‡½æ•°çš„çº¿ç¨‹åœæ­¢</span></span><br><span class="line">    dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æŒ‡å®šç­‰å¾…æ—¶é—´ã€‚disparch_group_waitï¼Œæœ‰ä¸€ä¸ªlongç±»å‹çš„è¿”å›å€¼ï¼Œè¿”å›å€¼ä¸º0ï¼Œè¡¨ç¤ºå…¨éƒ¨æ‰§è¡Œç»“æŸï¼Œè¿”å›å€¼ä¸ä¸º0ï¼Œè¡¨ç¤ºè™½ç„¶ç»è¿‡äº†æŒ‡å®šæ—¶é—´ï¼Œä½†è¿˜æœ‰æŸäº›å¤„ç†æ²¡æœ‰æ‰§è¡Œå®Œã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">long</span> result = dispatch_group_wait(group, dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number">3</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>)));</span><br><span class="line">    <span class="hljs-keyword">if</span> (result &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"æ²¡æœ‰å…¨éƒ¨æ‰§è¡Œç»“æŸæ‰§è¡Œç»“æŸ"</span>);</span><br><span class="line">    &#125;<span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"å…¨éƒ¨æ‰§è¡Œç»“æŸ"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æŒ‡å®štimeä¸ºDISPATCH_TIME_NOWï¼Œåˆ™ä¸ç”¨ä»»ä½•ç­‰å¾…å³å¯åˆ¤å®šå±äºDispatch Groupçš„å¤„ç†æ˜¯å¦æ‰§è¡Œç»“æŸã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">long</span> result = dispatch_group_wait(group, DISPATCH_TIME_NOW);</span><br></pre></td></tr></table></figure><h4 id="dispatch-a-sync"><a href="#dispatch-a-sync" class="headerlink" title="dispatch_(a)sync"></a>dispatch_(a)sync</h4><p>dispatch_asyncå‡½æ•°çš„â€asyncâ€œæ„å‘³ç€â€œéåŒæ­¥â€ï¼Œå°±æ˜¯å°†æŒ‡å®šçš„blockâ€éåŒæ­¥â€åœ°è¿½åŠ åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ã€‚dispatch_asyncå‡½æ•°ä¸ä½œä»»ä½•ç­‰å¾…ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/gcd2.jpg" alt="mage-20180315162245"></p><p>dispatch_syncæ„å‘³ç€â€œåŒæ­¥â€ã€‚å‡½æ•°ä¼šä¸€ç›´ç­‰å¾…æ‰§è¡Œç»“æŸï¼Œâ€œç­‰å¾…â€æ„å‘³ç€å½“å‰çº¿ç¨‹åœæ­¢ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://coding.net/u/wqh_iOS/p/tuchuang/git/raw/master/2018/gcd3.jpg" alt="mage-20180315162057"></p><p>æ³¨æ„ï¼šdispatch_syncå‡½æ•°å®¹æ˜“å¼•èµ·é—®é¢˜ï¼Œå³æ­»é”ã€‚ä¾‹å¦‚åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä»¥ä¸‹æºä»£ç å°±ä¼šæ­»é”ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="hljs-comment">//ã€‚ã€‚ã€‚</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨asyncï¼Œæˆ–è€…Serail Dispatch Queueéƒ½ä¼šé‡åˆ°æ­»é”ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"..."</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"com.gcd.error"</span>, <span class="hljs-literal">NULL</span>);</span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"..."</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="dispatchbarrier-a-sync"><a href="#dispatchbarrier-a-sync" class="headerlink" title="dispatchbarrier(a)sync"></a>dispatch<em>barrier</em>(a)sync</h4><p>åœ¨è¿›ç¨‹ç®¡ç†ä¸­èµ·åˆ°ä¸€ä¸ªæ …æ çš„ä½œç”¨ï¼Œå®ƒç­‰å¾…æ‰€æœ‰ä½äºbarrierå‡½æ•°ä¹‹å‰çš„æ“ä½œæ‰§è¡Œå®Œæ¯•åæ‰§è¡Œï¼Œå¹¶ä¸”åœ¨barrierå‡½æ•°æ‰§è¡Œä¹‹åï¼Œbarrierå‡½æ•°ä¹‹åçš„æ“ä½œæ‰ä¼šå¾—åˆ°æ‰§è¡Œï¼Œè¯¥å‡½æ•°éœ€è¦åŒdispatch_queue_createå‡½æ•°ç”Ÿæˆçš„Concureent Dispatch Queueé˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨ã€‚<strong>æ³¨æ„ï¼šä¸ä½¿ç”¨dispatch_get_global_queue()è·å¾—çš„é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨æ— æ•ˆ</strong>ã€‚</p><p>ä½œç”¨ï¼š</p><ul><li>å®ç°é«˜æ•ˆç‡çš„æ•°æ®åº“è®¿é—®å’Œæ–‡ä»¶è®¿é—®</li><li>é¿å…æ•°æ®ç«äº‰</li></ul><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"com.gcd"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">20</span>; i++) &#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"----1----%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">20</span>; i++) &#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"----2----%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">20</span>; i++) &#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"----barrier----%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">20</span>; i++) &#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"----3----%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">20</span>; i++) &#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"----4----%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="hljs-comment">//å…ˆæ‰§è¡Œ1å’Œ2ï¼Œä¹‹åæ˜¯barrierï¼Œæœ€åæ˜¯3å’Œ4</span></span><br></pre></td></tr></table></figure><p>åŒdispath_asyncä¸€æ ·ï¼Œæ­¤å‡½æ•°ä¹Ÿæœ‰ä¸€ä¸ªè¿™æ ·çš„å‡½æ•°ï¼šdispatch_barrier_syncå‡½æ•°ï¼Œæ­¤å‡½æ•°ä¸dispatch_barrier_asyncçš„åŒºåˆ«å’Œ dispatch_asyncä¸dispatch_syncçš„åŒºåˆ«ç›¸åŒï¼šasyncä¸é˜»å¡å½“å‰çº¿ç¨‹ã€‚</p><h4 id="dispatch-apply"><a href="#dispatch-apply" class="headerlink" title="dispatch_apply"></a>dispatch_apply</h4><p> dispatch_applyå‡½æ•°æ—¶dispatch_syncå‡½æ•°å’ŒDispatch Groupçš„å…³è”APIã€‚è¯¥å‡½æ•°æŒ‰æŒ‡å®šçš„æ¬¡æ•°å°†æŒ‡å®šçš„blockè¿½åŠ åˆ°æŒ‡å®šçš„Dispatch Queueä¸­ï¼Œå¹¶ç­‰å¾…å…¨éƒ¨å¤„ç†æ‰§è¡Œç»“æŸã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">NSArray</span> *array = [<span class="hljs-built_in">NSArray</span> arrayWithObjects:@<span class="hljs-number">0</span>,@<span class="hljs-number">1</span>,@<span class="hljs-number">2</span>,@<span class="hljs-number">3</span>,@<span class="hljs-number">4</span>,@<span class="hljs-number">5</span>,@<span class="hljs-number">6</span>,@<span class="hljs-number">7</span>,@<span class="hljs-number">8</span>,@<span class="hljs-number">9</span>, <span class="hljs-literal">nil</span>];</span><br><span class="line">dispatch_apply([array count], dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^(size_t index) &#123;</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"async:%@-%@"</span>,array[index],[<span class="hljs-built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"done"</span>);<span class="hljs-comment">//åŒsyncä¸€æ ·ã€‚æœ€åæ‰ä¼šæ‰“å°doneã€‚</span></span><br></pre></td></tr></table></figure><p>ç”±äºdispatch_applyå‡½æ•°ä¼šç­‰å¾…æ‰§è¡Œç»“æŸï¼Œå› æ­¤æœ‰æ—¶å€™ä¹Ÿå¯ä»¥åœ¨dispatch_asyncå‡½æ•°ä¸­éåŒæ­¥åœ°æ‰§è¡Œdispatch_applyå‡½æ•°ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;</span><br><span class="line">        dispatch_apply([array count],  dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^(size_t index) &#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"async:%@-%@"</span>,array[index],[<span class="hljs-built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"success"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"done"</span>);<span class="hljs-comment">//å› ä¸ºasyncä¸éœ€è¦ç­‰å¾…ï¼Œæ‰€ä»¥ä¼šç«‹é©¬æ‰§è¡Œï¼Œä¸ä¼šæœ€åæ‰æ‰“å°ã€‚</span></span><br></pre></td></tr></table></figure><h4 id="dispatch-suspend-dispatch-resume"><a href="#dispatch-suspend-dispatch-resume" class="headerlink" title="dispatch_suspend/dispatch_resume"></a>dispatch_suspend/dispatch_resume</h4><p>å½“è¿½åŠ å¤§é‡å¤„ç†åˆ°Dispatch Queueæ—¶ï¼Œåœ¨è¿½åŠ å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å¸Œæœ›ä¸æ‰§è¡Œå·²è¿½åŠ çš„å¤„ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªè¦æŒ‚èµ·Dispatch Queueå³å¯ï¼Œå½“å¯ä»¥æ‰§è¡Œæ—¶å†æ¢å¤ã€‚</p><p>æ³¨æ„ï¼šdispatch_suspend/dispatch_resumeå¯¹å…¨å±€é˜Ÿåˆ—ä¸èµ·ä½œç”¨ã€‚</p><p>å¿…é¡»ç¡®ä¿dispatch_suspend/dispatch_resumeæˆå¯¹è°ƒç”¨ã€‚é‚£ä¹ˆè¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Ÿ<strong>gcdä¸­å¦‚ä½•ä¸­é€”ç»“æŸçº¿ç¨‹ï¼Ÿ</strong></p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"com.test.gcd"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="hljs-comment">//æäº¤ç¬¬ä¸€ä¸ªblockï¼Œå»¶æ—¶5ç§’æ‰“å°ã€‚</span></span><br><span class="line"><span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    sleep(<span class="hljs-number">5</span>);</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"After 5 seconds..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="hljs-comment">//æäº¤ç¬¬äºŒä¸ªblockï¼Œä¹Ÿæ˜¯å»¶æ—¶5ç§’æ‰“å°</span></span><br><span class="line"><span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    sleep(<span class="hljs-number">5</span>);</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"After 5 seconds again..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="hljs-comment">//å»¶æ—¶ä¸€ç§’</span></span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"sleep 1 second..."</span>);</span><br><span class="line">sleep(<span class="hljs-number">1</span>);</span><br><span class="line"><span class="hljs-comment">//æŒ‚èµ·é˜Ÿåˆ—</span></span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"suspend..."</span>);</span><br><span class="line">dispatch_suspend(queue);</span><br><span class="line"><span class="hljs-comment">//å»¶æ—¶10ç§’</span></span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"sleep 10 second..."</span>);</span><br><span class="line">sleep(<span class="hljs-number">10</span>);</span><br><span class="line"><span class="hljs-comment">//æ¢å¤é˜Ÿåˆ—</span></span><br><span class="line"><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"resume..."</span>);</span><br><span class="line">dispatch_resume(queue);</span><br></pre></td></tr></table></figure><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-08</span><span class="hljs-number">-18</span> <span class="hljs-number">17</span>:<span class="hljs-number">52</span>:<span class="hljs-number">41.261398</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">5222</span>:<span class="hljs-number">795121</span>] sleep <span class="hljs-number">1</span> second...</span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-08</span><span class="hljs-number">-18</span> <span class="hljs-number">17</span>:<span class="hljs-number">52</span>:<span class="hljs-number">42.262096</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">5222</span>:<span class="hljs-number">795121</span>] suspend...</span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-08</span><span class="hljs-number">-18</span> <span class="hljs-number">17</span>:<span class="hljs-number">52</span>:<span class="hljs-number">42.262496</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">5222</span>:<span class="hljs-number">795121</span>] sleep <span class="hljs-number">10</span> second...</span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-08</span><span class="hljs-number">-18</span> <span class="hljs-number">17</span>:<span class="hljs-number">52</span>:<span class="hljs-number">46.263456</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">5222</span>:<span class="hljs-number">795188</span>] After <span class="hljs-number">5</span> seconds...</span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-08</span><span class="hljs-number">-18</span> <span class="hljs-number">17</span>:<span class="hljs-number">52</span>:<span class="hljs-number">52.263457</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">5222</span>:<span class="hljs-number">795121</span>] resume...</span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-08</span><span class="hljs-number">-18</span> <span class="hljs-number">17</span>:<span class="hljs-number">52</span>:<span class="hljs-number">57.264210</span>+<span class="hljs-number">0800</span> GCD[<span class="hljs-number">5222</span>:<span class="hljs-number">795191</span>] After <span class="hljs-number">5</span> seconds again...</span><br></pre></td></tr></table></figure><p>åœ¨dispatch_suspendæŒ‚èµ·é˜Ÿåˆ—åï¼Œç¬¬ä¸€ä¸ªblockè¿˜æ˜¯åœ¨è¿è¡Œï¼Œå¹¶ä¸”æ­£å¸¸è¾“å‡ºã€‚</p><p>dispatch_suspendå¹¶ä¸ä¼šç«‹å³æš‚åœæ­£åœ¨è¿è¡Œçš„blockï¼Œè€Œæ˜¯åœ¨å½“å‰blockæ‰§è¡Œå®Œæˆåï¼Œæš‚åœåç»­çš„blockæ‰§è¡Œã€‚</p><h4 id="Dispatch-Semaphore"><a href="#Dispatch-Semaphore" class="headerlink" title="Dispatch Semaphore"></a>Dispatch Semaphore</h4><p>dispatch_semaphoreåªæœ‰3ä¸ªæ–¹æ³•ï¼š</p><ul><li><p>dispatch_semaphore_create </p><p>æ‰§è¡Œdispatch_semaphore_createä¼šæ ¹æ®ä¼ å…¥çš„longç±»å‹å‚æ•°åˆ›å»ºå¯¹åº”æ•°ç›®çš„ä¿¡å·é‡</p></li><li><p>dispatch_semaphore_signal </p><p>æ‰§è¡Œdispatch_semaphore_singalä¼šå¢åŠ ä¸€ä¸ªä¿¡å·é‡</p></li><li><p>dispatch_semaphore_wait //ç­‰å¾…ä¿¡å·é‡</p><p>æ‰§è¡Œdispatch_semaphore_waitå¦‚æœä¿¡å·é‡æ˜¯0ï¼Œå°±ä¼šæ ¹æ®ä¼ å…¥çš„ç­‰å¾…æ—¶é—´æ¥ç­‰å¾…ï¼Œå¦‚æœå¤§äº0åˆ™ä¸ä¼šç­‰å¾…ï¼Œå¹¶ä¸”ä¼šå‡å»ä¸€ä¸ªä¿¡å·é‡</p></li></ul><p>ä½œç”¨ï¼š</p><ul><li><p>å¯ä»¥æ§åˆ¶ä¸€ä¸ªèµ„æºæœ€å¤šç”±å¤šå°‘ä¸ªçº¿ç¨‹æ¥è®¿é—®ã€‚</p><p>å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œç”±äºè®¾å®šçš„ä¿¡å·å€¼ä¸º2ï¼Œå…ˆæ‰§è¡Œä¸¤ä¸ªçº¿ç¨‹ï¼Œç­‰æ‰§è¡Œå®Œå…¶ä¸­ä¸€ä¸ªï¼Œç¬¬ä¸‰ä¸ªæ‰ä¼šç»§ç»­æ‰§è¡Œã€‚ä¿è¯åŒä¸€æ—¶é—´æ‰§è¡Œçš„çº¿ç¨‹æ•°ä¸è¶…è¿‡2ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//crateçš„valueè¡¨ç¤ºï¼Œæœ€å¤šå‡ ä¸ªèµ„æºå¯è®¿é—®</span></span><br><span class="line">   dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="hljs-number">2</span>);</span><br><span class="line">   <span class="hljs-built_in">dispatch_queue_t</span> quene = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>);</span><br><span class="line">   </span><br><span class="line">   <span class="hljs-comment">//ä»»åŠ¡1</span></span><br><span class="line">   <span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;</span><br><span class="line">       dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"run task 1"</span>);</span><br><span class="line">       sleep(<span class="hljs-number">1</span>);</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"complete task 1"</span>);</span><br><span class="line">       dispatch_semaphore_signal(semaphore);</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="hljs-comment">//ä»»åŠ¡2</span></span><br><span class="line">   <span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;</span><br><span class="line">       dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"run task 2"</span>);</span><br><span class="line">       sleep(<span class="hljs-number">1</span>);</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"complete task 2"</span>);</span><br><span class="line">       dispatch_semaphore_signal(semaphore);</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="hljs-comment">//ä»»åŠ¡3</span></span><br><span class="line">   <span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;</span><br><span class="line">       dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"run task 3"</span>);</span><br><span class="line">       sleep(<span class="hljs-number">1</span>);</span><br><span class="line">       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"complete task 3"</span>);</span><br><span class="line">       dispatch_semaphore_signal(semaphore);</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>ä¹Ÿå¯ä»¥èµ·åˆ°ç±»ä¼¼æ …æ å‡½æ•°çš„ä½œç”¨ã€‚çº¿ç¨‹Aå’Œçº¿ç¨‹Bï¼šçº¿ç¨‹Aæ‰§è¡Œå®Œä¹‹åçº¿ç¨‹Bå†ç»§ç»­æ‰§è¡Œã€‚</p><p>å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼šå…ˆæ‰§è¡Œè·å–tokenæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œrequest</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-comment">//è¿™é‡Œä½¿ç”¨dispatch_asyncï¼Œæ˜¯ä¸ºäº†ä¸é˜»å¡å½“å‰çº¿ç¨‹ã€‚</span></span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;</span><br><span class="line">        dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="hljs-number">0</span>);</span><br><span class="line">        [<span class="hljs-keyword">self</span> getToken:semaphore];</span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        [<span class="hljs-keyword">self</span> request];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"ç»§ç»­æ‰§è¡Œå•Š"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//å¼‚æ­¥è¯·æ±‚ï¼Œè·å–token</span></span><br><span class="line">- (<span class="hljs-keyword">void</span>)getToken:(dispatch_semaphore_t)semaphore &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"getToken:%d"</span>,i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"getToken:Success"</span>);</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">//æ‰§è¡Œç½‘ç»œè¯·æ±‚</span></span><br><span class="line">- (<span class="hljs-keyword">void</span>)request &#123;</span><br><span class="line">    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"request"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é¢˜å¤–è¯ï¼š</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>);</span><br><span class="line">&gt;     </span><br><span class="line">&gt;     <span class="hljs-built_in">NSMutableArray</span> *array = [[<span class="hljs-built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">&gt;     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) &#123;</span><br><span class="line">&gt;         <span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">&gt;             [array addObject:[<span class="hljs-built_in">NSNumber</span> numberWithInt:i]];</span><br><span class="line">&gt;         &#125;);</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>&gt;</p><blockquote><p>ä¸Šé¢è¿™æ®µä»£ç ä¼šæ‰§è¡Œé”™è¯¯ã€‚æŠ¥é”™å¦‚ä¸‹ï¼š</p><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="hljs-built_in">malloc</span>: *** error <span class="hljs-keyword">for</span> object <span class="hljs-number">0x6040003805b0</span>: pointer being freed was <span class="hljs-keyword">not</span> allocated</span><br><span class="line">&gt; *** <span class="hljs-built_in">set</span> a breakpoint in malloc_error_break to debug</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>&gt;</p><blockquote><p>ä¸ºä»€ä¹ˆã€ï¼Ÿ</p></blockquote><h4 id="dispatch-once"><a href="#dispatch-once" class="headerlink" title="dispatch_once"></a>dispatch_once</h4><p>dispatch_onceå‡½æ•°æ˜¯ä¿è¯åœ¨åº”ç”¨ç¨‹åºä¸­åªæ‰§è¡Œä¸€æ¬¡æŒ‡å®šå¤„ç†çš„APIã€‚å•ä¾‹æ¨¡å¼ç»å¸¸ç”¨åˆ°æ­¤å‡½æ•°ã€‚</p><figure class="highlight objc hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="hljs-comment">//code to be executed once</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h4 id="Dispatch-I-O"><a href="#Dispatch-I-O" class="headerlink" title="Dispatch I/O"></a>Dispatch I/O</h4>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ä»€ä¹ˆæ˜¯GCD&lt;ul&gt;
&lt;li&gt;å…¨ç¨‹ï¼šGrand Central Dispatchï¼ˆå¼ºå¤§çš„ä¸­æ¢è°ƒåº¦å™¨ï¼‰&lt;/li&gt;
&lt;li&gt;çº¯Cè¯­è¨€ï¼Œæä¾›äº†éå¸¸å¼ºå¤§çš„å‡½æ•°&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;GCDçš„ä¼˜åŠ¿&lt;ul&gt;
&lt;li&gt;GCDä¼šè‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„CPUå†…æ ¸&lt;/li&gt;
&lt;li&gt;GCDä¼šè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºçº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€é”€æ¯çº¿ç¨‹ï¼‰&lt;/li&gt;
&lt;li&gt;ç¨‹åºå‘˜åªéœ€è¦å‘Šè¯‰GCDæƒ³è¦æ‰§è¡Œä»€ä¹ˆä»»åŠ¡ï¼Œä¸éœ€è¦ç¼–å†™ä»»ä½•çº¿ç¨‹ç®¡ç†ä»£ç &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.wuqihan.cn/categories/iOS/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://www.wuqihan.cn/categories/iOS/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
    
      <category term="å¤šçº¿ç¨‹" scheme="http://www.wuqihan.cn/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="GCD" scheme="http://www.wuqihan.cn/tags/GCD/"/>
    
  </entry>
  
</feed>
